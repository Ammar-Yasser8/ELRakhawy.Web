@{
    ViewData["Title"] = "الجهات";
    var currentTime = "2025-08-19 19:06:16";
    var currentUser = "Ammar-Yasser8";
}
<style>
    .table-responsive {
        overflow-x: hidden !important;
    }

        .table-responsive table {
            width: 100% !important;
            table-layout: fixed !important;
            word-wrap: break-word !important;
        }

        .table-responsive th,
        .table-responsive td {
            white-space: normal !important;
            word-break: break-word !important;
        }
</style>

<!-- Enhanced Navigation Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
    <div class="card border-0 shadow-sm">
        <div class="card-body py-2">
            <ol class="breadcrumb mb-0 align-items-center">
                <li class="breadcrumb-item">
                    <a href="@Url.Action("Index", "Home")" class="text-decoration-none d-flex align-items-center">
                        <i class="fas fa-home text-primary me-2"></i>
                        <span class="fw-semibold">الرئيسية</span>
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="@Url.Action("PublicTables", "Home")" class="text-decoration-none d-flex align-items-center">
                        <i class="fas fa-table text-info me-2"></i>
                        <span class="fw-semibold">الجداول العامة</span>
                    </a>
                </li>
            </ol>
        </div>
    </div>
</nav>


<!-- Enhanced Success/Error Messages -->
@if (TempData["Success"] != null || TempData["Error"] != null)
{
    <div class="alert @(TempData["Success"] != null ? "alert-success" : "alert-danger") alert-dismissible fade show shadow-sm border-0" role="alert">
        <div class="d-flex align-items-center">
            <i class="fas @(TempData["Success"] != null ? "fa-check-circle" : "fa-exclamation-circle") me-3 fa-lg"></i>
            <div>
                <strong>@(TempData["Success"] != null ? "نجح!" : "خطأ!")</strong>
                <span class="ms-2">@(TempData["Success"] ?? TempData["Error"])</span>
            </div>
        </div>
        <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
    </div>
}

<!-- Enhanced Data Display Section with Inline Search -->
<div id="stakeholdersContainer">
    <div class="section-card">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light border-bottom">
                <div class="d-flex justify-content-between align-items-center">
                    <h5 class="mb-0 fw-bold text-dark">
                        <i class="fas fa-list me-2 text-primary"></i>قائمة الجهات
                    </h5>
                    <div class="d-flex align-items-center gap-2">
                        <!-- Search Results Info -->
                        <small class="text-muted">
                            <span id="resultsInfo">عرض <strong id="visibleCount">0</strong> من أصل <strong id="totalCount">0</strong> جهة</span>
                        </small>
                        <div class="badge bg-success px-3 py-2">
                            <i class="fas fa-database me-1"></i>
                            <span id="badgeCount">0</span> جهة
                        </div>
                        <button class="btn btn-outline-danger btn-sm" id="clearAllSearch" style="display: none;">
                            <i class="fas fa-eraser me-1"></i>مسح المرشحات
                        </button>
                        <button class="btn btn-outline-dark btn-sm" id="toggleColumnsBtn" data-bs-toggle="dropdown">
                            <i class="fas fa-columns me-1"></i>إظهار/إخفاء
                        </button>
                        <ul class="dropdown-menu column-toggle-menu" id="columnToggleMenu"></ul>
                        <button class="btn btn-outline-info btn-sm" id="refreshData">
                            <i class="fas fa-sync-alt me-1"></i>تحديث
                        </button>
                        <button class="btn btn-primary btn-sm" id="btnAddStakeholder">
                            <i class="fas fa-plus me-1"></i>إضافة جهة
                        </button>
                        <button class="btn btn-outline-success btn-sm" onclick="exportToExcel()">
                            <i class="fas fa-file-excel me-1"></i>تصدير Excel
                        </button>
                        <button class="btn btn-outline-secondary btn-sm" onclick="printTable()">
                            <i class="fas fa-print me-1"></i>طباعة
                        </button>
                    </div>
                </div>
            </div>

            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-hover align-middle mb-0" id="stakeholdersTable">
                        <thead class="table-light">
                            <tr>
                                <th class="fw-bold sortable" style="width: 18%; cursor: pointer;" data-column="0">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span>
                                            <i class="fas fa-building text-primary me-1"></i>الجهة
                                        </span>
                                        <i class="fas fa-sort sort-icon text-muted"></i>
                                    </div>
                                </th>
                                <th class="fw-bold sortable" style="width: 20%; cursor: pointer;" data-column="1">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span>
                                            <i class="fas fa-tags text-info me-1"></i>نوع الجهة
                                        </span>
                                        <i class="fas fa-sort sort-icon text-muted"></i>
                                    </div>
                                </th>
                                <th class="fw-bold sortable" style="width: 10%; cursor: pointer;" data-column="2">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span>
                                            <i class="fas fa-toggle-on text-success me-1"></i>الحالة
                                        </span>
                                        <i class="fas fa-sort sort-icon text-muted"></i>
                                    </div>
                                </th>
                                <th class="fw-bold sortable" style="width: 18%; cursor: pointer;" data-column="3">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span>
                                            <i class="fas fa-coins text-warning me-1"></i>نوع المعاملة المالية
                                        </span>
                                        <i class="fas fa-sort sort-icon text-muted"></i>
                                    </div>
                                </th>
                                <th class="fw-bold sortable" style="width: 12%; cursor: pointer;" data-column="4">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span>
                                            <i class="fas fa-phone text-purple me-1"></i>التليفون
                                        </span>
                                        <i class="fas fa-sort sort-icon text-muted"></i>
                                    </div>
                                </th>
                                <th class="fw-bold sortable" style="width: 22%; cursor: pointer;" data-column="5">
                                    <div class="d-flex align-items-center justify-content-between">
                                        <span>
                                            <i class="fas fa-comment text-secondary me-1"></i>البيان
                                        </span>
                                        <i class="fas fa-sort sort-icon text-muted"></i>
                                    </div>
                                </th>
                                <th class="text-center fw-bold" style="width: 10%;">
                                    <i class="fas fa-cogs text-dark me-1"></i>الإجراءات
                                </th>
                            </tr>
                            <!-- Inline Search Row -->
                            <tr class="search-row bg-white">
                                <th class="border-bottom-0 pb-2 pt-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="search-container flex-grow-1">
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text bg-light border-end-0">
                                                    <i class="fas fa-search text-muted"></i>
                                                </span>
                                                <input type="text" id="searchByName" class="form-control border-start-0"
                                                       placeholder="ابحث في أسماء الجهات...">
                                                <button class="btn btn-outline-secondary btn-sm" type="button" id="clearNameSearch" style="display: none;">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="sort-indicator" id="sortIndicator0" style="display: none;">
                                            <span class="badge bg-primary">
                                                <i class="fas fa-sort-amount-down"></i>
                                            </span>
                                        </div>
                                    </div>
                                </th>
                                <th class="border-bottom-0 pb-2 pt-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="search-container flex-grow-1">
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text bg-light border-end-0">
                                                    <i class="fas fa-search text-muted"></i>
                                                </span>
                                                <input type="text" id="searchByType" class="form-control border-start-0"
                                                       placeholder="ابحث في الأنواع...">
                                                <button class="btn btn-outline-secondary btn-sm" type="button" id="clearTypeSearch" style="display: none;">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="sort-indicator" id="sortIndicator1" style="display: none;">
                                            <span class="badge bg-primary">
                                                <i class="fas fa-sort-amount-down"></i>
                                            </span>
                                        </div>
                                    </div>
                                </th>
                                <th class="border-bottom-0 pb-2 pt-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="search-container flex-grow-1">
                                            <select id="searchByStatus" class="form-select form-select-sm">
                                                <option value="">الكل</option>
                                                <option value="active">نشط</option>
                                                <option value="inactive">غير نشط</option>
                                            </select>
                                        </div>
                                        <div class="sort-indicator" id="sortIndicator2" style="display: none;">
                                            <span class="badge bg-primary">
                                                <i class="fas fa-sort-amount-down"></i>
                                            </span>
                                        </div>
                                    </div>
                                </th>
                                <th class="border-bottom-0 pb-2 pt-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="search-container flex-grow-1">
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text bg-light border-end-0">
                                                    <i class="fas fa-search text-muted"></i>
                                                </span>
                                                <input type="text" id="searchByFinancial" class="form-control border-start-0"
                                                       placeholder="ابحث في المعاملات...">
                                                <button class="btn btn-outline-secondary btn-sm" type="button" id="clearFinancialSearch" style="display: none;">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="sort-indicator" id="sortIndicator3" style="display: none;">
                                            <span class="badge bg-primary">
                                                <i class="fas fa-sort-amount-down"></i>
                                            </span>
                                        </div>
                                    </div>
                                </th>
                                <th class="border-bottom-0 pb-2 pt-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="search-container flex-grow-1">
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text bg-light border-end-0">
                                                    <i class="fas fa-search text-muted"></i>
                                                </span>
                                                <input type="text" id="searchByPhone" class="form-control border-start-0"
                                                       placeholder="ابحث في الهواتف...">
                                                <button class="btn btn-outline-secondary btn-sm" type="button" id="clearPhoneSearch" style="display: none;">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="sort-indicator" id="sortIndicator4" style="display: none;">
                                            <span class="badge bg-primary">
                                                <i class="fas fa-sort-amount-down"></i>
                                            </span>
                                        </div>
                                    </div>
                                </th>
                                <th class="border-bottom-0 pb-2 pt-2">
                                    <div class="d-flex align-items-center gap-2">
                                        <div class="search-container flex-grow-1">
                                            <div class="input-group input-group-sm">
                                                <span class="input-group-text bg-light border-end-0">
                                                    <i class="fas fa-search text-muted"></i>
                                                </span>
                                                <input type="text" id="searchByComment" class="form-control border-start-0"
                                                       placeholder="ابحث في البيان...">
                                                <button class="btn btn-outline-secondary btn-sm" type="button" id="clearCommentSearch" style="display: none;">
                                                    <i class="fas fa-times"></i>
                                                </button>
                                            </div>
                                        </div>
                                        <div class="sort-indicator" id="sortIndicator5" style="display: none;">
                                            <span class="badge bg-primary">
                                                <i class="fas fa-sort-amount-down"></i>
                                            </span>
                                        </div>
                                    </div>
                                </th>
                                <th class="border-bottom-0 pb-2 pt-2 text-center">
                                    <small class="text-muted">
                                        <i class="fas fa-filter me-1"></i>البحث والتصفية
                                    </small>
                                </th>
                            </tr>
                        </thead>
                        <tbody id="stakeholdersTableBody">
                            <!-- Data will be loaded via API -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <!-- No Results Message -->
    <div id="noResultsMessage" class="text-center py-5" style="display: none;">
        <div class="card border-0 shadow-sm">
            <div class="card-body">
                <i class="fas fa-search fa-3x text-muted mb-3"></i>
                <h5 class="text-muted">لا توجد نتائج مطابقة</h5>
                <p class="text-muted mb-3">لم يتم العثور على جهات تطابق معايير البحث الحالية</p>
                <button class="btn btn-outline-primary" id="resetSearch">
                    <i class="fas fa-refresh me-1"></i>إعادة تعيين البحث
                </button>
            </div>
        </div>
    </div>
</div>

<style>
.sortable {
    user-select: none;
    transition: background-color 0.2s;
}

.sortable:hover {
    background-color: rgba(0, 0, 0, 0.05);
}

.sort-icon {
    font-size: 0.8rem;
    transition: all 0.2s;
}

.sortable.asc .sort-icon {
    transform: rotate(180deg);
    color: #0d6efd !important;
}

.sortable.desc .sort-icon {
    color: #0d6efd !important;
}

.column-toggle-menu {
    max-height: 300px;
    overflow-y: auto;
}

.sort-indicator {
    min-width: 35px;
    animation: fadeIn 0.3s;
}

.sort-indicator .badge {
    font-size: 0.75rem;
    padding: 0.35rem 0.5rem;
}

@@keyframes fadeIn {
    from {
        opacity: 0;
        transform: scale(0.8);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

/* Enhanced Print Styles */
@@media print {
    /* Hide everything except print content */
    body * {
        visibility: hidden;
    }
    
    #printSection,
    #printSection * {
        visibility: visible;
    }
    
    #printSection {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        direction: rtl;
    }
    
    .print-header {
        text-align: center;
        margin-bottom: 20px;
        border-bottom: 2px solid #333;
        padding-bottom: 10px;
    }
    
    .print-header h2 {
        color: #333;
        font-size: 24px;
        margin-bottom: 5px;
        font-weight: bold;
    }
    
    .print-header p {
        color: #666;
        font-size: 12px;
        margin: 0;
    }
    
    .print-table {
        width: 100%;
        border-collapse: collapse;
        direction: rtl;
        margin-top: 10px;
        font-size: 10px;
    }
    
    .print-table th,
    .print-table td {
        border: 1px solid #333;
        padding: 6px 4px;
        text-align: right;
        vertical-align: top;
    }
    
    .print-table th {
        background-color: #f0f0f0 !important;
        font-weight: bold;
        color: #000 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .print-table tbody tr:nth-child(even) {
        background-color: #f9f9f9 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .print-footer {
        margin-top: 20px;
        padding-top: 10px;
        border-top: 1px solid #999;
        text-align: center;
        font-size: 10px;
        color: #666;
    }
    
    .print-table tr {
        page-break-inside: avoid;
    }
    
    @@page {
        margin: 1cm;
        size: A4 landscape;
    }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
    document.addEventListener("DOMContentLoaded", function () {
        const table = document.getElementById('stakeholdersTable');
        const tbody = table.querySelector('tbody');
        const headers = table.querySelectorAll('thead tr:first-child th');
        const columnToggleMenu = document.getElementById('columnToggleMenu');

        // Add Show All / Hide All buttons with proper icons
        const controlsLi = document.createElement("li");
        controlsLi.innerHTML = `
            <div class="dropdown-item-text pb-2 mb-2">
                <div class="d-flex gap-2">
                    <button class="btn btn-sm btn-success flex-fill" id="showAllColumns" title="إظهار جميع الأعمدة">
                        <i class="fas fa-eye me-1"></i>
                        <span class="d-none d-sm-inline">إظهار الكل</span>
                    </button>
                    <button class="btn btn-sm btn-danger flex-fill" id="hideAllColumns" title="إخفاء جميع الأعمدة">
                        <i class="fas fa-eye-slash me-1"></i>
                        <span class="d-none d-sm-inline">إخفاء الكل</span>
                    </button>
                </div>
            </div>`;
        columnToggleMenu.appendChild(controlsLi);

        // Add separator
        const separatorLi = document.createElement("li");
        separatorLi.innerHTML = `<hr class="dropdown-divider">`;
        columnToggleMenu.appendChild(separatorLi);

        // Add individual column toggles with icons
        headers.forEach((th, index) => {
            if (index === headers.length - 1) return; // Skip actions column

            const title = th.textContent.trim().replace(/\s+/g, ' ');
            const li = document.createElement("li");
            li.innerHTML = `
                <label class="dropdown-item d-flex align-items-center">
                    <input type="checkbox" class="me-2 column-toggle" data-index="${index}" checked>
                    <i class="fas fa-eye text-success me-2 column-icon"></i>
                    <span>${title}</span>
                </label>`;
            columnToggleMenu.appendChild(li);
        });

        // Handle Show All Columns
        document.getElementById('showAllColumns').addEventListener('click', function(e) {
            e.preventDefault();
            const checkboxes = columnToggleMenu.querySelectorAll('.column-toggle');
            checkboxes.forEach(checkbox => {
                if (!checkbox.checked) {
                    checkbox.checked = true;
                    const colIndex = parseInt(checkbox.getAttribute("data-index"));

                    // Show the column
                    table.querySelectorAll("tr").forEach(row => {
                        const cell = row.querySelectorAll("th, td")[colIndex];
                        if (cell) {
                            cell.style.display = "";
                        }
                    });

                    // Update icon to "eye" (visible)
                    const label = checkbox.closest('label');
                    const icon = label.querySelector('.column-icon');
                    if (icon) {
                        icon.className = 'fas fa-eye text-success me-2 column-icon';
                    }
                }
            });
        });

        // Handle Hide All Columns
        document.getElementById('hideAllColumns').addEventListener('click', function(e) {
            e.preventDefault();
            const checkboxes = columnToggleMenu.querySelectorAll('.column-toggle');
            checkboxes.forEach(checkbox => {
                if (checkbox.checked) {
                    checkbox.checked = false;
                    const colIndex = parseInt(checkbox.getAttribute("data-index"));

                    // Hide the column
                    table.querySelectorAll("tr").forEach(row => {
                        const cell = row.querySelectorAll("th, td")[colIndex];
                        if (cell) {
                            cell.style.display = "none";
                        }
                    });

                    // Update icon to "eye-slash" (hidden)
                    const label = checkbox.closest('label');
                    const icon = label.querySelector('.column-icon');
                    if (icon) {
                        icon.className = 'fas fa-eye-slash text-danger me-2 column-icon';
                    }
                }
            });
        });

        // Handle individual column visibility toggle
        columnToggleMenu.addEventListener("change", function (e) {
            if (!e.target.classList.contains("column-toggle")) return;

            const checkbox = e.target;
            const colIndex = parseInt(checkbox.getAttribute("data-index"));
            const isVisible = checkbox.checked;

            // Toggle column visibility
            table.querySelectorAll("tr").forEach(row => {
                const cell = row.querySelectorAll("th, td")[colIndex];
                if (cell) {
                    cell.style.display = isVisible ? "" : "none";
                }
            });

            // Update icon
            const label = checkbox.closest('label');
            const icon = label.querySelector('.column-icon');
            if (icon) {
                if (isVisible) {
                    icon.className = 'fas fa-eye text-success me-2 column-icon';
                } else {
                    icon.className = 'fas fa-eye-slash text-danger me-2 column-icon';
                }
            }
        });

        // Sorting functionality
        let sortDirection = {};

        document.querySelectorAll('.sortable').forEach(header => {
            const column = parseInt(header.getAttribute('data-column'));
            sortDirection[column] = 'none';

            header.addEventListener('click', function() {
                // Get all rows
                const rows = Array.from(tbody.querySelectorAll('tr.stakeholder-row'));

                if (rows.length === 0) return;

                // Determine sort direction
                if (sortDirection[column] === 'none' || sortDirection[column] === 'desc') {
                    sortDirection[column] = 'asc';
                } else {
                    sortDirection[column] = 'desc';
                }

                // Update all headers to show unsorted state
                document.querySelectorAll('.sortable').forEach(h => {
                    h.classList.remove('asc', 'desc');
                    const icon = h.querySelector('.sort-icon');
                    icon.className = 'fas fa-sort sort-icon text-muted';
                });

                // Hide all sort indicators
                document.querySelectorAll('.sort-indicator').forEach(indicator => {
                    indicator.style.display = 'none';
                });

                // Update current header
                header.classList.add(sortDirection[column]);
                const icon = header.querySelector('.sort-icon');
                const sortIndicator = document.getElementById('sortIndicator' + column);
                const sortBadgeIcon = sortIndicator.querySelector('i');

                if (sortDirection[column] === 'asc') {
                    icon.className = 'fas fa-sort-up sort-icon';
                    sortBadgeIcon.className = 'fas fa-sort-amount-up';
                    sortIndicator.querySelector('.badge').classList.remove('bg-danger');
                    sortIndicator.querySelector('.badge').classList.add('bg-success');
                } else {
                    icon.className = 'fas fa-sort-down sort-icon';
                    sortBadgeIcon.className = 'fas fa-sort-amount-down';
                    sortIndicator.querySelector('.badge').classList.remove('bg-success');
                    sortIndicator.querySelector('.badge').classList.add('bg-danger');
                }

                // Show current sort indicator
                sortIndicator.style.display = 'block';

                // Sort rows
                rows.sort((a, b) => {
                    const aCell = a.querySelectorAll('td')[column];
                    const bCell = b.querySelectorAll('td')[column];

                    let aValue = aCell.textContent.trim();
                    let bValue = bCell.textContent.trim();

                    // Handle empty or "no data" values
                    if (aValue.includes('لا يوجد') || aValue.includes('غير محدد') || aValue === '-' || aValue === '') aValue = '';
                    if (bValue.includes('لا يوجد') || bValue.includes('غير محدد') || bValue === '-' || bValue === '') bValue = '';

                    // Try to parse as numbers
                    const aNum = parseFloat(aValue);
                    const bNum = parseFloat(aValue);

                    let comparison = 0;

                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        // Both are numbers
                        comparison = aNum - bNum;
                    } else {
                        // String comparison (case-insensitive)
                        comparison = aValue.localeCompare(bValue, 'ar');
                    }

                    return sortDirection[column] === 'asc' ? comparison : -comparison;
                });

                // Re-append sorted rows
                rows.forEach(row => tbody.appendChild(row));
            });
        });
    });

    // Helper functions
    function getCleanCellText(cell) {
        if (!cell) return '';

        let text = cell.textContent.trim().replace(/\s+/g, ' ');

        // Remove "no data" indicators
        if (text.includes('لا يوجد') || text.includes('غير محدد') || text === '-') {
            return '';
        }

        return text;
    }

    function isColumnVisible(table, colIndex) {
        const firstRowCells = table.querySelectorAll('thead tr:first-child th');
        if (firstRowCells[colIndex]) {
            return firstRowCells[colIndex].style.display !== 'none';
        }
        return false;
    }

    function isRowVisible(row) {
        return row.style.display !== 'none' && row.offsetParent !== null;
    }

        // COMPLETELY FIXED exportToExcel with proper badge separation
    function exportToExcel() {
        try {
            const table = document.getElementById('stakeholdersTable');
            if (!table) throw new Error('Table with id "stakeholdersTable" not found');

            const wsData = [];

            // --- HEADERS & VISIBLE COLUMNS ---
            const headerCells = table.querySelectorAll('thead tr:first-child th');
            const headers = [];
            const visibleColumnIndices = [];

            headerCells.forEach((th, index) => {
                if (index === headerCells.length - 1) return; // skip actions column
                if (th.style.display === "none") return; // skip hidden columns

                visibleColumnIndices.push(index);
                let headerText = th.textContent.trim().replace(/\s+/g, ' ');
                headerText = headerText.replace(/[\u{1F300}-\u{1F9FF}]/gu, '').trim();
                headers.push(headerText);
            });

            if (headers.length === 0) {
                throw new Error('No visible columns to export');
            }

            wsData.push(headers);

            // --- ENHANCED TYPE EXTRACTION FUNCTION ---
            function extractTypesFromCell(col) {
                console.log('=== ANALYZING TYPES CELL ===');
                console.log('Cell HTML:', col.innerHTML);

                const types = [];

                // Method 1: Look for individual badge elements
                const badges = col.querySelectorAll('.badge, span.badge, .stakeholder-type-badge, [class*="badge"]');
                console.log('Found badges:', badges.length);

                if (badges.length > 0) {
                    badges.forEach((badge, index) => {
                        console.log(`\n--- Badge ${index + 1} ---`);
                        console.log('Badge HTML:', badge.outerHTML);

                        // Create a clean copy of the badge
                        const badgeClone = badge.cloneNode(true);

                        // Remove all icon elements completely
                        const iconsToRemove = badgeClone.querySelectorAll('i, .fa, .fas, .far, .fab, .fal, .fad, [class*="fa-"], .icon');
                        iconsToRemove.forEach(icon => {
                            console.log('Removing icon:', icon.outerHTML);
                            icon.remove();
                        });

                        // Get clean text from the badge
                        let badgeText = badgeClone.textContent || '';
                        console.log('Raw badge text:', `"${badgeText}"`);

                        // Clean up the text
                        badgeText = badgeText
                            .replace(/[\u{1F300}-\u{1F9FF}]/gu, '') // Remove emojis
                            .replace(/[★✩✪✫✬✭✮✯✰☆✦✧✨⭐]/g, '') // Remove star symbols
                            .replace(/\s+/g, ' ') // Normalize whitespace
                            .trim();

                        console.log('Cleaned badge text:', `"${badgeText}"`);

                        if (badgeText && badgeText.length > 0) {
                            types.push(badgeText);
                        }
                    });
                }

                // Method 2: If no badges found, try alternative selectors
                if (types.length === 0) {
                    console.log('\nNo badges found, trying alternative methods...');

                    // Look for spans that might contain type information
                    const spans = col.querySelectorAll('span');
                    console.log('Found spans:', spans.length);

                    spans.forEach((span, index) => {
                        // Skip if it's clearly an icon or empty
                        if (span.classList.contains('fa') ||
                            span.classList.contains('fas') ||
                            span.classList.contains('far') ||
                            span.classList.contains('fab') ||
                            span.innerHTML.includes('<i ')) {
                            return;
                        }

                        const spanText = span.textContent.trim();
                        console.log(`Span ${index + 1} text:`, `"${spanText}"`);

                        if (spanText && spanText.length > 2 && !spanText.includes('fa-')) {
                            types.push(spanText);
                        }
                    });
                }

                // Method 3: If still no types, try parsing the entire cell text
                if (types.length === 0) {
                    console.log('\nNo spans worked, trying full cell parsing...');

                    // Get all text content but remove icons first
                    const cellClone = col.cloneNode(true);
                    const allIcons = cellClone.querySelectorAll('i, .fa, .fas, .far, .fab, [class*="fa-"]');
                    allIcons.forEach(icon => icon.remove());

                    let fullText = cellClone.textContent || '';
                    console.log('Full cell text after icon removal:', `"${fullText}"`);

                    // Clean up the text
                    fullText = fullText
                        .replace(/[★✩✪✫✬✭✮✯✰☆✦✧✨⭐]/g, '') // Remove stars
                        .replace(/\s+/g, ' ') // Normalize whitespace
                        .trim();

                    if (fullText) {
                        // Try to split by common patterns that might separate types
                        let possibleTypes = [];

                        // Split by existing Arabic commas first
                        if (fullText.includes('،')) {
                            possibleTypes = fullText.split('،').map(t => t.trim()).filter(Boolean);
                        }
                        // Split by English commas
                        else if (fullText.includes(',')) {
                            possibleTypes = fullText.split(',').map(t => t.trim()).filter(Boolean);
                        }
                        // If no commas, try to identify word boundaries that might indicate separate types
                        else {
                            // This is a heuristic approach - split when we see potential type endings + beginnings
                            const words = fullText.split(/\s+/);
                            let currentType = '';

                            for (let i = 0; i < words.length; i++) {
                                const word = words[i];
                                currentType += word + ' ';

                                // Check if this might be the end of a type (common Arabic business type patterns)
                                const isLikelyTypeEnd = /^(تاجر|مصنع|شركة|مؤسسة|مكتب|معمل|محل|متجر|مطعم|مقهى|صيدلية|عيادة|مستشفى|مدرسة|جامعة|معهد)$/i.test(word) ||
                                                      /ين$|ون$|ة$|ات$/.test(word);

                                // Check if next word might be start of new type
                                const nextWord = words[i + 1];
                                const isNextTypeStart = nextWord && /^(تاجر|مصنع|شركة|مؤسسة|مكتب|معمل|محل|متجر|مطعم|مقهى|صيدلية|عيادة|مستشفى|مدرسة|جامعة|معهد)/i.test(nextWord);

                                if (isLikelyTypeEnd && isNextTypeStart) {
                                    possibleTypes.push(currentType.trim());
                                    currentType = '';
                                }
                            }

                            // Add any remaining text as a type
                            if (currentType.trim()) {
                                possibleTypes.push(currentType.trim());
                            }

                            // If heuristic didn't work well (only one type but seems long), fall back to original text
                            if (possibleTypes.length === 1 && possibleTypes[0].length > 50) {
                                possibleTypes = [fullText];
                            }
                        }

                        console.log('Possible types found:', possibleTypes);
                        types.push(...possibleTypes.filter(Boolean));
                    }
                }

                // Remove duplicates and clean final results
                const uniqueTypes = [...new Set(types.map(t =>
                    t.replace(/\s+/g, ' ')
                     .trim()
                     .replace(/^[:\-–—\s]+|[:\-–—\s]+$/g, '')
                ))].filter(Boolean);

                console.log('Final extracted types:', uniqueTypes);
                console.log('=== END CELL ANALYSIS ===\n');

                return uniqueTypes;
            }

            // --- ROWS ---
            const rows = table.querySelectorAll('tbody tr.stakeholder-row');
            let exportedRowCount = 0;

            rows.forEach((row, rowIndex) => {
                console.log(`\n=== PROCESSING ROW ${rowIndex + 1} ===`);

                const computedStyle = window.getComputedStyle(row);
                if (row.style.display === "none" ||
                    computedStyle.display === "none" ||
                    computedStyle.visibility === "hidden") {
                    console.log('Row is hidden, skipping...');
                    return;
                }

                const cols = row.querySelectorAll('td');
                const rowData = [];

                visibleColumnIndices.forEach((colIndex, visibleIndex) => {
                    const col = cols[colIndex];
                    if (!col) {
                        rowData.push('');
                        return;
                    }

                    let text = '';
                    const headerText = headers[visibleIndex] || '';

                    console.log(`Processing column ${colIndex} (${headerText})...`);

                    // Determine if this is the types column
                    const isTypesColumn = col.classList.contains('stakeholder-type') ||
                                         /نوع|النوع|الأنواع/i.test(headerText) ||
                                         colIndex === 1;

                    if (isTypesColumn) {
                        console.log('This is identified as the TYPES column');
                        const extractedTypes = extractTypesFromCell(col);
                        text = extractedTypes.join('، '); // Join with Arabic comma
                        console.log('Final types text:', `"${text}"`);
                    }
                    // Handle other column types as before
                    else if (col.classList.contains('stakeholder-phone') || /هاتف|تواصل/i.test(headerText)) {
                        const phoneElements = col.querySelectorAll('span[dir="ltr"], .phone, .phones');
                        if (phoneElements.length > 0) {
                            const phones = Array.from(phoneElements)
                                .map(el => el.textContent.trim())
                                .filter(p => p && p !== '-');
                            text = phones.join('، ');
                        } else {
                            text = col.textContent.trim().replace(/\s+/g, ' ');
                        }
                    }
                    else if (col.classList.contains('stakeholder-status') || /حالة|نشط|غير نشط/i.test(headerText)) {
                        const statusToggle = col.querySelector('.status-toggle, input[type="checkbox"]');
                        if (statusToggle && typeof statusToggle.checked !== 'undefined') {
                            text = statusToggle.checked ? 'نشط' : 'غير نشط';
                        } else {
                            text = col.textContent.trim();
                        }
                    }
                    else if (col.classList.contains('stakeholder-comment') || /ملاحظات|تعليق/i.test(headerText)) {
                        const commentSpan = col.querySelector('.comment-text');
                        text = commentSpan ? (commentSpan.getAttribute('title') || commentSpan.textContent.trim()) : col.textContent.trim();
                    }
                    else {
                        const cellClone = col.cloneNode(true);
                        const icons = cellClone.querySelectorAll('i, [class*="fa-"], .fa, .fas, .far, .fab, .fal, .fad');
                        icons.forEach(icon => icon.remove());
                        text = cellClone.textContent.trim().replace(/\s+/g, ' ');
                    }

                    // Clean up common placeholder text
                    if (['لا يوجد وصف', '-', '', 'لا يوجد نوع', 'لا يوجد', 'لا توجد واجهات مرتبطة'].includes(text)) {
                        text = '';
                    }

                    text = text.replace(/[\u{1F300}-\u{1F9FF}]/gu, '')
                              .replace(/fa-[a-z-]+/gi, '')
                              .replace(/\s+/g, ' ')
                              .trim();

                    rowData.push(text);
                });

                if (rowData.some(cell => cell !== '')) {
                    wsData.push(rowData);
                    exportedRowCount++;
                }
            });

            if (exportedRowCount === 0) {
                showNotification('لا توجد بيانات للتصدير', 'warning');
                return;
            }

            // --- EXCEL CREATION (keeping your existing styling) ---
            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            if (!ws['!views']) ws['!views'] = [];
            ws['!views'][0] = { rightToLeft: true };

            const colWidths = headers.map((header, index) => {
                const maxLength = Math.max(
                    header.length,
                    ...wsData.slice(1).map(row => (row[index] || '').toString().length)
                );
                let width = Math.max(maxLength + 2, 15);
                if (header.includes('نوع') || header.includes('الأنواع')) width = Math.max(width, 35);
                else if (header.includes('هاتف') || header.includes('تواصل')) width = Math.max(width, 20);
                else if (header.includes('ملاحظات') || header.includes('تعليق')) width = Math.max(width, 35);
                return { wch: Math.min(width, 70) };
            });
            ws['!cols'] = colWidths;

            // Header styling
            const range = XLSX.utils.decode_range(ws['!ref']);
            for (let C = range.s.c; C <= range.e.c; ++C) {
                const address = XLSX.utils.encode_col(C) + "1";
                if (!ws[address]) continue;
                ws[address].s = {
                    font: { bold: true, sz: 12, color: { rgb: "FFFFFF" } },
                    fill: { fgColor: { rgb: "2E7D32" } },
                    alignment: { horizontal: "center", vertical: "center", wrapText: true },
                    border: {
                        top: { style: "thin", color: { rgb: "000000" } },
                        bottom: { style: "thin", color: { rgb: "000000" } },
                        left: { style: "thin", color: { rgb: "000000" } },
                        right: { style: "thin", color: { rgb: "000000" } }
                    }
                };
            }

            // Data cell styling
            for (let R = range.s.r + 1; R <= range.e.r; ++R) {
                for (let C = range.s.c; C <= range.e.c; ++C) {
                    const address = XLSX.utils.encode_cell({ r: R, c: C });
                    if (!ws[address]) continue;
                    ws[address].s = ws[address].s || {};
                    ws[address].s.border = {
                        top: { style: "thin", color: { rgb: "CCCCCC" } },
                        bottom: { style: "thin", color: { rgb: "CCCCCC" } },
                        left: { style: "thin", color: { rgb: "CCCCCC" } },
                        right: { style: "thin", color: { rgb: "CCCCCC" } }
                    };
                    ws[address].s.alignment = { horizontal: "right", vertical: "center", wrapText: true };
                    if (R % 2 === 0) ws[address].s.fill = { fgColor: { rgb: "F8F9FA" } };
                }
            }

            XLSX.utils.book_append_sheet(wb, ws, "قائمة الجهات المعنية");

            if (!wb.Workbook) wb.Workbook = {};
            wb.Workbook.Views = [{ RTL: true }];
            wb.Props = {
                Title: "قائمة الجهات المعنية",
                Subject: "تصدير بيانات الجهات المعنية",
                Author: "نظام إدارة الجهات المعنية",
                Creator: "Ammar-Yasser8",
                CreatedDate: new Date()
            };

            const now = new Date();
            const filename = `stakeholders_${now.getFullYear()}-${(now.getMonth()+1).toString().padStart(2,'0')}-${now.getDate().toString().padStart(2,'0')}_${now.getHours().toString().padStart(2,'0')}-${now.getMinutes().toString().padStart(2,'0')}.xlsx`;

            XLSX.writeFile(wb, filename);

            const arabicRowCount = exportedRowCount.toString().replace(/\d/g, d => '٠١٢٣٤٥٦٧٨٩'[d]);
            showNotification(`تم تصدير ${arabicRowCount} جهة بنجاح إلى ملف Excel`, 'success');

            console.log('Excel export completed:', {
                rowsExported: exportedRowCount,
                filename: filename,
                timestamp: new Date().toISOString(),
                user: 'Ammar-Yasser8'
            });

        } catch (error) {
            console.error('Export error:', error);
            showNotification('حدث خطأ أثناء التصدير. يرجى المحاولة مرة أخرى.', 'error');
        }
    }

    // Helper function for notifications
    function showNotification(message, type = 'info') {
        if (typeof Notification !== 'undefined' && Notification.show) {
            Notification.show(message, type);
        } else {
            console.log(`${type.toUpperCase()}: ${message}`);
            alert(message);
        }
    }

            // Print function - FIXED
    function printTable() {
        try {
            const table = document.getElementById('stakeholdersTable');

            // Remove existing print section if any
            const existingPrintSection = document.getElementById('printSection');
            if (existingPrintSection) {
                existingPrintSection.remove();
            }

            // Create print content
            const printSection = document.createElement('div');
            printSection.id = 'printSection';

            // Header
            const header = document.createElement('div');
            header.className = 'print-header';
            header.innerHTML = `
                <h2>قائمة الجهات</h2>
                <p>تاريخ الطباعة: ${new Date().toLocaleDateString('ar-EG', {
                    weekday: 'long',
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric'
                })} - ${new Date().toLocaleTimeString('ar-EG')}</p>
            `;
            printSection.appendChild(header);

            // Create print table
            const printTable = document.createElement('table');
            printTable.className = 'print-table';

            // Get visible column indices (skip actions column)
            const headerCells = table.querySelectorAll('thead tr:first-child th');
            const visibleColumnIndices = [];

            headerCells.forEach((th, index) => {
                // Skip actions column (last column)
                if (index === headerCells.length - 1) return;

                // Only include visible columns
                if (isColumnVisible(table, index)) {
                    visibleColumnIndices.push(index);
                }
            });

            // Create table header
            const thead = document.createElement('thead');
            const headerRow = document.createElement('tr');

            visibleColumnIndices.forEach(colIndex => {
                const th = document.createElement('th');
                th.textContent = headerCells[colIndex].textContent.trim().replace(/\s+/g, ' ');
                headerRow.appendChild(th);
            });

            thead.appendChild(headerRow);
            printTable.appendChild(thead);

            // Create table body
            const tbody = document.createElement('tbody');
            let visibleRowCount = 0;

            // Get only VISIBLE rows
            const allRows = table.querySelectorAll('tbody tr.stakeholder-row');

            allRows.forEach(row => {
                // Skip hidden rows
                if (!isRowVisible(row)) return;

                visibleRowCount++;
                const cols = row.querySelectorAll('td');
                const tr = document.createElement('tr');

                visibleColumnIndices.forEach(colIndex => {
                    const td = document.createElement('td');

                    // Special handling for phone number column (index 4)
                    if (colIndex === 4) {
                        const phoneCell = cols[colIndex];
                        const phoneElements = phoneCell.querySelectorAll('[dir="ltr"]');

                        if (phoneElements.length > 0) {
                            // Extract phone numbers and format them for print
                            const phoneNumbers = Array.from(phoneElements)
                                .map(el => el.textContent.trim())
                                .filter(phone => phone && phone !== '-');

                            if (phoneNumbers.length > 0) {
                                // Join multiple phone numbers with commas for print
                                td.textContent = phoneNumbers.join(' ، ');
                                td.style.direction = 'ltr';
                                td.style.textAlign = 'left';
                            } else {
                                td.textContent = '-';
                            }
                        } else {
                            const text = getCleanCellText(cols[colIndex]);
                            td.textContent = text || '-';
                        }
                    } else {
                        const text = getCleanCellText(cols[colIndex]);
                        td.textContent = text || '-';
                    }

                    tr.appendChild(td);
                });

                tbody.appendChild(tr);
            });

            // Handle empty results
            if (visibleRowCount === 0) {
                const emptyRow = document.createElement('tr');
                const emptyCell = document.createElement('td');
                emptyCell.colSpan = visibleColumnIndices.length;
                emptyCell.textContent = 'لا توجد بيانات للعرض';
                emptyCell.style.textAlign = 'center';
                emptyCell.style.padding = '20px';
                emptyCell.style.color = '#999';
                emptyRow.appendChild(emptyCell);
                tbody.appendChild(emptyRow);
            }

            printTable.appendChild(tbody);
            printSection.appendChild(printTable);

            // Create footer
            const footer = document.createElement('div');
            footer.className = 'print-footer';
            footer.innerHTML = `
                <p><strong>عدد الجهات المعروضة:</strong> ${visibleRowCount} | <strong>عدد الأعمدة:</strong> ${visibleColumnIndices.length}</p>
                <p>تم الطباعة من نظام إدارة الجهات</p>
            `;
            printSection.appendChild(footer);

            // Add to document
            document.body.appendChild(printSection);

            // Trigger print
            window.print();

            // Clean up after print dialog closes
            setTimeout(() => {
                if (document.getElementById('printSection')) {
                    document.getElementById('printSection').remove();
                }
            }, 100);

            // Show success notification
            if (typeof showNotification === 'function') {
                showNotification('تم تجهيز الصفحة للطباعة بنجاح', 'success');
            }

        } catch (error) {
            console.error('Error printing table:', error);
            if (typeof showNotification === 'function') {
                showNotification('حدث خطأ أثناء الطباعة', 'error');
            }
        }
    }

</script>
<!-- Empty State Message -->
<div id="emptyState" class="text-center py-5" style="display: none;">
    <div class="card border-0 shadow-sm">
        <div class="card-body">
            <i class="fas fa-users fa-3x text-muted mb-3"></i>
            <h5 class="text-muted">لا توجد جهات</h5>
            <p class="text-muted mb-3">لا توجد جهات مضافة بعد في النظام</p>
            <a asp-action="Create" class="btn btn-success">
                <i class="fas fa-plus-circle me-1"></i>إضافة جهة جديدة
            </a>
        </div>
    </div>
</div>

<!-- Enhanced Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-info text-white border-bottom-0">
                <h5 class="modal-title fw-bold">
                    <i class="fas fa-info-circle me-2"></i>تفاصيل الجهة
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-0" id="detailsContent">
                <!-- Details content will be loaded here -->
            </div>
            <div class="modal-footer bg-light border-top">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>إغلاق
                </button>
                <button type="button" class="btn btn-info" id="editFromDetails">
                    <i class="fas fa-edit me-1"></i>تعديل
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Enhanced Delete Confirmation Modal -->
<div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content border-0 shadow">
            <div class="modal-header bg-danger text-white border-bottom-0">
                <h5 class="modal-title fw-bold">
                    <i class="fas fa-exclamation-triangle me-2"></i>تأكيد الحذف
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body p-4">
                <div class="text-center">
                    <i class="fas fa-trash-alt fa-3x text-danger mb-3"></i>
                    <h6 class="mb-3">هل أنت متأكد من حذف هذه الجهة؟</h6>
                    <div class="alert alert-warning">
                        <strong id="deleteStakeholderName" class="text-dark"></strong>
                    </div>
                    <p class="text-muted">لا يمكن التراجع عن هذا الإجراء</p>
                    <div class="alert alert-danger">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        سيتم حذف جميع البيانات المرتبطة بهذه الجهة
                    </div>
                </div>
                <input type="hidden" id="deleteStakeholderId">
            </div>
            <div class="modal-footer border-top">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>إلغاء
                </button>
                <button type="button" class="btn btn-danger" id="confirmDelete">
                    <i class="fas fa-trash me-1"></i>تأكيد الحذف
                </button>
            </div>
        </div>
    </div>
</div>
<!-- Modal -->
<div class="modal fade" id="stakeholderModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header bg-light">
                <h5 class="modal-title fw-bold">إضافة / تعديل جهة</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="إغلاق"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <!-- هنا الـ Partial هيترندر -->
            </div>
        </div>
    </div>
</div>

<!-- Enhanced Toast Notifications -->
<div class="toast-container position-fixed bottom-0 end-0 p-3">
    <div id="notificationToast" class="toast align-items-center text-white border-0" role="alert" aria-live="assertive" aria-atomic="true">
        <div class="d-flex">
            <div class="toast-body">
                <i id="toastIcon" class="fas fa-check-circle me-2"></i>
                <span id="toastMessage"></span>
            </div>
            <button type="button" class="btn-close btn-close-white ms-auto me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
        </div>
    </div>
</div>

<!-- Loading Spinner -->
<div id="loadingOverlay" class="position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center d-none" style="background-color: rgba(255,255,255,0.8); z-index: 9999;">
    <div class="text-center">
        <div class="spinner-border text-primary mb-3" role="status" style="width: 3rem; height: 3rem;">
            <span class="visually-hidden">جاري التحميل...</span>
        </div>
        <div class="text-muted">جاري تحميل بيانات الجهات...</div>
    </div>
</div>

@section Scripts {
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <!-- Export and Print Functions -->
    <script>
        $(document).ready(function() {
            // ========================================
            // CONSTANTS & CONFIGURATION
            // ========================================
            const CONFIG = {
                CURRENT_TIME: '2025-11-17 10:14:41',
                CURRENT_USER: 'Ammar-Yasser8',
                SEARCH_DELAY: 200,
                TOAST_DELAY: 4000,
                ALERT_DISMISS_DELAY: 5000,
                COMMENT_MAX_LENGTH: 1000,
                COMMENT_DISPLAY_LENGTH: 60
            };

            // ========================================
            // STATE MANAGEMENT
            // ========================================
            const State = {
                stakeholdersData: [],
                currentDetailsId: null,
                searchTimeout: null
            };

            // ========================================
            // MODAL INSTANCES
            // ========================================
            const Modals = {
                stakeholder: null,
                delete: new bootstrap.Modal(document.getElementById('deleteModal')),
                details: new bootstrap.Modal(document.getElementById('detailsModal')),
                toast: new bootstrap.Toast(document.getElementById('notificationToast'), {
                    delay: CONFIG.TOAST_DELAY
                })
            };

            // ========================================
            // UTILITY: ARABIC NUMBER CONVERSION
            // ========================================
            const NumberConverter = {
                arabicDigits: '٠١٢٣٤٥٦٧٨٩',
                latinDigits: '0123456789',

                toArabic(str) {
                    if (str === null || str === undefined) return '';
                    return str.toString().replace(/[0-9]/g, d => this.arabicDigits[d]);
                },

                toLatin(str) {
                    if (str === null || str === undefined) return '';
                    return str.toString().replace(/[٠-٩]/g, d => this.latinDigits[this.arabicDigits.indexOf(d)]);
                }
            };

            // ========================================
            // UTILITY: NOTIFICATIONS
            // ========================================
            const Notification = {
                icons: {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    warning: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                },

                colors: {
                    success: 'bg-success',
                    error: 'bg-danger',
                    warning: 'bg-warning',
                    info: 'bg-info'
                },

                show(message, type = 'success') {
                    $('#toastIcon').removeClass().addClass(`fas ${this.icons[type]} me-2`);
                    $('#toastMessage').text(message);
                    $('#notificationToast')
                        .removeClass('bg-success bg-danger bg-warning bg-info text-white text-dark')
                        .addClass(`${this.colors[type]} ${type === 'warning' ? 'text-dark' : 'text-white'}`);

                    Modals.toast.show();
                }
            };

            // ========================================
            // UTILITY: LOADING OVERLAY
            // ========================================
            const Loading = {
                show() {
                    $('#loadingOverlay').removeClass('d-none');
                },

                hide() {
                    $('#loadingOverlay').addClass('d-none');
                }
            };

            // ========================================
            // UTILITY: INPUT NUMBER HANDLER (FORMS)
            // ========================================
            const InputNumberHandler = {
                // Strict conversion: forces any typed Latin digit to Arabic immediately
                forceArabicInput($input) {
                    const val = $input.val();
                    if (!val) return;

                    // If contains any Latin digits 0-9
                    if (/[0-9]/.test(val)) {
                        const cursorStart = $input[0].selectionStart;
                        const cursorEnd = $input[0].selectionEnd;

                        // Convert to Arabic
                        const newVal = NumberConverter.toArabic(val);

                        $input.val(newVal);

                        // Restore cursor position
                        try {
                            $input[0].setSelectionRange(cursorStart, cursorEnd);
                        } catch (ex) {
                            // ignore
                        }
                    }
                },

                initialize() {
                    // Target ALL text inputs and textareas, specifically including ContactNumber
                    const $inputs = $('#modalBody input[type="text"], #modalBody textarea');

                    // Remove existing handlers
                    $inputs.off('input.numberHandler blur.numberHandler');

                    // Apply strict conversion on input (while typing)
                    $inputs.on('input.numberHandler', (e) => {
                        this.forceArabicInput($(e.target));

                        // Update counters slightly delayed
                        setTimeout(() => {
                            Counters.updateAll();
                        }, 10);
                    });

                    // Ensure conversion on blur as well
                    $inputs.on('blur.numberHandler', (e) => {
                        this.forceArabicInput($(e.target));
                        Counters.updateAll();
                    });
                }
            };

            // ========================================
            // COUNTERS MANAGEMENT
            // ========================================
            const Counters = {
                updateAll() {
                    this.updateComment();
                    this.updateType();
                    this.updateValidation();
                },

                updateComment() {
                    const $comment = $('#Comment');
                    if ($comment.length === 0) return;

                    const currentLength = $comment.val().length;

                    // Force Arabic display for counters
                    const formattedCurrent = NumberConverter.toArabic(currentLength.toString());
                    const formattedMax = NumberConverter.toArabic(CONFIG.COMMENT_MAX_LENGTH.toString());

                    let $counter = $('#commentCounter');
                    if ($counter.length === 0) {
                        $comment.after(`
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <small class="text-muted">عدد الأحرف: <span id="commentCounter">${formattedCurrent}/${formattedMax}</span></small>
                            </div>
                        `);
                        $counter = $('#commentCounter');
                    } else {
                        $counter.text(`${formattedCurrent}/${formattedMax}`);
                    }

                    $counter.removeClass('text-warning text-danger');
                    if (currentLength > CONFIG.COMMENT_MAX_LENGTH * 0.8) {
                        $counter.addClass('text-warning');
                    }
                    if (currentLength >= CONFIG.COMMENT_MAX_LENGTH) {
                        $counter.addClass('text-danger').removeClass('text-warning');
                    }
                },

                updateType() {
                    const selectedCount = $("input[name='SelectedTypeIds']:checked").length;
                    const totalCount = $("input[name='SelectedTypeIds']").length;

                    if (totalCount === 0) return;

                    // Force Arabic display
                    const formattedSelected = NumberConverter.toArabic(selectedCount.toString());
                    const formattedTotal = NumberConverter.toArabic(totalCount.toString());

                    let $typeControls = $('#typeControls');
                    if ($typeControls.length === 0) {
                        const $firstTypeContainer = $("input[name='SelectedTypeIds']").first().closest('.form-check').parent();
                        if ($firstTypeContainer.length > 0) {
                            $firstTypeContainer.before(`
                                <div class="row mb-3" id="typeControls">
                                    <div class="col-12">
                                        <div class="btn-group w-100" role="group">
                                            <button type="button" class="btn btn-outline-primary btn-sm" id="selectAllTypes">
                                                <i class="fas fa-check-double me-1"></i>تحديد الكل (<span class="type-counter">${formattedSelected}/${formattedTotal}</span>)
                                            </button>
                                            <button type="button" class="btn btn-outline-secondary btn-sm" id="deselectAllTypes">
                                                <i class="fas fa-times me-1"></i>إلغاء الكل
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            `);
                        }
                    } else {
                        $typeControls.find('.type-counter').text(`${formattedSelected}/${formattedTotal}`);
                    }

                    const $selectBtn = $('#selectAllTypes');
                    const $deselectBtn = $('#deselectAllTypes');

                    $selectBtn.prop('disabled', selectedCount === totalCount);
                    $deselectBtn.prop('disabled', selectedCount === 0);
                },

                updateValidation() {
                    const $validationSummary = $('#validationSummary');
                    if ($validationSummary.length === 0) return;

                    const errorCount = $validationSummary.find('li').length;
                    // Force Arabic display
                    const formattedCount = NumberConverter.toArabic(errorCount.toString());

                    $validationSummary.find('h6').html(
                        `<i class="fas fa-exclamation-triangle me-2"></i>تم العثور على ${formattedCount} أخطاء`
                    );
                }
            };

            // ========================================
            // VALIDATION
            // ========================================
            const Validation = {
                display(errors) {
                    this.clear();

                    if (!errors || Object.keys(errors).length === 0) return;

                    const errorCount = Object.keys(errors).reduce((count, key) => {
                        return count + (Array.isArray(errors[key]) ? errors[key].length : 1);
                    }, 0);

                    const formattedCount = NumberConverter.toArabic(errorCount.toString());

                    let errorHtml = '';
                    Object.keys(errors).forEach(key => {
                        if (Array.isArray(errors[key])) {
                            errors[key].forEach(error => {
                                // Convert any numbers inside error messages to Arabic
                                const arabicError = NumberConverter.toArabic(error);
                                errorHtml += `<li><i class="fas fa-exclamation-circle me-2"></i>${arabicError}</li>`;
                            });
                        } else {
                            const arabicError = NumberConverter.toArabic(errors[key]);
                            errorHtml += `<li><i class="fas fa-exclamation-circle me-2"></i>${arabicError}</li>`;
                        }
                    });

                    const validationSummary = `
                        <div class="alert alert-danger mb-4" id="validationSummary">
                            <h6 class="alert-heading">
                                <i class="fas fa-exclamation-triangle me-2"></i>تم العثور على ${formattedCount} أخطاء
                            </h6>
                            <ul class="mb-0">${errorHtml}</ul>
                        </div>
                    `;

                    $('#modalBody form').prepend(validationSummary);
                    $('#modalBody').animate({ scrollTop: 0 }, 300);
                },

                clear() {
                    $('#validationSummary').remove();
                    $('.is-invalid').removeClass('is-invalid');
                    $('.text-danger').text('');
                }
            };

            // ========================================
            // SEARCH FUNCTIONALITY
            // ========================================
            const Search = {
                getSearchValues(query) {
                    const trimmed = query.toLowerCase().trim();
                    return {
                        original: trimmed,
                        latin: NumberConverter.toLatin(trimmed),
                        arabic: NumberConverter.toArabic(trimmed)
                    };
                },

                matchesSearch(text, searchValues) {
                    if (!searchValues.original) return true;
                    // Check against all variants to ensure finding mixed content
                    const lowerText = text.toLowerCase();
                    return lowerText.includes(searchValues.original) ||
                           lowerText.includes(searchValues.latin) ||
                           lowerText.includes(searchValues.arabic);
                },

                perform() {
                    const searches = {
                        name: this.getSearchValues($('#searchByName').val()),
                        type: this.getSearchValues($('#searchByType').val()),
                        status: $('#searchByStatus').val(),
                        financial: this.getSearchValues($('#searchByFinancial').val()),
                        phone: this.getSearchValues($('#searchByPhone').val()),
                        comment: this.getSearchValues($('#searchByComment').val())
                    };

                    let visibleCount = 0;

                    $('.stakeholder-row').each(function() {
                        const $row = $(this);
                        const data = {
                            name: $row.find('.stakeholder-name').text().toLowerCase(),
                            type: $row.find('.stakeholder-type').text().toLowerCase(),
                            status: $row.find('.status-toggle').prop('checked') ? 'active' : 'inactive',
                            financial: $row.find('.stakeholder-financial').text().toLowerCase(),
                            phone: $row.find('.stakeholder-phone').text().toLowerCase(),
                            comment: $row.find('.stakeholder-comment').text().toLowerCase()
                        };

                        const matches = {
                            name: Search.matchesSearch(data.name, searches.name),
                            type: Search.matchesSearch(data.type, searches.type),
                            status: !searches.status || data.status === searches.status,
                            financial: Search.matchesSearch(data.financial, searches.financial),
                            // Updated phone matching to use the flexible match logic
                            phone: Search.matchesSearch(data.phone, searches.phone),
                            comment: Search.matchesSearch(data.comment, searches.comment)
                        };

                        const shouldShow = Object.values(matches).every(m => m);
                        $row.toggle(shouldShow);
                        if (shouldShow) visibleCount++;
                    });

                    this.updateUI(visibleCount, searches);
                },

                updateUI(visibleCount, searches) {
                    const arabicCount = NumberConverter.toArabic(visibleCount.toString());
                    $('#visibleCount, #badgeCount').text(arabicCount);

                    // Logic for showing clear buttons...
                    const fields = ['Name', 'Type', 'Financial', 'Phone', 'Comment'];
                    let hasAnySearch = false;

                    fields.forEach(field => {
                        const key = field.toLowerCase();
                        const val = searches[key];
                        const hasVal = val && val.original.length > 0;
                        if(hasVal) hasAnySearch = true;

                        $(`#clear${field}Search`).toggle(hasVal);
                        $(`#searchBy${field}`).toggleClass('border-primary', hasVal);
                    });

                    if(searches.status) hasAnySearch = true;
                    $('#searchByStatus').toggleClass('border-primary', !!searches.status);

                    $('#clearAllSearch').toggle(hasAnySearch);
                    $('#stakeholdersContainer .section-card').toggle(!(visibleCount === 0 && hasAnySearch));
                    $('#noResultsMessage').toggle(visibleCount === 0 && hasAnySearch);
                },

                clear(field) {
                    if (field === 'all') {
                        $('#searchByName, #searchByType, #searchByFinancial, #searchByPhone, #searchByComment')
                            .val('').removeClass('border-primary');
                        $('#searchByStatus').val('').removeClass('border-primary');
                    } else {
                        $(`#searchBy${field}`).val('').removeClass('border-primary').focus();
                    }
                    this.perform();
                },

                initialize() {
                    const selector = '#searchByName, #searchByType, #searchByFinancial, #searchByComment, #searchByPhone';

                    // Attach event to FORCE Arabic numbers on typing in search
                    $(selector).on('input', function() {
                        const $input = $(this);
                        const val = $input.val();

                        // Check for Latin digits
                        if (/[0-9]/.test(val)) {
                            const cursorStart = this.selectionStart;
                            const cursorEnd = this.selectionEnd;
                            const newVal = NumberConverter.toArabic(val);

                            $input.val(newVal);

                            try {
                                this.setSelectionRange(cursorStart, cursorEnd);
                            } catch(e) {}
                        }

                        clearTimeout(State.searchTimeout);
                        State.searchTimeout = setTimeout(() => Search.perform(), CONFIG.SEARCH_DELAY);
                    });

                    $('#searchByStatus').on('change', () => this.perform());

                    $('#clearNameSearch').click(() => this.clear('Name'));
                    $('#clearTypeSearch').click(() => this.clear('Type'));
                    $('#clearFinancialSearch').click(() => this.clear('Financial'));
                    $('#clearPhoneSearch').click(() => this.clear('Phone'));
                    $('#clearCommentSearch').click(() => this.clear('Comment'));
                    $('#clearAllSearch, #resetSearch').click(() => this.clear('all'));
                }
            };

            // ========================================
            // DATA MANAGEMENT
            // ========================================
            const DataManager = {
                load() {
                    Loading.show();
                    $.ajax({
                        url: '/StakeholdersInfo/GetAll',
                        method: 'GET',
                        success(response) {
                            Loading.hide();
                            if (response.success && response.data) {
                                State.stakeholdersData = response.data;
                                DataManager.render(State.stakeholdersData);
                                DataManager.updateCounts(State.stakeholdersData.length);

                                if (State.stakeholdersData.length === 0) {
                                    $('#emptyState').show();
                                    $('#stakeholdersContainer').hide();
                                } else {
                                    $('#emptyState').hide();
                                    $('#stakeholdersContainer').show();
                                }
                            } else {
                                Notification.show('حدث خطأ أثناء تحميل البيانات', 'error');
                            }
                        },
                        error(xhr, status, error) {
                            Loading.hide();
                            Notification.show('حدث خطأ أثناء تحميل بيانات الجهات', 'error');
                        }
                    });
                },

                render(data) {
                    const tbody = $('#stakeholdersTableBody');
                    tbody.empty();
                    if (!data || data.length === 0) return;
                    data.forEach(stakeholder => {
                        tbody.append(this.createRow(stakeholder));
                    });
                },

                createRow(stakeholder) {
                    const typesHtml = (stakeholder.types?.length > 0)
                        ? stakeholder.types.map(type =>
                            `<span class="badge ${type.isPrimary ? 'bg-primary' : 'bg-light text-dark border'} rounded-pill">
                                ${type.typeName}
                                ${type.isPrimary ? '<i class="fas fa-star ms-1 small" title="النوع الرئيسي"></i>' : ''}
                            </span>`
                          ).join(' ')
                        : '<span class="text-muted fst-italic">لا يوجد نوع</span>';

                    const statusHtml = `
                        <div class="form-check form-switch">
                            <input type="checkbox" class="form-check-input status-toggle"
                                   ${stakeholder.status ? 'checked' : ''}
                                   data-id="${stakeholder.id}"
                                   data-name="${stakeholder.name}">
                            <label class="form-check-label">${stakeholder.status ? 'نشط' : 'غير نشط'}</label>
                        </div>
                    `;

                    const primaryType = stakeholder.types?.find(t => t.isPrimary);
                    const financialType = primaryType?.financialTransactionType || '<span class="text-muted">-</span>';

                    // Process Phone Numbers to ARABIC
                    let phoneHtml = '<span class="text-muted">-</span>';
                    if (stakeholder.contactNumbers && stakeholder.contactNumbers.trim()) {
                        const phones = stakeholder.contactNumbers
                            .split(/[;,\n]/)
                            .map(p => p.trim())
                            .filter(p => p);

                        if (phones.length > 0) {
                            phoneHtml = phones.map(p => `
                                <div class="d-flex align-items-center gap-2 mb-1">
                                    <i class="fas fa-phone text-primary"></i>
                                    <span dir="ltr" class="small">${NumberConverter.toArabic(p)}</span>
                                </div>
                            `).join('');
                        }
                    }

                    const commentHtml = stakeholder.comment
                        ? `<span title="${stakeholder.comment}" class="comment-text">
                            ${stakeholder.comment.length > CONFIG.COMMENT_DISPLAY_LENGTH
                                ? stakeholder.comment.substring(0, CONFIG.COMMENT_DISPLAY_LENGTH - 3) + '...'
                                : stakeholder.comment}
                           </span>`
                        : '<span class="text-muted">-</span>';

                    return `
                        <tr data-id="${stakeholder.id}" class="stakeholder-row">
                            <td class="stakeholder-name">
                                <div class="d-flex align-items-center">
                                    <div class="stakeholder-icon me-2">
                                        <i class="fas fa-building text-success"></i>
                                    </div>
                                    <div><span class="fw-semibold">${stakeholder.name}</span></div>
                                </div>
                            </td>
                            <td class="stakeholder-type">
                                <div class="d-flex flex-wrap gap-1">${typesHtml}</div>
                            </td>
                            <td class="stakeholder-status">${statusHtml}</td>
                            <td class="stakeholder-financial">${financialType}</td>
                            <td class="stakeholder-phone">${phoneHtml}</td>
                            <td class="stakeholder-comment">${commentHtml}</td>
                            <td class="text-center">
                                <div class="btn-group" role="group">
                                    <button class="btn btn-sm btn-outline-info btnEdit"
                                            data-id="${stakeholder.id}"
                                            title="تعديل ${stakeholder.name}">
                                        <i class="fas fa-edit"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-secondary view-details"
                                            data-id="${stakeholder.id}"
                                            title="تفاصيل ${stakeholder.name}">
                                        <i class="fas fa-info-circle"></i>
                                    </button>
                                    <button class="btn btn-sm btn-outline-danger delete-stakeholder"
                                            data-id="${stakeholder.id}"
                                            data-name="${stakeholder.name}"
                                            title="حذف ${stakeholder.name}">
                                        <i class="fas fa-trash"></i>
                                    </button>
                                </div>
                            </td>
                        </tr>
                    `;
                },

                updateCounts(count) {
                    const arabicCount = NumberConverter.toArabic(count.toString());
                    $('#totalCount').text(arabicCount);
                    $('#visibleCount').text(arabicCount);
                    $('#badgeCount').text(arabicCount);
                },

                delete(id) {
                    const btn = $('#confirmDelete');
                    const originalText = btn.html();

                    btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>جاري الحذف...');

                    $.ajax({
                        url: `/StakeholdersInfo/${id}`,
                        method: 'DELETE',
                        success(response) {
                            btn.prop('disabled', false).html(originalText);
                            if (response.success) {
                                Notification.show(response.message, 'success');
                                Modals.delete.hide();
                                $(`tr[data-id="${id}"]`).fadeOut(300, function() {
                                    $(this).remove();
                                    State.stakeholdersData = State.stakeholdersData.filter(s => s.id != id);
                                    DataManager.updateCounts(State.stakeholdersData.length);
                                    if (State.stakeholdersData.length === 0) {
                                        $('#emptyState').show();
                                        $('#stakeholdersContainer').hide();
                                    }
                                });
                            } else {
                                Notification.show(response.message || 'حدث خطأ أثناء الحذف', 'error');
                            }
                        },
                        error(xhr) {
                            btn.prop('disabled', false).html(originalText);
                            Notification.show(xhr.responseJSON?.message || 'حدث خطأ أثناء حذف الجهة', 'error');
                        }
                    });
                },

                toggleStatus(id, newStatus) {
                    $.ajax({
                        url: `/api/StakeholdersInfo/${id}/status`,
                        method: 'PUT',
                        contentType: 'application/json',
                        data: JSON.stringify({ status: newStatus }),
                        success(response) {
                            if (response.success) {
                                $(`.status-toggle[data-id="${id}"]`)
                                    .prop('checked', newStatus)
                                    .closest('.form-switch').find('.form-check-label')
                                    .text(newStatus ? 'نشط' : 'غير نشط');
                                const stakeholder = State.stakeholdersData.find(s => s.id == id);
                                if (stakeholder) stakeholder.status = newStatus;
                                Notification.show(response.message, 'success');
                            } else {
                                $(`.status-toggle[data-id="${id}"]`).prop('checked', !newStatus);
                                Notification.show(response.message || 'حدث خطأ أثناء تحديث الحالة', 'error');
                            }
                        },
                        error(xhr) {
                            $(`.status-toggle[data-id="${id}"]`).prop('checked', !newStatus);
                            Notification.show(xhr.responseJSON?.message || 'حدث خطأ أثناء تحديث الحالة', 'error');
                        }
                    });
                }
            };

            // ========================================
            // MODAL: STAKEHOLDER FORM
            // ========================================
            const StakeholderModal = {
                load(action, id = null) {
                    const url = id ? `/StakeholdersInfo/${action}/${id}` : `/StakeholdersInfo/${action}`;
                    $.get(url)
                        .done(response => {
                            $('#modalBody').html(response);
                            if (!Modals.stakeholder) {
                                Modals.stakeholder = new bootstrap.Modal(document.getElementById('stakeholderModal'));
                            }
                            Modals.stakeholder.show();
                            $('#stakeholderModal').one('shown.bs.modal', function() {
                                StakeholderModal.initialize();
                                $('#Name').focus();
                            });
                        })
                        .fail(() => {
                            Notification.show('حدث خطأ أثناء تحميل النموذج', 'error');
                        });
                },

                initialize() {
                    $('#modalBody').off('.stakeholderModal');
                    $(document).off('.typeHandlers');

                    // Initialize the forced Arabic Input handler
                    InputNumberHandler.initialize();

                    Counters.updateAll();
                    this.setupFormSubmission();
                    this.setupTypeHandlers();
                },

                setupFormSubmission() {
                    $('#modalBody').on('submit.stakeholderModal', '#stakeholderForm', function(e) {
                        e.preventDefault();
                        const form = $(this);
                        const formData = new FormData(this);
                        const $submitBtn = form.find('button[type="submit"]');
                        const originalText = $submitBtn.html();

                        $submitBtn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>جارٍ الحفظ...');
                        Validation.clear();

                        $.ajax({
                            url: form.attr('action'),
                            type: 'POST',
                            data: formData,
                            processData: false,
                            contentType: false,
                            success(response) {
                                $submitBtn.prop('disabled', false).html(originalText);
                                if (response.success) {
                                    if (Modals.stakeholder) Modals.stakeholder.hide();
                                    Notification.show(response.message || 'تم الحفظ بنجاح', 'success');
                                    DataManager.load();
                                } else {
                                    if (response.errors) Validation.display(response.errors);
                                    else Notification.show(response.message || 'حدث خطأ أثناء الحفظ', 'error');
                                }
                            },
                            error(xhr) {
                                $submitBtn.prop('disabled', false).html(originalText);
                                if (xhr.responseJSON?.errors) Validation.display(xhr.responseJSON.errors);
                                else Notification.show(xhr.responseJSON?.message || 'حدث خطأ أثناء حفظ البيانات', 'error');
                            }
                        });
                    });
                },

                setupTypeHandlers() {
                    $(document).on('change.typeHandlers', "input[name='SelectedTypeIds']", function() {
                        Counters.updateType();
                        StakeholderModal.updatePrimaryTypeOptions();
                    });

                    $(document).on('click.typeHandlers', '#selectAllTypes', function(e) {
                        e.preventDefault();
                        const totalCount = $("input[name='SelectedTypeIds']").length;
                        const checkedCount = $("input[name='SelectedTypeIds']:checked").length;
                        if (checkedCount === totalCount) return;
                        if (confirm(`هل تريد تحديد جميع الأنواع (${NumberConverter.toArabic(totalCount)})؟`)) {
                            $("input[name='SelectedTypeIds']").prop('checked', true).trigger('change');
                        }
                    });

                    $(document).on('click.typeHandlers', '#deselectAllTypes', function(e) {
                        e.preventDefault();
                        const selectedCount = $("input[name='SelectedTypeIds']:checked").length;
                        if (selectedCount === 0) return;
                        if (confirm(`هل تريد إلغاء تحديد ${NumberConverter.toArabic(selectedCount)} نوع؟`)) {
                            $("input[name='SelectedTypeIds']").prop('checked', false).trigger('change');
                            $('#PrimaryTypeId').val('').trigger('change');
                        }
                    });
                },

                updatePrimaryTypeOptions() {
                    const selectedTypes = $("input[name='SelectedTypeIds']:checked").map(function() { return $(this).val(); }).get();
                    const $primarySelect = $('#PrimaryTypeId');
                    if ($primarySelect.length === 0) return;

                    $primarySelect.find('option').each(function() {
                        const value = $(this).val();
                        if (value && !selectedTypes.includes(value)) {
                            $(this).prop('disabled', true);
                            if ($(this).prop('selected')) {
                                $(this).prop('selected', false);
                                $primarySelect.val('');
                            }
                        } else {
                            $(this).prop('disabled', false);
                        }
                    });
                }
            };

            // ========================================
            // DETAILS MODAL
            // ========================================
            const DetailsModal = {
                load(id) {
                    Loading.show();
                    $.ajax({
                        url: `/api/StakeholdersInfo/${id}`,
                        method: 'GET',
                        success(response) {
                            Loading.hide();
                            if (response.success) {
                                DetailsModal.render(response.data);
                                State.currentDetailsId = id;
                                Modals.details.show();
                            } else {
                                Notification.show('حدث خطأ أثناء تحميل تفاصيل الجهة', 'error');
                            }
                        },
                        error(xhr) {
                            Loading.hide();
                            Notification.show('حدث خطأ أثناء تحميل تفاصيل الجهة', 'error');
                        }
                    });
                },

                render(stakeholder) {
                    const arabicTypesCount = NumberConverter.toArabic((stakeholder.types?.length || 0).toString());

                    const typesHtml = stakeholder.types && stakeholder.types.length > 0
                        ? stakeholder.types.map(type =>
                            `<div class="col-auto">
                                <span class="badge ${type.isPrimary ? 'bg-primary' : 'bg-light text-dark border'} fs-6 py-2 px-3">
                                    <i class="fas fa-tag me-1"></i>${type.typeName}
                                    ${type.isPrimary ? '<i class="fas fa-star ms-1" title="النوع الرئيسي"></i>' : ''}
                                </span>
                            </div>`
                          ).join('')
                        : '<div class="col-12"><span class="text-muted fst-italic">لا توجد أنواع</span></div>';

                    const primaryType = stakeholder.types?.find(t => t.isPrimary);
                    const financialTypeHtml = primaryType && primaryType.financialTransactionType
                        ? `<div class="alert alert-light border-start border-4 border-warning">
                             <h6 class="alert-heading mb-2"><i class="fas fa-coins text-warning me-2"></i>نوع المعاملة المالية</h6>
                             <p class="mb-0">${primaryType.financialTransactionType}</p>
                           </div>`
                        : '<div class="alert alert-light text-muted text-center">لا يوجد نوع معاملة مالية</div>';

                    let contactHtml = '<span class="text-muted fst-italic">لا يوجد أرقام تواصل</span>';
                    if (stakeholder.contactNumbers && stakeholder.contactNumbers.trim()) {
                        const numbers = stakeholder.contactNumbers.split(/[,;\n]/).map(num => num.trim()).filter(num => num);
                        if (numbers.length > 0) {
                            contactHtml = `<div>
                                <h6 class="fw-bold text-dark mb-3"><i class="fas fa-phone text-success me-2"></i>أرقام التواصل</h6>
                                ${numbers.map(num => `
                                    <div class="d-flex align-items-center mb-2">
                                        <i class="fas fa-phone-alt text-success me-2"></i>
                                        <span dir="ltr">${NumberConverter.toArabic(num)}</span>
                                    </div>
                                `).join('')}
                            </div>`;
                        }
                    }

                    // Render other sections similar to before...
                    const content = `
                        <div class="p-4">
                            <div class="d-flex align-items-center p-3 bg-light rounded mb-4">
                                <div class="icon-circle bg-info text-white me-3"><i class="fas fa-building"></i></div>
                                <div>
                                    <h4 class="mb-1 fw-bold text-dark">${stakeholder.name}</h4>
                                    <small class="text-muted">
                                        <i class="fas fa-toggle-${stakeholder.status ? 'on text-success' : 'off text-danger'} me-1"></i>
                                        الحالة: <strong>${stakeholder.status ? 'نشط' : 'غير نشط'}</strong>
                                    </small>
                                </div>
                            </div>
                            <div class="mb-4"><h6 class="fw-bold"><i class="fas fa-tags text-info me-2"></i>أنواع الجهة</h6><div class="row g-2">${typesHtml}</div></div>
                            <div class="mb-4">${financialTypeHtml}</div>
                            <div class="mb-4">${contactHtml}</div>
                            <div class="mb-4">
                                <h6 class="fw-bold"><i class="fas fa-comment text-primary me-2"></i>ملاحظات</h6>
                                <p>${stakeholder.comment || 'لا توجد ملاحظات'}</p>
                            </div>
                            <div class="row pt-3 border-top text-center">
                                <div class="col-12"><div class="text-primary fs-5 fw-bold">${arabicTypesCount}</div><small class="text-muted">أنواع مرتبطة</small></div>
                            </div>
                        </div>
                    `;
                    $('#detailsContent').html(content);
                }
            };

            // ========================================
            // EVENT HANDLERS
            // ========================================
            const EventHandlers = {
                initialize() {
                    $(document).off('.mainHandlers');

                    $('#btnAddStakeholder').off('click.main').on('click.main', () => StakeholderModal.load('Create'));

                    $(document).on('click.mainHandlers', '.btnEdit', function() {
                        StakeholderModal.load('Edit', $(this).data('id'));
                    });

                    $(document).on('click.mainHandlers', '.view-details', function() {
                        DetailsModal.load($(this).data('id'));
                    });

                    $('#editFromDetails').off('click.main').on('click.main', () => {
                        if (State.currentDetailsId) {
                            Modals.details.hide();
                            StakeholderModal.load('Edit', State.currentDetailsId);
                        }
                    });

                    $(document).on('click.mainHandlers', '.delete-stakeholder', function() {
                        $('#deleteStakeholderId').val($(this).data('id'));
                        $('#deleteStakeholderName').text($(this).data('name'));
                        Modals.delete.show();
                    });

                    $('#confirmDelete').off('click.main').on('click.main', () => DataManager.delete($('#deleteStakeholderId').val()));

                    $(document).on('change.mainHandlers', '.status-toggle', function() {
                        DataManager.toggleStatus($(this).data('id'), $(this).prop('checked'));
                    });

                    $('#refreshData').off('click.main').on('click.main', function() {
                        const $btn = $(this);
                        const originalText = $btn.html();
                        $btn.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>جاري التحديث...');
                        DataManager.load();
                        setTimeout(() => $btn.prop('disabled', false).html(originalText), 1000);
                    });

                    // Search shortcut
                    $(document).on('keydown.main', function(e) {
                        if (e.ctrlKey && e.keyCode === 70) { e.preventDefault(); $('#searchByName').focus(); }
                        if (e.keyCode === 27) Search.clear('all');
                    });
                }
            };

            // Initialize
            Search.initialize();
            EventHandlers.initialize();
            DataManager.load();
        });

        // FIXED PRINT TABLE FUNCTION
        function printTable() {
            try {
                const table = document.getElementById('stakeholdersTable');
                const existingPrint = document.getElementById('printSection');
                if (existingPrint) existingPrint.remove();

                const printSection = document.createElement('div');
                printSection.id = 'printSection';

                // Header
                printSection.innerHTML = `
                    <div class="print-header">
                        <h2>قائمة الجهات</h2>
                        <p>تاريخ الطباعة: ${new Date().toLocaleDateString('ar-EG')} - ${new Date().toLocaleTimeString('ar-EG')}</p>
                    </div>
                `;

                const printTable = document.createElement('table');
                printTable.className = 'print-table';

                // Clone Header (Simple)
                const thead = document.createElement('thead');
                const trHead = document.createElement('tr');
                table.querySelectorAll('thead tr:first-child th').forEach((th, idx) => {
                    // Skip action column
                    if (idx < 6 && th.style.display !== 'none') {
                        const newTh = document.createElement('th');
                        newTh.textContent = th.innerText.trim();
                        trHead.appendChild(newTh);
                    }
                });
                thead.appendChild(trHead);
                printTable.appendChild(thead);

                // Clone Body
                const tbody = document.createElement('tbody');
                table.querySelectorAll('tbody tr.stakeholder-row').forEach(row => {
                    if (row.style.display === 'none') return;

                    const tr = document.createElement('tr');
                    row.querySelectorAll('td').forEach((td, idx) => {
                        if (idx < 6) { // Skip action column
                            const newTd = document.createElement('td');

                            // Check for phone number (index 4 usually, or based on class)
                            if (td.classList.contains('stakeholder-phone')) {
                                // Extract text, ensuring it is Arabic
                                let phoneText = td.textContent.trim();
                                if (phoneText !== '-') {
                                     // Re-run conversion just in case
                                     phoneText = phoneText.replace(/[0-9]/g, d => '٠١٢٣٤٥٦٧٨٩'[d]);
                                }
                                newTd.textContent = phoneText;
                                newTd.style.direction = 'ltr'; // Ensure order stays correct
                            } else {
                                newTd.textContent = td.innerText.trim();
                            }
                            tr.appendChild(newTd);
                        }
                    });
                    tbody.appendChild(tr);
                });
                printTable.appendChild(tbody);
                printSection.appendChild(printTable);

                document.body.appendChild(printSection);
                window.print();

                setTimeout(() => { if(printSection) printSection.remove(); }, 100);

            } catch (error) {
                console.error('Print Error', error);
                alert('حدث خطأ أثناء الطباعة');
            }
        }
    </script>

    <style>
        /* Enhanced Styles for Stakeholders Management */
        .icon-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
        }

        .stakeholder-row {
            transition: all 0.2s ease;
        }

            .stakeholder-row:hover {
                background-color: rgba(25,135,84,0.05);
                transform: scale(1.002);
            }

        .search-row th {
            background-color: #ffffff;
            border-bottom: 1px solid #dee2e6;
            padding: 8px 12px;
        }

        .search-container .input-group {
            transition: all 0.2s ease;
        }

            .search-container .input-group:hover {
                transform: translateY(-1px);
            }

            .search-container .input-group.shadow-sm {
                box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075) !important;
            }

        .search-container .input-group-text {
            background-color: #f8f9fa;
            border-color: #ced4da;
            font-size: 0.875rem;
        }

        .search-container .form-control, .search-container .form-select {
            border-color: #ced4da;
            font-size: 0.875rem;
            padding: 6px 12px;
        }

            .search-container .form-control:focus, .search-container .form-select:focus {
                border-color: #86b7fe;
                box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
            }

            .search-container .form-control.border-primary, .search-container .form-select.border-primary {
                border-color: #0d6efd !important;
                box-shadow: 0 0 0 0.1rem rgba(13, 110, 253, 0.15);
            }

        .stakeholder-icon {
            width: 30px;
            text-align: center;
        }

        .btn-group .btn {
            margin: 0 1px;
        }

        .comment-text {
            cursor: help;
        }

        .form-switch .form-check-input {
            width: 2.5em;
        }

            .form-switch .form-check-input:checked {
                background-color: var(--bs-success);
                border-color: var(--bs-success);
            }

        .badge .fa-star {
            font-size: 0.75em;
        }

        .toast {
            min-width: 300px;
        }

        .modal-content {
            border-radius: 12px;
        }

        /* Enhanced details modal styling */
        .details-modal .icon-circle {
            width: 80px;
            height: 80px;
            font-size: 2rem;
        }

        .border-start {
            border-left: 4px solid !important;
        }

        .stakeholder-row {
            animation: fadeInUp 0.5s ease-out;
        }

        @@keyframes fadeInUp {
            from

        {
            opacity: 0;
            transform: translateY(20px);
        }

        to {
            opacity: 1;
            transform: translateY(0);
        }

        }

        .table thead th {
            position: relative;
            vertical-align: middle;
        }

        .table thead tr:first-child th {
            border-bottom: 2px solid #dee2e6;
        }

        /* Enhanced loading overlay */
        #loadingOverlay {
            backdrop-filter: blur(2px);
            -webkit-backdrop-filter: blur(2px);
        }

        /* Mobile responsiveness */
        @@media (max-width: 768px) {
            .icon-circle

        {
            width: 45px;
            height: 45px;
            font-size: 1.2rem;
        }

        .btn-group {
            flex-direction: column;
            width: 100%;
        }

            .btn-group .btn {
                margin: 1px 0;
                border-radius: 4px !important;
            }

        .search-row th {
            padding: 6px 8px;
        }

        .search-container .form-control, .search-container .form-select {
            font-size: 0.8rem;
            padding: 4px 8px;
        }

        .details-modal .icon-circle {
            width: 60px;
            height: 60px;
            font-size: 1.5rem;
        }

        .stakeholder-name, .stakeholder-comment {
            font-size: 0.9rem;
        }

        }

        /* Print styles */
        @@media print {
            .btn-group, .form-switch, .search-row

        {
            display: none !important;
        }

        .stakeholder-row {
            break-inside: avoid;
        }

        }
    </style>
}