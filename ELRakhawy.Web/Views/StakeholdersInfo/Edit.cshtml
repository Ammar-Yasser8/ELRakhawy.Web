@* @using ELRakhawy.EL.ViewModels
@model StakeholdersInfoViewModel
@{
    ViewData["Title"] = "تعديل الجهة";
    var currentTime = "2025-08-19 19:23:31";
    var currentUser = "Ammar-Yasser8";
}

<!-- Enhanced Navigation Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
    <div class="card border-0 shadow-sm">
        <div class="card-body py-2">
            <ol class="breadcrumb mb-0 align-items-center">
                <li class="breadcrumb-item">
                    <a href="@Url.Action("Index", "Home")" class="text-decoration-none d-flex align-items-center">
                        <i class="fas fa-home text-primary me-2"></i>
                        <span class="fw-semibold">الرئيسية</span>
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="@Url.Action("PublicTables", "Home")" class="text-decoration-none d-flex align-items-center">
                        <i class="fas fa-table text-info me-2"></i>
                        <span class="fw-semibold">الجداول العامة</span>
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="@Url.Action("Index", "StakeholdersInfo")" class="text-decoration-none d-flex align-items-center">
                        <i class="fas fa-users text-success me-2"></i>
                        <span class="fw-semibold">الجهات</span>
                    </a>
                </li>
                <li class="breadcrumb-item active d-flex align-items-center">
                    <i class="fas fa-edit text-warning me-2"></i>
                    <span class="fw-bold text-dark">تعديل: @Model.Name</span>
                </li>
            </ol>
        </div>
    </div>
</nav>

<!-- Enhanced Header Section -->
<div class="welcome-card mb-4">
    <div class="card border-0 shadow-sm">
        <div class="card-body bg-light p-4">
            <div class="row align-items-center">
                <div class="col-lg-8">
                    <div class="d-flex align-items-center">
                        <div class="icon-circle bg-warning text-white me-3">
                            <i class="fas fa-user-edit"></i>
                        </div>
                        <div>
                            <h2 class="mb-1 text-dark">تعديل بيانات الجهة</h2>
                            <p class="text-muted mb-0">
                                <i class="fas fa-info-circle me-1"></i>
                                تعديل بيانات <strong class="text-primary">@Model.Name</strong>
                            </p>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4 text-lg-end mt-3 mt-lg-0">
                    <div class="d-flex flex-column flex-lg-row gap-2 justify-content-lg-end">
                        <a asp-action="Index" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-right me-1"></i>العودة للقائمة
                        </a>
                        <button type="button" class="btn btn-info" id="viewDetailsBtn">
                            <i class="fas fa-eye me-1"></i>عرض التفاصيل
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</nav>

    <!-- Main Content -->
    <div class="row">
        <!-- Form Section -->
        <div class="col-lg-8 mb-4">
            <div class="section-card">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-light border-bottom">
                        <div class="d-flex justify-content-between align-items-center">
                            <h5 class="mb-0 fw-bold text-dark">
                                <i class="fas fa-edit me-2 text-primary"></i>تعديل بيانات الجهة
                            </h5>
                            <div class="badge bg-info">
                                <i class="fas fa-hashtag me-1"></i>معرف: @Model.Id
                            </div>
                        </div>
                    </div>
                    <div class="card-body p-4">
                        <form asp-action="Edit" method="post" id="editForm" novalidate>
                            <input type="hidden" asp-for="Id" />
                            <div asp-validation-summary="ModelOnly" class="alert alert-danger mb-4 d-none" id="validationSummary"></div>

                            <div class="row g-4">
                                <!-- Name Field -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="Name" class="form-label fw-semibold">
                                            <i class="fas fa-building text-primary me-1"></i>
                                            اسم الجهة <span class="text-danger">*</span>
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-building text-muted"></i>
                                            </span>
                                            <input asp-for="Name" class="form-control"
                                                   placeholder="أدخل اسم الجهة..."
                                                   maxlength="200"
                                                   data-original-name="@Model.Name" />
                                        </div>
                                        <span asp-validation-for="Name" class="text-danger small"></span>
                                        <div class="form-text">
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                يجب أن يكون اسم الجهة فريداً ووصفياً
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Contact Numbers Field -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label asp-for="ContactNumbers" class="form-label fw-semibold">
                                            <i class="fas fa-phone text-info me-1"></i>
                                            أرقام التواصل
                                        </label>
                                        <div class="input-group">
                                            <span class="input-group-text bg-light">
                                                <i class="fas fa-phone text-muted"></i>
                                            </span>
                                            <input asp-for="ContactNumbers" class="form-control"
                                                   placeholder="أدخل أرقام التواصل..."
                                                   dir="ltr"
                                                   data-original-contact="@Model.ContactNumbers" />
                                        </div>
                                        <span asp-validation-for="ContactNumbers" class="text-danger small"></span>
                                        <div class="form-text">
                                            <small class="text-muted">
                                                <i class="fas fa-lightbulb me-1"></i>
                                                يمكن إدخال أكثر من رقم مفصولة بفاصلة
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Status Switch -->
                                <div class="col-md-6">
                                    <div class="form-group">
                                        <label class="form-label fw-semibold">
                                            <i class="fas fa-toggle-on text-success me-1"></i>
                                            حالة الجهة
                                        </label>
                                        <div class="form-check form-switch form-switch-lg">
                                            <input asp-for="Status" class="form-check-input" type="checkbox"
                                                   data-original-status="@Model.Status" />
                                            <label asp-for="Status" class="form-check-label fw-semibold">
                                                <span id="statusLabel">@(Model.Status ? "نشط" : "غير نشط")</span>
                                            </label>
                                        </div>
                                        <div class="form-text">
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                الجهات النشطة فقط تظهر في العمليات
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Types Selection -->
                                <div class="col-12">
                                    <div class="form-group">
                                        <label class="form-label fw-semibold d-block mb-3">
                                            <i class="fas fa-tags text-warning me-1"></i>
                                            أنواع الجهة <span class="text-danger">*</span>
                                        </label>
                                        <div class="card border border-2">
                                            <div class="card-header bg-light py-3">
                                                <div class="d-flex justify-content-between align-items-center">
                                                    <span class="fw-semibold">
                                                        <i class="fas fa-list me-2"></i>حدد أنواع الجهة
                                                    </span>
                                                    <div class="btn-group" role="group">
                                                        <button type="button" class="btn btn-sm btn-outline-primary" id="selectAllTypes">
                                                            <i class="fas fa-check-double me-1"></i>تحديد الكل
                                                        </button>
                                                        <button type="button" class="btn btn-sm btn-outline-secondary" id="deselectAllTypes">
                                                            <i class="fas fa-times me-1"></i>إلغاء تحديد الكل
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="card-body">
                                                @if (Model?.AvailableTypes?.Any() == true)
                                                {
                                                    <div class="row g-3" id="typesContainer">
                                                        @foreach (var type in Model.AvailableTypes)
                                                        {
                                                            <div class="col-md-6">
                                                                <div class="type-check-container @(Model.SelectedTypeIds.Contains(type.Id) ? "selected" : "")">
                                                                    <div class="form-check type-check">
                                                                        <input type="checkbox" class="form-check-input"
                                                                               id="type_@type.Id"
                                                                               name="SelectedTypeIds"
                                                                               value="@type.Id"
                                                                               @(Model.SelectedTypeIds.Contains(type.Id) ? "checked" : "")
                                                                               data-financial-type="@type.FinancialTransactionType?.Type" />
                                                                        <label class="form-check-label" for="type_@type.Id">
                                                                            <div class="d-flex align-items-start">
                                                                                <div class="flex-grow-1">
                                                                                    <span class="fw-semibold">@type.Type</span>
                                                                                    @if (!string.IsNullOrEmpty(type.FinancialTransactionType?.Type))
                                                                                    {
                                                                                        <small class="text-muted d-block">
                                                                                            <i class="fas fa-coins me-1"></i>@type.FinancialTransactionType.Type
                                                                                        </small>
                                                                                    }
                                                                                </div>
                                                                                <i class="fas fa-check text-success ms-2 check-icon @(Model.SelectedTypeIds.Contains(type.Id) ? "" : "d-none")"></i>
                                                                            </div>
                                                                        </label>
                                                                    </div>
                                                                </div>
                                                            </div>
                                                        }
                                                    </div>
                                                }
                                                else
                                                {
                                                    <div class="text-center py-4">
                                                        <i class="fas fa-exclamation-circle fa-2x text-muted mb-2"></i>
                                                        <p class="text-muted mb-0">لا توجد أنواع متاحة</p>
                                                    </div>
                                                }
                                                <div id="typesValidationMsg" class="alert alert-danger mt-3 d-none">
                                                    <i class="fas fa-exclamation-triangle me-2"></i>
                                                    يجب اختيار نوع واحد على الأقل للجهة
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>

                                <!-- Primary Type Selection -->
                                <div class="col-12">
                                    <div class="form-group">
                                        <label asp-for="PrimaryTypeId" class="form-label fw-semibold">
                                            <i class="fas fa-star text-warning me-1"></i>
                                            النوع الرئيسي للجهة
                                        </label>
                                        <select asp-for="PrimaryTypeId" class="form-select form-select-lg" id="primaryTypeSelect"
                                                data-original-primary="@Model.PrimaryTypeId">
                                            <option value="">-- اختر النوع الرئيسي (اختياري) --</option>
                                            @if (Model?.AvailableTypes?.Any() == true)
                                            {
                                                @foreach (var type in Model.AvailableTypes)
                                                {
                                                    <option value="@type.Id"
                                                            data-financial-type="@type.FinancialTransactionType?.Type"
                                                            disabled="@(!Model.SelectedTypeIds.Contains(type.Id))">
                                                        @type.Type
                                                    </option>
                                                }
                                            }
                                        </select>
                                        <span asp-validation-for="PrimaryTypeId" class="text-danger small"></span>
                                        <div class="form-text">
                                            <small class="text-muted">
                                                <i class="fas fa-info-circle me-1"></i>
                                                النوع الرئيسي يجب أن يكون من ضمن الأنواع المحددة أعلاه
                                            </small>
                                        </div>
                                    </div>
                                </div>

                                <!-- Comment Field -->
                                <div class="col-12">
                                    <div class="form-group">
                                        <label asp-for="Comment" class="form-label fw-semibold">
                                            <i class="fas fa-comment-alt text-secondary me-1"></i>
                                            بيان وملاحظات
                                        </label>
                                        <textarea asp-for="Comment" class="form-control" rows="4"
                                                  placeholder="أدخل أي بيان أو ملاحظات إضافية عن الجهة (اختياري)..."
                                                  maxlength="1000"
                                                  data-original-comment="@Model.Comment"></textarea>
                                        <span asp-validation-for="Comment" class="text-danger small"></span>
                                        <div class="d-flex justify-content-between align-items-center mt-2">
                                            <div class="form-text">
                                                <small class="text-muted">
                                                    <i class="fas fa-lightbulb me-1"></i>
                                                    يمكن إضافة معلومات إضافية تساعد في التعرف على الجهة
                                                </small>
                                            </div>
                                            <small class="text-muted">
                                                <span id="commentCounter">@(Model.Comment?.Length ?? 0)</span> / 1000 حرف
                                            </small>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Action Buttons -->
                            <hr class="my-4">
                            <div class="d-flex justify-content-between">
                                <a asp-action="Index" class="btn btn-outline-secondary btn-lg">
                                    <i class="fas fa-arrow-right me-2"></i>العودة للقائمة
                                </a>
                                <div class="d-flex gap-3">
                                    <button type="button" class="btn btn-danger btn-lg" id="deleteBtn">
                                        <i class="fas fa-trash me-2"></i>حذف الجهة
                                    </button>
                                    <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                                        <i class="fas fa-save me-2"></i>حفظ التغييرات
                                    </button>
                                </div>
                            </div>
                        </form>
                        <script>
                            // دالة لتحويل الأرقام للغة العربية
                            function toArabicDigits(str) {
                                return str.replace(/[0-9]/g, d => '٠١٢٣٤٥٦٧٨٩'[d]);
                            }

                            // دالة لتحويل الأرقام للاتينية
                            function toLatinDigits(str) {
                                return str.replace(/[٠-٩]/g, d => '0123456789'['٠١٢٣٤٥٦٧٨٩'.indexOf(d)]);
                            }

                            // دالة لاكتشاف إذا كان الحرف عربي
                            function isArabicChar(c) {
                                return /[\u0600-\u06FF]/.test(c);
                            }

                            // دالة لاكتشاف إذا كان الحرف إنجليزي
                            function isEnglishChar(c) {
                                return /[a-zA-Z]/.test(c);
                            }

                            // دالة للعثور على آخر حرف (ليس رقم أو رمز)
                            function getLastLetter(str) {
                                for (let i = str.length - 1; i >= 0; i--) {
                                    let char = str[i];
                                    if (isArabicChar(char)) {
                                        return 'arabic';
                                    } else if (isEnglishChar(char)) {
                                        return 'english';
                                    }
                                }
                                return 'arabic'; // default is Arabic
                            }

                            // استثناء حقل أرقام التواصل من التحويل
                            function shouldSkipConversion(input) {
                                return input.name === 'ContactNumbers' || input.id === 'ContactNumbers';
                            }

                            // تطبيق التحويل على كل الحقول النصية
                            document.addEventListener("input", function (e) {
                                if (e.target.closest("#editForm")) {
                                    let input = e.target;
                                    let val = input.value;

                                    // تجاهل حقل أرقام التواصل
                                    if (shouldSkipConversion(input)) {
                                        // تحديث عداد الأحرف فقط للتعليقات
                                        if (input.name === 'Comment') {
                                            document.getElementById('commentCounter').textContent = val.length;
                                        }
                                        return;
                                    }

                                    if (val.length > 0) {
                                        let lastLetterLang = getLastLetter(val);

                                        let newVal;
                                        if (lastLetterLang === 'arabic') {
                                            // حول جميع الأرقام للعربية
                                            newVal = toArabicDigits(val);
                                        } else {
                                            // حول جميع الأرقام للاتينية
                                            newVal = toLatinDigits(val);
                                        }

                                        // تحديث القيمة فقط إذا تغيرت
                                        if (newVal !== val) {
                                            let cursorPos = input.selectionStart;
                                            input.value = newVal;
                                            // استعادة موضع المؤشر
                                            input.setSelectionRange(cursorPos, cursorPos);
                                        }
                                    }

                                    // تحديث عداد الأحرف للتعليقات
                                    if (input.name === 'Comment') {
                                        document.getElementById('commentCounter').textContent = val.length;
                                    }
                                }
                            });

                            // وظائف إضافية للفورم
                            document.addEventListener('DOMContentLoaded', function() {
                                // تحديث مؤشر الحالة
                                const statusCheckbox = document.querySelector('input[name="Status"]');
                                const statusLabel = document.getElementById('statusLabel');

                                if (statusCheckbox && statusLabel) {
                                    statusCheckbox.addEventListener('change', function() {
                                        statusLabel.textContent = this.checked ? 'نشط' : 'غير نشط';
                                    });
                                }

                                // وظائف تحديد/إلغاء تحديد الكل للأنواع
                                const selectAllBtn = document.getElementById('selectAllTypes');
                                const deselectAllBtn = document.getElementById('deselectAllTypes');
                                const typeCheckboxes = document.querySelectorAll('input[name="SelectedTypeIds"]');

                                if (selectAllBtn) {
                                    selectAllBtn.addEventListener('click', function() {
                                        typeCheckboxes.forEach(checkbox => {
                                            checkbox.checked = true;
                                            checkbox.dispatchEvent(new Event('change'));
                                        });
                                    });
                                }

                                if (deselectAllBtn) {
                                    deselectAllBtn.addEventListener('click', function() {
                                        typeCheckboxes.forEach(checkbox => {
                                            checkbox.checked = false;
                                            checkbox.dispatchEvent(new Event('change'));
                                        });
                                    });
                                }

                                // تحديث النوع الرئيسي بناءً على الأنواع المحددة
                                const primaryTypeSelect = document.getElementById('primaryTypeSelect');

                                typeCheckboxes.forEach(checkbox => {
                                    checkbox.addEventListener('change', function() {
                                        updatePrimaryTypeOptions();
                                        updateCheckIcons();
                                        updateTypeContainerState();
                                    });
                                });

                                function updatePrimaryTypeOptions() {
                                    if (!primaryTypeSelect) return;

                                    const selectedTypes = Array.from(typeCheckboxes)
                                        .filter(cb => cb.checked)
                                        .map(cb => cb.value);

                                    // تحديث خيارات النوع الرئيسي
                                    Array.from(primaryTypeSelect.options).forEach(option => {
                                        if (option.value === '') return; // تجاهل الخيار الافتراضي

                                        option.disabled = !selectedTypes.includes(option.value);
                                    });

                                    // إذا كان النوع الرئيسي المحدد غير موجود في الأنواع المحددة، امسحه
                                    if (primaryTypeSelect.value && !selectedTypes.includes(primaryTypeSelect.value)) {
                                        primaryTypeSelect.value = '';
                                    }
                                }

                                function updateCheckIcons() {
                                    typeCheckboxes.forEach(checkbox => {
                                        const checkIcon = checkbox.closest('.type-check-container')?.querySelector('.check-icon');
                                        if (checkIcon) {
                                            if (checkbox.checked) {
                                                checkIcon.classList.remove('d-none');
                                            } else {
                                                checkIcon.classList.add('d-none');
                                            }
                                        }
                                    });
                                }

                                function updateTypeContainerState() {
                                    typeCheckboxes.forEach(checkbox => {
                                        const container = checkbox.closest('.type-check-container');
                                        if (container) {
                                            if (checkbox.checked) {
                                                container.classList.add('selected');
                                            } else {
                                                container.classList.remove('selected');
                                            }
                                        }
                                    });
                                }

                                // دالة لتتبع التغييرات في الفورم
                                function trackFormChanges() {
                                    const form = document.getElementById('editForm');
                                    const submitBtn = document.getElementById('submitBtn');
                                    let hasChanges = false;

                                    // تتبع التغييرات في جميع الحقول
                                    const inputs = form.querySelectorAll('input, textarea, select');
                                    inputs.forEach(input => {
                                        let originalValue;

                                        if (input.type === 'checkbox') {
                                            originalValue = input.dataset.originalStatus === 'True';
                                        } else {
                                            originalValue = input.dataset.originalName ||
                                                          input.dataset.originalContact ||
                                                          input.dataset.originalComment ||
                                                          input.dataset.originalPrimary ||
                                                          input.value;
                                        }

                                        input.addEventListener('change', function() {
                                            checkForChanges();
                                        });

                                        input.addEventListener('input', function() {
                                            checkForChanges();
                                        });
                                    });

                                    // تتبع تغييرات الأنواع
                                    typeCheckboxes.forEach(checkbox => {
                                        checkbox.addEventListener('change', function() {
                                            checkForChanges();
                                        });
                                    });

                                    function checkForChanges() {
                                        // يمكن إضافة منطق تتبع التغييرات هنا
                                        hasChanges = true;
                                        if (submitBtn) {
                                            submitBtn.classList.add('btn-warning');
                                            submitBtn.innerHTML = '<i class="fas fa-exclamation-triangle me-2"></i>حفظ التغييرات';
                                        }
                                    }
                                }

                                // تهيئة الحالة الأولية
                                updatePrimaryTypeOptions();
                                updateCheckIcons();
                                updateTypeContainerState();
                                trackFormChanges();

                                // تأكيد الحذف
                                const deleteBtn = document.getElementById('deleteBtn');
                                if (deleteBtn) {
                                    deleteBtn.addEventListener('click', function() {
                                        if (confirm('هل أنت متأكد من حذف هذه الجهة؟ هذا الإجراء لا يمكن التراجع عنه.')) {
                                            // يمكن إضافة منطق الحذف هنا
                                            console.log('تم تأكيد الحذف');
                                        }
                                    });
                                }
                            });
                        </script>
                    </div>
                </div>
            </div>
        </div>

        <!-- Sidebar Section -->
        <div class="col-lg-4">
            <!-- Changes Log Card -->
            <div class="section-card mb-4">
                <div class="card border-0 shadow-sm">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0 fw-bold">
                            <i class="fas fa-history me-2"></i>سجل التغييرات
                        </h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="list-group list-group-flush" id="changesLog">
                            <div class="text-center p-4 text-muted">
                                <i class="fas fa-clock fa-2x mb-2"></i>
                                <p class="mb-0">لا توجد تغييرات بعد</p>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Enhanced Delete Confirmation Modal -->
    <div class="modal fade" id="deleteModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-danger text-white border-bottom-0">
                    <h5 class="modal-title fw-bold">
                        <i class="fas fa-exclamation-triangle me-2"></i>تأكيد حذف الجهة
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body p-4">
                    <div class="text-center">
                        <i class="fas fa-trash-alt fa-3x text-danger mb-3"></i>
                        <h6 class="mb-3">هل أنت متأكد من حذف هذه الجهة؟</h6>
                        <div class="alert alert-warning">
                            <strong class="text-dark">@Model.Name</strong>
                        </div>
                        <div class="alert alert-danger">
                            <i class="fas fa-exclamation-triangle me-2"></i>
                            <strong>تحذير:</strong> هذا الإجراء لا يمكن التراجع عنه!
                            <br>
                            سيتم حذف جميع البيانات المرتبطة بهذه الجهة.
                        </div>
                    </div>
                </div>
                <div class="modal-footer border-top">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-2"></i>إلغاء
                    </button>
                    <button type="button" class="btn btn-danger" id="confirmDelete">
                        <i class="fas fa-trash me-2"></i>تأكيد الحذف
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- View Details Modal -->
    <div class="modal fade" id="detailsModal" tabindex="-1" aria-hidden="true">
        <div class="modal-dialog modal-lg">
            <div class="modal-content border-0 shadow">
                <div class="modal-header bg-info text-white border-bottom-0">
                    <h5 class="modal-title fw-bold">
                        <i class="fas fa-info-circle me-2"></i>تفاصيل الجهة
                    </h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body" id="detailsContent">
                    <!-- Details will be loaded here -->
                </div>
                <div class="modal-footer bg-light border-top">
                    <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>إغلاق
                    </button>
                </div>
            </div>
        </div>
    </div>

@section Scripts {
    @{
        await Html.RenderPartialAsync("_ValidationScriptsPartial");
    }

        <script>
            $(document).ready(function() {
                const CURRENT_TIME = '@currentTime';
                const CURRENT_USER = '@currentUser';

                console.log('Enhanced stakeholders edit form loaded:', {
                    time: CURRENT_TIME,
                    user: CURRENT_USER,
                    stakeholderId: @Model.Id
                });

                let formChanged = false;
                const changesLog = [];
                const originalValues = {
                    name: $('#Name').data('original-name'),
                    contact: $('#ContactNumbers').data('original-contact'),
                    status: $('#Status').data('original-status'),
                    comment: $('#Comment').data('original-comment'),
                    primary: $('#primaryTypeSelect').data('original-primary'),
                    types: @Html.Raw(Json.Serialize(Model.SelectedTypeIds))
                };

                // Track form changes
                function logChange(field, oldValue, newValue) {
                    formChanged = true;
                    changesLog.unshift({
                        field: field,
                        oldValue: oldValue,
                        newValue: newValue,
                        timestamp: new Date()
                    });
                    updateChangesLog();
                }

                // Update changes log display
                function updateChangesLog() {
                    if (changesLog.length === 0) {
                        $('#changesLog').html(`
                            <div class="text-center p-4 text-muted">
                                <i class="fas fa-clock fa-2x mb-2"></i>
                                <p class="mb-0">لا توجد تغييرات بعد</p>
                            </div>
                        `);
                        return;
                    }

                    const logHtml = changesLog.map(change => `
                        <div class="list-group-item">
                            <div class="d-flex justify-content-between align-items-start">
                                <div class="flex-grow-1">
                                    <h6 class="mb-1 fw-semibold text-primary">${change.field}</h6>
                                    <div class="small text-muted">
                                        <div class="mb-1">
                                            <strong>من:</strong> <span class="text-danger">${change.oldValue || 'فارغ'}</span>
                                        </div>
                                        <div>
                                            <strong>إلى:</strong> <span class="text-success">${change.newValue || 'فارغ'}</span>
                                        </div>
                                    </div>
                                </div>
                                <small class="text-muted">
                                    ${new Date(change.timestamp).toLocaleTimeString('ar-SA')}
                                </small>
                            </div>
                        </div>
                    `).join('');

                    $('#changesLog').html(logHtml);
                }

                // Form validation and submission
                $('#editForm').on('submit', function(e) {
                    if (!validateForm()) {
                        e.preventDefault();
                        return false;
                    }

                    $("#submitBtn")
                        .prop('disabled', true)
                        .html('<span class="spinner-border spinner-border-sm me-2"></span>جارٍ الحفظ...');

                    return true;
                });

                // Enhanced form validation
                function validateForm() {
                    let isValid = true;
                    $("#validationSummary").addClass("d-none");

                    // Check if at least one type is selected
                    if (!$("input[name='SelectedTypeIds']:checked").length) {
                        $("#typesValidationMsg").removeClass("d-none");
                        $("#validationSummary").removeClass("d-none");
                        isValid = false;
                    } else {
                        $("#typesValidationMsg").addClass("d-none");
                    }

                    // Check name field
                    if (!$("#Name").val().trim()) {
                        $("#Name").addClass("is-invalid");
                        isValid = false;
                    } else {
                        $("#Name").removeClass("is-invalid");
                    }

                    return isValid;
                }

                // Handle type selection changes
                $("input[name='SelectedTypeIds']").on('change', function() {
                    const typeId = $(this).val();
                    const isChecked = $(this).prop('checked');
                    const typeName = $(this).closest('.form-check').find('.form-check-label .fw-semibold').text().trim();
                    const container = $(this).closest(".type-check-container");
                    const checkIcon = container.find(".check-icon");

                    // Visual feedback
                    if (isChecked) {
                        container.addClass("selected");
                        checkIcon.removeClass("d-none");
                    } else {
                        container.removeClass("selected");
                        checkIcon.addClass("d-none");
                    }

                    // Update primary type dropdown
                    $(`#primaryTypeSelect option[value='${typeId}']`).prop('disabled', !isChecked);

                    // Reset primary type if it's disabled
                    if (!isChecked && $('#primaryTypeSelect').val() == typeId) {
                        $('#primaryTypeSelect').val('');
                    }

                    // Log change
                    logChange('نوع الجهة',
                        isChecked ? 'غير محدد' : typeName,
                        isChecked ? typeName : 'غير محدد'
                    );

                    updateSummary();
                    validateForm();
                });

                // Select/Deselect all types
                $("#selectAllTypes").on("click", function() {
                    $("input[name='SelectedTypeIds']").prop("checked", true).trigger("change");
                });

                $("#deselectAllTypes").on("click", function() {
                    $("input[name='SelectedTypeIds']").prop("checked", false).trigger("change");
                    $("#primaryTypeSelect").val("");
                    updateSummary();
                });

                // Handle primary type change
                $('#primaryTypeSelect').on('change', function() {
                    const oldValue = $(this).data('last-value');
                    const newValue = $(this).val();
                    const newText = newValue ? $(`#primaryTypeSelect option[value='${newValue}']`).text() : 'غير محدد';
                    const oldText = oldValue ? $(`#primaryTypeSelect option[value='${oldValue}']`).text() : 'غير محدد';

                    if (oldValue !== newValue) {
                        logChange('النوع الرئيسي', oldText, newText);
                        $(this).data('last-value', newValue);
                        updateSummary();
                    }
                });

                // Handle other field changes
                $('#Name').on('change', function() {
                    const newValue = $(this).val();
                    if (originalValues.name !== newValue) {
                        logChange('اسم الجهة', originalValues.name, newValue);
                    }
                    $(this).removeClass('is-invalid');
                });

                $('#ContactNumbers').on('change', function() {
                    const newValue = $(this).val();
                    if (originalValues.contact !== newValue) {
                        logChange('أرقام التواصل', originalValues.contact || 'فارغ', newValue || 'فارغ');
                    }
                });

                $('#Status').on('change', function() {
                    const newStatus = $(this).prop('checked');
                    $("#statusLabel").text(newStatus ? "نشط" : "غير نشط");

                    if (originalValues.status !== newStatus) {
                        logChange('الحالة',
                            originalValues.status ? 'نشط' : 'غير نشط',
                            newStatus ? 'نشط' : 'غير نشط'
                        );
                    }
                    updateSummary();
                });

                $('#Comment').on('input', function() {
                    updateCharCount();
                });

                $('#Comment').on('change', function() {
                    const newValue = $(this).val();
                    if (originalValues.comment !== newValue) {
                        logChange('البيان', originalValues.comment || 'فارغ', newValue || 'فارغ');
                    }
                });

                // Enhanced character counter
                function updateCharCount() {
                    const maxLength = 1000;
                    const currentLength = $("#Comment").val().length;
                    $("#commentCounter").text(currentLength);

                    if (currentLength > maxLength * 0.8) {
                        $("#commentCounter").addClass("text-warning");
                    } else {
                        $("#commentCounter").removeClass("text-warning");
                    }

                    if (currentLength >= maxLength) {
                        $("#commentCounter").addClass("text-danger").removeClass("text-warning");
                    } else {
                        $("#commentCounter").removeClass("text-danger");
                    }
                }

                // Update summary panel
                function updateSummary() {
                    // Update status
                    const isActive = $("#Status").prop("checked");
                    $("#statusSummary")
                        .removeClass("bg-success bg-danger")
                        .addClass(isActive ? "bg-success" : "bg-danger")
                        .text(isActive ? "نشط" : "غير نشط");

                    // Update types count
                    const typesCount = $("input[name='SelectedTypeIds']:checked").length;
                    $("#typesSummary").text(typesCount);

                    // Update primary type
                    const primaryTypeText = $("#primaryTypeSelect option:selected").text();
                    $("#primaryTypeSummary").text(
                        $("#primaryTypeSelect").val() ? primaryTypeText : "غير محدد"
                    );
                }

                // View details functionality
                $('#viewDetailsBtn').click(function() {
                    loadStakeholderDetails(@Model.Id);
                });

                function loadStakeholderDetails(id) {
                    $.ajax({
                        url: `/api/StakeholdersInfo/${id}`,
                        method: 'GET',
                        success: function(response) {
                            if (response.success) {
                                renderDetailsModal(response.data);
                                $('#detailsModal').modal('show');
                            } else {
                                showNotification('حدث خطأ أثناء تحميل التفاصيل', 'error');
                            }
                        },
                        error: function() {
                            showNotification('حدث خطأ أثناء تحميل التفاصيل', 'error');
                        }
                    });
                }

                function renderDetailsModal(stakeholder) {
                    const typesHtml = stakeholder.types && stakeholder.types.length > 0
                        ? stakeholder.types.map(type =>
                            `<span class="badge ${type.isPrimary ? "bg-primary" : "bg-light text-dark border"} me-1 mb-1">
                                ${type.typeName}
                                ${type.isPrimary ? '<i class="fas fa-star ms-1"></i>' : ''}
                            </span>`
                          ).join('')
                        : '<span class="text-muted">لا توجد أنواع محددة</span>';

                    const detailsContent = `
                        <div class="row g-3">
                            <div class="col-12">
                                <h4 class="text-primary">${stakeholder.name}</h4>
                            </div>
                            <div class="col-md-6">
                                <strong>معرف الجهة:</strong> #${stakeholder.id}
                            </div>
                            <div class="col-md-6">
                                <strong>الحالة:</strong>
                                <span class="badge ${stakeholder.status ? 'bg-success' : 'bg-danger'}">
                                    ${stakeholder.status ? 'نشط' : 'غير نشط'}
                                </span>
                            </div>
                            <div class="col-12">
                                <strong>أنواع الجهة:</strong>
                                <div class="mt-2">${typesHtml}</div>
                            </div>
                            ${stakeholder.contactNumbers ? `
                            <div class="col-12">
                                <strong>أرقام التواصل:</strong>
                                <div class="mt-1" dir="ltr">${stakeholder.contactNumbers}</div>
                            </div>
                            ` : ''}
                            ${stakeholder.comment ? `
                            <div class="col-12">
                                <strong>البيان:</strong>
                                <div class="mt-1">${stakeholder.comment}</div>
                            </div>
                            ` : ''}
                        </div>
                    `;

                    $('#detailsContent').html(detailsContent);
                }

                // Delete functionality
                $('#deleteBtn').click(function() {
                    $('#deleteModal').modal('show');
                });

                $('#confirmDelete').click(function() {
                    const btn = $(this);
                    const originalText = btn.html();
                    btn.prop('disabled', true)
                       .html('<span class="spinner-border spinner-border-sm me-2"></span>جارٍ الحذف...');

                    $.ajax({
                        url: `/StakeholdersInfo/@Model.Id`,
                        method: 'DELETE',
                        success: function(response) {
                            if (response.success) {
                                showNotification(response.message, 'success');
                                setTimeout(() => {
                                    window.location.href = '@Url.Action("Index")';
                                }, 1500);
                            } else {
                                btn.prop('disabled', false).html(originalText);
                                showNotification(response.message || 'حدث خطأ أثناء الحذف', 'error');
                            }
                        },
                        error: function(xhr) {
                            btn.prop('disabled', false).html(originalText);
                            const errorMessage = xhr.responseJSON?.message || 'حدث خطأ أثناء حذف الجهة';
                            showNotification(errorMessage, 'error');
                        }
                    });
                });

                // Notification function
                function showNotification(message, type = 'success') {
                    // You can integrate with your toast notification system here
                    console.log(`${type.toUpperCase()}: ${message}`);
                }

                // Prevent accidental navigation
                $(window).on('beforeunload', function() {
                    if (formChanged) {
                        return 'لديك تغييرات غير محفوظة. هل أنت متأكد من المغادرة؟';
                    }
                });

                // Initialize
                updateCharCount();
                updateSummary();
                $('#primaryTypeSelect').data('last-value', $('#primaryTypeSelect').val());

                console.log('Stakeholders edit form initialized successfully at', CURRENT_TIME, 'by', CURRENT_USER);
            });
        </script>

        <style>
            /* Enhanced Styles for Edit Form */
            .icon-circle {
                width: 60px;
                height: 60px;
                border-radius: 50%;
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 1.5rem;
            }

            .type-check-container {
                transition: all 0.2s ease;
                border-radius: 8px;
                border: 2px solid transparent;
            }

                .type-check-container.selected {
                    border-color: var(--bs-primary);
                    background-color: rgba(13, 110, 253, 0.1);
                }

            .type-check {
                padding: 1rem;
                border-radius: 6px;
                transition: all 0.2s ease;
                cursor: pointer;
            }

                .type-check:hover {
                    background-color: rgba(0,0,0,0.02);
                }

            .type-check-container.selected .type-check {
                background-color: transparent;
            }

            .form-check-input:checked + .form-check-label {
                font-weight: 600;
                color: var(--bs-primary);
            }

            .check-icon {
                font-size: 1.2rem;
            }

            .form-switch-lg .form-check-input {
                width: 3em;
                height: 1.5em;
            }

            .summary-item {
                display: flex;
                justify-content: space-between;
                align-items: center;
                padding: 0.5rem 0;
                border-bottom: 1px solid #eee;
            }

                .summary-item:last-child {
                    border-bottom: none;
                }

            /* Enhanced changes log styling */
            #changesLog {
                max-height: 400px;
                overflow-y: auto;
            }

            .input-group-text {
                border-color: #ced4da;
            }

            .form-control:focus, .form-select:focus {
                border-color: #86b7fe;
                box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
            }

            .btn-group .btn {
                border-radius: 0.375rem !important;
                margin: 0 2px;
            }

            .card-header {
                border-bottom: 2px solid rgba(0,0,0,0.1);
            }

            /* Animation for selected types */
            .type-check-container {
                animation: fadeIn 0.3s ease-out;
            }

            @@keyframes fadeIn {
                from

            {
                opacity: 0;
                transform: translateY(10px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }

            }

            /* Mobile responsiveness */
            @@media (max-width: 768px) {
                .icon-circle

            {
                width: 45px;
                height: 45px;
                font-size: 1.2rem;
            }

            .type-check {
                padding: 0.75rem;
            }

            .btn-group {
                flex-direction: column;
                width: 100%;
            }

                .btn-group .btn {
                    margin: 2px 0;
                    width: 100%;
                }

            .d-flex.justify-content-between {
                flex-direction: column;
            }

                .d-flex.justify-content-between .btn,
                .d-flex.justify-content-between .d-flex {
                    width: 100%;
                    margin: 0.25rem 0;
                }

                .d-flex.justify-content-between .d-flex {
                    flex-direction: column;
                }

            }

            /* Print styles */
            @@media print {
                .btn, .btn-group, #changesLog

            {
                display: none !important;
            }

            }
        </style>
}
 *@