@using ELRakhawy.EL.ViewModels
@model FormStyleViewModel
@{
    ViewData["Title"] = "إضافة عملية تجارية جديدة";
    var currentTime = "2025-08-19 20:01:18";
    var currentUser = "Ammar-Yasser8";
}

<!-- Navigation Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
    <div class="card border-0 shadow-sm">
        <div class="card-body py-2">
            <ol class="breadcrumb mb-0 align-items-center">
                <li class="breadcrumb-item">
                    <a href="@Url.Action("Index", "Home")" class="text-decoration-none d-flex align-items-center">
                        <i class="fas fa-home text-primary me-2"></i>
                        <span class="fw-semibold">الرئيسية</span>
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="@Url.Action("PublicTables", "Home")" class="text-decoration-none d-flex align-items-center">
                        <i class="fas fa-table text-info me-2"></i>
                        <span class="fw-semibold">الجداول العامة</span>
                    </a>
                </li>
                <li class="breadcrumb-item">
                    <a href="@Url.Action("Index", "FormStyles")" class="text-decoration-none d-flex align-items-center">
                        <i class="fas fa-cogs text-success me-2"></i>
                        <span class="fw-semibold">العمليات التجارية</span>
                    </a>
                </li>
                <li class="breadcrumb-item active d-flex align-items-center">
                    <i class="fas fa-plus-circle text-warning me-2"></i>
                    <span class="fw-bold text-dark">إضافة عملية جديدة</span>
                </li>
            </ol>
        </div>
    </div>
</nav>

<div class="row">
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm">
            <div class="card-header bg-light">
                <h5 class="mb-0 fw-bold">
                    <i class="fas fa-plus-circle text-success me-2"></i>إضافة عملية تجارية جديدة
                </h5>
            </div>
            <div class="card-body p-4">
                <form asp-action="Create" method="post" id="createForm" novalidate>
                    <div asp-validation-summary="ModelOnly" class="alert alert-danger mb-4 d-none" id="validationSummary"></div>

                    <div class="row">
                        <div class="col-12">
                            <div class="form-group mb-4">
                                <label asp-for="FormName" class="form-label fw-semibold">
                                    <i class="fas fa-cogs text-primary me-1"></i>
                                    اسم العملية التجارية <span class="text-danger">*</span>
                                </label>
                                <div class="input-group">
                                    <span class="input-group-text bg-light">
                                        <i class="fas fa-edit text-muted"></i>
                                    </span>
                                    <input asp-for="FormName" class="form-control form-control-lg"
                                           placeholder="مثال: اضافة وارد غزل، اضافة صادر قماش..."
                                           autocomplete="off" />
                                </div>
                                <span asp-validation-for="FormName" class="text-danger small"></span>

                                <!-- Real-time validation feedback -->
                                <div id="formNameFeedback" class="mt-2"></div>

                                <!-- Suggestions dropdown -->
                                <div id="suggestionsDropdown" class="dropdown-menu w-100 shadow-lg" style="display: none;">
                                    <div class="dropdown-header">
                                        <i class="fas fa-lightbulb text-warning me-2"></i>اقتراحات العمليات التجارية
                                    </div>
                                    <div id="suggestionsList"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quick Template Generator -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="card bg-light">
                                <div class="card-header">
                                    <h6 class="mb-0">
                                        <i class="fas fa-magic text-info me-2"></i>منشئ النماذج السريع
                                    </h6>
                                </div>
                                <div class="card-body">
                                    <div class="row g-3">
                                        <div class="col-md-6">
                                            <label class="form-label">نوع المادة:</label>
                                            <select id="materialType" class="form-select">
                                                <option value="">اختر نوع المادة</option>
                                                <option value="غزل">غزل</option>
                                                <option value="قماش">قماش</option>
                                                <option value="خام">خام</option>
                                                <option value="منتجات">منتجات</option>
                                                <option value="اكسسوارات">اكسسوارات</option>
                                                <option value="اصباغ">اصباغ</option>
                                                <option value="كيماويات">كيماويات</option>
                                            </select>
                                        </div>
                                        <div class="col-md-6">
                                            <label class="form-label">نوع العملية:</label>
                                            <select id="operationType" class="form-select">
                                                <option value="">اختر نوع العملية</option>
                                                <option value="اضافة وارد">اضافة وارد</option>
                                                <option value="اضافة صادر">اضافة صادر</option>
                                                <option value="تعديل مخزون">تعديل مخزون</option>
                                                <option value="جرد">جرد</option>
                                                <option value="فحص جودة">فحص جودة</option>
                                                <option value="تحويل">تحويل</option>
                                                <option value="تخزين">تخزين</option>
                                                <option value="ارجاع">ارجاع</option>
                                            </select>
                                        </div>
                                        <div class="col-12">
                                            <button type="button" id="generateForm" class="btn btn-info">
                                                <i class="fas fa-magic me-2"></i>توليد اسم العملية
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex justify-content-end gap-3">
                        <a asp-action="Index" class="btn btn-outline-secondary btn-lg">
                            <i class="fas fa-arrow-right me-2"></i>العودة للقائمة
                        </a>
                        <button type="submit" class="btn btn-success btn-lg" id="submitBtn">
                            <i class="fas fa-save me-2"></i>حفظ العملية
                        </button>
                    </div>
                </form>
                <script>
                    // دالة لتحويل الأرقام للغة العربية
                    function toArabicDigits(str) {
                        return str.replace(/[0-9]/g, d => '٠١٢٣٤٥٦٧٨٩'[d]);
                    }

                    // دالة لتحويل الأرقام للاتينية
                    function toLatinDigits(str) {
                        return str.replace(/[٠-٩]/g, d => '0123456789'['٠١٢٣٤٥٦٧٨٩'.indexOf(d)]);
                    }

                    // دالة لاكتشاف إذا كان الحرف عربي
                    function isArabicChar(c) {
                        return /[\u0600-\u06FF]/.test(c);
                    }

                    // دالة لاكتشاف إذا كان الحرف إنجليزي
                    function isEnglishChar(c) {
                        return /[a-zA-Z]/.test(c);
                    }

                    // دالة للعثور على آخر حرف (ليس رقم أو رمز)
                    function getLastLetter(str) {
                        for (let i = str.length - 1; i >= 0; i--) {
                            let char = str[i];
                            if (isArabicChar(char)) {
                                return 'arabic';
                            } else if (isEnglishChar(char)) {
                                return 'english';
                            }
                        }
                        return 'arabic'; // default is Arabic
                    }

                    // تطبيق التحويل على كل الحقول النصية
                    document.addEventListener("input", function (e) {
                        if (e.target.closest("#createForm")) {
                            let input = e.target;
                            let val = input.value;

                            if (val.length > 0) {
                                let lastLetterLang = getLastLetter(val);

                                let newVal;
                                if (lastLetterLang === 'arabic') {
                                    // حول جميع الأرقام للعربية
                                    newVal = toArabicDigits(val);
                                } else {
                                    // حول جميع الأرقام للاتينية
                                    newVal = toLatinDigits(val);
                                }

                                // تحديث القيمة فقط إذا تغيرت
                                if (newVal !== val) {
                                    let cursorPos = input.selectionStart;
                                    input.value = newVal;
                                    // استعادة موضع المؤشر
                                    input.setSelectionRange(cursorPos, cursorPos);
                                }
                            }
                        }
                    });

                    // دالة منشئ النماذج السريع
                    document.getElementById('generateForm')?.addEventListener('click', function() {
                        let materialType = document.getElementById('materialType').value;
                        let operationType = document.getElementById('operationType').value;

                        if (materialType && operationType) {
                            let generatedName = operationType + ' ' + materialType;
                            let formNameInput = document.querySelector('input[name="FormName"]');
                            if (formNameInput) {
                                formNameInput.value = generatedName;
                                // تطبيق تحويل الأرقام على النص المولد
                                let event = new Event('input', { bubbles: true });
                                formNameInput.dispatchEvent(event);
                            }
                        } else {
                            alert('يرجى اختيار نوع المادة ونوع العملية أولاً');
                        }
                    });
                </script>
            </div>
        </div>
    </div>

    <div class="col-lg-4">
        <!-- Business Operation Categories -->
        <div class="card border-0 shadow-sm mb-4">
            <div class="card-header bg-info text-white">
                <h6 class="mb-0 fw-bold">
                    <i class="fas fa-list me-2"></i>فئات العمليات التجارية
                </h6>
            </div>
            <div class="card-body p-0">
                <div class="accordion" id="businessCategoriesAccordion">
                    <!-- Categories will be loaded here -->
                </div>
            </div>
        </div>

    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            const CURRENT_TIME = '@currentTime';
            const CURRENT_USER = '@currentUser';

            let suggestionsTimeout;
            let validationTimeout;

            // Load categorized business operation suggestions
            loadBusinessOperationCategories();

            // Form name input handler
            $('#FormName').on('input', function() {
                const value = $(this).val().trim();

                clearTimeout(suggestionsTimeout);
                clearTimeout(validationTimeout);

                if (value.length >= 2) {
                    suggestionsTimeout = setTimeout(() => {
                        getBusinessOperationSuggestions(value);
                    }, 300);

                    validationTimeout = setTimeout(() => {
                        validateFormName(value);
                    }, 500);
                } else {
                    hideSuggestions();
                    clearValidationFeedback();
                }
            });

            // Generate form name from template
            $('#generateForm').on('click', function() {
                const materialType = $('#materialType').val();
                const operationType = $('#operationType').val();

                if (materialType && operationType) {
                    const generatedName = `${operationType} ${materialType}`;
                    $('#FormName').val(generatedName);
                    validateFormName(generatedName);
                } else {
                    alert('يرجى اختيار نوع المادة ونوع العملية');
                }
            });

            // Get business operation suggestions from API
            function getBusinessOperationSuggestions(input) {
                $.ajax({
                    url: '/FormStyles/GetBusinessOperationSuggestions',
                    method: 'GET',
                    data: { input: input },
                    success: function(response) {
                        if (response.success && response.suggestions.length > 0) {
                            showSuggestions(response.suggestions);
                        } else {
                            hideSuggestions();
                        }
                    },
                    error: function() {
                        hideSuggestions();
                    }
                });
            }

            // Show suggestions dropdown
            function showSuggestions(suggestions) {
                const suggestionsList = $('#suggestionsList');
                suggestionsList.empty();

                suggestions.forEach(function(suggestion) {
                    const confidenceClass = suggestion.confidence >= 80 ? 'text-success' :
                                          suggestion.confidence >= 60 ? 'text-warning' : 'text-muted';
                    const typeIcon = suggestion.type === 'operation' ? 'fa-cogs' :
                                   suggestion.type === 'existing' ? 'fa-check' : 'fa-question';

                    const item = $(`
                        <button type="button" class="dropdown-item suggestion-item" data-value="${suggestion.name}">
                            <div class="d-flex justify-content-between align-items-center">
                                <div>
                                    <i class="fas ${typeIcon} me-2 ${confidenceClass}"></i>
                                    <span>${suggestion.name}</span>
                                    <small class="text-muted d-block ms-4">${suggestion.category}</small>
                                </div>
                                <small class="badge bg-light text-dark">${suggestion.confidence}%</small>
                            </div>
                        </button>
                    `);

                    item.on('click', function() {
                        $('#FormName').val(suggestion.name);
                        hideSuggestions();
                        validateFormName(suggestion.name);
                    });

                    suggestionsList.append(item);
                });

                $('#suggestionsDropdown').show();
            }

            // Load business operation categories
            function loadBusinessOperationCategories() {
                $.ajax({
                    url: '/FormStyles/GetCategorizedBusinessOperationSuggestions',
                    method: 'GET',
                    success: function(response) {
                        if (response.success) {
                            renderBusinessOperationCategories(response.categories);
                        }
                    }
                });
            }

            // Render business operation categories
            function renderBusinessOperationCategories(categories) {
                const accordion = $('#businessCategoriesAccordion');

                // Materials section
                addCategorySection(accordion, 'materials', 'المواد', 'fa-boxes', categories.materials, 0);

                // Operations section
                addCategorySection(accordion, 'operations', 'العمليات', 'fa-cogs', categories.operations, 1);

                // Business functions section
                addCategorySection(accordion, 'business', 'الوظائف التجارية', 'fa-briefcase', categories.business, 2);
            }

            function addCategorySection(accordion, sectionKey, sectionName, sectionIcon, sectionData, index) {
                const isFirst = index === 0;
                const collapseId = `collapse${sectionKey}`;

                const section = $(`
                    <div class="accordion-item border-0">
                        <h2 class="accordion-header">
                            <button class="accordion-button ${isFirst ? '' : 'collapsed'}" type="button"
                                    data-bs-toggle="collapse" data-bs-target="#${collapseId}">
                                <i class="fas ${sectionIcon} me-2 text-primary"></i>
                                ${sectionName}
                            </button>
                        </h2>
                        <div id="${collapseId}" class="accordion-collapse collapse ${isFirst ? 'show' : ''}"
                             data-bs-parent="#businessCategoriesAccordion">
                            <div class="accordion-body p-2">
                                <div class="section-items"></div>
                            </div>
                        </div>
                    </div>
                `);

                const itemsContainer = section.find('.section-items');

                Object.keys(sectionData).forEach(function(categoryKey) {
                    const categoryItems = sectionData[categoryKey];
                    if (categoryItems.length > 0) {
                        const categoryName = getCategoryDisplayName(categoryKey);
                        const categoryDiv = $(`
                            <div class="mb-3">
                                <h6 class="small fw-bold text-secondary mb-2">${categoryName} (${categoryItems.length})</h6>
                                <div class="category-items"></div>
                            </div>
                        `);

                        const categoryItemsContainer = categoryDiv.find('.category-items');
                        categoryItems.slice(0, 5).forEach(function(item) { // Show only first 5 items
                            const itemButton = $(`
                                <button type="button" class="btn btn-sm btn-outline-secondary mb-1 me-1 category-item"
                                        data-value="${item}" title="${item}">
                                    ${item.length > 20 ? item.substring(0, 17) + '...' : item}
                                </button>
                            `);

                            itemButton.on('click', function() {
                                $('#FormName').val(item);
                                validateFormName(item);
                            });

                            categoryItemsContainer.append(itemButton);
                        });

                        if (categoryItems.length > 5) {
                            const moreButton = $(`
                                <button type="button" class="btn btn-sm btn-link text-muted p-0">
                                    +${categoryItems.length - 5} المزيد...
                                </button>
                            `);
                            categoryItemsContainer.append(moreButton);
                        }

                        itemsContainer.append(categoryDiv);
                    }
                });

                accordion.append(section);
            }

            function getCategoryDisplayName(categoryKey) {
                const names = {
                    yarn: 'الغزل',
                    fabric: 'الأقمشة',
                    rawMaterials: ' الخام',
                    accessories: 'الإكسسوارات',
                    dyes: 'الأصباغ والكيماويات',
                    inbound: 'الواردات',
                    outbound: 'الصادرات',
                    inventory: 'المخزون',
                    quality: 'الجودة',
                    production: 'الإنتاج',
                    financial: 'المالية',
                    warehouse: 'المخازن',
                    administrative: 'الإدارية',
                    maintenance: 'الصيانة'
                };
                return names[categoryKey] || categoryKey;
            }

            // Other functions remain the same (hideSuggestions, validateFormName, etc.)
            function hideSuggestions() {
                $('#suggestionsDropdown').hide();
            }

            function validateFormName(formName) {
                // Implementation similar to previous version
                console.log('Validating:', formName);
            }

            function clearValidationFeedback() {
                $('#formNameFeedback').empty();
            }

            console.log('Enhanced business operations form create page initialized at', CURRENT_TIME, 'by', CURRENT_USER);
        });
    </script>

    <style>
        .suggestion-item:hover {
            background-color: #f8f9fa;
        }

        #suggestionsDropdown {
            position: absolute;
            top: 100%;
            left: 0;
            right: 0;
            z-index: 1000;
            max-height: 400px;
            overflow-y: auto;
        }

        .category-item {
            font-size: 0.75rem;
            padding: 0.2rem 0.4rem;
        }

            .category-item:hover {
                background-color: #007bff;
                color: white;
                border-color: #007bff;
            }

        .form-group {
            position: relative;
        }

        .accordion-button {
            font-size: 0.85rem;
            padding: 0.5rem;
        }

        .accordion-body {
            background-color: #f8f9fa;
        }
    </style>
}