@using ELRakhawy.EL.ViewModels
@model YarnOverviewViewModel

@{
    ViewData["Title"] = "نظرة عامة على أرصدة الغزل";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var currentTime = "2025-09-04 18:39:33";
    var currentUser = "Ammar-Yasser8";
}

<!-- Navigation Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
    <div class="card border-0 shadow-sm">
        <div class="card-body py-2">
            <ol class="breadcrumb mb-0 align-items-center">
                <li class="breadcrumb-item">
                    <a href="@Url.Action("Dashboard", "YarnItems")" class="text-decoration-none d-flex align-items-center">
                        <i class="fas fa-home me-2"></i>
                        <span class="fw-semibold">الرئيسية</span>
                    </a>
                </li>
                <li class="breadcrumb-item active d-flex align-items-center">
                    <i class="fas fa-box me-2"></i>
                    <span class="fw-bold">@ViewData["Title"]</span>
                </li>
            </ol>
        </div>
    </div>
</nav>

<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    نظرة عامة على أرصدة الغزل
                </h2>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-secondary" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-1"></i>
                        تحديث
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-primary dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-download me-1"></i>
                            تصدير
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <button class="dropdown-item" onclick="exportToExcel()">
                                    <i class="fas fa-file-excel me-2"></i>
                                    تصدير إلى Excel
                                </button>
                            </li>
                            <li>
                                <button class="dropdown-item" onclick="shareWhatsApp()">
                                    <i class="fab fa-whatsapp me-2"></i>
                                    مشاركة عبر واتساب
                                </button>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <button class="dropdown-item" onclick="printOverview()">
                                    <i class="fas fa-print me-2"></i>
                                    طباعة
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row mb-4">
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title text-muted mb-2">إجمالي الأصناف</h6>
                            <h3 class="mb-0" id="totalItemsDisplay">@Model.OverviewItems.Count</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-boxes fa-2x text-muted opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title text-muted mb-2">الأصناف المتاحة</h6>
                            <h3 class="mb-0" id="availableItemsDisplay">@Model.OverviewItems.Count(x => x.IsAvailable)</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-check-circle fa-2x text-muted opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title text-muted mb-2">إجمالي الكمية (كجم)</h6>
                            <h3 class="mb-0" id="totalQuantityDisplay">@Model.OverviewItems.Sum(x => x.QuantityBalance).ToString("N2")</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-weight fa-2x text-muted opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6 mb-3">
            <div class="card border shadow-sm h-100">
                <div class="card-body">
                    <div class="d-flex justify-content-between">
                        <div>
                            <h6 class="card-title text-muted mb-2">إجمالي العدد</h6>
                            <h3 class="mb-0" id="totalCountDisplay">@Model.OverviewItems.Sum(x => x.CountBalance)</h3>
                        </div>
                        <div class="align-self-center">
                            <i class="fas fa-cubes fa-2x text-muted opacity-50"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters and Controls -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="d-flex align-items-center gap-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="availableOnlyFilter"
                                       @(Model.AvailableOnly ? "checked" : "") onchange="toggleAvailableFilter()">
                                <label class="form-check-label" for="availableOnlyFilter">
                                    <i class="fas fa-filter me-1"></i>
                                    المتاح فقط
                                </label>
                            </div>
                        </div>

                        <div class="d-flex align-items-center gap-2">
                            <small class="text-muted">
                                آخر تحديث: <span id="lastUpdatedDisplay">@Model.LastUpdated.ToString("dd/MM/yyyy HH:mm")</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overview Table -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="overviewTable">
                            <thead class="table-light sticky-top">
                                <tr>
                                    <th data-sort="yarnItemName">
                                        <div class="d-flex flex-column">
                                            <div class="d-flex align-items-center mb-1">
                                                <span>صنف الغزل</span>
                                                <i class="fas fa-sort ms-1"></i>
                                            </div>
                                            <input type="text" class="form-control form-control-sm table-search" 
                                                   placeholder="بحث..." data-column="yarnItemName">
                                        </div>
                                    </th>
                                    <th data-sort="originYarnName">
                                        <div class="d-flex flex-column">
                                            <div class="d-flex align-items-center mb-1">
                                                <span>الغزل الأصلي</span>
                                                <i class="fas fa-sort ms-1"></i>
                                            </div>
                                            <input type="text" class="form-control form-control-sm table-search" 
                                                   placeholder="بحث..." data-column="originYarnName">
                                        </div>
                                    </th>
                                    <th data-sort="manufacturerNames">
                                        <div class="d-flex flex-column">
                                            <div class="d-flex align-items-center mb-1">
                                                <span>الشركة المصنعة</span>
                                                <i class="fas fa-sort ms-1"></i>
                                            </div>
                                            <input type="text" class="form-control form-control-sm table-search" 
                                                   placeholder="بحث..." data-column="manufacturerNames">
                                        </div>
                                    </th>
                                    <th data-sort="quantityBalance">
                                        <div class="d-flex flex-column">
                                            <div class="d-flex align-items-center mb-1">
                                                <span>الكمية (كجم)</span>
                                                <i class="fas fa-sort ms-1"></i>
                                            </div>
                                            <input type="text" class="form-control form-control-sm table-search" 
                                                   placeholder="بحث..." data-column="quantityBalance">
                                        </div>
                                    </th>
                                    <th data-sort="countBalance">
                                        <div class="d-flex flex-column">
                                            <div class="d-flex align-items-center mb-1">
                                                <span>رصيد العدد والتعبئة</span>
                                                <i class="fas fa-sort ms-1"></i>
                                            </div>
                                            <input type="text" class="form-control form-control-sm table-search" 
                                                   placeholder="بحث..." data-column="countBalance">
                                        </div>
                                    </th>
                                    <th data-sort="status">
                                        <div class="d-flex flex-column">
                                            <div class="d-flex align-items-center mb-1">
                                                <span>الحالة</span>
                                                <i class="fas fa-sort ms-1"></i>
                                            </div>
                                            <input type="text" class="form-control form-control-sm table-search" 
                                                   placeholder="بحث..." data-column="status">
                                        </div>
                                    </th>
                                    <th data-sort="totalTransactions">
                                        <div class="d-flex flex-column">
                                            <div class="d-flex align-items-center mb-1">
                                                <span>إجمالي المعاملات</span>
                                                <i class="fas fa-sort ms-1"></i>
                                            </div>
                                            <input type="text" class="form-control form-control-sm table-search" 
                                                   placeholder="بحث..." data-column="totalTransactions">
                                        </div>
                                    </th>
                                    <th data-sort="lastTransactionDate">
                                        <div class="d-flex flex-column">
                                            <div class="d-flex align-items-center mb-1">
                                                <span>آخر معاملة</span>
                                                <i class="fas fa-sort ms-1"></i>
                                            </div>
                                            <input type="text" class="form-control form-control-sm table-search" 
                                                   placeholder="بحث..." data-column="lastTransactionDate">
                                        </div>
                                    </th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.OverviewItems)
                                {
                                    <tr class="yarn-item-row" data-yarn-id="@item.YarnItemId"
                                        data-yarn-item-name="@item.YarnItemName"
                                        data-origin-yarn-name="@item.OriginYarnName"
                                        data-manufacturer-names="@item.ManufacturerNames"
                                        data-quantity-balance="@item.QuantityBalance"
                                        data-count-balance="@item.CountBalance"
                                        data-status="@(item.IsAvailable ? "متاح" : "غير متاح")"
                                        data-total-transactions="@item.TotalTransactions"
                                        data-last-transaction-date="@(item.LastTransactionDate?.ToString("yyyy-MM-dd") ?? "")"
                                        data-available="@item.IsAvailable.ToString().ToLower()">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="me-2">
                                                    @if (item.IsAvailable)
                                                    {
                                                        <div class="bg-success rounded-circle" style="width: 10px; height: 10px;" title="متاح"></div>
                                                    }
                                                    else
                                                    {
                                                        <div class="bg-secondary rounded-circle" style="width: 10px; height: 10px;" title="غير متاح"></div>
                                                    }
                                                </div>
                                                <div>
                                                    <strong class="yarn-item-name">@item.YarnItemName</strong>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="origin-yarn-name">@(item.OriginYarnName ?? "غير محدد")</div>
                                        </td>
                                        <td>
                                            <small class="text-muted manufacturer-names">@(item.ManufacturerNames ?? "غير محدد")</small>
                                        </td>
                                        <td>
                                            <div class="fw-bold quantity-balance">
                                                @item.QuantityBalance.ToString("N2")
                                            </div>
                                        </td>
                                        <td>
                                            <div class="count-balance-cell" data-yarn-id="@item.YarnItemId">
                                                <div class="d-flex align-items-center justify-content-center">
                                                    <div class="spinner-border spinner-border-sm me-2" role="status">
                                                        <span class="visually-hidden">جاري التحميل...</span>
                                                    </div>
                                                    <small class="text-muted">جاري التحميل...</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge @(item.IsAvailable ? "bg-success" : "bg-secondary") status-badge">
                                                @if (item.IsAvailable)
                                                {
                                                    <i class="fas fa-check-circle me-1"></i>
                                                    @:متاح
                                                }
                                                else
                                                {
                                                    <i class="fas fa-times-circle me-1"></i>
                                                    @:غير متاح
                                                }
                                            </span>
                                        </td>
                                        <td>
                                            <div class="text-center">
                                                <span class="fw-bold d-block total-transactions">@item.TotalTransactions</span>
                                                @if (item.TotalTransactions > 0)
                                                {
                                                    <div class="d-flex justify-content-center gap-2 mt-1">
                                                        <small class="text-success">
                                                            <i class="fas fa-arrow-down me-1"></i>
                                                            <span class="inbound-transactions">@item.InboundTransactions</span>
                                                        </small>
                                                        <small class="text-danger">
                                                            <i class="fas fa-arrow-up me-1"></i>
                                                            <span class="outbound-transactions">@item.OutboundTransactions</span>
                                                        </small>
                                                    </div>
                                                }
                                            </div>
                                        </td>
                                        <td>
                                            @if (item.LastTransactionDate.HasValue)
                                            {
                                                <div class="text-center">
                                                    <span class="fw-bold last-transaction-date">@item.LastTransactionText</span>
                                                    @if (item.DaysSinceLastTransaction >= 0)
                                                    {
                                                        <small class="d-block text-muted">
                                                            منذ <span class="days-since">@item.DaysSinceLastTransaction</span> يوم
                                                        </small>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <span class="text-muted">لا توجد معاملات</span>
                                            }
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button type="button" class="btn btn-outline-secondary" title="عرض التفاصيل"
                                                        onclick="viewItemDetails(@item.YarnItemId, '@item.YarnItemName')">
                                                    <i class="fas fa-info-circle"></i>
                                                </button>
                                                <a href="@Url.Action("Search", "YarnTransactions", new { YarnItemId = item.YarnItemId })"
                                                   class="btn btn-outline-primary" title="البحث في المعاملات">
                                                    <i class="fas fa-search"></i>
                                                </a>
                                                @if (item.IsAvailable)
                                                {
                                                    <a href="@Url.Action("Outbound", "YarnTransactions", new { YarnItemId = item.YarnItemId })"
                                                       class="btn btn-outline-dark" title="إنشاء معاملة صادر">
                                                        <i class="fas fa-arrow-up"></i>
                                                    </a>
                                                }
                                                <a href="@Url.Action("Inbound", "YarnTransactions", new { YarnItemId = item.YarnItemId })"
                                                   class="btn btn-outline-success" title="إنشاء معاملة وارد">
                                                    <i class="fas fa-arrow-down"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (!Model.OverviewItems.Any())
    {
        <div class="row mt-4">
            <div class="col-12">
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle fa-2x mb-3"></i>
                    <h5>لا توجد أصناف غزل</h5>
                    <p>لم يتم العثور على أي أصناف غزل نشطة في النظام.</p>
                    <a href="@Url.Action("Create", "YarnItems")" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>
                        إضافة صنف جديد
                    </a>
                </div>
            </div>
        </div>
    }
</div>

<!-- Item Details Modal -->
<div class="modal fade" id="itemDetailsModal" tabindex="-1" aria-labelledby="itemDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="itemDetailsModalLabel">
                    <i class="fas fa-info-circle me-2"></i>
                    تفاصيل صنف الغزل
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="text-center py-4">
                    <div class="spinner-border" role="status">
                        <span class="visually-hidden">جاري التحميل...</span>
                    </div>
                </div>
            </div>
            <div class="modal-footer">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="exportTransactionsToExcel()" title="تصدير المعاملات إلى Excel">
                            <i class="fas fa-file-excel me-1"></i>
                            تصدير Excel
                        </button>
                        <button type="button" class="btn btn-outline-secondary btn-sm" onclick="printTransactions()" title="طباعة المعاملات">
                            <i class="fas fa-print me-1"></i>
                            طباعة
                        </button>
                    </div>
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>
                            إغلاق
                        </button>
                        <button type="button" class="btn btn-primary" id="seeMoreBtn" onclick="seeMoreTransactions()">
                            <i class="fas fa-eye me-1"></i>
                            عرض المزيد
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="spinner-border" role="status">
        <span class="visually-hidden">جاري التحميل...</span>
    </div>
</div>

@section Scripts {
   <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="~/js/overview.js"></script>
   
}
<link href="~/css/Overview.css" rel="stylesheet" />
<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">