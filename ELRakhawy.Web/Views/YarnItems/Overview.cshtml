@using ELRakhawy.EL.ViewModels
@using System.Text.Json
@model IEnumerable<YarnItemViewModel>

@{
    ViewData["Title"] = "لوحة تحكم مخزون الخيوط";
    var currentTime = "2025-09-01 00:58:06";
    var currentUser = "Ammar-Yasser8";

    // Calculate statistics
    var totalItems = Model.Count();
    var activeItems = Model.Count(x => x.Status);
    var totalBalance = Model.Sum(x => x.CurrentBalance);
    var lowStockItems = Model.Count(x => x.CurrentBalance <= 10 && x.CurrentBalance > 0);
    var zeroStockItems = Model.Count(x => x.CurrentBalance <= 0);
    var availableItems = Model.Count(x => x.Status && x.CurrentBalance > 0);

    // Prepare manufacturers data for charts
    var manufacturers = Model
        .SelectMany(x => x.ManufacturerNames ?? Enumerable.Empty<string>())
        .GroupBy(x => x)
        .Select(g => new
        {
            Name = g.Key,
            Count = g.Count(),
            Balance = Model
                .Where(x => x.ManufacturerNames != null && x.ManufacturerNames.Contains(g.Key))
                .Sum(x => x.CurrentBalance)
        })
        .OrderByDescending(x => x.Balance)
        .Take(5)
        .ToList();
}

<div class="dashboard-container">
    <!-- Header Section -->
    <div class="dashboard-header bg-gradient-primary text-white rounded-4 p-4 mb-4">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1 class="h3 mb-2">
                    <i class="fas fa-chart-line me-2"></i>لوحة تحكم مخزون الخيوط
                </h1>
                <p class="mb-0 opacity-75">آخر تحديث: @currentTime</p>
            </div>
            <div class="col-md-6 text-md-end mt-3 mt-md-0">
                <div class="btn-group">
                    <a href="@Url.Action("Create")" class="btn btn-light">
                        <i class="fas fa-plus-circle me-2"></i>إضافة صنف جديد
                    </a>
                    <button type="button" class="btn btn-light" id="refreshDashboard">
                        <i class="fas fa-sync-alt me-2"></i>تحديث
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Statistics Cards -->
    <div class="row g-4 mb-4">
        <!-- Total Items -->
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card border-0 rounded-4 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-primary bg-opacity-10 text-primary rounded-3 p-3 me-3">
                            <i class="fas fa-boxes fa-2x"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">إجمالي الأصناف</h6>
                            <h2 class="mb-0">@totalItems</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Active Items -->
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card border-0 rounded-4 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-success bg-opacity-10 text-success rounded-3 p-3 me-3">
                            <i class="fas fa-check-circle fa-2x"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">الأصناف النشطة</h6>
                            <h2 class="mb-0">@activeItems</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Low Stock -->
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card border-0 rounded-4 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-warning bg-opacity-10 text-warning rounded-3 p-3 me-3">
                            <i class="fas fa-exclamation-triangle fa-2x"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">رصيد منخفض</h6>
                            <h2 class="mb-0">@lowStockItems</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Out of Stock -->
        <div class="col-xl-3 col-md-6">
            <div class="card stat-card border-0 rounded-4 shadow-sm">
                <div class="card-body">
                    <div class="d-flex align-items-center">
                        <div class="stat-icon bg-danger bg-opacity-10 text-danger rounded-3 p-3 me-3">
                            <i class="fas fa-times-circle fa-2x"></i>
                        </div>
                        <div>
                            <h6 class="text-muted mb-1">بدون رصيد</h6>
                            <h2 class="mb-0">@zeroStockItems</h2>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <!-- Charts Section -->
    <div class="row g-4 mb-4">
        <!-- Inventory Distribution -->
        <div class="col-xl-8">
            <div class="card border-0 rounded-4 shadow-sm">
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="card-title mb-0">
                            <i class="fas fa-chart-bar text-primary me-2"></i>
                            توزيع المخزون حسب الشركة المصنعة
                        </h5>
                        <div class="chart-legend"></div>
                    </div>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="inventoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Stock Status -->
        <div class="col-xl-4">
            <div class="card border-0 rounded-4 shadow-sm">
                <div class="card-body">
                    <h5 class="card-title mb-4">
                        <i class="fas fa-chart-pie text-primary me-2"></i>
                        حالة المخزون
                    </h5>
                    <div class="chart-container" style="height: 300px;">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Filters Section -->
    <div class="card border-0 rounded-4 shadow-sm mb-4">
        <div class="card-body">
            <div class="row g-3">
                <div class="col-lg-3 col-md-6">
                    <label class="form-label small">حالة الصنف</label>
                    <select class="form-select" id="statusFilter">
                        <option value="all">جميع الحالات</option>
                        <option value="active">نشط فقط</option>
                        <option value="inactive">غير نشط فقط</option>
                    </select>
                </div>
                <div class="col-lg-3 col-md-6">
                    <label class="form-label small">الشركة المصنعة</label>
                    <select class="form-select" id="manufacturerFilter">
                        <option value="all">جميع الشركات</option>
                        @foreach (var mfg in Model
                                                .SelectMany(x => x.ManufacturerNames ?? Enumerable.Empty<string>())
                                                .Distinct()
                                                .OrderBy(x => x))
                        {
                            <option value="@mfg">@mfg</option>
                        }
                    </select>
                </div>
                <div class="col-lg-3 col-md-6">
                    <label class="form-label small">مستوى المخزون</label>
                    <select class="form-select" id="stockLevelFilter">
                        <option value="all">جميع المستويات</option>
                        <option value="out">نفذ المخزون</option>
                        <option value="low">مخزون منخفض</option>
                        <option value="normal">مخزون عادي</option>
                    </select>
                </div>
                <div class="col-lg-3 col-md-6">
                    <label class="form-label small">بحث سريع</label>
                    <div class="input-group">
                        <span class="input-group-text bg-light border-0">
                            <i class="fas fa-search"></i>
                        </span>
                        <input type="text"
                               class="form-control border-0 bg-light"
                               id="quickSearch"
                               placeholder="البحث في الأصناف...">
                    </div>
                </div>
            </div>

            <!-- Active Filters -->
            <div id="activeFilters" class="mt-3" style="display: none;">
                <div class="d-flex align-items-center gap-2">
                    <span class="text-muted small">المرشحات النشطة:</span>
                    <div id="filterTags" class="d-flex flex-wrap gap-2"></div>
                    <button type="button"
                            class="btn btn-sm btn-light ms-auto"
                            id="clearFilters">
                        <i class="fas fa-times me-1"></i>
                        مسح المرشحات
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Items Grid -->
    <div class="card border-0 rounded-4 shadow-sm">
        <div class="card-body">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h5 class="card-title mb-0">
                    <i class="fas fa-boxes text-primary me-2"></i>
                    قائمة الأصناف
                    <span class="badge bg-primary ms-2">@Model.Count()</span>
                </h5>
                
            </div>

            <div class="row g-4" id="itemsGrid">
                @foreach (var item in Model)
                {
                    <div class="col-xl-4 col-md-6 item-card-wrapper"
                         data-id="@item.Id"
                         data-status="@(item.Status ? "active" : "inactive")"
                         data-balance="@item.CurrentBalance"
                         data-manufacturers="@(item.ManufacturerNames != null ? string.Join(",", item.ManufacturerNames) : "")"
                         data-search="@item.Item.ToLower()">
                        <div class="card h-100 border-0 rounded-4 shadow-sm item-card">
                            <div class="card-body">
                                <div class="d-flex justify-content-between align-items-start mb-3">
                                    <div>
                                        <h6 class="card-title mb-1">@item.Item</h6>
                                        <span class="badge bg-@(item.Status ? "success" : "secondary")">
                                            @(item.Status ? "نشط" : "غير نشط")
                                        </span>
                                    </div>
                                    <div class="stock-indicator">
                                        <span class="badge bg-@(item.CurrentBalance <= 0 ? "danger" :
                                                                                                             item.CurrentBalance <= 10 ? "warning" : "success")">
                                        @item.CurrentBalance.ToString("N3") كجم
                                    </span>
                                </div>
                            </div>

                                <div class="item-details small text-muted">
                                @if (item.ManufacturerNames != null && item.ManufacturerNames.Any())
                                    {
                                        <div class="mb-1">
                                            <i class="fas fa-industry me-1"></i>
                                            @string.Join(", ", item.ManufacturerNames)
                                        </div>
                                    }
                                    @if (!string.IsNullOrEmpty(item.OriginYarnName))
                                    {
                                        <div class="mb-1">
                                            <i class="fas fa-link me-1"></i>
                                            @item.OriginYarnName
                                        </div>
                                    }
                                    <div>
                                        <i class="fas fa-hashtag me-1"></i>
                                        رصيد العدد: @item.CurrentCountBalance
                                    </div>
                                </div>

                                <div class="item-actions mt-3 pt-3 border-top">
                                    <div class="btn-group w-100">
                                        
                                        <a href="@Url.Action("Edit", new { id = item.Id })"
                                           class="btn btn-sm btn-outline-secondary">
                                            <i class="fas fa-edit me-1"></i>
                                            تعديل
                                        </a>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<!-- Details Modal -->
<div class="modal fade" id="detailsModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 rounded-4">
            <div class="modal-header border-0">
                <h5 class="modal-title">تفاصيل الصنف</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalContent">
                <!-- Content will be loaded dynamically -->
            </div>
        </div>
    </div>
</div>


    <style>
        /* Dashboard Styles */
        :root {
            --primary-color: #4e73df;
            --success-color: #1cc88a;
            --warning-color: #f6c23e;
            --danger-color: #e74a3b;
            --light-color: #f8f9fc;
            --card-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
            --transition: all 0.3s ease;
        }

        .dashboard-container {
            padding: 1.5rem 0;
        }

        .dashboard-header {
            background: linear-gradient(135deg, var(--primary-color) 0%, #224abe 100%);
        }

        /* Card Styles */
        .card {
            transition: var(--transition);
            border: none !important;
            box-shadow: var(--card-shadow);
        }

        .stat-card:hover {
            transform: translateY(-5px);
        }

        .stat-icon {
            width: 60px;
            height: 60px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: var(--transition);
        }

        .stat-card:hover .stat-icon {
            transform: scale(1.1);
        }

        /* Chart Styles */
        .chart-container {
            position: relative;
            height: 300px;
            width: 100%;
        }

        /* Filter Styles */
        .filter-tag {
            display: inline-block;
            padding: 0.25rem 0.75rem;
            background: var(--light-color);
            border-radius: 1rem;
            font-size: 0.875rem;
            margin: 0.25rem;
            color: var(--primary-color);
            border: 1px solid var(--primary-color);
        }

            .filter-tag .close {
                margin-left: 0.5rem;
                cursor: pointer;
                opacity: 0.7;
                transition: var(--transition);
            }

                .filter-tag .close:hover {
                    opacity: 1;
                }

        /* Item Card Styles */
        .item-card {
            transition: var(--transition);
        }

            .item-card:hover {
                transform: translateY(-5px);
            }

        .item-details {
            min-height: 80px;
        }

        .stock-indicator {
            font-size: 1.1rem;
            font-weight: 500;
        }

        /* Custom Form Controls */
        .form-select, .form-control {
            padding: 0.75rem;
            border-radius: 0.5rem;
        }

            .form-select:focus, .form-control:focus {
                box-shadow: 0 0 0 0.25rem rgba(78, 115, 223, 0.25);
                border-color: var(--primary-color);
            }

        /* Modal Styles */
        .modal-content {
            border: none;
            box-shadow: var(--card-shadow);
        }

        .modal-header {
            background: var(--light-color);
            border-bottom: 2px solid #e3e6f0;
        }

        /* Responsive Adjustments */
        @@media (max-width: 768px) {
            .stat-card

        {
            margin-bottom: 1rem;
        }

        .chart-container {
            height: 200px;
        }

        .dashboard-header h1 {
            font-size: 1.5rem;
        }

        }

        /* Animation Classes */
        .fade-enter {
            opacity: 0;
            transform: translateY(20px);
        }

        .fade-enter-active {
            opacity: 1;
            transform: translateY(0);
            transition: var(--transition);
        }

        /* Current User Info */
        .current-user {
            background: var(--light-color);
            padding: 0.5rem 1rem;
            border-radius: 2rem;
            font-size: 0.875rem;
        }

            .current-user i {
                color: var(--primary-color);
            }
    </style>


@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            const ctx = {
                currentTime: '@currentTime',
                currentUser: '@currentUser',
                chartData: {
                    manufacturers: @Html.Raw(JsonSerializer.Serialize(manufacturers.Select(m => m.Name))),
                    balances: @Html.Raw(JsonSerializer.Serialize(manufacturers.Select(m => m.Balance))),
                    stats: {
                        active: @activeItems,
                        inactive: @(totalItems - activeItems),
                        lowStock: @lowStockItems,
                        zeroStock: @zeroStockItems
                    }
                }
            };

            // Initialize Charts
            initializeCharts(ctx.chartData);

            // Initialize Filters
            initializeFilters();

            // Initialize Real-time Updates
            initializeRealTimeUpdates(ctx);
        });

        function initializeCharts(data) {
            // Inventory Distribution Chart
            new Chart(document.getElementById('inventoryChart').getContext('2d'), {
                type: 'bar',
                data: {
                    labels: data.manufacturers,
                    datasets: [{
                        label: 'كمية المخزون',
                        data: data.balances,
                        backgroundColor: 'rgba(78, 115, 223, 0.7)',
                        borderColor: 'rgb(78, 115, 223)',
                        borderWidth: 1
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + ' كجم';
                                }
                            }
                        }
                    }
                }
            });

            // Status Chart
            new Chart(document.getElementById('statusChart').getContext('2d'), {
                type: 'doughnut',
                data: {
                    labels: ['نشط', 'غير نشط', 'رصيد منخفض', 'نفذ المخزون'],
                    datasets: [{
                        data: [
                            data.stats.active,
                            data.stats.inactive,
                            data.stats.lowStock,
                            data.stats.zeroStock
                        ],
                        backgroundColor: [
                            'rgba(28, 200, 138, 0.8)',
                            'rgba(133, 135, 150, 0.8)',
                            'rgba(246, 194, 62, 0.8)',
                            'rgba(231, 74, 59, 0.8)'
                        ]
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%'
                }
            });
        }

        function initializeFilters() {
            const filters = {
                status: document.getElementById('statusFilter'),
                manufacturer: document.getElementById('manufacturerFilter'),
                stockLevel: document.getElementById('stockLevelFilter'),
                search: document.getElementById('quickSearch')
            };

            function applyFilters() {
                const activeFilters = {};
                let hasActiveFilters = false;

                // Collect active filters
                Object.entries(filters).forEach(([key, element]) => {
                    const value = element.value;
                    if (value && value !== 'all') {
                        activeFilters[key] = value;
                        hasActiveFilters = true;
                    }
                });

                // Show/hide items based on filters
                document.querySelectorAll('.item-card-wrapper').forEach(card => {
                    let show = true;

                    if (activeFilters.status) {
                        show = show && card.dataset.status === activeFilters.status;
                    }
                    if (activeFilters.manufacturer) {
                        show = show && card.dataset.manufacturers.includes(activeFilters.manufacturer);
                    }
                    if (activeFilters.stockLevel) {
                        const balance = parseFloat(card.dataset.balance);
                        switch (activeFilters.stockLevel) {
                            case 'out':
                                show = show && balance <= 0;
                                break;
                            case 'low':
                                show = show && balance > 0 && balance <= 10;
                                break;
                            case 'normal':
                                show = show && balance > 10;
                                break;
                        }
                    }
                    if (activeFilters.search) {
                        show = show && card.dataset.search.includes(activeFilters.search.toLowerCase());
                    }

                    card.style.display = show ? 'block' : 'none';
                });

                // Update filter tags
                updateFilterTags(activeFilters);
            }

            // Add event listeners
            Object.values(filters).forEach(element => {
                element.addEventListener('change', applyFilters);
                if (element.type === 'text') {
                    element.addEventListener('input', applyFilters);
                }
            });

            // Clear filters
            document.getElementById('clearFilters').addEventListener('click', () => {
                Object.values(filters).forEach(element => {
                    if (element.type === 'select-one') {
                        element.value = 'all';
                    } else {
                        element.value = '';
                    }
                });
                applyFilters();
            });
        }

        function updateFilterTags(activeFilters) {
            const container = document.getElementById('filterTags');
            const activeFiltersSection = document.getElementById('activeFilters');

            container.innerHTML = '';

            Object.entries(activeFilters).forEach(([key, value]) => {
                const tag = document.createElement('span');
                tag.className = 'filter-tag';
                tag.innerHTML = `
                    ${getFilterLabel(key, value)}
                    <i class="fas fa-times close" data-filter="${key}"></i>
                `;
                container.appendChild(tag);
            });

            activeFiltersSection.style.display =
                Object.keys(activeFilters).length > 0 ? 'block' : 'none';
        }

        function getFilterLabel(key, value) {
            const labels = {
                status: { active: 'نشط', inactive: 'غير نشط' },
                stockLevel: {
                    out: 'نفذ المخزون',
                    low: 'مخزون منخفض',
                    normal: 'مخزون عادي'
                }
            };

            switch (key) {
                case 'status':
                    return `الحالة: ${labels.status[value]}`;
                case 'manufacturer':
                    return `الشركة: ${value}`;
                case 'stockLevel':
                    return `المستوى: ${labels.stockLevel[value]}`;
                case 'search':
                    return `بحث: ${value}`;
                default:
                    return value;
            }
        }

        function initializeRealTimeUpdates(ctx) {
            // Update time display
            setInterval(() => {
                const now = new Date();
                const timeString = now.toISOString().slice(0, 19).replace('T', ' ');
                document.querySelector('.current-user').innerHTML = `
                    <i class="fas fa-user me-1"></i>
                    ${ctx.currentUser}
                    <span class="mx-2">•</span>
                    <i class="fas fa-clock me-1"></i>
                    ${timeString}
                `;
            }, 1000);
        }
    </script>
}