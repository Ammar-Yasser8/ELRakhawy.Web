@using ELRakhawy.EL.ViewModels
@model IEnumerable<YarnItemViewModel>
@{
    ViewData["Title"] = "لوحة تحكم مخزون الخيوط";
    Layout = "_Layout";

    // إحصائيات محسوبة من النموذج
    var totalItems = Model.Count();
    var activeItems = Model.Count(x => x.Status);
    var totalBalance = Model.Sum(x => x.CurrentBalance);
    var lowStockItems = Model.Count(x => x.CurrentBalance <= 10 && x.CurrentBalance > 0);
    var zeroStockItems = Model.Count(x => x.CurrentBalance <= 0);
    var availableItems = Model.Count(x => x.Status && x.CurrentBalance > 0);

    // تجميع البيانات للرسوم البيانية
    var manufacturers = Model
        .Where(x => !string.IsNullOrEmpty(x.ManufacturerName))
        .GroupBy(x => x.ManufacturerName)
        .Select(g => new { Name = g.Key, Count = g.Count(), Balance = g.Sum(x => x.CurrentBalance) })
        .OrderByDescending(x => x.Balance)
        .Take(5)
        .ToList();
}

<style>
    .dashboard-header {
        background: linear-gradient(135deg, #4e73df 0%, #224abe 100%);
        color: white;
        padding: 20px 0;
        margin-bottom: 24px;
        border-radius: 0 0 10px 10px;
        box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
    }

    .card {
        border: none;
        border-radius: 10px;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
        margin-bottom: 24px;
    }

    .card-header {
        background-color: #f8f9fc;
        border-bottom: 1px solid #e3e6f0;
        font-weight: 700;
        padding: 15px 20px;
        border-radius: 10px 10px 0 0 !important;
    }

    .summary-card {
        border-left: 4px solid;
        transition: transform 0.3s;
    }

        .summary-card:hover {
            transform: translateY(-5px);
        }

        .summary-card.total {
            border-left-color: #4e73df;
        }

        .summary-card.available {
            border-left-color: #1cc88a;
        }

        .summary-card.low-stock {
            border-left-color: #f6c23e;
        }

        .summary-card.out-of-stock {
            border-left-color: #e74a3b;
        }

    .summary-icon {
        font-size: 2rem;
        opacity: 0.3;
        position: absolute;
        left: 20px;
        top: 15px;
    }

    .chart-container {
        position: relative;
        height: 300px;
        padding: 20px;
    }

    .view-option {
        cursor: pointer;
        padding: 10px 15px;
        border-radius: 5px;
        margin-right: 10px;
        background-color: #eaecf4;
        text-decoration: none;
        color: #6e707e;
    }

        .view-option.active {
            background-color: #4e73df;
            color: white;
        }

    .filter-section {
        background-color: white;
        padding: 15px;
        border-radius: 10px;
        margin-bottom: 20px;
        box-shadow: 0 0.15rem 1.75rem 0 rgba(58, 59, 69, 0.15);
    }

    .filter-label {
        font-weight: 600;
        color: #5a5c69;
        margin-bottom: 5px;
    }

    .item-card {
        transition: all 0.3s ease;
        height: 100%;
    }

        .item-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

    .search-tag {
        display: inline-block;
        background: #eaecf4;
        color: #4e73df;
        padding: 4px 10px;
        border-radius: 15px;
        margin: 2px;
        font-size: 0.8rem;
        font-weight: 500;
    }

    .search-tag-remove {
        margin-right: 5px;
        cursor: pointer;
    }

    .no-data {
        text-align: center;
        padding: 40px;
        color: #b7b9cc;
    }

        .no-data i {
            font-size: 3rem;
            margin-bottom: 15px;
        }

    /* تحسينات جديدة */
    .export-btn {
        background-color: #1cc88a;
        border-color: #1cc88a;
        color: white;
    }

        .export-btn:hover {
            background-color: #17a673;
            border-color: #17a673;
            color: white;
        }

    .whatsapp-btn {
        background-color: #25D366;
        border-color: #25D366;
        color: white;
    }

        .whatsapp-btn:hover {
            background-color: #128C7E;
            border-color: #128C7E;
            color: white;
        }

    .available-filter-btn {
        background-color: #4e73df;
        border-color: #4e73df;
        color: white;
        font-weight: bold;
    }

        .available-filter-btn.active {
            background-color: #224abe;
            border-color: #224abe;
        }

    .transaction-modal .modal-content {
        border-radius: 10px;
    }

    .transaction-table th {
        background-color: #f8f9fc;
        font-weight: 600;
    }

    .product-overview {
        background: linear-gradient(to right, #f8f9fc, #fff);
        border-radius: 10px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid #4e73df;
    }

    .see-more-btn {
        color: #4e73df;
        font-weight: 600;
        text-decoration: none;
        font-size: 0.9rem;
    }

        .see-more-btn:hover {
            text-decoration: underline;
        }
</style>

<div class="dashboard-header">
    <div class="container">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h1><i class="fas fa-th-large me-2"></i>لوحة تحكم مخزون الخيوط</h1>
                <p class="lead">نظرة عامة مرئية على حالة مخزون الخيوط والمقاييس</p>
            </div>
            <div class="col-md-6 text-start">
                <div class="btn-group">
                    <span class="view-option active"><i class="fas fa-th-large me-1"></i> لوحة التحكم</span>
                    <a href="@Url.Action("Index")" class="view-option"><i class="fas fa-table me-1"></i> عرض الجدول</a>
                </div>
                <div class="btn-group ms-2">
                    <button class="btn btn-light dropdown-toggle" type="button" data-bs-toggle="dropdown">
                        <i class="fas fa-download me-1"></i> إنشاء تقرير
                    </button>
                    <ul class="dropdown-menu">
                        <li><a class="dropdown-item" href="#"><i class="fas fa-file-pdf me-2"></i>PDF</a></li>
                        <li><a class="dropdown-item" href="#"><i class="fas fa-file-excel me-2"></i>Excel</a></li>
                        <li><hr class="dropdown-divider"></li>
                        <li><a class="dropdown-item whatsapp-btn" href="#"><i class="fab fa-whatsapp me-2"></i>إرسال عبر واتساب</a></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container">
    <!-- نظرة عامة على المنتجات النشطة -->
    <div class="product-overview">
        <div class="row align-items-center">
            <div class="col-md-8">
                <h4 class="text-primary"><i class="fas fa-boxes me-2"></i>نظرة عامة على المنتجات النشطة</h4>
                <p class="mb-0">إجمالي الأصناف النشطة: <span class="fw-bold">@activeItems</span> صنف | إجمالي الرصيد: <span class="fw-bold">@totalBalance.ToString("N3") كجم</span></p>
            </div>
            <div class="col-md-4 text-start">
                <button id="availableFilterBtn" class="btn available-filter-btn">
                    <i class="fas fa-filter me-1"></i>المتاح فقط (@availableItems)
                </button>
            </div>
        </div>
    </div>

    <!-- بطاقات الملخص -->
    <div class="row" id="summaryCards">
        <div class="col-xl-3 col-md-6">
            <div class="card summary-card total">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs fw-bold text-primary text-uppercase mb-1">إجمالي الأصناف</div>
                            <div class="h5 mb-0 fw-bold text-gray-800">@totalItems</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-boxes summary-icon text-primary"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card summary-card available">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs fw-bold text-success text-uppercase mb-1">الأصناف النشطة</div>
                            <div class="h5 mb-0 fw-bold text-gray-800">@activeItems</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-check-circle summary-icon text-success"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card summary-card low-stock">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs fw-bold text-warning text-uppercase mb-1">رصيد منخفض</div>
                            <div class="h5 mb-0 fw-bold text-gray-800">@lowStockItems</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-exclamation-triangle summary-icon text-warning"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-xl-3 col-md-6">
            <div class="card summary-card out-of-stock">
                <div class="card-body">
                    <div class="row align-items-center">
                        <div class="col">
                            <div class="text-xs fw-bold text-danger text-uppercase mb-1">بدون رصيد</div>
                            <div class="h5 mb-0 fw-bold text-gray-800">@zeroStockItems</div>
                        </div>
                        <div class="col-auto">
                            <i class="fas fa-times-circle summary-icon text-danger"></i>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- مرشحات -->
    <div class="filter-section">
        <div class="row">
            <div class="col-md-3 mb-2">
                <div class="filter-label">الحالة</div>
                <select class="form-select form-select-sm" id="statusFilter">
                    <option value="all">جميع الحالات</option>
                    <option value="active">نشط فقط</option>
                    <option value="inactive">غير نشط فقط</option>
                </select>
            </div>
            <div class="col-md-3 mb-2">
                <div class="filter-label">الشركة المصنعة</div>
                <select class="form-select form-select-sm" id="manufacturerFilter">
                    <option value="all">جميع الشركات</option>
                    @foreach (var mfg in manufacturers)
                    {
                        <option value="@mfg.Name">@mfg.Name</option>
                    }
                </select>
            </div>
            <div class="col-md-3 mb-2">
                <div class="filter-label">مستوى الرصيد</div>
                <select class="form-select form-select-sm" id="balanceFilter">
                    <option value="all">جميع المستويات</option>
                    <option value="zero">بدون رصيد</option>
                    <option value="low">رصيد منخفض</option>
                    <option value="medium">رصيد متوسط</option>
                    <option value="high">رصيد عالي</option>
                </select>
            </div>
            <div class="col-md-3 mb-2">
                <div class="filter-label">بحث</div>
                <input type="text" class="form-control form-control-sm" id="searchInput" placeholder="اسم الصنف...">
            </div>
        </div>
        <div class="row mt-2" id="activeFilters" style="display: none;">
            <div class="col-12">
                <div class="filter-label">المرشحات النشطة:</div>
                <div id="filterTags"></div>
                <button class="btn btn-sm btn-outline-secondary mt-2" id="clearFilters">
                    <i class="fas fa-times me-1"></i>مسح جميع المرشحات
                </button>
            </div>
        </div>
    </div>

    <!-- صف الرسوم البيانية -->
    <div class="row">
        <!-- توزيع المخزون حسب الشركة المصنعة -->
        <div class="col-xl-8">
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">توزيع المخزون حسب الشركة المصنعة</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="inventoryChart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- نظرة عامة على حالة المخزون -->
        <div class="col-xl-4">
            <div class="card">
                <div class="card-header">
                    <h6 class="m-0 font-weight-bold text-primary">نظرة عامة على حالة المخزون</h6>
                </div>
                <div class="card-body">
                    <div class="chart-container">
                        <canvas id="statusChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- بطاقات الأصناف -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <h6 class="m-0 font-weight-bold text-primary">الأصناف النشطة</h6>
                    <div>
                        <span class="badge bg-primary me-1" id="filteredCount">@activeItems</span> من
                        <span class="badge bg-secondary ms-1">@activeItems</span> إجمالي
                    </div>
                </div>
                <div class="card-body">
                    <div class="row" id="itemsContainer">
                        @foreach (var item in Model.Where(x => x.Status).Take(6))
                        {
                            <div class="col-xl-4 col-md-6 mb-4 item-card-container"
                                 data-id="@item.Id"
                                 data-status="@(item.Status ? "active" : "inactive")"
                                 data-manufacturer="@item.ManufacturerName"
                                 data-balance="@item.CurrentBalance"
                                 data-search="@item.Item.ToLower()">
                                <div class="card item-card border-left-@(item.CurrentBalance <= 0 ? "danger" : item.CurrentBalance <= 10 ? "warning" : "success") h-100 py-2">
                                    <div class="card-body">
                                        <div class="row no-gutters align-items-center">
                                            <div class="col mr-2">
                                                <div class="text-xs font-weight-bold text-@(item.CurrentBalance <= 0 ? "danger" : item.CurrentBalance <= 10 ? "warning" : "success") text-uppercase mb-1">
                                                    @item.Item
                                                </div>
                                                <div class="h5 mb-0 font-weight-bold text-gray-800">@item.CurrentBalance.ToString("N3") كجم</div>
                                                <div class="mt-2 text-muted small">
                                                    @if (!string.IsNullOrEmpty(item.ManufacturerName))
                                                    {
                                                        <div><i class="fas fa-industry me-1"></i> @item.ManufacturerName</div>
                                                    }
                                                    @if (!string.IsNullOrEmpty(item.OriginYarnName))
                                                    {
                                                        <div><i class="fas fa-link me-1"></i> @item.OriginYarnName</div>
                                                    }
                                                    <div>
                                                        <span class="badge bg-@(item.Status ? "success" : "secondary")">
                                                            @(item.Status ? "نشط" : "غير نشط")
                                                        </span>
                                                    </div>
                                                </div>
                                            </div>
                                            <div class="col-auto">
                                                <i class="fas fa-@(item.CurrentBalance <= 0 ? "times-circle" : item.CurrentBalance <= 10 ? "exclamation-triangle" : "check-circle") fa-2x text-@(item.CurrentBalance <= 0 ? "danger" : item.CurrentBalance <= 10 ? "warning" : "success")"></i>
                                            </div>
                                        </div>
                                        <div class="mt-3 d-flex justify-content-between">
                                            <a href="#" class="see-more-btn view-transactions" data-id="@item.Id">
                                                <i class="fas fa-list me-1"></i>عرض المعاملات
                                            </a>
                                            <div class="btn-group">
                                                <button class="btn btn-sm export-btn" data-id="@item.Id">
                                                    <i class="fas fa-download"></i>
                                                </button>
                                                <button class="btn btn-sm whatsapp-btn" data-id="@item.Id">
                                                    <i class="fab fa-whatsapp"></i>
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        }
                    </div>
                    <div class="text-center mt-3">
                        <a href="@Url.Action("Index")" class="btn btn-primary">عرض جميع الأصناف</a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Modal for Transactions -->
<div class="modal fade transaction-modal" id="transactionsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">المعاملات للصنف: <span id="itemName"></span></h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <div class="table-responsive">
                    <table class="table table-bordered transaction-table">
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>نوع المعاملة</th>
                                <th>الكمية</th>
                                <th>الرصيد بعد المعاملة</th>
                                <th>ملاحظات</th>
                            </tr>
                        </thead>
                        <tbody id="transactionsBody">
                            <!-- سيتم ملؤها بالبيانات عبر JavaScript -->
                        </tbody>
                    </table>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إغلاق</button>
                <button type="button" class="btn export-btn"><i class="fas fa-download me-1"></i>تصدير</button>
                <button type="button" class="btn whatsapp-btn"><i class="fab fa-whatsapp me-1"></i>إرسال عبر واتساب</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // Get AntiForgeryToken for AJAX
        function getAntiForgeryToken() {
            return $('input[name="__RequestVerificationToken"]').val();
        }

        document.addEventListener('DOMContentLoaded', function() {
            // Inventory Chart
            const inventoryCtx = document.getElementById('inventoryChart').getContext('2d');
            const inventoryChart = new Chart(inventoryCtx, {
                type: 'bar',
                data: {
                    labels: [@Html.Raw(string.Join(", ", manufacturers.Select(m => $"'{m.Name}'")))],
                    datasets: [{
                        label: 'كمية المخزون',
                        data: [@string.Join(", ", manufacturers.Select(m => m.Balance))],
                        backgroundColor: 'rgba(78, 115, 223, 0.7)',
                        borderColor: 'rgb(78, 115, 223)',
                        borderWidth: 1
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            ticks: {
                                callback: function(value) {
                                    return value + ' كجم';
                                }
                            }
                        }
                    },
                    plugins: {
                        legend: {
                            display: false
                        }
                    }
                }
            });

            // Status Overview Chart
            const statusCtx = document.getElementById('statusChart').getContext('2d');
            const statusChart = new Chart(statusCtx, {
                type: 'doughnut',
                data: {
                    labels: ['نشط', 'غير نشط', 'رصيد منخفض', 'بدون رصيد'],
                    datasets: [{
                        data: [@activeItems, @(totalItems - activeItems), @lowStockItems, @zeroStockItems],
                        backgroundColor: [
                            'rgba(28, 200, 138, 0.7)',
                            'rgba(133, 135, 150, 0.7)',
                            'rgba(246, 194, 62, 0.7)',
                            'rgba(231, 74, 59, 0.7)'
                        ],
                        borderColor: [
                            'rgb(28, 200, 138)',
                            'rgb(133, 135, 150)',
                            'rgb(246, 194, 62)',
                            'rgb(231, 74, 59)'
                        ],
                        borderWidth: 1
                    }]
                },
                options: {
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: {
                            position: 'bottom',
                            rtl: true
                        }
                    }
                }
            });

            // Filters
            const statusFilter = document.getElementById('statusFilter');
            const manufacturerFilter = document.getElementById('manufacturerFilter');
            const balanceFilter = document.getElementById('balanceFilter');
            const searchInput = document.getElementById('searchInput');
            const filterTags = document.getElementById('filterTags');
            const activeFilters = document.getElementById('activeFilters');
            const clearFilters = document.getElementById('clearFilters');
            const filteredCount = document.getElementById('filteredCount');
            const itemsContainer = document.getElementById('itemsContainer');
            const itemCards = document.querySelectorAll('.item-card-container');
            const availableFilterBtn = document.getElementById('availableFilterBtn');

            let activeFiltersCount = 0;
            let isAvailableFilterActive = false;

            function applyFilters() {
                const statusValue = statusFilter.value;
                const manufacturerValue = manufacturerFilter.value;
                const balanceValue = balanceFilter.value;
                const searchValue = searchInput.value.toLowerCase();

                let visibleCount = 0;
                activeFiltersCount = 0;
                filterTags.innerHTML = '';

                itemCards.forEach(card => {
                    const status = card.dataset.status;
                    const manufacturer = card.dataset.manufacturer || '';
                    const balance = parseFloat(card.dataset.balance);
                    const searchText = card.dataset.search;

                    let statusMatch = true;
                    let manufacturerMatch = true;
                    let balanceMatch = true;
                    let searchMatch = true;

                    if (statusValue !== 'all') {
                        if (statusValue === 'active' && status !== 'active') statusMatch = false;
                        if (statusValue === 'inactive' && status !== 'inactive') statusMatch = false;
                    }
                    if (manufacturerValue !== 'all') {
                        if (manufacturer !== manufacturerValue) manufacturerMatch = false;
                    }
                    if (balanceValue !== 'all') {
                        if (balanceValue === 'zero' && balance > 0) balanceMatch = false;
                        if (balanceValue === 'low' && (balance <= 0 || balance > 10)) balanceMatch = false;
                        if (balanceValue === 'medium' && (balance <= 10 || balance > 50)) balanceMatch = false;
                        if (balanceValue === 'high' && balance <= 50) balanceMatch = false;
                    }
                    if (searchValue && !searchText.includes(searchValue)) {
                        searchMatch = false;
                    }
                    if (isAvailableFilterActive && (status !== 'active' || balance <= 0)) {
                        statusMatch = false;
                    }

                    if (statusMatch && manufacturerMatch && balanceMatch && searchMatch) {
                        card.style.display = 'block';
                        visibleCount++;
                    } else {
                        card.style.display = 'none';
                    }
                });

                filteredCount.textContent = visibleCount;
                updateActiveFilters(statusValue, manufacturerValue, balanceValue, searchValue);
            }

            function updateActiveFilters(status, manufacturer, balance, search) {
                filterTags.innerHTML = '';
                if (status !== 'all') {
                    addFilterTag('الحالة: ' + (status === 'active' ? 'نشط' : 'غير نشط'), 'status');
                    activeFiltersCount++;
                }
                if (manufacturer !== 'all') {
                    addFilterTag('الشركة: ' + manufacturer, 'manufacturer');
                    activeFiltersCount++;
                }
                if (balance !== 'all') {
                    let balanceText = '';
                    switch(balance) {
                        case 'zero': balanceText = 'بدون رصيد'; break;
                        case 'low': balanceText = 'رصيد منخفض'; break;
                        case 'medium': balanceText = 'رصيد متوسط'; break;
                        case 'high': balanceText = 'رصيد عالي'; break;
                    }
                    addFilterTag('المستوى: ' + balanceText, 'balance');
                    activeFiltersCount++;
                }
                if (search) {
                    addFilterTag('بحث: ' + search, 'search');
                    activeFiltersCount++;
                }
                if (isAvailableFilterActive) {
                    addFilterTag('المتاح فقط', 'available');
                    activeFiltersCount++;
                }
                activeFilters.style.display = activeFiltersCount > 0 ? 'block' : 'none';
            }

            function addFilterTag(text, type) {
                const tag = document.createElement('span');
                tag.className = 'search-tag';
                tag.innerHTML = `<i class="fas fa-times search-tag-remove" data-type="${type}"></i>${text}`;
                filterTags.appendChild(tag);
            }

            statusFilter.addEventListener('change', applyFilters);
            manufacturerFilter.addEventListener('change', applyFilters);
            balanceFilter.addEventListener('change', applyFilters);
            searchInput.addEventListener('input', applyFilters);

            availableFilterBtn.addEventListener('click', function() {
                isAvailableFilterActive = !isAvailableFilterActive;
                if (isAvailableFilterActive) {
                    this.classList.add('active');
                } else {
                    this.classList.remove('active');
                }
                applyFilters();
            });

            clearFilters.addEventListener('click', function() {
                statusFilter.value = 'all';
                manufacturerFilter.value = 'all';
                balanceFilter.value = 'all';
                searchInput.value = '';
                isAvailableFilterActive = false;
                availableFilterBtn.classList.remove('active');
                applyFilters();
            });

            document.addEventListener('click', function(e) {
                if (e.target.classList.contains('search-tag-remove')) {
                    const type = e.target.dataset.type;
                    switch(type) {
                        case 'status': statusFilter.value = 'all'; break;
                        case 'manufacturer': manufacturerFilter.value = 'all'; break;
                        case 'balance': balanceFilter.value = 'all'; break;
                        case 'search': searchInput.value = ''; break;
                        case 'available': isAvailableFilterActive = false; availableFilterBtn.classList.remove('active'); break;
                    }
                    applyFilters();
                }
            });

            // --- Transaction Modal ---
            const transactionsModal = new bootstrap.Modal(document.getElementById('transactionsModal'));
            const viewTransactionsButtons = document.querySelectorAll('.view-transactions');

            function fetchItemDetails(itemId) {
                $.ajax({
                    url: `/YarnTransactions/ItemDetails/${itemId}`,
                    type: 'GET',
                    headers: {
                        'RequestVerificationToken': getAntiForgeryToken()
                    },
                    success: function(response) {
                        if (!response.success) {
                            document.getElementById('transactionsBody').innerHTML = `<tr><td colspan="5">${response.message || 'تعذر تحميل تفاصيل الصنف'}</td></tr>`;
                            document.getElementById('itemName').textContent = '';
                            document.getElementById('balanceInfo').textContent = '';
                            return;
                        }
                        const yarn = response.yarnItem;
                        document.getElementById('itemName').textContent = yarn.name || 'غير محدد';

                        // Defensive fix: always default to 0 before .toFixed
                        document.getElementById('balanceInfo').textContent =
                            `الرصيد: ${(yarn.quantityBalance !== undefined && yarn.quantityBalance !== null ? Number(yarn.quantityBalance) : 0).toFixed(2)} كجم / عدد: ${(yarn.countBalance !== undefined && yarn.countBalance !== null ? Number(yarn.countBalance) : 0).toFixed(0)}`

                        const transactionsBody = document.getElementById('transactionsBody');
                        transactionsBody.innerHTML = '';
                        if (response.transactions && response.transactions.length > 0) {
                            response.transactions.forEach(transaction => {
                                // Defensive: always default to 0 before .toFixed
                                const q = (transaction.Quantity !== undefined && transaction.Quantity !== null && !isNaN(transaction.Quantity)) ? Number(transaction.Quantity) : 0;
                                const qb = (transaction.QuantityBalance !== undefined && transaction.QuantityBalance !== null && !isNaN(transaction.QuantityBalance)) ? Number(transaction.QuantityBalance) : 0;
                                const date = transaction.Date || '';
                                const isInbound = transaction.IsInbound ? 'شراء' : 'بيع';
                                const comment = transaction.Comment || '';
                                const quantityClass = transaction.IsInbound ? 'text-success' : 'text-danger';

                                const row = document.createElement('tr');
                                row.innerHTML = `
                                    <td>${date}</td>
                                    <td>${isInbound}</td>
                                    <td class="${quantityClass}">${q.toFixed(2)} كجم</td>
                                    <td>${qb.toFixed(2)} كجم</td>
                                    <td>${comment}</td>
                                `;
                                transactionsBody.appendChild(row);
                            });
                        } else {
                            transactionsBody.innerHTML = `<tr><td colspan="5">لا توجد معاملات متاحة</td></tr>`;
                        }
                    },
                    error: function(xhr) {
                        document.getElementById('transactionsBody').innerHTML = `<tr><td colspan="5">حدث خطأ أثناء تحميل التفاصيل</td></tr>`;
                        document.getElementById('itemName').textContent = '';
                        document.getElementById('balanceInfo').textContent = '';
                    }
                });
            }

            viewTransactionsButtons.forEach(button => {
                button.addEventListener('click', function() {
                    const itemId = this.dataset.id;
                    fetchItemDetails(itemId);
                    transactionsModal.show();
                });
            });

            applyFilters();
        });
    </script>
}