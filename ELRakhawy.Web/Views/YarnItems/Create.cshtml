@using ELRakhawy.EL.ViewModels
@model YarnItemViewModel
@{
    ViewData["Title"] = "إضافة صنف جديد";
}

<!-- Modern Breadcrumb -->
<nav class="mb-4 p-3 bg-white rounded-4 shadow-sm">
    <ol class="breadcrumb mb-0 px-1">
        <li class="breadcrumb-item">
            <a href="@Url.Action("Index", "Home")" class="text-decoration-none">
                <i class="fas fa-home opacity-50"></i>
                <span class="ms-2">الرئيسية</span>
            </a>
        </li>
        <li class="breadcrumb-item">
            <a href="@Url.Action("Index")" class="text-decoration-none">
                <i class="fas fa-boxes opacity-50"></i>
                <span class="ms-2">الأصناف</span>
            </a>
        </li>
        <li class="breadcrumb-item active d-flex align-items-center">
            <i class="fas fa-plus-circle text-primary opacity-50"></i>
            <span class="ms-2">@ViewData["Title"]</span>
        </li>
    </ol>
</nav>

<div class="row g-4">
    <!-- Main Form Column -->
    <div class="col-lg-8">
        <div class="card border-0 shadow-sm rounded-4">
            <div class="card-body p-4">
                <!-- Form Progress Indicator -->
                <div class="progress mb-4" style="height: 4px;">
                    <div class="progress-bar progress-bar-striped progress-bar-animated"
                         role="progressbar"
                         id="formProgress"></div>
                </div>

                <form id="createForm" asp-action="Create" method="post" novalidate>
                    @Html.AntiForgeryToken()

                    <!-- Validation Summary -->
                    @if (!ViewContext.ModelState.IsValid)
                    {
                        <div class="alert alert-danger alert-dismissible fade show mb-4 rounded-3">
                            <div class="d-flex">
                                <div class="flex-shrink-0">
                                    <i class="fas fa-exclamation-circle fa-2x text-danger"></i>
                                </div>
                                <div class="flex-grow-1 ms-3">
                                    <h6 class="alert-heading mb-1">يوجد أخطاء في النموذج</h6>
                                    <div asp-validation-summary="ModelOnly" class="text-danger small"></div>
                                </div>
                            </div>
                            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                        </div>
                    }

                    <!-- Basic Information Section -->
                    <div class="form-section bg-light p-4 rounded-4 mb-4">
                        <div class="section-header mb-4">
                            <div class="d-flex align-items-center">
                                <div class="section-icon me-3">
                                    <span class="badge bg-primary p-2 rounded-3">
                                        <i class="fas fa-info-circle fa-lg"></i>
                                    </span>
                                </div>
                                <div>
                                    <h6 class="mb-1">المعلومات الأساسية</h6>
                                    <p class="text-muted small mb-0">معلومات الصنف الرئيسية</p>
                                </div>
                            </div>
                        </div>

                        <div class="row g-4">
                            <!-- Item Name -->
                            <div class="col-md-8">
                                <div class="form-floating">
                                    <input asp-for="Item"
                                           class="form-control form-control-lg rounded-3 border-0"
                                           placeholder="اسم الصنف"
                                           data-bs-toggle="tooltip"
                                           data-bs-placement="top"
                                           title="أدخل اسم الصنف بشكل واضح ومميز" />
                                    <label asp-for="Item" class="form-label required">
                                        <i class="fas fa-box-open me-2 text-primary"></i>اسم الصنف
                                    </label>
                                    <span asp-validation-for="Item" class="invalid-feedback"></span>
                                </div>
                            </div>

                            <!-- Status Switch -->
                            <div class="col-md-4">
                                <div class="status-toggle p-4 bg-white rounded-4 text-center h-100">
                                    <label class="form-check form-switch d-inline-flex align-items-center gap-3">
                                        <input asp-for="Status"
                                               class="form-check-input flex-shrink-0"
                                               style="width: 3em; height: 1.5em;"
                                               role="switch" />
                                        <span class="form-check-label">
                                            <i class="fas fa-toggle-on text-success me-2"></i>
                                            <span id="statusText">نشط</span>
                                        </span>
                                    </label>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Manufacturers Section -->
                    <div class="form-section bg-light p-4 rounded-4 mb-4">
                        <div class="section-header mb-4">
                            <div class="d-flex align-items-center justify-content-between">
                                <div class="d-flex align-items-center">
                                    <div class="section-icon me-3">
                                        <span class="badge bg-success p-2 rounded-3">
                                            <i class="fas fa-industry fa-lg"></i>
                                        </span>
                                    </div>
                                    <div>
                                        <h6 class="mb-1">الشركات المصنعة</h6>
                                        <p class="text-muted small mb-0">يمكنك اختيار شركة أو أكثر</p>
                                    </div>
                                </div>
                                <div class="selected-count">
                                    <span class="badge bg-primary rounded-pill" id="selectedCount">0 محدد</span>
                                </div>
                            </div>
                        </div>

                        <!-- Enhanced Manufacturers Selection UI -->
                        <div class="manufacturers-container bg-white rounded-4 overflow-hidden">
                            <!-- Search Box -->
                            <div class="manufacturer-search-box p-3 border-bottom">
                                <div class="input-group">
                                    <span class="input-group-text bg-light border-0">
                                        <i class="fas fa-search text-muted"></i>
                                    </span>
                                    <input type="text"
                                           class="form-control border-0 bg-light"
                                           placeholder="ابحث عن الشركات المصنعة..."
                                           id="manufacturerSearch">
                                    <button class="btn btn-outline-secondary border-0"
                                            type="button"
                                            id="clearSearch"
                                            title="مسح البحث">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>

                            <!-- Quick Actions -->
                            <div class="manufacturer-actions p-3 bg-light border-bottom">
                                <div class="d-flex gap-2 flex-wrap">
                                    <button type="button" class="btn btn-sm btn-outline-primary rounded-pill" id="selectAll">
                                        <i class="fas fa-check-double me-1"></i>تحديد الكل
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-secondary rounded-pill" id="clearAll">
                                        <i class="fas fa-times me-1"></i>إلغاء الكل
                                    </button>
                                    <button type="button" class="btn btn-sm btn-outline-info rounded-pill" id="toggleView">
                                        <i class="fas fa-th-large me-1"></i>عرض البطاقات
                                    </button>
                                </div>
                            </div>

                            <!-- Selected Items Display -->
                            <div class="selected-manufacturers p-3 bg-success bg-opacity-10 border-bottom" id="selectedDisplay" style="display: none;">
                                <div class="d-flex align-items-center mb-2">
                                    <i class="fas fa-check-circle text-success me-2"></i>
                                    <small class="fw-bold text-success">الشركات المحددة:</small>
                                </div>
                                <div class="selected-tags d-flex flex-wrap gap-1" id="selectedTags"></div>
                            </div>

                            <!-- Manufacturers List/Grid -->
                            <div class="manufacturers-list p-3" id="manufacturersList">
                                <!-- This will be populated by JavaScript -->
                            </div>

                            <!-- Hidden Select for Form Submission -->
                            <select asp-for="ManufacturerIds"
                                    asp-items="Model.Manufacturers"
                                    multiple
                                    class="d-none"
                                    id="hiddenManufacturerSelect">
                            </select>
                            <span asp-validation-for="ManufacturerIds" class="invalid-feedback"></span>
                        </div>
                    </div>

                    <!-- Origin Yarn Section -->
                    <div class="form-section bg-light p-4 rounded-4 mb-4">
                        <div class="section-header mb-4">
                            <div class="d-flex align-items-center">
                                <div class="section-icon me-3">
                                    <span class="badge bg-info p-2 rounded-3">
                                        <i class="fas fa-link fa-lg"></i>
                                    </span>
                                </div>
                                <div>
                                    <h6 class="mb-1">الغزل المكون</h6>
                                    <p class="text-muted small mb-0">اختياري - حدد الغزل الأساسي</p>
                                </div>
                            </div>
                        </div>

                        <div class="origin-select bg-white p-3 rounded-4">
                            <select asp-for="OriginYarnId"
                                    asp-items="Model.OriginYarns"
                                    class="form-select select2-origin"
                                    data-placeholder="اختر الغزل المكون...">
                                <option value="">-- اختر الغزل المكون --</option>
                            </select>
                            <span asp-validation-for="OriginYarnId" class="invalid-feedback"></span>
                        </div>
                    </div>

                    <!-- Comments Section -->
                    <div class="form-section bg-light p-4 rounded-4 mb-4">
                        <div class="section-header mb-4">
                            <div class="d-flex align-items-center">
                                <div class="section-icon me-3">
                                    <span class="badge bg-warning p-2 rounded-3">
                                        <i class="fas fa-comments fa-lg"></i>
                                    </span>
                                </div>
                                <div>
                                    <h6 class="mb-1">الملاحظات</h6>
                                    <p class="text-muted small mb-0">أي معلومات إضافية عن الصنف</p>
                                </div>
                            </div>
                        </div>

                        <div class="comment-input bg-white p-3 rounded-4">
                            <div class="form-floating">
                                <textarea asp-for="Comment"
                                          class="form-control"
                                          style="height: 120px"
                                          placeholder="أدخل الملاحظات هنا"></textarea>
                                <label asp-for="Comment">
                                    <i class="fas fa-comment-alt me-2 text-warning"></i>الملاحظات
                                </label>
                            </div>
                            <div class="d-flex justify-content-between align-items-center mt-2">
                                <small class="text-muted">
                                    <i class="fas fa-info-circle me-1"></i>
                                    اختياري
                                </small>
                                <small class="text-muted">
                                    <span id="charCount">0</span>/500
                                </small>
                            </div>
                        </div>
                    </div>

                    <!-- Form Actions -->
                    <div class="form-actions bg-light p-4 rounded-4">
                        <div class="d-flex gap-2 justify-content-end">
                            <a href="@Url.Action("Index")" class="btn btn-light px-4">
                                <i class="fas fa-times me-2"></i>إلغاء
                            </a>

                            <button type="submit" class="btn btn-primary px-4" id="submitBtn">
                                <i class="fas fa-save me-2"></i>حفظ
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Help Section -->
    <div class="col-lg-4">
        <div class="card border-0 shadow-sm rounded-4">
            <div class="card-header bg-primary text-white border-0 rounded-top-4">
                <h6 class="mb-0">
                    <i class="fas fa-question-circle me-2"></i>
                    إرشادات الإدخال
                </h6>
            </div>
            <div class="card-body p-4">
                <div class="help-items">
                    <!-- Item Name Help -->
                    <div class="help-item mb-4">
                        <div class="d-flex">
                            <div class="help-icon me-3">
                                <span class="badge bg-primary bg-opacity-10 text-primary p-2 rounded-circle">
                                    <i class="fas fa-box-open"></i>
                                </span>
                            </div>
                            <div>
                                <h6 class="mb-2">اسم الصنف</h6>
                                <ul class="text-muted small mb-0 ps-3">
                                    <li>يجب أن يكون الاسم فريداً</li>
                                    <li>لا يقل عن حرفين</li>
                                    <li>يمكن استخدام الأرقام والحروف</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Enhanced Manufacturers Help -->
                    <div class="help-item mb-4">
                        <div class="d-flex">
                            <div class="help-icon me-3">
                                <span class="badge bg-success bg-opacity-10 text-success p-2 rounded-circle">
                                    <i class="fas fa-industry"></i>
                                </span>
                            </div>
                            <div>
                                <h6 class="mb-2">الشركات المصنعة</h6>
                                <ul class="text-muted small mb-0 ps-3">
                                    <li>يمكنك اختيار شركة أو أكثر</li>
                                    <li>استخدم البحث للعثور بسرعة</li>
                                    <li>يمكن تحديد الكل أو إلغاء الكل</li>
                                    <li>التبديل بين عرض القائمة والبطاقات</li>
                                </ul>
                            </div>
                        </div>
                    </div>

                    <!-- Origin Yarn Help -->
                    <div class="help-item">
                        <div class="d-flex">
                            <div class="help-icon me-3">
                                <span class="badge bg-info bg-opacity-10 text-info p-2 rounded-circle">
                                    <i class="fas fa-link"></i>
                                </span>
                            </div>
                            <div>
                                <h6 class="mb-2">الغزل المكون</h6>
                                <ul class="text-muted small mb-0 ps-3">
                                    <li>اختياري</li>
                                    <li>يمكنك تحديد الغزل الأساسي المكون</li>
                                </ul>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Toast Container -->
<div class="toast-container position-fixed bottom-0 end-0 p-3"></div>

<style>
    /* Custom Properties */
    :root {
        --primary-color: #4e73df;
        --success-color: #1cc88a;
        --info-color: #36b9cc;
        --warning-color: #f6c23e;
        --danger-color: #e74a3b;
        --transition-base: all 0.3s ease;
    }

    /* Form Sections */
    .form-section {
        transition: var(--transition-base);
        border: 1px solid rgba(0,0,0,0.05);
    }

        .form-section:hover {
            transform: translateY(-2px);
            box-shadow: 0 0.5rem 1rem rgba(0,0,0,0.05);
        }

    /* Enhanced Form Controls */
    .form-control, .form-select {
        transition: var(--transition-base);
        border: 1px solid rgba(0,0,0,0.1);
    }

        .form-control:focus, .form-select:focus {
            box-shadow: 0 0 0 0.25rem rgba(78,115,223,0.25);
            border-color: var(--primary-color);
        }

    /* Enhanced Manufacturers UI Styles */
    .manufacturers-container {
        border: 2px solid rgba(0,0,0,0.1);
        transition: var(--transition-base);
    }

        .manufacturers-container:focus-within {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.25rem rgba(78,115,223,0.1);
        }

    .manufacturer-item {
        transition: var(--transition-base);
        cursor: pointer;
        border: 2px solid transparent;
        background: white;
    }

        .manufacturer-item:hover {
            background-color: #f8f9fa;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .manufacturer-item.selected {
            background: linear-gradient(135deg, var(--success-color), #28a745);
            color: white;
            border-color: var(--success-color);
            transform: scale(1.02);
        }

            .manufacturer-item.selected:hover {
                background: linear-gradient(135deg, #28a745, var(--success-color));
            }

    /* Grid View */
    .manufacturers-grid .manufacturer-item {
        border-radius: 12px;
        padding: 1rem;
        text-align: center;
        min-height: 80px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    /* List View */
    .manufacturers-list .manufacturer-item {
        border-radius: 8px;
        padding: 0.75rem 1rem;
        margin-bottom: 0.5rem;
        display: flex;
        align-items: center;
        justify-content: space-between;
    }

    /* Selected Tags */
    .selected-tag {
        background: var(--success-color);
        color: white;
        padding: 0.25rem 0.75rem;
        border-radius: 15px;
        font-size: 0.85rem;
        display: inline-flex;
        align-items: center;
        gap: 0.5rem;
        transition: var(--transition-base);
    }

        .selected-tag:hover {
            background: #28a745;
            transform: scale(1.05);
        }

        .selected-tag .remove-tag {
            cursor: pointer;
            opacity: 0.8;
            transition: var(--transition-base);
        }

            .selected-tag .remove-tag:hover {
                opacity: 1;
                transform: scale(1.2);
            }

    /* Search Box */
    .manufacturer-search-box .input-group {
        border-radius: 25px;
        overflow: hidden;
    }

    .manufacturer-search-box .form-control:focus {
        box-shadow: none;
        border-color: transparent;
    }

    /* Progress Bar Animation */
    .progress-bar {
        background: linear-gradient(45deg, var(--primary-color), var(--success-color));
        background-size: 200% 200%;
        animation: gradient 2s ease infinite;
    }

    @@keyframes gradient {
        0%

    {
        background-position: 0% 50%;
    }

    50% {
        background-position: 100% 50%;
    }

    100% {
        background-position: 0% 50%;
    }

    }

    /* Help Items */
    .help-item {
        transition: var(--transition-base);
        padding: 1rem;
        border-radius: 1rem;
    }

        .help-item:hover {
            background-color: rgba(0,0,0,0.02);
        }

    /* Button Enhancements */
    .btn {
        border-radius: 0.5rem;
        padding: 0.5rem 1.5rem;
        transition: var(--transition-base);
    }

        .btn:hover {
            transform: translateY(-1px);
        }

    /* Required Field Indicator */
    .required:after {
        content: " *";
        color: var(--danger-color);
    }

    /* Animation for selection */
    @@keyframes selectBounce {
        0%

    {
        transform: scale(1);
    }

    50% {
        transform: scale(1.1);
    }

    100% {
        transform: scale(1.02);
    }

    }

    .manufacturer-item.just-selected {
        animation: selectBounce 0.3s ease;
    }

    /* Responsive Adjustments */
    @@media (max-width: 768px) {
        .form-section

    {
        padding: 1rem !important;
    }

    .btn {
        width: 100%;
        margin-bottom: 0.5rem;
    }

    .manufacturers-grid {
        grid-template-columns: 1fr 1fr;
    }

    .help-items {
        display: none;
    }

    .selected-count {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    }
</style>

<script>
    // Enhanced Manufacturers Selection JavaScript
    class ManufacturersSelector {
        constructor() {
            this.selectedIds = new Set();
            this.manufacturers = [];
            this.isGridView = false;
            this.init();
        }

        init() {
            this.loadManufacturers();
            this.bindEvents();
            this.renderManufacturers();
            this.updateDisplay();
        }

        loadManufacturers() {
            // Get manufacturers from the select options
            const select = document.getElementById('hiddenManufacturerSelect');
            this.manufacturers = Array.from(select.options).map(option => ({
                id: option.value,
                name: option.text,
                selected: option.selected
            }));

            // Initialize selected items
            this.manufacturers.forEach(manufacturer => {
                if (manufacturer.selected) {
                    this.selectedIds.add(manufacturer.id);
                }
            });
        }

        bindEvents() {
            // Search functionality
            document.getElementById('manufacturerSearch').addEventListener('input', (e) => {
                this.filterManufacturers(e.target.value);
            });

            // Clear search
            document.getElementById('clearSearch').addEventListener('click', () => {
                document.getElementById('manufacturerSearch').value = '';
                this.filterManufacturers('');
            });

            // Select all
            document.getElementById('selectAll').addEventListener('click', () => {
                this.selectAll();
            });

            // Clear all
            document.getElementById('clearAll').addEventListener('click', () => {
                this.clearAll();
            });

            // Toggle view
            document.getElementById('toggleView').addEventListener('click', () => {
                this.toggleView();
            });
        }

        renderManufacturers(filteredManufacturers = null) {
            const manufacturersToRender = filteredManufacturers || this.manufacturers;
            const container = document.getElementById('manufacturersList');

            container.className = `manufacturers-${this.isGridView ? 'grid' : 'list'} p-3`;

            if (this.isGridView) {
                container.style.display = 'grid';
                container.style.gridTemplateColumns = 'repeat(auto-fill, minmax(200px, 1fr))';
                container.style.gap = '1rem';
            } else {
                container.style.display = 'block';
                container.style.gridTemplateColumns = 'none';
            }

            container.innerHTML = manufacturersToRender.map(manufacturer => `
                <div class="manufacturer-item ${this.selectedIds.has(manufacturer.id) ? 'selected' : ''}"
                     data-id="${manufacturer.id}"
                     onclick="manufacturersSelector.toggleManufacturer('${manufacturer.id}')">
                    <div class="manufacturer-content">
                        <div class="d-flex align-items-center ${this.isGridView ? 'justify-content-center' : ''}">
                            <i class="fas fa-industry me-2 ${this.selectedIds.has(manufacturer.id) ? 'text-white' : 'text-primary'}"></i>
                            <span class="manufacturer-name">${manufacturer.name}</span>
                        </div>
                        ${!this.isGridView ? `
                            <div class="manufacturer-status">
                                <i class="fas fa-${this.selectedIds.has(manufacturer.id) ? 'check-circle text-white' : 'circle text-muted'}"></i>
                            </div>
                        ` : ''}
                    </div>
                </div>
            `).join('');

            // Show/hide no results message
            if (manufacturersToRender.length === 0) {
                container.innerHTML = `
                    <div class="text-center p-4 text-muted">
                        <i class="fas fa-search fa-2x mb-3"></i>
                        <p>لا توجد نتائج مطابقة</p>
                    </div>
                `;
            }
        }

        toggleManufacturer(id) {
            const item = document.querySelector(`.manufacturer-item[data-id="${id}"]`);

            if (this.selectedIds.has(id)) {
                this.selectedIds.delete(id);
                item.classList.remove('selected');
            } else {
                this.selectedIds.add(id);
                item.classList.add('selected', 'just-selected');

                // Remove animation class after animation completes
                setTimeout(() => {
                    item.classList.remove('just-selected');
                }, 300);
            }

            this.updateHiddenSelect();
            this.updateDisplay();
            this.showToast(`تم ${this.selectedIds.has(id) ? 'تحديد' : 'إلغاء تحديد'} ${this.getManufacturerName(id)}`);
        }

        selectAll() {
            const visibleItems = document.querySelectorAll('.manufacturer-item');
            visibleItems.forEach(item => {
                const id = item.dataset.id;
                this.selectedIds.add(id);
                item.classList.add('selected');
            });

            this.updateHiddenSelect();
            this.updateDisplay();
            this.showToast('تم تحديد جميع الشركات المرئية');
        }

        clearAll() {
            this.selectedIds.clear();
            document.querySelectorAll('.manufacturer-item').forEach(item => {
                item.classList.remove('selected');
            });

            this.updateHiddenSelect();
            this.updateDisplay();
            this.showToast('تم إلغاء تحديد جميع الشركات');
        }

        toggleView() {
            this.isGridView = !this.isGridView;
            const button = document.getElementById('toggleView');
            const icon = button.querySelector('i');

            if (this.isGridView) {
                button.innerHTML = '<i class="fas fa-list me-1"></i>عرض القائمة';
            } else {
                button.innerHTML = '<i class="fas fa-th-large me-1"></i>عرض البطاقات';
            }

            this.renderManufacturers();
        }

        filterManufacturers(searchTerm) {
            const filtered = this.manufacturers.filter(manufacturer =>
                manufacturer.name.toLowerCase().includes(searchTerm.toLowerCase())
            );
            this.renderManufacturers(filtered);
        }

        updateHiddenSelect() {
            const select = document.getElementById('hiddenManufacturerSelect');
            Array.from(select.options).forEach(option => {
                option.selected = this.selectedIds.has(option.value);
            });
        }

        updateDisplay() {
            // Update count
            const countElement = document.getElementById('selectedCount');
            const count = this.selectedIds.size;
            countElement.textContent = `${count} محدد`;
            countElement.className = `badge rounded-pill ${count > 0 ? 'bg-success' : 'bg-primary'}`;

            // Update selected display
            const selectedDisplay = document.getElementById('selectedDisplay');
            const selectedTags = document.getElementById('selectedTags');

            if (count > 0) {
                selectedDisplay.style.display = 'block';
                selectedTags.innerHTML = Array.from(this.selectedIds).map(id => `
                    <span class="selected-tag">
                        ${this.getManufacturerName(id)}
                        <i class="fas fa-times remove-tag" onclick="manufacturersSelector.toggleManufacturer('${id}')"></i>
                    </span>
                `).join('');
            } else {
                selectedDisplay.style.display = 'none';
            }

            // Update form progress
            this.updateFormProgress();
        }

        getManufacturerName(id) {
            const manufacturer = this.manufacturers.find(m => m.id === id);
            return manufacturer ? manufacturer.name : '';
        }

        updateFormProgress() {
            const progressBar = document.getElementById('formProgress');
            const itemName = document.getElementById('Item').value;
            const selectedCount = this.selectedIds.size;

            let progress = 0;
            if (itemName.trim()) progress += 40;
            if (selectedCount > 0) progress += 40;
            if (document.getElementById('Comment').value.trim()) progress += 20;

            progressBar.style.width = `${progress}%`;
        }

        showToast(message, type = 'success') {
            const toastContainer = document.querySelector('.toast-container');
            const toastId = 'toast-' + Date.now();

            const toast = document.createElement('div');
            toast.className = `toast align-items-center text-white bg-${type} border-0`;
            toast.id = toastId;
            toast.setAttribute('role', 'alert');
            toast.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body">
                        <i class="fas fa-${type === 'success' ? 'check-circle' : 'info-circle'} me-2"></i>
                        ${message}
                    </div>
                    <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button>
                </div>
            `;

            toastContainer.appendChild(toast);
            const bsToast = new bootstrap.Toast(toast);
            bsToast.show();

            // Remove toast element after it's hidden
            toast.addEventListener('hidden.bs.toast', () => {
                toast.remove();
            });
        }
    }

    // Initialize the manufacturers selector
    let manufacturersSelector;

    document.addEventListener('DOMContentLoaded', function() {
        // Initialize manufacturers selector
        manufacturersSelector = new ManufacturersSelector();

        // Initialize tooltips
        var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
        var tooltipList = tooltipTriggerList.map(function(tooltipTriggerEl) {
            return new bootstrap.Tooltip(tooltipTriggerEl);
        });

        // Status toggle functionality
        const statusToggle = document.querySelector('input[name="Status"]');
        const statusText = document.getElementById('statusText');

        if (statusToggle) {
            statusToggle.addEventListener('change', function() {
                statusText.textContent = this.checked ? 'نشط' : 'غير نشط';
                statusText.className = this.checked ? 'text-success' : 'text-muted';
            });
        }

        // Character count for comments
        const commentTextarea = document.getElementById('Comment');
        if (commentTextarea) {
            const updateCharCount = () => {
                const count = commentTextarea.value.length.toString();
                document.getElementById('charCount').textContent = toArabicDigits(count);

                // Update progress
                manufacturersSelector.updateFormProgress();
            };

            commentTextarea.addEventListener('input', updateCharCount);
            updateCharCount(); // Initial count
        }

        // Item name progress update
        const itemInput = document.getElementById('Item');
        if (itemInput) {
            itemInput.addEventListener('input', () => {
                manufacturersSelector.updateFormProgress();
            });
        }

        // Initialize Select2 for Origin Yarn
        if (typeof $.fn.select2 !== 'undefined') {
            $('.select2-origin').select2({
                theme: 'bootstrap4',
                placeholder: 'اختر الغزل المكون...',
                allowClear: true,
                dir: 'rtl'
            });
        }

        // Form validation enhancement
        const form = document.getElementById('createForm');
        if (form) {
            form.addEventListener('submit', function(e) {
                if (!this.checkValidity()) {
                    e.preventDefault();
                    e.stopPropagation();

                    // Show validation toast
                    manufacturersSelector.showToast('يرجى التحقق من البيانات المدخلة', 'danger');

                    // Focus on first invalid field
                    const firstInvalid = this.querySelector(':invalid');
                    if (firstInvalid) {
                        firstInvalid.focus();
                    }
                } else {
                    // Show success message
                    const submitBtn = document.getElementById('submitBtn');
                    submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin me-2"></i>جاري الحفظ...';
                    submitBtn.disabled = true;
                }

                this.classList.add('was-validated');
            });
        }
    });

    // Arabic/Latin digits conversion functions
    function toArabicDigits(str) {
        return str.replace(/[0-9]/g, d => '٠١٢٣٤٥٦٧٨٩'[d]);
    }

    function toLatinDigits(str) {
        return str.replace(/[٠-٩]/g, d => '0123456789'['٠١٢٣٤٥٦٧٨٩'.indexOf(d)]);
    }

    function isArabicChar(c) {
        return /[\u0600-\u06FF]/.test(c);
    }

    function isEnglishChar(c) {
        return /[a-zA-Z]/.test(c);
    }

    function getLastLetter(str) {
        for (let i = str.length - 1; i >= 0; i--) {
            let char = str[i];
            if (isArabicChar(char)) {
                return 'arabic';
            } else if (isEnglishChar(char)) {
                return 'english';
            }
        }
        return 'arabic';
    }

    // Enhanced input processing
    document.addEventListener("input", function (e) {
        if (e.target.closest("#createForm")) {
            let input = e.target;
            let val = input.value;

            if (input.type === 'text' || input.tagName === 'TEXTAREA') {
                if (input.id === 'Item') {
                    if (val.length > 0) {
                        let lastLetterLang = getLastLetter(val);
                        let newVal = lastLetterLang === 'arabic' ?
                            toArabicDigits(val) :
                            toLatinDigits(val);

                        if (newVal !== val) {
                            let cursorPos = input.selectionStart;
                            input.value = newVal;
                            input.setSelectionRange(cursorPos, cursorPos);
                        }
                    }
                }
                else if (input.id === 'Comment') {
                    if (val.length > 0) {
                        let newVal = toArabicDigits(val);
                        if (newVal !== val) {
                            let cursorPos = input.selectionStart;
                            input.value = newVal;
                            input.setSelectionRange(cursorPos, cursorPos);
                        }
                    }
                }
            }
        }
    });

    // Keyboard shortcuts
    document.addEventListener('keydown', function(e) {
        // Ctrl + A to select all manufacturers (when search is focused)
        if (e.ctrlKey && e.key === 'a' && document.activeElement.id === 'manufacturerSearch') {
            e.preventDefault();
            manufacturersSelector.selectAll();
        }

        // Escape to clear search
        if (e.key === 'Escape' && document.activeElement.id === 'manufacturerSearch') {
            document.getElementById('manufacturerSearch').value = '';
            manufacturersSelector.filterManufacturers('');
        }
    });

    // Auto-save functionality (optional)
    let autoSaveTimeout;
    function autoSave() {
        clearTimeout(autoSaveTimeout);
        autoSaveTimeout = setTimeout(() => {
            const formData = new FormData(document.getElementById('createForm'));
            // Here you could implement auto-save to localStorage or server
            console.log('Auto-saving form data...');
        }, 2000);
    }

    // Listen for form changes for auto-save
    document.getElementById('createForm').addEventListener('input', autoSave);
</script>