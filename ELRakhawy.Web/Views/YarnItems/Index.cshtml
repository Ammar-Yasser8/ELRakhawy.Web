@using ELRakhawy.EL.ViewModels
@model IEnumerable<YarnItemViewModel>
@{
    ViewData["Title"] = "إدارة أصناف الغزل";
    var totalItems = Model.Count();
    var activeItems = Model.Count(x => x.Status);
}

<!-- Enhanced Navigation Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
    <div class="card border-0 shadow-sm">
        <div class="card-body py-2">
            <ol class="breadcrumb mb-0 align-items-center">
                <li class="breadcrumb-item">
                    <a href="@Url.Action("Dashboard", "YarnItems")" class="text-decoration-none d-flex align-items-center">
                        <i class="fas fa-home text-primary me-2"></i>
                        <span class="fw-semibold">الرئيسية</span>
                    </a>
                </li>
             
                <li class="breadcrumb-item active d-flex align-items-center">
                    <i class="fas fa-box text-success me-2"></i>
                    <span class="fw-bold text-dark">@ViewData["Title"]</span>
                </li>
            </ol>
        </div>
    </div>
</nav>


<!-- Alerts -->
@if (TempData["Success"] != null || TempData["Error"] != null)
{
    <div class="alert @(TempData["Success"] != null ? "alert-success" : "alert-danger") alert-dismissible fade show mb-3">
        <i class="fas @(TempData["Success"] != null ? "fa-check-circle" : "fa-exclamation-circle") me-2"></i>
        @(TempData["Success"] ?? TempData["Error"])
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- Main Content -->
<div class="card shadow-sm">
    <!-- Compact Header -->
    <div class="card-header bg-white border-bottom py-2">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h5 class="mb-0">
                    <i class="fas fa-box text-primary me-2"></i>
                    أصناف الغزل
                    <small class="text-muted ms-2">(<span id="visibleCount">@totalItems</span> من @totalItems)</small>
                </h5>
            </div>
            <div class="col-md-6 text-end">
                <button class="btn btn-success btn-sm me-2" id="openCreateModal">
                    <i class="fas fa-plus me-1"></i>إضافة جديد
                </button>
                <div class="btn-group">
                    <button class="btn btn-outline-secondary btn-sm dropdown-toggle" data-bs-toggle="dropdown">
                        <i class="fas fa-cog"></i>
                    </button>
                    <ul class="dropdown-menu">
                        <li><button class="dropdown-item" id="clearAllSearches">
                            <i class="fas fa-eraser me-1"></i>مسح البحث
                        </button></li>
                        <li><button class="dropdown-item" onclick="exportToExcel()">
                            <i class="fas fa-file-excel me-1"></i>تصدير Excel
                        </button></li>
                        <li><button class="dropdown-item" onclick="printTable()">
                            <i class="fas fa-print me-1"></i>طباعة
                        </button></li>
                    </ul>
                </div>
            </div>
        </div>
    </div>

    <div class="card-body p-0">
        <!-- Mobile Cards View -->
        <div class="d-block d-lg-none" id="mobileCards">
            <!-- Mobile Global Search -->
            <div class="p-3 border-bottom bg-light">
                <input type="text" class="form-control" id="mobileGlobalSearch" placeholder="بحث سريع...">
            </div>

            @foreach (var item in Model)
            {
                <div class="border-bottom p-3 mobile-item-card"
                     data-status="@(item.Status ? "active" : "inactive")"
                     data-balance="@item.CurrentBalance"
                     data-search-content="@item.Item @(item.ManufacturerNames != null ? string.Join(", ", item.ManufacturerNames) : "") @(item.OriginYarnName ?? "") @(item.Comment ?? "")">
                    
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0 text-primary fw-bold">@item.Item</h6>
                        <span class="badge bg-@(item.Status ? "success" : "secondary")">
                            @(item.Status ? "نشط" : "غير نشط")
                        </span>
                    </div>

                    <div class="row g-2 small text-muted mb-2">
                        <div class="col-6">
                            <strong>الشركة:</strong> @(item.ManufacturerNames != null && item.ManufacturerNames.Any() ? string.Join(", ", item.ManufacturerNames) : "غير محدد")
                        </div>
                        <div class="col-6">
                            <strong>الرصيد:</strong> 
                            <span class="text-@(item.CurrentBalance <= 0 ? "danger" : item.CurrentBalance <= 10 ? "warning" : "success")">
                                @item.CurrentBalance.ToString("N1") كجم
                            </span>
                        </div>
                    </div>

                    <div class="d-flex gap-1">
                        <button class="btn btn-sm btn-outline-info view-details flex-fill" data-id="@item.Id">
                            <i class="fas fa-info-circle"></i> تفاصيل
                        </button>
                        <button class="btn btn-sm btn-outline-primary edit-btn flex-fill" data-id="@item.Id">
                            <i class="fas fa-edit"></i> تعديل
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-item" data-id="@item.Id" data-name="@item.Item">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            }
       
        </div>

        <!-- Desktop Table -->
        <div class="d-none d-lg-block">
            <div class="table-responsive">
                <div class="table-toolbar mb-2"></div>
                <table id="itemsTable" class="table table-hover table-sm mb-0">

                    <thead class="table-light">
                        <!-- Headers -->
                        <tr>
                            <th style="width: 25%;">الصنف</th>
                            <th style="width: 20%;">الشركة المصنعة</th>
                            <th style="width: 15%;">الغزل المكون</th>
                            <th style="width: 10%;">الحالة</th>
                            <th style="width: 12%;">الرصيد</th>
                            <th style="width: 8%;">العدد</th>
                            <th style="width: 7%;">الإجراءات</th>
                        </tr>
                        <!-- Instant Search Row -->
                        <tr class="search-row">
                            <th>
                                <input type="text" class="form-control form-control-sm instant-search" 
                                       placeholder="بحث الأصناف..." data-column="0">
                            </th>
                            <th>
                                <input type="text" class="form-control form-control-sm instant-search" 
                                       placeholder="بحث الشركات..." data-column="1">
                            </th>
                            <th>
                                <input type="text" class="form-control form-control-sm instant-search" 
                                       placeholder="بحث الغزل..." data-column="2">
                            </th>
                            <th>
                                <select class="form-select form-select-sm instant-search" data-column="3">
                                    <option value="">الكل</option>
                                    <option value="نشط">نشط</option>
                                    <option value="غير نشط">غير نشط</option>
                                </select>
                            </th>
                            <th>
                                <select class="form-select form-select-sm instant-search" data-column="4">
                                    <option value="">جميع الأرصدة</option>
                                    <option value="zero">بدون رصيد</option>
                                    <option value="low">رصيد منخفض</option>
                                    <option value="high">رصيد عالي</option>
                                </select>
                            </th>
                            <th>
                                <input type="number" class="form-control form-control-sm instant-search" 
                                       placeholder="العدد..." data-column="5">
                            </th>
                            <th>
                                <button type="button" class="btn btn-sm btn-outline-secondary w-100" id="clearAllFilters">
                                    <i class="fas fa-times"></i>
                                </button>
                            </th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var item in Model)
                        {
                            <tr data-status="@(item.Status ? "active" : "inactive")"
                                data-balance="@item.CurrentBalance"
                                data-search-content="@item.Item @(item.ManufacturerNames != null ? string.Join(", ", item.ManufacturerNames) : "") @(item.OriginYarnName ?? "") @(item.Comment ?? "")"
                                class="table-row">
                                <td>
                                    <div class="fw-semibold">@item.Item</div>
                                    @if (!string.IsNullOrEmpty(item.Comment))
                                    {
                                        <small class="text-muted d-block text-truncate" style="max-width: 200px;">@item.Comment</small>
                                    }
                                </td>
                                <td>
                                    <span class="@(item.ManufacturerNames != null && item.ManufacturerNames.Any() ? "text-success" : "text-muted")">
                                        @(item.ManufacturerNames != null && item.ManufacturerNames.Any() ? string.Join(", ", item.ManufacturerNames) : "غير محدد")
                                    </span>
                                </td>
                                <td>
                                    <span class="@(!string.IsNullOrEmpty(item.OriginYarnName) ? "text-info" : "text-muted")">
                                        @(item.OriginYarnName ?? "غير محدد")
                                    </span>
                                </td>
                                <td>
                                    <span class="badge bg-@(item.Status ? "success" : "secondary") text-white">
                                        @(item.Status ? "نشط" : "غير نشط")
                                    </span>
                                </td>
                                <td>
                                    <span class="fw-bold text-@(item.CurrentBalance <= 0 ? "danger" : item.CurrentBalance <= 10 ? "warning" : "success")">
                                        @item.CurrentBalance.ToString("N1")
                                    </span>
                                    <small class="text-muted d-block">كجم</small>
                                </td>
                                <td class="text-center">
                                    <span class="fw-bold">@item.CurrentCountBalance</span>
                                </td>
                                <td>
                                    <div class="btn-group btn-group-sm">
                                        <button class="btn btn-outline-info btn-sm view-details" data-id="@item.Id" title="عرض التفاصيل">
                                            <i class="fas fa-info-circle"></i>
                                        </button>
                                        <a href="@Url.Action("Edit", new { id = item.Id })" class="btn btn-outline-primary btn-sm" title="تعديل">
                                            <i class="fas fa-edit"></i>
                                        </a>
                                        <button class="btn btn-outline-danger btn-sm delete-item" 
                                                data-id="@item.Id" data-name="@item.Item" title="حذف">
                                            <i class="fas fa-trash"></i>
                                        </button>
                                    </div>
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
            <script>
                document.addEventListener("DOMContentLoaded", function () {
                    const table = document.getElementById("itemsTable");
                    if (!table) return;

                    const headers = table.querySelectorAll("thead tr:first-child th");
                    if (headers.length === 0) return;

                    const toolbar = table.closest(".table-responsive").querySelector(".table-toolbar");
                    if (!toolbar) return;

                    const btnGroup = document.createElement("div");
                    btnGroup.className = "btn-group mb-2";
                    btnGroup.innerHTML = `
                        <button type="button" class="btn btn-outline-dark dropdown-toggle" data-bs-toggle="dropdown">
                            <i class="fas fa-columns me-1"></i> إظهار/إخفاء الأعمدة
                        </button>
                        <ul class="dropdown-menu column-toggle-menu"></ul>
                    `;
                    toolbar.appendChild(btnGroup);

                    const toggleMenu = btnGroup.querySelector(".column-toggle-menu");

                    headers.forEach((th, index) => {
                        const title = th.innerText.trim() || `عمود ${index + 1}`;
                        const li = document.createElement("li");
                        li.innerHTML = `
                            <label class="dropdown-item">
                                <input type="checkbox" class="me-2 column-toggle" data-index="${index}" checked>
                                ${title}
                            </label>`;
                        toggleMenu.appendChild(li);
                    });

                    document.body.addEventListener("change", function (e) {
                        if (!e.target.classList.contains("column-toggle")) return;

                        const colIndex = e.target.getAttribute("data-index");
                        const isVisible = e.target.checked;

                        table.querySelectorAll("tr").forEach(row => {
                            const cells = row.querySelectorAll("th, td");
                            if (cells[colIndex]) {
                                cells[colIndex].style.display = isVisible ? "" : "none";
                            }
                        });
                    });
                });
            </script>
        </div>
    </div>

    <!-- Compact Footer -->
    <div class="card-footer bg-light py-2">
        <div class="row align-items-center">
            <div class="col-md-6">
                <small class="text-muted">
                    إجمالي: <span class="badge bg-primary">@totalItems</span>
                    نشطة: <span class="badge bg-success">@activeItems</span>
                </small>
            </div>
            
        </div>
    </div>
</div>

<!-- Create/Edit Modal -->
<div class="modal fade" id="yarnItemModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle me-2" id="modalIcon"></i>
                    <span id="modalTitle">إضافة صنف جديد</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="yarnItemForm">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <input type="hidden" id="yarnItemId" name="Id" value="0">
                    
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label for="yarnItemName" class="form-label fw-semibold required">اسم الصنف *</label>
                            <input type="text" class="form-control" id="yarnItemName" name="Item" required maxlength="200">
                            <div class="invalid-feedback" id="itemError"></div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">الحالة</label>
                            <div class="form-check form-switch mt-2">
                                <input class="form-check-input" type="checkbox" id="yarnItemStatus" name="Status" checked>
                                <label class="form-check-label fw-semibold" for="yarnItemStatus">
                                    <span class="status-text">نشط</span>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="originYarnSelect" class="form-label fw-semibold">الغزل المكون</label>
                            <div class="input-group">
                                <select class="form-select" id="originYarnSelect" name="OriginYarnId">
                                    <option value="">-- اختر الغزل المكون --</option>
                                </select>
                                <button type="button" class="btn btn-outline-secondary" id="refreshOriginYarns" title="تحديث القائمة">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <div class="invalid-feedback" id="originYarnError"></div>
                        </div>
                        <div class="col-md-6" id="manufacturerSection">
                            <label class="form-label fw-semibold">الشركات المصنعة</label>
                            <div class="card border">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
                                    <span class="fw-semibold small">اختر الشركات</span>
                                    <div>
                                        <button type="button" class="btn btn-sm btn-outline-success" id="selectAllManufacturers">
                                            <i class="fas fa-check-double me-1"></i>الكل
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary ms-1" id="clearAllManufacturers">
                                            <i class="fas fa-times me-1"></i>مسح
                                        </button>
                                    </div>
                                </div>
                                <div id="manufacturersContainer" class="card-body p-2" style="max-height: 120px; overflow-y: auto;">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <label for="yarnItemComment" class="form-label">البيان</label>
                            <textarea class="form-control" id="yarnItemComment" name="Comment" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-success" id="saveButton">حفظ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Details Modal (restored from original) -->
<div class="modal fade" id="yarnDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-info text-white border-bottom-0">
                <h5 class="modal-title fw-bold">
                    <i class="fas fa-info-circle me-2"></i>تفاصيل صنف الغزل
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0" id="detailsContent">
                <!-- Details content will be loaded here -->
            </div>
            <div class="modal-footer bg-light border-top">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>إغلاق
                </button>
                <button type="button" class="btn btn-primary me-2" id="editFromDetails">
                    <i class="fas fa-edit me-1"></i>تعديل
                </button>
                <button type="button" class="btn btn-danger" id="deleteFromDetails">
                    <i class="fas fa-trash me-1"></i>حذف
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">تأكيد الحذف</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-trash-alt fa-3x text-danger mb-3"></i>
                <h6>هل أنت متأكد من حذف هذا الصنف؟</h6>
                <p class="text-muted mb-0"><strong id="deleteItemName"></strong></p>
                <input type="hidden" id="deleteItemId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">حذف</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

    <!-- Export Functions -->
    <script>
                     function exportToExcel() {
                try {
                    // Get table data
                    const table = document.getElementById('itemsTable');
                    const rows = table.querySelectorAll('tr:not(.search-row)');

                    // Create Excel workbook
                    const wb = XLSX.utils.book_new();
                    const wsData = [];

                    // Add header row (skip actions column - index 6)
                    const headerCells = Array.from(table.querySelectorAll('thead tr:first-child th'));
                    const headers = headerCells
                        .map((th, index) => ({ text: th.textContent.trim().replace(/\s+/g, ' '), index }))
                        .filter(item => item.index !== 7) // Skip actions column (index 6)
                        .map(item => item.text);

                    wsData.push(headers);

                    // Add data rows
                    rows.forEach(row => {
                        // Skip search row and header
                        if (row.classList.contains('search-row') || row.querySelector('th')) return;

                        const rowData = [];
                        const cols = row.querySelectorAll('td');

                        cols.forEach((col, index) => {
                            // Skip actions column (index 6)
                            if (index === 6) return;

                            let text = col.textContent.trim().replace(/\s+/g, ' ');

                            // For yarn item name, extract just the text without icons
                            if (index === 0) {
                                text = col.querySelector('.fw-semibold')?.textContent.trim() || text;
                            }

                            rowData.push(text);
                        });

                        if (rowData.length > 0) {
                            wsData.push(rowData);
                        }
                    });

                    // Create worksheet
                    const ws = XLSX.utils.aoa_to_sheet(wsData);

                    // Set column widths
                    const colWidths = [
                        { wch: 25 }, // Yarn item name
                        { wch: 20 }, // Manufacturer
                        { wch: 15 }, // Origin Yarn
                        { wch: 10 }, // Status
                        { wch: 12 }, // Balance
                        { wch: 8 },  // Count
                    ];
                    ws['!cols'] = colWidths;

                    // Add worksheet to workbook
                    XLSX.utils.book_append_sheet(wb, ws, 'أصناف الغزل');

                    // Generate Excel file and trigger download
                    const currentDate = new Date().toISOString().slice(0, 10);
                    XLSX.writeFile(wb, `أصناف_الغزل_${currentDate}.xlsx`);

                    // Show success notification
                    if (typeof showNotification === 'function') {
                        showNotification('تم تصدير البيانات إلى Excel بنجاح', 'success');
                    }

                } catch (error) {
                    console.error('Error exporting to Excel:', error);
                    if (typeof showNotification === 'function') {
                        showNotification('حدث خطأ أثناء التصدير إلى Excel', 'error');
                    }
                }
            }
        function printTable() {
            window.print();
        }
    </script>

    <!-- Main JavaScript -->
    <script>
        $(document).ready(function() {
            // Replace existing "Add New" button with popup trigger (like original)
            $('a[href*="Create"]').replaceWith(`
                <button class="btn btn-success btn-sm" id="openCreateModal">
                    <i class="fas fa-plus me-1"></i>إضافة جديد
                </button>
            `);

            const yarnItemModal = new bootstrap.Modal(document.getElementById('yarnItemModal'));
            const detailsModal = new bootstrap.Modal(document.getElementById('yarnDetailsModal'));
            const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
            
            let isEditMode = false;
            let availableManufacturers = [];
            let availableOriginYarns = [];
            let currentItemId = null;

            // Number conversion functions (restored from original)
            function toArabicDigits(str) {
                if (typeof str !== 'string') return str;
                return str.replace(/[0-9]/g, d => '٠١٢٣٤٥٦٧٨٩'[d]);
            }

            function toLatinDigits(str) {
                if (typeof str !== 'string') return str;
                return str.replace(/[٠-٩]/g, d => '0123456789'['٠١٢٣٤٥٦٧٨٩'.indexOf(d)]);
            }

            function containsArabic(str) {
                return /[\u0600-\u06FF]/.test(str);
            }

            function shouldUseArabicNumbers(str) {
                if (!str || str.trim().length === 0) {
                    return true; // Default Arabic when empty
                }
                if (containsArabic(str)) {
                    return true;
                }
                if (/^[0-9٠-٩]+$/.test(str)) {
                    return true;
                }
                return false;
            }

            function applySmartNumberConversion($input) {
                let val = $input.val();
                let useArabicNumbers = shouldUseArabicNumbers(val || "");
                let newVal = useArabicNumbers ? toArabicDigits(val || "") : toLatinDigits(val || "");

                if (newVal !== val) {
                    let cursorPos = $input[0].selectionStart || 0;
                    $input.val(newVal);
                    try {
                        $input[0].setSelectionRange(cursorPos, cursorPos);
                    } catch (ex) {
                        $input.focus();
                    }
                }
            }

            // Apply number conversion on inputs
            $(document).on("input keyup paste", "input[type='text'], textarea, .smart-number", function () {
                applySmartNumberConversion($(this));
            });

            // Instant Search Implementation
            $('.instant-search, #mobileGlobalSearch').on('input keyup', function() {
                performInstantSearch();
            });

            function performInstantSearch() {
                const searchValues = {};
                
                // Get desktop search values
                $('.instant-search').each(function() {
                    const column = $(this).data('column');
                    const value = $(this).val().toLowerCase().trim();
                    if (value) searchValues[column] = value;
                });

                // Get mobile search value
                const mobileSearch = $('#mobileGlobalSearch').val().toLowerCase().trim();
                
                let visibleCount = 0;

                // Filter table rows (desktop)
                $('#itemsTable tbody tr').each(function() {
                    const $row = $(this);
                    let showRow = true;

                    // Check each column search
                    Object.keys(searchValues).forEach(column => {
                        const searchValue = searchValues[column];
                        const cellText = $row.find(`td:eq(${column})`).text().toLowerCase();
                        
                        if (column == '4') { // Balance column
                            const balance = parseFloat($row.data('balance') || 0);
                            if (searchValue === 'zero' && balance > 0) showRow = false;
                            else if (searchValue === 'low' && (balance <= 0 || balance > 10)) showRow = false;
                            else if (searchValue === 'high' && balance <= 100) showRow = false;
                        } else {
                            if (!cellText.includes(searchValue)) showRow = false;
                        }
                    });

                    $row.toggle(showRow);
                    if (showRow) visibleCount++;
                });

                // Filter mobile cards
                $('.mobile-item-card').each(function() {
                    const $card = $(this);
                    const searchContent = $card.data('search-content').toLowerCase();
                    const showCard = !mobileSearch || searchContent.includes(mobileSearch);
                    $card.toggle(showCard);
                });

                $('#visibleCount').text(visibleCount);
            }

            // Clear all filters
            $('#clearAllFilters, #clearAllSearches').click(function() {
                $('.instant-search, #mobileGlobalSearch').val('');
                $('#itemsTable tbody tr, .mobile-item-card').show();
                $('#visibleCount').text(@totalItems);
            });

            // Replace edit links with popup triggers (restored from original)
            $(document).on('click', 'a[href*="Edit"]', function(e) {
                e.preventDefault();
                const href = $(this).attr('href');
                const id = href.split('/').pop();
                openEditModal(parseInt(id));
            });

            // Add detail view triggers (restored from original)
            $(document).on('click', '.view-details', function(e) {
                e.preventDefault();
                const id = $(this).data('id');
                if (id) {
                    openDetailsModal(id);
                }
            });

            // Modal handlers
            $('#openCreateModal').click(function() {
                openCreateModal();
            });

            $(document).on('click', '.edit-btn', function() {
                const itemId = $(this).data('id');
                openEditModal(itemId);
            });

            $(document).on('click', '.delete-item', function() {
                const itemId = $(this).data('id');
                const itemName = $(this).data('name');
                showDeleteConfirm(itemId, itemName);
            });

            // Open create modal function (restored from original)
            function openCreateModal() {
                isEditMode = false;
                currentItemId = null;
                resetForm();
                updateModalTitle('إضافة صنف غزل جديد', 'fa-plus-circle', 'bg-success');
                loadDataAndShowModal();
            }

            // Open edit modal function (restored from original)
            function openEditModal(itemId) {
                isEditMode = true;
                currentItemId = itemId;
                resetForm();
                updateModalTitle('تعديل صنف الغزل', 'fa-edit', 'bg-primary');
                loadItemForEdit(itemId);
            }

            // Open details modal (restored from original)
            function openDetailsModal(itemId) {
                currentItemId = itemId;
                loadItemDetails(itemId);
            }

            // Update modal title and styling (restored from original)
            function updateModalTitle(title, iconClass, bgClass) {
                $('#modalTitle').text(title);
                $('#modalIcon').removeClass().addClass(`fas ${iconClass} me-2`);
                $('.modal-header').removeClass('bg-success bg-primary bg-warning').addClass(bgClass);
                $('#saveButton').html(`<i class="fas fa-save me-1"></i>${isEditMode ? 'تحديث الصنف' : 'حفظ الصنف'}`);
            }

            // Load item details (restored from original)
            function loadItemDetails(itemId) {
                $('#detailsContent').html(`
                    <div class="text-center py-4">
                        <div class="spinner-border text-primary mb-3" role="status"></div>
                        <div class="text-muted">جاري تحميل التفاصيل...</div>
                    </div>
                `);
                detailsModal.show();

                // Extract details from existing table row
                const row = $(`tr:has([data-id="${itemId}"])`);
                if (row.length) {
                    const itemName = row.find('.fw-semibold, .fw-bold').first().text().trim();
                    const status = row.data('status') === 'active';
                    const manufacturer = row.find('td:eq(1)').text().trim() || 'غير محدد';
                    const originYarn = row.find('td:eq(2)').text().trim() || 'غير محدد';
                    const balance = row.find('td:eq(4) .fw-bold').text().trim() + ' كجم';
                    const countBalance = row.find('td:eq(5) .fw-bold').text().trim();
                    const comment = row.find('small').text().trim() || 'لا يوجد بيان';

                    const detailsHtml = `
                        <div class="p-4">
                            <!-- Header -->
                            <div class="row mb-4">
                                <div class="col-12">
                                    <div class="d-flex align-items-center p-3 bg-light rounded">
                                        <div class="icon-circle bg-primary text-white me-3">
                                            <i class="fas fa-box fa-2x"></i>
                                        </div>
                                        <div>
                                            <h4 class="mb-1 fw-bold text-dark">${itemName}</h4>
                                            <span class="badge bg-${status ? 'success' : 'secondary'} px-3 py-2">
                                                <i class="fas fa-${status ? 'check' : 'times'} me-1"></i>
                                                ${status ? 'نشط' : 'غير نشط'}
                                            </span>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Details Grid -->
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title text-success">
                                                <i class="fas fa-industry me-2"></i>الشركة المصنعة
                                            </h6>
                                            <p class="card-text">${manufacturer}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title text-info">
                                                <i class="fas fa-link me-2"></i>الغزل المكون
                                            </h6>
                                            <p class="card-text">${originYarn}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title text-warning">
                                                <i class="fas fa-calculator me-2"></i>الرصيد الحالي
                                            </h6>
                                            <p class="card-text fs-5 fw-bold">${balance}</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="card h-100">
                                        <div class="card-body">
                                            <h6 class="card-title text-primary">
                                                <i class="fas fa-hashtag me-2"></i>رصيد العدد
                                            </h6>
                                            <p class="card-text fs-5 fw-bold">${countBalance} وحدة</p>
                                        </div>
                                    </div>
                                </div>
                                <div class="col-12">
                                    <div class="card">
                                        <div class="card-body">
                                            <h6 class="card-title text-secondary">
                                                <i class="fas fa-comment-alt me-2"></i>البيان والملاحظات
                                            </h6>
                                            <p class="card-text">${comment}</p>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    `;

                    $('#detailsContent').html(detailsHtml);
                }
            }

            // Edit from details (restored from original)
            $('#editFromDetails').click(function() {
                detailsModal.hide();
                if (currentItemId) {
                    setTimeout(() => openEditModal(currentItemId), 300);
                }
            });

            // Delete from details (restored from original)
            $('#deleteFromDetails').click(function() {
                detailsModal.hide();
                if (currentItemId) {
                    setTimeout(() => showDeleteConfirm(currentItemId), 300);
                }
            });

            // Reset form
            function resetForm() {
                $('#yarnItemForm')[0].reset();
                $('#yarnItemId').val('0');
                $('#yarnItemStatus').prop('checked', true);
                $('#manufacturersContainer').empty();
                $('#originYarnSelect').empty().append('<option value="">-- اختياري --</option>');
            }

            // Load data and show modal
            function loadDataAndShowModal() {
                Promise.all([loadManufacturers(), loadOriginYarns()])
                .then(() => yarnItemModal.show())
                .catch(() => showNotification('حدث خطأ أثناء تحميل البيانات', 'error'));
            }

            // Load manufacturers (restored original logic)
            function loadManufacturers() {
                return new Promise((resolve, reject) => {
                    $.ajax({
                        url: '/api/YarnItems/GetManufacturers',
                        method: 'GET',
                        success: function(response) {
                            if (response.success) {
                                availableManufacturers = response.data;
                                renderManufacturers();
                                resolve();
                            } else {
                                reject('Failed to load manufacturers');
                            }
                        },
                        error: function() {
                            // Fallback with mock data
                            availableManufacturers = [
                                {id: 1, name: 'الشركة الأولى للغزل', status: true},
                                {id: 2, name: 'مصانع النسيج المتطورة', status: true},
                                {id: 3, name: 'شركة الغزل الذهبي', status: true}
                            ];
                            renderManufacturers();
                            resolve();
                        }
                    });
                });
            }

            // Load origin yarns (restored original logic)
            function loadOriginYarns(excludeId = null) {
                return new Promise((resolve, reject) => {
                    $.ajax({
                        url: '/api/YarnItems/GetOriginYarns',
                        method: 'GET',
                        data: excludeId ? { excludeId: excludeId } : {},
                        success: function(response) {
                            if (response.success) {
                                availableOriginYarns = response.data;
                                renderOriginYarns();
                                resolve();
                            } else {
                                reject('Failed to load origin yarns');
                            }
                        },
                        error: function() {
                            reject('Failed to load origin yarns');
                        }
                    });
                });
            }

            // Render manufacturers (enhanced from original)
            function renderManufacturers() {
                const container = $('#manufacturersContainer');
                container.empty();
                
                availableManufacturers.forEach(manufacturer => {
                    if (manufacturer.status) {
                        const checkboxHtml = `
                            <div class="form-check form-check-sm">
                                <input class="form-check-input manufacturer-checkbox" type="checkbox" 
                                       value="${manufacturer.id}" id="manufacturer_${manufacturer.id}" name="ManufacturerIds">
                                <label class="form-check-label small" for="manufacturer_${manufacturer.id}">
                                    ${manufacturer.name}
                                </label>
                            </div>
                        `;
                        container.append(checkboxHtml);
                    }
                });

                // Add event listeners
                $('.manufacturer-checkbox').on('change', updateSelectedManufacturers);
            }

            // Update selected manufacturers count
            function updateSelectedManufacturers() {
                const selectedCount = $('.manufacturer-checkbox:checked').length;
                // Visual feedback could be added here
            }

            // Render origin yarns (restored original)
            function renderOriginYarns() {
                const select = $('#originYarnSelect');
                select.empty().append('<option value="">-- اختر الغزل المكون --</option>');

                availableOriginYarns.forEach(yarn => {
                    select.append(`<option value="${yarn.value}">${yarn.text}</option>`);
                });
            }

            // Load item for edit (restored original complex logic)
            function loadItemForEdit(itemId) {
                $('#formLoading').show();

                Promise.all([
                    loadManufacturers(),
                    loadOriginYarns(itemId),
                    loadItemData(itemId)
                ]).then(() => {
                    $('#formLoading').hide();
                    yarnItemModal.show();
                }).catch(error => {
                    $('#formLoading').hide();
                    showNotification('حدث خطأ أثناء تحميل بيانات الصنف', 'error');
                    console.error('Error loading item data:', error);
                });
            }

            // Load item data (restored original with API fallback)
            function loadItemData(itemId) {
                return new Promise((resolve, reject) => {
                    // Try to find in DOM first
                    const row = $(`tr[data-id="${itemId}"], .mobile-item-card[data-id="${itemId}"]`);
                    if (row.length) {
                        // Extract data from DOM
                        const itemName = row.find('.fw-bold, .fw-semibold').first().text().trim();
                        const status = row.data('status') === 'active';
                        const comment = row.find('[title]').attr('title') || 
                                       row.find('small').text().trim() || '';

                        // Populate form
                        $('#yarnItemId').val(itemId);
                        $('#yarnItemName').val(itemName);
                        $('#yarnItemStatus').prop('checked', status);
                        $('#yarnItemComment').val(comment);

                        updateStatusText();
                        resolve();
                    } else {
                        // Fallback: API call
                               $.ajax({
            url: `/api/YarnItems/${itemId}`,   // ✅ Correct
            method: 'GET',
            success: function (response) {
                if (response.success) {
                    const item = response.data;

                    $('#yarnItemId').val(item.id);
                    $('#yarnItemName').val(item.item);
                    $('#yarnItemStatus').prop('checked', item.status);
                    $('#yarnItemComment').val(item.comment);

                    updateStatusText();
                    resolve();
                } else {
                    reject(response.message || 'Failed to load item from API');
                }
            },
            error: function () {
                reject('API error loading item');
            }
        });

                    }
                });
            }

            // Status switch handler (restored)
            $('#yarnItemStatus').change(function() {
                updateStatusText();
            });

            function updateStatusText() {
                const isActive = $('#yarnItemStatus').prop('checked');
                $('.status-text').text(isActive ? 'نشط' : 'غير نشط');
            }

            // Add select/clear all manufacturers buttons functionality
            $(document).on('click', '#selectAllManufacturers', function() {
                $('.manufacturer-checkbox').prop('checked', true);
                updateSelectedManufacturers();
            });

            $(document).on('click', '#clearAllManufacturers', function() {
                $('.manufacturer-checkbox').prop('checked', false);
                updateSelectedManufacturers();
            });

            // Refresh origin yarns functionality
            $(document).on('click', '#refreshOriginYarns', function() {
                const btn = $(this);
                const originalHtml = btn.html();
                btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');

                loadOriginYarns(isEditMode ? currentItemId : null).then(() => {
                    btn.prop('disabled', false).html(originalHtml);
                    showNotification('تم تحديث قائمة الغزل المكون بنجاح', 'success');
                }).catch(() => {
                    btn.prop('disabled', false).html(originalHtml);
                    showNotification('فشل في تحديث قائمة الغزل المكون', 'error');
                });
            });

            // Show delete confirmation
            function showDeleteConfirm(itemId, itemName) {
                $('#deleteItemId').val(itemId);
                $('#deleteItemName').text(itemName);
                deleteModal.show();
            }

            // Form submission (restored original with full validation and conversion)
            $('#yarnItemForm').submit(function(e) {
                e.preventDefault();
                clearValidationErrors();

                const formData = {
                    Id: parseInt($('#yarnItemId').val()) || 0,
                    Item: $('#yarnItemName').val().trim(),
                    Status: $('#yarnItemStatus').prop('checked'),
                    Comment: $('#yarnItemComment').val().trim(),
                    OriginYarnId: $('#originYarnSelect').val() ? parseInt($('#originYarnSelect').val()) : null,
                    ManufacturerIds: $('.manufacturer-checkbox:checked').map(function() {
                        return parseInt($(this).val());
                    }).get()
                };

                // Client-side validation
                if (!formData.Item) {
                    showFieldError('yarnItemName', 'itemError', 'اسم الصنف مطلوب');
                    return;
                }

                if (formData.Item.length > 200) {
                    showFieldError('yarnItemName', 'itemError', 'اسم الصنف لا يمكن أن يزيد عن 200 حرف');
                    return;
                }

                // Convert Arabic numbers to English for server
                formData.Item = toLatinDigits(formData.Item);
                formData.Comment = toLatinDigits(formData.Comment);

                // Show loading state
                const saveButton = $('#saveButton');
                const originalText = saveButton.html();
                saveButton.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>جاري الحفظ...');

                            $.ajax({
            url: isEditMode ? `/YarnItems/Edit/${formData.Id}` : '/YarnItems/Create',
            method: 'POST',
            data: $.param(formData, true),   // ← يخلي ManufacturerIds[]=1&ManufacturerIds[]=2
            headers: {
                'X-Requested-With': 'XMLHttpRequest',
                'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
            },
            success: function (response) {
                saveButton.prop('disabled', false).html(originalText);

                if (response.success) {
                    const successMessage = isEditMode
                        ? `تم تحديث الصنف "${formData.Item}" بنجاح`
                        : `تم إضافة الصنف "${formData.Item}" بنجاح`;

                    showNotification(successMessage, 'success');
                    yarnItemModal.hide();

                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                } else {
                    handleValidationErrors(response);
                }
            },
            error: function (xhr) {
                saveButton.prop('disabled', false).html(originalText);

                if (xhr.status === 400 && xhr.responseJSON) {
                    handleValidationErrors(xhr.responseJSON);
                } else {
                    showNotification('حدث خطأ أثناء الحفظ', 'error');
                }
            }
        });


            });

            // Handle validation errors (restored original)
            function handleValidationErrors(response) {
                if (response.errors) {
                    Object.keys(response.errors).forEach(field => {
                        const errors = response.errors[field];
                        if (errors && errors.length > 0) {
                            const fieldMap = {
                                'Item': { input: 'yarnItemName', error: 'itemError' },
                                'OriginYarnId': { input: 'originYarnSelect', error: 'originYarnError' },
                                'ManufacturerIds': { input: '', error: '' }
                            };

                            const mapping = fieldMap[field];
                            if (mapping && mapping.input) {
                                showFieldError(mapping.input, mapping.error, errors[0]);
                            }
                        }
                    });
                }

                if (response.message) {
                    showNotification(response.message, 'error');
                }
            }

            // Show field error
            function showFieldError(fieldId, errorId, message) {
                $(`#${fieldId}`).addClass('is-invalid');
                if (errorId) {
                    $(`#${errorId}`).text(message);
                }
            }

            // Clear validation errors
            function clearValidationErrors() {
                $('.form-control, .form-select').removeClass('is-invalid');
                $('.invalid-feedback').text('');
            }

            // Clear validation errors on input focus
            $(document).on('focus', '.form-control, .form-select', function() {
                $(this).removeClass('is-invalid');
                const fieldName = $(this).attr('id');
                if (fieldName) {
                    const errorMap = {
                        'yarnItemName': 'itemError',
                        'originYarnSelect': 'originYarnError'
                    };
                    const errorId = errorMap[fieldName];
                    if (errorId) {
                        $(`#${errorId}`).text('');
                    }
                }
            });

            // Confirm delete
            $('#confirmDeleteButton').click(function() {
                const itemId = $('#deleteItemId').val();
                const btn = $(this);
                const originalText = btn.text();
                
                btn.prop('disabled', true).text('جاري الحذف...');

                $.ajax({
                    url: `/api/YarnItems/${itemId}`,
                    method: 'DELETE',
                    success: function(response) {
                        btn.prop('disabled', false).text(originalText);
                        showNotification('تم حذف الصنف بنجاح', 'success');
                        deleteModal.hide();
                        
                        $(`tr:has([data-id="${itemId}"])`).fadeOut(300, function() {
                            $(this).remove();
                            $('#visibleCount').text($('#itemsTable tbody tr:visible').length);
                        });
                        $(`.mobile-item-card[data-id="${itemId}"]`).fadeOut(300);
                    },
                    error: function() {
                        btn.prop('disabled', false).text(originalText);
                        showNotification('حدث خطأ أثناء حذف الصنف', 'error');
                    }
                });
            });

            // Modal hidden events (restored from original)
            $('#yarnItemModal').on('hidden.bs.modal', function() {
                resetForm();
                currentItemId = null;
            });

            $('#yarnDetailsModal').on('hidden.bs.modal', function() {
                currentItemId = null;
            });

            // Enhanced notification function (restored original with better positioning)
            function showNotification(message, type = 'success') {
                // Try to use existing notification system first
                if (typeof showAlert === 'function') {
                    const alertType = type === 'error' ? 'danger' : type;
                    showAlert(alertType, message);
                    return;
                }

                // Fallback notification system (enhanced)
                const alertClass = type === 'error' ? 'alert-danger' :
                                  type === 'warning' ? 'alert-warning' :
                                  type === 'info' ? 'alert-info' : 'alert-success';

                const icon = type === 'error' ? 'fa-exclamation-circle' :
                            type === 'warning' ? 'fa-exclamation-triangle' :
                            type === 'info' ? 'fa-info-circle' : 'fa-check-circle';

                const alertHtml = `
                    <div class="alert ${alertClass} alert-dismissible fade show mb-4 shadow-sm border-0 popup-notification position-fixed" 
                         style="top: 20px; right: 20px; z-index: 1055; min-width: 300px; max-width: 400px;">
                        <div class="d-flex align-items-center">
                            <i class="fas ${icon} me-3 fa-lg"></i>
                            <div>
                                <strong>${type === 'error' ? 'خطأ!' : type === 'warning' ? 'تحذير!' : type === 'info' ? 'معلومة!' : 'نجح!'}</strong>
                                <span class="ms-2">${message}</span>
                            </div>
                        </div>
                        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
                    </div>`;

                $('body').append(alertHtml);

                // Auto-hide after 5 seconds
                setTimeout(() => {
                    $('.popup-notification').fadeOut(350, function() {
                        $(this).remove();
                    });
                }, 5000);
            }

            // Update visible count function
            function updateVisibleCount() {
                const visibleDesktop = $('#itemsTable tbody tr:visible').length;
                const visibleMobile = $('.mobile-item-card:visible').length;
                const total = Math.max(visibleDesktop, visibleMobile);
                $('#visibleCount').text(total);
            }

            // Add loading indicator to form (for consistency with original)
            function showFormLoading() {
                const loadingHtml = `
                    <div id="formLoading" class="text-center py-4 position-absolute w-100 h-100 d-flex align-items-center justify-content-center" 
                         style="background: rgba(255,255,255,0.9); top: 0; left: 0; z-index: 1000;">
                        <div>
                            <div class="spinner-border text-primary mb-3" role="status">
                                <span class="visually-hidden">جاري التحميل...</span>
                            </div>
                            <div class="text-muted">جاري تحميل البيانات...</div>
                        </div>
                    </div>
                `;
                $('.modal-body').append(loadingHtml);
            }

            function hideFormLoading() {
                $('#formLoading').remove();
            }

            console.log('Simplified YarnItems system initialized');
        });
    </script>

    <style>
        /* Compact Styles */
        .card-header {
            padding: 0.75rem 1rem;
        }
        
        .search-row th {
            padding: 0.25rem;
        }

        .search-row input, .search-row select {
            border: 1px solid #dee2e6;
            font-size: 0.875rem;
        }

        .table-sm td {
            padding: 0.5rem 0.25rem;
            vertical-align: middle;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.05);
        }

        .mobile-item-card:hover {
            background-color: rgba(0, 123, 255, 0.02);
        }

        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.775rem;
        }

        .badge {
            font-size: 0.7rem;
        }

        /* Modal Improvements */
        .modal-dialog {
            margin: 1rem;
        }

        .form-check-sm {
            margin-bottom: 0.25rem;
        }

        .form-check-sm .form-check-input {
            margin-top: 0.15rem;
        }

        .form-check-sm .form-check-label {
            font-size: 0.875rem;
        }

        /* Responsive adjustments */
        @@media (max-width: 768px) {
            .modal-lg {
                max-width: 95%;
                margin: 0.5rem;
            }
            
            .mobile-item-card {
                margin: 0.5rem;
                border-radius: 0.375rem;
            }

            .btn-group .btn {
                padding: 0.375rem 0.5rem;
                font-size: 0.8rem;
            }
        }

        /* Print styles */
        @@media print {
            body * {
                visibility: hidden;
            }
            
            .card, .card * {
                visibility: visible;
            }
            
            .card {
                position: absolute;
                top: 0;
                left: 0;
                width: 100%;
            }
            
            .card-header, .card-footer {
                background: white !important;
            }
            
            .search-row {
                display: none !important;
            }
            
            .btn-group {
                display: none !important;
            }
        }

        /* Animation for smooth filtering */
        .table-row {
            transition: opacity 0.2s ease;
        }

        .mobile-item-card {
            transition: opacity 0.2s ease;
        }

        /* Status indicator colors */
        .text-success { color: #198754 !important; }
        .text-danger { color: #dc3545 !important; }
        .text-warning { color: #fd7e14 !important; }
        .text-info { color: #0dcaf0 !important; }
        .text-muted { color: #6c757d !important; }

        /* Notification positioning */
        .alert.position-fixed {
            max-width: 400px;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        /* Form validation */
        .is-invalid {
            border-color: #dc3545;
        }

        .invalid-feedback {
            display: block;
            color: #dc3545;
            font-size: 0.875rem;
        }
    </style>
    }