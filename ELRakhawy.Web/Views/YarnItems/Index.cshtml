@using ELRakhawy.EL.ViewModels
@model IEnumerable<YarnItemViewModel>
@{
    ViewData["Title"] = "إدارة أصناف الغزل";
    var totalItems = Model.Count();
    var activeItems = Model.Count(x => x.Status);
}

<!-- Enhanced Navigation Breadcrumb -->
<nav aria-label="breadcrumb" class="mb-4">
    <div class="card border-0 shadow-sm">
        <div class="card-body py-2">
            <ol class="breadcrumb mb-0 align-items-center">
                <li class="breadcrumb-item">
                    <a href="@Url.Action("Dashboard", "YarnItems")" class="text-decoration-none d-flex align-items-center">
                        <i class="fas fa-home text-primary me-2"></i>
                        <span class="fw-semibold">الرئيسية</span>
                    </a>
                </li>
             
                <li class="breadcrumb-item active d-flex align-items-center">
                    <i class="fas fa-box text-success me-2"></i>
                    <span class="fw-bold text-dark">@ViewData["Title"]</span>
                </li>
            </ol>
        </div>
    </div>
</nav>


<!-- Alerts -->
@if (TempData["Success"] != null || TempData["Error"] != null)
{
    <div class="alert @(TempData["Success"] != null ? "alert-success" : "alert-danger") alert-dismissible fade show mb-3">
        <i class="fas @(TempData["Success"] != null ? "fa-check-circle" : "fa-exclamation-circle") me-2"></i>
        @(TempData["Success"] ?? TempData["Error"])
        <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
    </div>
}

<!-- Main Content -->
<div class="card shadow-sm">
    <!-- Compact Header -->
    <div class="card-header bg-white border-bottom py-2">
        <div class="row align-items-center">
            <div class="col-md-6">
                <h5 class="mb-0">
                    <i class="fas fa-box text-primary me-2"></i>
                    أصناف الغزل
                    <small class="text-muted ms-2">(<span id="visibleCount">@totalItems</span> من @totalItems)</small>
                </h5>
            </div>
            <div class="col-md-6 text-end">
                <div class="d-inline-flex gap-2">
                    <button class="btn btn-outline-dark btn-sm" id="toggleColumnsBtn" data-bs-toggle="dropdown">
                        <i class="fas fa-columns me-1"></i>إظهار/إخفاء
                    </button>
                    <ul class="dropdown-menu column-toggle-menu" id="columnToggleMenu"></ul>
                    
                    <button class="btn btn-success btn-sm" id="openCreateModal">
                        <i class="fas fa-plus me-1"></i>إضافة جديد
                    </button>
                    
                    <button class="btn btn-outline-danger btn-sm" id="clearAllSearches">
                        <i class="fas fa-eraser me-1"></i>مسح البحث
                    </button>
                    
                    <button class="btn btn-outline-success btn-sm" onclick="exportToExcel()">
                        <i class="fas fa-file-excel me-1"></i>تصدير Excel
                    </button>
                    
                    <button class="btn btn-outline-secondary btn-sm" onclick="printTable()">
                        <i class="fas fa-print me-1"></i>طباعة
                    </button>
                </div>
            </div>
        </div>
    </div>

    <div class="card-body p-0">
        <!-- Mobile Cards View -->
        <div class="d-block d-lg-none" id="mobileCards">
            <!-- Mobile Global Search -->
            <div class="p-3 border-bottom bg-light">
                <input type="text" class="form-control" id="mobileGlobalSearch" placeholder="بحث سريع...">
            </div>

            @foreach (var item in Model)
            {
                <div class="border-bottom p-3 mobile-item-card"
                     data-status="@(item.Status ? "active" : "inactive")"
                     data-balance="@item.CurrentBalance"
                     data-search-content="@item.Item @(item.ManufacturerNames != null ? string.Join(", ", item.ManufacturerNames) : "") @(item.OriginYarnName ?? "") @(item.Comment ?? "")">
                    
                    <div class="d-flex justify-content-between align-items-start mb-2">
                        <h6 class="mb-0 text-primary fw-bold">@item.Item</h6>
                        <span class="badge bg-@(item.Status ? "success" : "secondary")">
                            @(item.Status ? "نشط" : "غير نشط")
                        </span>
                    </div>

                    <div class="row g-2 small text-muted mb-2">
                        <div class="col-6">
                            <strong>الشركة:</strong> @(item.ManufacturerNames != null && item.ManufacturerNames.Any() ? string.Join(", ", item.ManufacturerNames) : "غير محدد")
                        </div>
                        <div class="col-6">
                            <strong>الرصيد:</strong> 
                            <span class="text-@(item.CurrentBalance <= 0 ? "danger" : item.CurrentBalance <= 10 ? "warning" : "success")">
                                @item.CurrentBalance.ToString("N1") كجم
                            </span>
                        </div>
                    </div>

                    <div class="d-flex gap-1">
                        <button class="btn btn-sm btn-outline-info view-details flex-fill" data-id="@item.Id">
                            <i class="fas fa-info-circle"></i> تفاصيل
                        </button>
                        <button class="btn btn-sm btn-outline-primary edit-btn flex-fill" data-id="@item.Id">
                            <i class="fas fa-edit"></i> تعديل
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-item" data-id="@item.Id" data-name="@item.Item">
                            <i class="fas fa-trash"></i>
                        </button>
                    </div>
                </div>
            }
       
        </div>

       <!-- Desktop Table -->
<div class="d-none d-lg-block">
    <div class="table-responsive">
        <table id="itemsTable" class="table table-hover table-sm mb-0">

            <thead class="table-light">
                <!-- Headers -->
                <tr>
                    <th class="sortable" style="width: 20%; cursor: pointer;" data-column="0">
                        <div class="d-flex align-items-center justify-content-between">
                            <span>الصنف</span>
                            <i class="fas fa-sort sort-icon text-muted"></i>
                        </div>
                    </th>
                    <th class="sortable" style="width: 20%; cursor: pointer;" data-column="1">
                        <div class="d-flex align-items-center justify-content-between">
                            <span>الشركة المصنعة</span>
                            <i class="fas fa-sort sort-icon text-muted"></i>
                        </div>
                    </th>
                    <th class="sortable" style="width: 20%; cursor: pointer;" data-column="2">
                        <div class="d-flex align-items-center justify-content-between">
                            <span>الغزل المكون</span>
                            <i class="fas fa-sort sort-icon text-muted"></i>
                        </div>
                    </th>
                    <th class="sortable" style="width: 15%; cursor: pointer;" data-column="3">
                        <div class="d-flex align-items-center justify-content-between">
                            <span>الحالة</span>
                            <i class="fas fa-sort sort-icon text-muted"></i>
                        </div>
                    </th>
                    <!-- ✅ New Comment Column -->
                    <th class="sortable" style="width: 15%; cursor: pointer;" data-column="4">
                        <div class="d-flex align-items-center justify-content-between">
                            <span>التعليق</span>
                            <i class="fas fa-sort sort-icon text-muted"></i>
                        </div>
                    </th>
                    <th style="width: 15%;">الإجراءات</th>
                </tr>

                <!-- Instant Search Row -->
                <tr class="search-row">
                    <th>
                        <div class="d-flex align-items-center gap-2">
                            <input type="text" class="form-control form-control-sm instant-search flex-grow-1"
                                   placeholder="بحث الأصناف..." data-column="0">
                            <div class="sort-indicator" id="sortIndicator0" style="display: none;">
                                <span class="badge bg-primary">
                                    <i class="fas fa-sort-amount-down"></i>
                                </span>
                            </div>
                        </div>
                    </th>
                    <th>
                        <div class="d-flex align-items-center gap-2">
                            <input type="text" class="form-control form-control-sm instant-search flex-grow-1"
                                   placeholder="بحث الشركات..." data-column="1">
                            <div class="sort-indicator" id="sortIndicator1" style="display: none;">
                                <span class="badge bg-primary">
                                    <i class="fas fa-sort-amount-down"></i>
                                </span>
                            </div>
                        </div>
                    </th>
                    <th>
                        <div class="d-flex align-items-center gap-2">
                            <input type="text" class="form-control form-control-sm instant-search flex-grow-1"
                                   placeholder="بحث الغزل..." data-column="2">
                            <div class="sort-indicator" id="sortIndicator2" style="display: none;">
                                <span class="badge bg-primary">
                                    <i class="fas fa-sort-amount-down"></i>
                                </span>
                            </div>
                        </div>
                    </th>
                    <th>
                        <div class="d-flex align-items-center gap-2">
                            <select class="form-select form-select-sm instant-search flex-grow-1" data-column="3">
                                <option value="">الكل</option>
                                <option value="نشط">نشط</option>
                                <option value="غير نشط">غير نشط</option>
                            </select>
                            <div class="sort-indicator" id="sortIndicator3" style="display: none;">
                                <span class="badge bg-primary">
                                    <i class="fas fa-sort-amount-down"></i>
                                </span>
                            </div>
                        </div>
                    </th>
                    <!-- ✅ Comment Search Input -->
                    <th>
                        <div class="d-flex align-items-center gap-2">
                            <input type="text" class="form-control form-control-sm instant-search flex-grow-1"
                                   placeholder="بحث التعليق..." data-column="4">
                            <div class="sort-indicator" id="sortIndicator4" style="display: none;">
                                <span class="badge bg-primary">
                                    <i class="fas fa-sort-amount-down"></i>
                                </span>
                            </div>
                        </div>
                    </th>
                    <th class="text-center">
                        <small class="text-muted">
                            <i class="fas fa-filter me-1"></i>البحث
                        </small>
                    </th>
                </tr>
            </thead>

            <tbody>
                @foreach (var item in Model)
                {
                    <tr data-status="@(item.Status ? "active" : "inactive")"
                        data-balance="@item.CurrentBalance"
                        data-search-content="@item.Item @(item.ManufacturerNames != null ? string.Join(", ", item.ManufacturerNames) : "") @(item.OriginYarnName ?? "") @(item.Comment ?? "")"
                        class="table-row item-row">

                        <td>
                            <div class="fw-semibold">@item.Item</div>
                        </td>

                        <td>
                            <span class="@(item.ManufacturerNames != null && item.ManufacturerNames.Any() ? "text-success" : "text-muted")">
                                @(item.ManufacturerNames != null && item.ManufacturerNames.Any() ? string.Join(", ", item.ManufacturerNames) : "غير محدد")
                            </span>
                        </td>

                        <td>
                            <span class="@(!string.IsNullOrEmpty(item.OriginYarnName) ? "text-info" : "text-muted")">
                                @(item.OriginYarnName ?? "غير محدد")
                            </span>
                        </td>

                        <td>
                            <span class="badge bg-@(item.Status ? "success" : "secondary") text-white">
                                @(item.Status ? "نشط" : "غير نشط")
                            </span>
                        </td>

                        <!-- ✅ Comment Column -->
                        <td>
                            @if (!string.IsNullOrEmpty(item.Comment))
                            {
                                <small class="text-muted d-block text-truncate" style="max-width: 200px;">@item.Comment</small>
                            }
                            else
                            {
                                <span class="text-muted">—</span>
                            }
                        </td>

                        <td>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-outline-info btn-sm view-details" data-id="@item.Id" title="عرض التفاصيل">
                                    <i class="fas fa-info-circle"></i>
                                </button>
                                <a href="@Url.Action("Edit", new { id = item.Id })" class="btn btn-outline-primary btn-sm" title="تعديل">
                                    <i class="fas fa-edit"></i>
                                </a>
                                <button class="btn btn-outline-danger btn-sm delete-item"
                                        data-id="@item.Id" data-name="@item.Item" title="حذف">
                                    <i class="fas fa-trash"></i>
                                </button>
                            </div>
                        </td>
                    </tr>
                }
            </tbody>

        </table>
    </div>
</div>


    <!-- Compact Footer -->
    <div class="card-footer bg-light py-2">
        <div class="row align-items-center">
            <div class="col-md-6">
                <small class="text-muted">
                    إجمالي: <span class="badge bg-primary">@totalItems</span>
                    نشطة: <span class="badge bg-success">@activeItems</span>
                </small>
            </div>
        </div>
    </div>
</div>

<style>
.sortable {
    user-select: none;
    transition: background-color 0.2s;
}

.sortable:hover {
    background-color: rgba(0, 0, 0, 0.05);
}

.sort-icon {
    font-size: 0.8rem;
    transition: all 0.2s;
}

.sortable.asc .sort-icon {
    transform: rotate(180deg);
    color: #0d6efd !important;
}

.sortable.desc .sort-icon {
    color: #0d6efd !important;
}

.column-toggle-menu {
    max-height: 300px;
    overflow-y: auto;
}

.sort-indicator {
    min-width: 35px;
    animation: fadeIn 0.3s;
}

.sort-indicator .badge {
    font-size: 0.75rem;
    padding: 0.35rem 0.5rem;
}

@@keyframes fadeIn {
    from {
        opacity: 0;
        transform: scale(0.8);
    }
    to {
        opacity: 1;
        transform: scale(1);
    }
}

/* Enhanced Print Styles */
@@media print {
    body * {
        visibility: hidden;
    }
    
    #printSection,
    #printSection * {
        visibility: visible;
    }
    
    #printSection {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        direction: rtl;
    }
    
    .print-header {
        text-align: center;
        margin-bottom: 20px;
        border-bottom: 2px solid #333;
        padding-bottom: 10px;
    }
    
    .print-header h2 {
        color: #333;
        font-size: 24px;
        margin-bottom: 5px;
        font-weight: bold;
    }
    
    .print-header p {
        color: #666;
        font-size: 12px;
        margin: 0;
    }
    
    .print-table {
        width: 100%;
        border-collapse: collapse;
        direction: rtl;
        margin-top: 10px;
        font-size: 11px;
    }
    
    .print-table th,
    .print-table td {
        border: 1px solid #333;
        padding: 8px 6px;
        text-align: right;
        vertical-align: top;
    }
    
    .print-table th {
        background-color: #f0f0f0 !important;
        font-weight: bold;
        color: #000 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .print-table tbody tr:nth-child(even) {
        background-color: #f9f9f9 !important;
        -webkit-print-color-adjust: exact;
        print-color-adjust: exact;
    }
    
    .print-footer {
        margin-top: 20px;
        padding-top: 10px;
        border-top: 1px solid #999;
        text-align: center;
        font-size: 10px;
        color: #666;
    }
    
    .print-table tr {
        page-break-inside: avoid;
    }
    
    @@page {
        margin: 1cm;
        size: A4 landscape;
    }
}
</style>

<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", function () {
    const table = document.getElementById('itemsTable');
    const tbody = table.querySelector('tbody');
    const headers = table.querySelectorAll('thead tr:first-child th');
    const columnToggleMenu = document.getElementById('columnToggleMenu');
    
    // Initialize column toggle menu
    headers.forEach((th, index) => {
        // Skip actions column (last column)
        if (index === headers.length - 1) return;
        
        const title = th.textContent.trim().replace(/\s+/g, ' ');
        const li = document.createElement("li");
        li.innerHTML = `
            <label class="dropdown-item">
                <input type="checkbox" class="me-2 column-toggle" data-index="${index}" checked>
                ${title}
            </label>`;
        columnToggleMenu.appendChild(li);
    });

    // Add "Display All" and "Hide All" options at the beginning
    const displayAllLi = document.createElement("li");
    displayAllLi.innerHTML = `
        <button class="dropdown-item" id="displayAllColumns">
            <i class="fas fa-eye text-success me-2"></i>إظهار جميع الأعمدة
        </button>`;
    columnToggleMenu.insertBefore(displayAllLi, columnToggleMenu.firstChild);

    const hideAllLi = document.createElement("li");
    hideAllLi.innerHTML = `
        <button class="dropdown-item" id="hideAllColumns">
            <i class="fas fa-eye-slash text-danger me-2"></i>إخفاء جميع الأعمدة
        </button>`;
    columnToggleMenu.insertBefore(hideAllLi, columnToggleMenu.firstChild);

    // Add separator
    const separatorLi = document.createElement("li");
    separatorLi.innerHTML = `<hr class="dropdown-divider">`;
    columnToggleMenu.appendChild(separatorLi);

    // Handle column visibility toggle
    columnToggleMenu.addEventListener("change", function (e) {
        if (!e.target.classList.contains("column-toggle")) return;

        const colIndex = parseInt(e.target.getAttribute("data-index"));
        const isVisible = e.target.checked;

        table.querySelectorAll("tr").forEach(row => {
            const cell = row.querySelectorAll("th, td")[colIndex];
            if (cell) {
                cell.style.display = isVisible ? "" : "none";
            }
        });
    });

    // Handle "Display All" button click
    columnToggleMenu.addEventListener("click", function (e) {
        if (e.target.id === "displayAllColumns") {
            e.preventDefault();
            const columnToggles = columnToggleMenu.querySelectorAll(".column-toggle");
            columnToggles.forEach((checkbox) => {
                const index = parseInt(checkbox.getAttribute("data-index"));
                checkbox.checked = true;
                // Show the column
                table.querySelectorAll("tr").forEach(row => {
                    const cell = row.querySelectorAll("th, td")[index];
                    if (cell) cell.style.display = "";
                });
            });
        }
        
        if (e.target.id === "hideAllColumns") {
            e.preventDefault();
            const columnToggles = columnToggleMenu.querySelectorAll(".column-toggle");
            columnToggles.forEach((checkbox) => {
                const index = parseInt(checkbox.getAttribute("data-index"));
                checkbox.checked = false;
                // Hide the column
                table.querySelectorAll("tr").forEach(row => {
                    const cell = row.querySelectorAll("th, td")[index];
                    if (cell) cell.style.display = "none";
                });
            });
        }
    });

    // Sorting functionality
    let sortDirection = {};
    
    document.querySelectorAll('.sortable').forEach(header => {
        const column = parseInt(header.getAttribute('data-column'));
        sortDirection[column] = 'none';
        
        header.addEventListener('click', function() {
            const rows = Array.from(tbody.querySelectorAll('tr.item-row'));
            
            if (rows.length === 0) return;
            
            if (sortDirection[column] === 'none' || sortDirection[column] === 'desc') {
                sortDirection[column] = 'asc';
            } else {
                sortDirection[column] = 'desc';
            }
            
            document.querySelectorAll('.sortable').forEach(h => {
                h.classList.remove('asc', 'desc');
                const icon = h.querySelector('.sort-icon');
                icon.className = 'fas fa-sort sort-icon text-muted';
            });
            
            document.querySelectorAll('.sort-indicator').forEach(indicator => {
                indicator.style.display = 'none';
            });
            
            header.classList.add(sortDirection[column]);
            const icon = header.querySelector('.sort-icon');
            const sortIndicator = document.getElementById('sortIndicator' + column);
            const sortBadgeIcon = sortIndicator.querySelector('i');
            
            if (sortDirection[column] === 'asc') {
                icon.className = 'fas fa-sort-up sort-icon';
                sortBadgeIcon.className = 'fas fa-sort-amount-up';
                sortIndicator.querySelector('.badge').classList.remove('bg-danger');
                sortIndicator.querySelector('.badge').classList.add('bg-success');
            } else {
                icon.className = 'fas fa-sort-down sort-icon';
                sortBadgeIcon.className = 'fas fa-sort-amount-down';
                sortIndicator.querySelector('.badge').classList.remove('bg-success');
                sortIndicator.querySelector('.badge').classList.add('bg-danger');
            }
            
            sortIndicator.style.display = 'block';
            
            rows.sort((a, b) => {
                const aCell = a.querySelectorAll('td')[column];
                const bCell = b.querySelectorAll('td')[column];
                
                let aValue = aCell.textContent.trim();
                let bValue = bCell.textContent.trim();
                
                if (aValue.includes('غير محدد') || aValue === '') aValue = '';
                if (bValue.includes('غير محدد') || bValue === '') bValue = '';
                
                const aNum = parseFloat(aValue);
                const bNum = parseFloat(bValue);
                
                let comparison = 0;
                
                if (!isNaN(aNum) && !isNaN(bNum)) {
                    comparison = aNum - bNum;
                } else {
                    comparison = aValue.localeCompare(bValue, 'ar');
                }
                
                return sortDirection[column] === 'asc' ? comparison : -comparison;
            });
            
            rows.forEach(row => tbody.appendChild(row));
        });
    });
});

// Helper functions
function getCleanCellText(cell) {
    if (!cell) return '';
    let text = cell.textContent.trim().replace(/\s+/g, ' ');
    if (text.includes('غير محدد') || text === '-') return '';
    return text;
}

function isColumnVisible(table, colIndex) {
    const firstRowCells = table.querySelectorAll('thead tr:first-child th');
    if (firstRowCells[colIndex]) {
        const th = firstRowCells[colIndex];
        // Check if column is hidden via display:none or visibility
        return th.style.display !== 'none' && th.offsetParent !== null;
    }
    return true;
}

function isRowVisible(row) {
    // Check if row is hidden via display:none or visibility
    return row.style.display !== 'none' && row.offsetParent !== null;
}

        // Export to Excel - ENHANCED RTL ARABIC FORMAT
        function exportToExcel() {
            try {
                const table = document.getElementById('itemsTable');
                const wsData = [];

                // Get all header cells
                const headerCells = table.querySelectorAll('thead tr:first-child th');
                const visibleColumnIndices = [];
                const headers = [];

                // Identify visible columns (skip actions column)
                headerCells.forEach((th, index) => {
                    // Skip actions column (last column)
                    if (index === headerCells.length - 1) return;

                    // Only include visible columns
                    if (isColumnVisible(table, index)) {
                        visibleColumnIndices.push(index);
                        const headerText = th.textContent.trim().replace(/\s+/g, ' ');
                        headers.push(headerText);
                    }
                });

                wsData.push(headers);

                // Get all data rows
                const allRows = table.querySelectorAll('tbody tr.item-row');
                let exportedRowCount = 0;

                allRows.forEach(row => {
                    // Skip hidden rows (filtered out by search)
                    if (!isRowVisible(row)) return;

                    exportedRowCount++;
                    const cols = row.querySelectorAll('td');
                    const rowData = [];

                    // Only include data from visible columns
                    visibleColumnIndices.forEach(colIndex => {
                        const cell = cols[colIndex];
                        if (!cell) {
                            rowData.push('');
                            return;
                        }

                        // Get clean text from cell
                        const text = getCleanCellText(cell);
                        rowData.push(text || '-');
                    });

                    wsData.push(rowData);
                });

                // Check if there's data to export
                if (exportedRowCount === 0) {
                    alert('لا توجد بيانات مرئية للتصدير');
                    return;
                }

                // Create Excel workbook
                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(wsData);

                // ✅ ENHANCED RTL CONFIGURATION FOR ARABIC

                // Set worksheet RTL direction
                ws['!rtl'] = true;

                // Set worksheet properties for RTL
                if (!wb.Workbook) wb.Workbook = {};
                if (!wb.Workbook.Views) wb.Workbook.Views = [{}];
                wb.Workbook.Views[0].RTL = true;

                // Configure column widths and alignment
                const colWidths = headers.map(() => ({
                    wch: 25,
                    // Set RTL alignment for each column
                    alignment: {
                        horizontal: 'right',
                        vertical: 'center',
                        readingOrder: 1 // RTL reading order
                    }
                }));
                ws['!cols'] = colWidths;

                // ✅ APPLY RTL STYLING TO ALL CELLS
                const range = XLSX.utils.decode_range(ws['!ref']);

                for (let row = range.s.r; row <= range.e.r; row++) {
                    for (let col = range.s.c; col <= range.e.c; col++) {
                        const cellAddress = XLSX.utils.encode_cell({ r: row, c: col });
                        const cell = ws[cellAddress];

                        if (cell) {
                            // Apply RTL styling to each cell
                            cell.s = {
                                alignment: {
                                    horizontal: 'right',
                                    vertical: 'center',
                                    readingOrder: 1, // RTL
                                    textRotation: 0
                                },
                                font: {
                                    name: 'Arial',
                                    sz: 11,
                                    color: { rgb: '000000' }
                                }
                            };

                            // Special styling for header row
                            if (row === 0) {
                                cell.s.fill = {
                                    fgColor: { rgb: 'E6F3FF' }
                                };
                                cell.s.font.bold = true;
                                cell.s.font.sz = 12;
                                cell.s.border = {
                                    top: { style: 'thin', color: { rgb: '000000' } },
                                    bottom: { style: 'thin', color: { rgb: '000000' } },
                                    left: { style: 'thin', color: { rgb: '000000' } },
                                    right: { style: 'thin', color: { rgb: '000000' } }
                                };
                            } else {
                                // Data rows border
                                cell.s.border = {
                                    top: { style: 'thin', color: { rgb: 'CCCCCC' } },
                                    bottom: { style: 'thin', color: { rgb: 'CCCCCC' } },
                                    left: { style: 'thin', color: { rgb: 'CCCCCC' } },
                                    right: { style: 'thin', color: { rgb: 'CCCCCC' } }
                                };
                            }
                        }
                    }
                }

                // ✅ SET WORKSHEET VIEW PROPERTIES FOR RTL
                ws['!views'] = [{
                    rightToLeft: true,
                    showGridLines: true,
                    showRowColHeaders: true
                }];

                // ✅ ADD WORKSHEET PROPERTIES FOR BETTER RTL SUPPORT
                ws['!protect'] = {
                    selectLockedCells: false,
                    selectUnlockedCells: true
                };

                // Add worksheet to workbook with Arabic name
                XLSX.utils.book_append_sheet(wb, ws, "أصناف الغزل");

                // ✅ SET WORKBOOK PROPERTIES FOR RTL
                wb.Props = {
                    Title: "أصناف الغزل",
                    Subject: "تقرير أصناف الغزل",
                    Author: "نظام إدارة أصناف الغزل",
                    CreatedDate: new Date(),
                    Language: "ar-SA" // Arabic language
                };

                // Generate filename with Arabic date
                const currentDate = new Date();
                const arabicDate = currentDate.toLocaleDateString('ar-SA');
                const isoDate = currentDate.toISOString().slice(0, 10);

                // Create filename with both Arabic and ISO date for compatibility
                const fileName = `أصناف_الغزل_${isoDate}.xlsx`;

                // ✅ WRITE FILE WITH RTL CONFIGURATION
                const wopts = {
                    bookType: 'xlsx',
                    type: 'binary',
                    cellStyles: true,
                    sheetStubs: false,
                    RTL: true // Ensure RTL at write level
                };

                XLSX.writeFile(wb, fileName, wopts);

                // Success message with Arabic formatting info
                alert(`تم تصدير ${toArabicDigits(exportedRowCount.toString())} صف و ${toArabicDigits(headers.length.toString())} عمود إلى Excel بتنسيق عربي RTL بنجاح`);

            } catch (error) {
                console.error('Error exporting to Excel:', error);
                alert('حدث خطأ أثناء التصدير إلى Excel');
            }
        }

        // ✅ HELPER FUNCTION FOR ARABIC DIGITS IN EXPORT
        function toArabicDigits(str) {
            if (typeof str !== 'string') str = str.toString();
            return str.replace(/[0-9]/g, d => '٠١٢٣٤٥٦٧٨٩'[d]);
        }

// Print function - FIXED to print only visible rows and columns
function printTable() {
    try {
        const table = document.getElementById('itemsTable');
        
        // Remove existing print section if any
        const existingPrintSection = document.getElementById('printSection');
        if (existingPrintSection) {
            existingPrintSection.remove();
        }
        
        // Create print section
        const printSection = document.createElement('div');
        printSection.id = 'printSection';

        // Create header
        const header = document.createElement('div');
        header.className = 'print-header';
        header.innerHTML = `
            <h2>أصناف الغزل</h2>
            <p>تاريخ الطباعة: ${new Date().toLocaleDateString('ar-EG', { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            })} - ${new Date().toLocaleTimeString('ar-EG')}</p>
        `;
        printSection.appendChild(header);

        // Create print table
        const printTable = document.createElement('table');
        printTable.className = 'print-table';

        // Get visible column indices (skip actions column)
        const headerCells = table.querySelectorAll('thead tr:first-child th');
        const visibleColumnIndices = [];
        
        headerCells.forEach((th, index) => {
            // Skip actions column (last column)
            if (index === headerCells.length - 1) return;
            
            // Only include visible columns
            if (isColumnVisible(table, index)) {
                visibleColumnIndices.push(index);
            }
        });

        // Create table header
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        
        visibleColumnIndices.forEach(colIndex => {
            const th = document.createElement('th');
            const headerText = headerCells[colIndex].textContent.trim().replace(/\s+/g, ' ');
            th.textContent = headerText;
            headerRow.appendChild(th);
        });
        
        thead.appendChild(headerRow);
        printTable.appendChild(thead);

        // Create table body
        const tbody = document.createElement('tbody');
        let visibleRowCount = 0;
        
        // Get only VISIBLE rows
        const allRows = table.querySelectorAll('tbody tr.item-row');
        
        allRows.forEach(row => {
            // Skip hidden rows (filtered by search)
            if (!isRowVisible(row)) return;
            
            visibleRowCount++;
            const cols = row.querySelectorAll('td');
            const tr = document.createElement('tr');
            
            visibleColumnIndices.forEach(colIndex => {
                const td = document.createElement('td');
                const cell = cols[colIndex];
                
                if (!cell) {
                    td.textContent = '-';
                } else {
                    const text = getCleanCellText(cell);
                    td.textContent = text || '-';
                }
                
                tr.appendChild(td);
            });
            
            tbody.appendChild(tr);
        });
        
        // Handle empty results
        if (visibleRowCount === 0) {
            const emptyRow = document.createElement('tr');
            const emptyCell = document.createElement('td');
            emptyCell.colSpan = visibleColumnIndices.length;
            emptyCell.textContent = 'لا توجد بيانات للعرض';
            emptyCell.style.textAlign = 'center';
            emptyCell.style.padding = '20px';
            emptyCell.style.color = '#999';
            emptyRow.appendChild(emptyCell);
            tbody.appendChild(emptyRow);
        }
        
        printTable.appendChild(tbody);
        printSection.appendChild(printTable);

        // Create footer
        const footer = document.createElement('div');
        footer.className = 'print-footer';
        footer.innerHTML = `
            <p><strong>عدد الأصناف المعروضة:</strong> ${visibleRowCount} | <strong>عدد الأعمدة:</strong> ${visibleColumnIndices.length}</p>
            <p>تم الطباعة من نظام إدارة أصناف الغزل</p>
        `;
        printSection.appendChild(footer);

        // Add to document
        document.body.appendChild(printSection);
        
        // Trigger print
        window.print();
        
        // Clean up after print dialog closes
        setTimeout(() => {
            const printSectionToRemove = document.getElementById('printSection');
            if (printSectionToRemove) {
                printSectionToRemove.remove();
            }
        }, 100);

        console.log(`Printed ${visibleRowCount} rows and ${visibleColumnIndices.length} columns`);

    } catch (error) {
        console.error('Error printing table:', error);
        alert('حدث خطأ أثناء الطباعة');
    }
}
</script>
<!-- Create/Edit Modal -->
<div class="modal fade" id="yarnItemModal" tabindex="-1">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">
                    <i class="fas fa-plus-circle me-2" id="modalIcon"></i>
                    <span id="modalTitle">إضافة صنف جديد</span>
                </h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <form id="yarnItemForm">
                @Html.AntiForgeryToken()
                <div class="modal-body">
                    <input type="hidden" id="yarnItemId" name="Id" value="0">
                    
                    <div class="row g-3">
                        <div class="col-md-8">
                            <label for="yarnItemName" class="form-label fw-semibold required">اسم الصنف *</label>
                            <input type="text" class="form-control" id="yarnItemName" name="Item" required maxlength="200">
                            <div class="invalid-feedback" id="itemError"></div>
                        </div>
                        <div class="col-md-4">
                            <label class="form-label fw-semibold">الحالة</label>
                            <div class="form-check form-switch mt-2">
                                <input class="form-check-input" type="checkbox" id="yarnItemStatus" name="Status" checked>
                                <label class="form-check-label fw-semibold" for="yarnItemStatus">
                                    <span class="status-text">نشط</span>
                                </label>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <label for="originYarnSelect" class="form-label fw-semibold">الغزل المكون</label>
                            <div class="input-group">
                                <select class="form-select" id="originYarnSelect" name="OriginYarnId">
                                    <option value="">-- اختر الغزل المكون --</option>
                                </select>
                                <button type="button" class="btn btn-outline-secondary" id="refreshOriginYarns" title="تحديث القائمة">
                                    <i class="fas fa-sync-alt"></i>
                                </button>
                            </div>
                            <div class="invalid-feedback" id="originYarnError"></div>
                        </div>
                        <div class="col-md-6" id="manufacturerSection">
                            <label class="form-label fw-semibold">الشركات المصنعة</label>
                            <div class="card border">
                                <div class="card-header bg-light d-flex justify-content-between align-items-center py-2">
                                    <span class="fw-semibold small">اختر الشركات</span>
                                    <div>
                                        <button type="button" class="btn btn-sm btn-outline-success" id="selectAllManufacturers">
                                            <i class="fas fa-check-double me-1"></i>الكل
                                        </button>
                                        <button type="button" class="btn btn-sm btn-outline-secondary ms-1" id="clearAllManufacturers">
                                            <i class="fas fa-times me-1"></i>مسح
                                        </button>
                                    </div>
                                </div>
                                <div id="manufacturersContainer" class="card-body p-2" style="max-height: 120px; overflow-y: auto;">
                                    <!-- Will be populated by JavaScript -->
                                </div>
                            </div>
                        </div>
                        <div class="col-12">
                            <label for="yarnItemComment" class="form-label">البيان</label>
                            <textarea class="form-control" id="yarnItemComment" name="Comment" rows="2"></textarea>
                        </div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                    <button type="submit" class="btn btn-success" id="saveButton">حفظ</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Details Modal (restored from original) -->
<div class="modal fade" id="yarnDetailsModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content border-0 shadow-lg">
            <div class="modal-header bg-info text-white border-bottom-0">
                <h5 class="modal-title fw-bold">
                    <i class="fas fa-info-circle me-2"></i>تفاصيل صنف الغزل
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body p-0" id="detailsContent">
                <!-- Details content will be loaded here -->
            </div>
            <div class="modal-footer bg-light border-top">
                <button type="button" class="btn btn-outline-secondary" data-bs-dismiss="modal">
                    <i class="fas fa-times me-1"></i>إغلاق
                </button>
                <button type="button" class="btn btn-primary me-2" id="editFromDetails">
                    <i class="fas fa-edit me-1"></i>تعديل
                </button>
                <button type="button" class="btn btn-danger" id="deleteFromDetails">
                    <i class="fas fa-trash me-1"></i>حذف
                </button>
            </div>
        </div>
    </div>
</div>

<!-- Delete Confirmation Modal -->
<div class="modal fade" id="deleteConfirmModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header bg-danger text-white">
                <h5 class="modal-title">تأكيد الحذف</h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body text-center">
                <i class="fas fa-trash-alt fa-3x text-danger mb-3"></i>
                <h6>هل أنت متأكد من حذف هذا الصنف؟</h6>
                <p class="text-muted mb-0"><strong id="deleteItemName"></strong></p>
                <input type="hidden" id="deleteItemId">
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">إلغاء</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteButton">حذف</button>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

   
<script>
$(document).ready(function() {
    const yarnItemModal = new bootstrap.Modal(document.getElementById('yarnItemModal'));
    const detailsModal = new bootstrap.Modal(document.getElementById('yarnDetailsModal'));
    const deleteModal = new bootstrap.Modal(document.getElementById('deleteConfirmModal'));
    
    let isEditMode = false;
    let availableManufacturers = [];
    let availableOriginYarns = [];
    let currentItemId = null;
    let selectedManufacturerIds = [];
    let selectedOriginYarnId = null;

    // ================================
    // NUMBER CONVERSION FUNCTIONS
    // ================================
    function toArabicDigits(str) {
        if (typeof str !== 'string') return str;
        return str.replace(/[0-9]/g, d => '٠١٢٣٤٥٦٧٨٩'[d]);
    }

    function toLatinDigits(str) {
        if (typeof str !== 'string') return str;
        return str.replace(/[٠-٩]/g, d => '0123456789'['٠١٢٣٤٥٦٧٨٩'.indexOf(d)]);
    }

    function containsArabic(str) {
        return /[\u0600-\u06FF]/.test(str);
    }

    function shouldUseArabicNumbers(str) {
        if (!str || str.trim().length === 0) return true;
        if (containsArabic(str)) return true;
        if (/^[0-9٠-٩]+$/.test(str)) return true;
        return false;
    }

    function applySmartNumberConversion($input) {
        let val = $input.val();
        let useArabicNumbers = shouldUseArabicNumbers(val || "");
        let newVal = useArabicNumbers ? toArabicDigits(val || "") : toLatinDigits(val || "");

        if (newVal !== val) {
            let cursorPos = $input[0].selectionStart || 0;
            $input.val(newVal);
            try {
                $input[0].setSelectionRange(cursorPos, cursorPos);
            } catch (ex) {
                $input.focus();
            }
        }
    }

    $(document).on("input keyup paste", "input[type='text'], textarea", function() {
        applySmartNumberConversion($(this));
    });

    // ================================
    // INSTANT SEARCH
    // ================================
    $('.instant-search, #mobileGlobalSearch').on('input keyup', function() {
        performInstantSearch();
    });

    function performInstantSearch() {
        const searchValues = {};
        
        $('.instant-search').each(function() {
            const column = $(this).data('column');
            const value = $(this).val().toLowerCase().trim();
            if (value) searchValues[column] = value;
        });

        const mobileSearch = $('#mobileGlobalSearch').val().toLowerCase().trim();
        let visibleCount = 0;

        $('#itemsTable tbody tr').each(function() {
            const $row = $(this);
            let showRow = true;

            Object.keys(searchValues).forEach(column => {
                const searchValue = searchValues[column];
                const cellText = $row.find(`td:eq(${column})`).text().toLowerCase();
                
                if (!cellText.includes(searchValue)) showRow = false;
            });

            $row.toggle(showRow);
            if (showRow) visibleCount++;
        });

        $('.mobile-item-card').each(function() {
            const $card = $(this);
            const searchContent = $card.data('search-content').toLowerCase();
            const showCard = !mobileSearch || searchContent.includes(mobileSearch);
            $card.toggle(showCard);
        });

        $('#visibleCount').text(visibleCount);
    }

    $('#clearAllFilters, #clearAllSearches').click(function() {
        $('.instant-search, #mobileGlobalSearch').val('');
        $('#itemsTable tbody tr, .mobile-item-card').show();
        $('#visibleCount').text($('#itemsTable tbody tr').length);
    });

    // ================================
    // MODAL HANDLERS
    // ================================
    $('#openCreateModal').click(function() {
        openCreateModal();
    });

    $(document).on('click', '.edit-btn, a[href*="Edit"]', function(e) {
        e.preventDefault();
        let itemId;
        
        if ($(this).hasClass('edit-btn')) {
            itemId = $(this).data('id');
        } else {
            const href = $(this).attr('href');
            itemId = parseInt(href.split('/').pop());
        }
        
        openEditModal(itemId);
    });

    $(document).on('click', '.view-details', function(e) {
        e.preventDefault();
        const id = $(this).data('id');
        if (id) openDetailsModal(id);
    });

    $(document).on('click', '.delete-item', function() {
        const itemId = $(this).data('id');
        const itemName = $(this).data('name');
        showDeleteConfirm(itemId, itemName);
    });

    // ================================
    // OPEN CREATE MODAL
    // ================================
    function openCreateModal() {
        isEditMode = false;
        currentItemId = null;
        selectedManufacturerIds = [];
        selectedOriginYarnId = null;
        resetForm();
        updateModalTitle('إضافة صنف غزل جديد', 'fa-plus-circle', 'bg-success');
        loadDataAndShowModal();
    }

    // ================================
    // OPEN EDIT MODAL - FIXED
    // ================================
    function openEditModal(itemId) {
        console.log('🔧 Opening edit modal for item:', itemId);
        
        isEditMode = true;
        currentItemId = itemId;
        resetForm();
        updateModalTitle('تعديل صنف الغزل', 'fa-edit', 'bg-primary');
        
        // Show loading overlay
        showFormLoading();
        
        // Load item data first to get selected IDs
        loadItemDataFromDOM(itemId)
            .then(() => {
                console.log('✅ Item data loaded, selected manufacturers:', selectedManufacturerIds);
                console.log('✅ Selected origin yarn:', selectedOriginYarnId);
                
                // Then load manufacturers and origin yarns with selections
                return Promise.all([
                    loadManufacturers(),
                    loadOriginYarns(itemId)
                ]);
            })
            .then(() => {
                console.log('✅ Manufacturers and origin yarns loaded');
                
                // Now apply selections
                applySelections();
                
                hideFormLoading();
                yarnItemModal.show();
            })
            .catch(error => {
                console.error('❌ Error loading edit modal:', error);
                hideFormLoading();
                showNotification('حدث خطأ أثناء تحميل بيانات الصنف', 'error');
            });
    }

    // ================================
    // LOAD ITEM DATA FROM DOM - FIXED
    // ================================
                // ================================
                // LOAD ITEM DATA FROM DOM - FIXED
                // ================================
                function loadItemDataFromDOM(itemId) {
                    return new Promise((resolve, reject) => {
                        console.log('📥 Loading item data from DOM for ID:', itemId);

                        // Try API first
                        $.ajax({
                            url: `/api/YarnItems/${itemId}`,
                            method: 'GET',
                            success: function(response) {
                                console.log('✅ API Response:', response);

                                if (response.success && response.data) {
                                    const item = response.data;

                                    // Populate form fields
                                    $('#yarnItemId').val(item.id);

                                    // Set Name and convert immediately
                                    $('#yarnItemName').val(item.item);
                                    applySmartNumberConversion($('#yarnItemName')); // ✅ FORCE CONVERSION

                                    $('#yarnItemStatus').prop('checked', item.status);

                                    // Set Comment and convert immediately
                                    $('#yarnItemComment').val(item.comment || '');
                                    applySmartNumberConversion($('#yarnItemComment')); // ✅ FORCE CONVERSION

                                    // ✅ Store selected IDs for later
                                    selectedManufacturerIds = item.manufacturerIds || [];
                                    selectedOriginYarnId = item.originYarnId || null;

                                    console.log('📌 Stored selections:', {
                                        manufacturers: selectedManufacturerIds,
                                        originYarn: selectedOriginYarnId
                                    });

                                    updateStatusText();
                                    resolve();
                                } else {
                                    // Fallback to DOM extraction
                                    loadItemDataFromDOMFallback(itemId, resolve, reject);
                                }
                            },
                            error: function(xhr) {
                                console.log('⚠️ API failed, trying DOM fallback');
                                loadItemDataFromDOMFallback(itemId, resolve, reject);
                            }
                        });
                    });
                }

                // ================================
                // FALLBACK: EXTRACT FROM DOM
                // ================================
                function loadItemDataFromDOMFallback(itemId, resolve, reject) {
                    const row = $(`tr:has([data-id="${itemId}"])`).first();

                    if (row.length) {
                        console.log('✅ Found item in DOM');

                        const itemName = row.find('td:eq(0) .fw-semibold').text().trim();
                        const status = row.data('status') === 'active';
                        const comment = row.find('td:eq(0) small').text().trim() || '';
                        const manufacturerText = row.find('td:eq(1)').text().trim();
                        const originYarnText = row.find('td:eq(2)').text().trim();

                        // Populate form
                        $('#yarnItemId').val(itemId);

                        // Set Name and convert immediately
                        $('#yarnItemName').val(itemName);
                        applySmartNumberConversion($('#yarnItemName')); // ✅ FORCE CONVERSION

                        $('#yarnItemStatus').prop('checked', status);

                        // Set Comment and convert immediately
                        $('#yarnItemComment').val(comment);
                        applySmartNumberConversion($('#yarnItemComment')); // ✅ FORCE CONVERSION

                        // ⚠️ We can't get IDs from DOM, will select by name later
                        selectedManufacturerIds = [];
                        selectedOriginYarnId = null;

                        // Store text for matching
                        window.tempManufacturerText = manufacturerText !== 'غير محدد' ? manufacturerText : '';
                        window.tempOriginYarnText = originYarnText !== 'غير محدد' ? originYarnText : '';

                        updateStatusText();
                        resolve();
                    } else {
                        console.error('❌ Item not found in DOM');
                        reject('Item not found');
                    }
                }

    // ================================
    // APPLY SELECTIONS - FIXED
    // ================================
    function applySelections() {
        console.log('🎯 Applying selections...');
        
        // ✅ Select manufacturers by ID
        if (selectedManufacturerIds && selectedManufacturerIds.length > 0) {
            console.log('Selecting manufacturers:', selectedManufacturerIds);
            
            selectedManufacturerIds.forEach(id => {
                $(`#manufacturer_${id}`).prop('checked', true);
            });
            
            const checkedCount = $('.manufacturer-checkbox:checked').length;
            console.log('✅ Selected', checkedCount, 'manufacturers');
        } 
        // Fallback: select by name if we only have text
        else if (window.tempManufacturerText) {
            console.log('Selecting manufacturers by name:', window.tempManufacturerText);
            
            const names = window.tempManufacturerText.split(',').map(n => n.trim());
            names.forEach(name => {
                $(`.manufacturer-checkbox`).each(function() {
                    const label = $(this).next('label').text().trim();
                    if (label === name) {
                        $(this).prop('checked', true);
                    }
                });
            });
        }
        
        // ✅ Select origin yarn by ID
        if (selectedOriginYarnId) {
            console.log('Selecting origin yarn:', selectedOriginYarnId);
            $('#originYarnSelect').val(selectedOriginYarnId);
            console.log('✅ Selected origin yarn value:', $('#originYarnSelect').val());
        }
        // Fallback: select by name
        else if (window.tempOriginYarnText) {
            console.log('Selecting origin yarn by text:', window.tempOriginYarnText);
            
            $(`#originYarnSelect option`).each(function() {
                if ($(this).text().trim() === window.tempOriginYarnText) {
                    $(this).prop('selected', true);
                }
            });
        }
        
        updateSelectedManufacturers();
        
        // Clean up temp variables
        window.tempManufacturerText = null;
        window.tempOriginYarnText = null;
    }

    // ================================
    // LOAD MANUFACTURERS
    // ================================
    function loadManufacturers() {
        return new Promise((resolve, reject) => {
            console.log('📥 Loading manufacturers...');
            
            $.ajax({
                url: '/api/YarnItems/GetManufacturers',
                method: 'GET',
                success: function(response) {
                    if (response.success) {
                        availableManufacturers = response.data;
                        console.log('✅ Loaded', availableManufacturers.length, 'manufacturers');
                        renderManufacturers();
                        resolve();
                    } else {
                        reject('Failed to load manufacturers');
                    }
                },
                error: function() {
                    console.log('⚠️ Using fallback manufacturers');
                    // Fallback
                    availableManufacturers = [
                        {id: 1, name: 'الشركة الأولى للغزل', status: true},
                        {id: 2, name: 'مصانع النسيج المتطورة', status: true},
                        {id: 3, name: 'شركة الغزل الذهبي', status: true}
                    ];
                    renderManufacturers();
                    resolve();
                }
            });
        });
    }

    // ================================
    // LOAD ORIGIN YARNS
    // ================================
    function loadOriginYarns(excludeId = null) {
        return new Promise((resolve, reject) => {
            console.log('📥 Loading origin yarns, excluding:', excludeId);
            
            $.ajax({
                url: '/api/YarnItems/GetOriginYarns',
                method: 'GET',
                data: excludeId ? { excludeId: excludeId } : {},
                success: function(response) {
                    if (response.success) {
                        availableOriginYarns = response.data;
                        console.log('✅ Loaded', availableOriginYarns.length, 'origin yarns');
                        renderOriginYarns();
                        resolve();
                    } else {
                        reject('Failed to load origin yarns');
                    }
                },
                error: function() {
                    console.error('❌ Failed to load origin yarns');
                    renderOriginYarns(); // Render empty
                    resolve(); // Don't block modal
                }
            });
        });
    }

    // ================================
    // RENDER MANUFACTURERS - FIXED
    // ================================
    function renderManufacturers() {
        const container = $('#manufacturersContainer');
        container.empty();
        
        console.log('🎨 Rendering', availableManufacturers.length, 'manufacturers');
        
        if (availableManufacturers.length === 0) {
            container.html('<p class="text-muted small text-center my-2">لا توجد شركات متاحة</p>');
            return;
        }
        
        availableManufacturers.forEach(manufacturer => {
            if (manufacturer.status) {
                const checkboxHtml = `
                    <div class="form-check form-check-sm">
                        <input class="form-check-input manufacturer-checkbox" 
                               type="checkbox" 
                               value="${manufacturer.id}" 
                               id="manufacturer_${manufacturer.id}" 
                               name="ManufacturerIds">
                        <label class="form-check-label small" for="manufacturer_${manufacturer.id}">
                            ${manufacturer.name}
                        </label>
                    </div>
                `;
                container.append(checkboxHtml);
            }
        });

        $('.manufacturer-checkbox').on('change', updateSelectedManufacturers);
    }

    // ================================
    // RENDER ORIGIN YARNS - FIXED
    // ================================
    function renderOriginYarns() {
        const select = $('#originYarnSelect');
        select.empty().append('<option value="">-- اختر الغزل المكون --</option>');

        console.log('🎨 Rendering', availableOriginYarns.length, 'origin yarns');

        availableOriginYarns.forEach(yarn => {
            select.append(`<option value="${yarn.value}">${yarn.text}</option>`);
        });
    }

    // ================================
    // UPDATE MODAL TITLE
    // ================================
    function updateModalTitle(title, iconClass, bgClass) {
        $('#modalTitle').text(title);
        $('#modalIcon').removeClass().addClass(`fas ${iconClass} me-2`);
        $('.modal-header').removeClass('bg-success bg-primary bg-warning').addClass(bgClass);
        $('#saveButton').html(`<i class="fas fa-save me-1"></i>${isEditMode ? 'تحديث الصنف' : 'حفظ الصنف'}`);
    }

    // ================================
    // RESET FORM
    // ================================
    function resetForm() {
        $('#yarnItemForm')[0].reset();
        $('#yarnItemId').val('0');
        $('#yarnItemStatus').prop('checked', true);
        $('#manufacturersContainer').empty();
        $('#originYarnSelect').empty().append('<option value="">-- اختر الغزل المكون --</option>');
        clearValidationErrors();
        selectedManufacturerIds = [];
        selectedOriginYarnId = null;
    }

    // ================================
    // LOAD DATA AND SHOW MODAL
    // ================================
    function loadDataAndShowModal() {
        showFormLoading();
        
        Promise.all([loadManufacturers(), loadOriginYarns()])
            .then(() => {
                hideFormLoading();
                yarnItemModal.show();
            })
            .catch(() => {
                hideFormLoading();
                showNotification('حدث خطأ أثناء تحميل البيانات', 'error');
            });
    }

    // ================================
    // STATUS SWITCH
    // ================================
    $('#yarnItemStatus').change(function() {
        updateStatusText();
    });

    function updateStatusText() {
        const isActive = $('#yarnItemStatus').prop('checked');
        $('.status-text').text(isActive ? 'نشط' : 'غير نشط');
    }

    // ================================
    // MANUFACTURER SELECTION
    // ================================
    function updateSelectedManufacturers() {
        const selectedCount = $('.manufacturer-checkbox:checked').length;
        console.log('📊 Selected manufacturers count:', selectedCount);
    }

    $('#selectAllManufacturers').click(function() {
        $('.manufacturer-checkbox').prop('checked', true);
        updateSelectedManufacturers();
    });

    $('#clearAllManufacturers').click(function() {
        $('.manufacturer-checkbox').prop('checked', false);
        updateSelectedManufacturers();
    });

    // ================================
    // REFRESH ORIGIN YARNS
    // ================================
    $('#refreshOriginYarns').click(function() {
        const btn = $(this);
        const originalHtml = btn.html();
        btn.prop('disabled', true).html('<i class="fas fa-spinner fa-spin"></i>');

        loadOriginYarns(isEditMode ? currentItemId : null)
            .then(() => {
                // Reapply selection if in edit mode
                if (isEditMode && selectedOriginYarnId) {
                    $('#originYarnSelect').val(selectedOriginYarnId);
                }
                
                btn.prop('disabled', false).html(originalHtml);
                showNotification('تم تحديث قائمة الغزل المكون بنجاح', 'success');
            })
            .catch(() => {
                btn.prop('disabled', false).html(originalHtml);
                showNotification('فشل في تحديث قائمة الغزل المكون', 'error');
            });
    });

    // ================================
// FORM SUBMISSION - AUTO RELOAD VERSION
// ================================
$('#yarnItemForm').submit(function (e) {
    e.preventDefault();
    clearValidationErrors();

    const formData = {
        Id: parseInt($('#yarnItemId').val()) || 0,
        Item: $('#yarnItemName').val().trim(),
        Status: $('#yarnItemStatus').prop('checked'),
        Comment: $('#yarnItemComment').val().trim(),
        OriginYarnId: $('#originYarnSelect').val() ? parseInt($('#originYarnSelect').val()) : null,
        ManufacturerIds: $('.manufacturer-checkbox:checked').map(function () {
            return parseInt($(this).val());
        }).get()
    };

    // Validation
    if (!formData.Item) {
        showFieldError('yarnItemName', 'itemError', 'اسم الصنف مطلوب');
        return;
    }

    if (formData.Item.length > 200) {
        showFieldError('yarnItemName', 'itemError', 'اسم الصنف لا يمكن أن يزيد عن 200 حرف');
        return;
    }

    // Convert Arabic/Indic digits to Latin
    formData.Item = toLatinDigits(formData.Item);
    formData.Comment = toLatinDigits(formData.Comment);

    const saveButton = $('#saveButton');
    const originalText = saveButton.html();
    saveButton.prop('disabled', true).html('<span class="spinner-border spinner-border-sm me-2"></span>جاري الحفظ...');

    $.ajax({
        url: isEditMode ? `/YarnItems/Edit/${formData.Id}` : '/YarnItems/Create',
        method: 'POST',
        data: $.param(formData, true),
        headers: {
            'X-Requested-With': 'XMLHttpRequest',
            'RequestVerificationToken': $('input[name="__RequestVerificationToken"]').val()
        },
        success: function (response) {
            saveButton.prop('disabled', false).html(originalText);

            if (response.success) {
                // ✅ Hide modal
                $('#yarnItemModal').modal('hide');

                // ✅ Refresh page to show updated data (no alert)
                window.location.reload();
            } else {
                handleValidationErrors(response);
            }
        },
        error: function (xhr) {
            saveButton.prop('disabled', false).html(originalText);

            if (xhr.status === 400 && xhr.responseJSON) {
                handleValidationErrors(xhr.responseJSON);
            } else {
                console.error('❌ Error saving Yarn Item:', xhr);
            }
        }
    });
});


    // ================================
    // UPDATE ITEM IN DOM WITHOUT RELOAD - NEW FUNCTION
    // ================================
    function updateItemInDOM(itemData) {
        console.log('🔄 Updating item in DOM:', itemData);
        
        const itemId = itemData.id;
        const rowSelector = `tr:has([data-id="${itemId}"])`;
        const cardSelector = `.mobile-item-card[data-id="${itemId}"]`;
        
        // Update table row
        if ($(rowSelector).length) {
            const row = $(rowSelector);
            
            // Update name and comment
            row.find('td:eq(0) .fw-semibold').text(itemData.item);
            row.find('td:eq(0) small').text(itemData.comment || '');
            
            // Update manufacturers
            const manufacturerNames = itemData.manufacturerNames || ['غير محدد'];
            row.find('td:eq(1)').text(manufacturerNames.join(', '));
            
            // Update origin yarn
            const originYarnName = itemData.originYarnName || 'غير محدد';
            row.find('td:eq(2)').text(originYarnName);
            
            // Update status
            row.data('status', itemData.status ? 'active' : 'inactive');
            const statusBadge = itemData.status ? 
                '<span class="badge bg-success">نشط</span>' : 
                '<span class="badge bg-secondary">غير نشط</span>';
            row.find('td:eq(3)').html(statusBadge);
            
            // Update search content for mobile cards
            const searchContent = `${itemData.item} ${manufacturerNames.join(' ')} ${originYarnName} ${itemData.comment || ''}`;
            row.attr('data-search-content', searchContent.toLowerCase());
        }
        
        // Update mobile card
        if ($(cardSelector).length) {
            const card = $(cardSelector);
            
            // Update card content
            card.find('.card-title').text(itemData.item);
            card.find('.card-text').eq(0).text(itemData.manufacturerNames?.join(', ') || 'غير محدد');
            card.find('.card-text').eq(1).text(itemData.originYarnName || 'غير محدد');
            card.find('small').text(itemData.comment || '');
            
            // Update status badge
            const statusBadge = itemData.status ? 
                '<span class="badge bg-success">نشط</span>' : 
                '<span class="badge bg-secondary">غير نشط</span>';
            card.find('.status-badge').html(statusBadge);
            
            // Update search content
            const searchContent = `${itemData.item} ${itemData.manufacturerNames?.join(' ')} ${itemData.originYarnName} ${itemData.comment || ''}`;
            card.attr('data-search-content', searchContent.toLowerCase());
        }
        
        // If it's a new item, reload the page to show it in the list
        if (!isEditMode) {
            setTimeout(() => {
                window.location.reload();
            }, 800);
        }
    }

    // ================================
    // VALIDATION
    // ================================
    function handleValidationErrors(response) {
        if (response.errors) {
            Object.keys(response.errors).forEach(field => {
                const errors = response.errors[field];
                if (errors && errors.length > 0) {
                    const fieldMap = {
                        'Item': { input: 'yarnItemName', error: 'itemError' },
                        'OriginYarnId': { input: 'originYarnSelect', error: 'originYarnError' }
                    };

                    const mapping = fieldMap[field];
                    if (mapping && mapping.input) {
                        showFieldError(mapping.input, mapping.error, errors[0]);
                    }
                }
            });
        }

        if (response.message) {
            showNotification(response.message, 'error');
        }
    }

    function showFieldError(fieldId, errorId, message) {
        $(`#${fieldId}`).addClass('is-invalid');
        if (errorId) {
            $(`#${errorId}`).text(message);
        }
    }

    function clearValidationErrors() {
        $('.form-control, .form-select').removeClass('is-invalid');
        $('.invalid-feedback').text('');
    }

    $(document).on('focus', '.form-control, .form-select', function() {
        $(this).removeClass('is-invalid');
    });

 // ================================
// DELETE ITEM - RELIABLE SILENT VERSION
// ================================
function showDeleteConfirm(itemId, itemName) {
    $('#deleteItemId').val(itemId);
    $('#deleteItemName').text(itemName);
    deleteModal.show();
}

$('#confirmDeleteButton').off('click').on('click', function () {
    const itemId = $('#deleteItemId').val();
    const btn = $(this);
    const originalText = btn.text();

    btn.prop('disabled', true).text('جاري الحذف...');

    $.ajax({
        url: `/api/YarnItems/${itemId}`,
        type: 'DELETE',
        success: function (response) {
            // ✅ Always hide modal immediately
            deleteModal.hide();

            // ✅ Small delay to ensure modal hides before reload
            setTimeout(() => {
                window.location.reload();
            }, 400);
        },
        error: function (xhr) {
            console.error('❌ Delete failed:', xhr);
            
            // ✅ Still hide modal & reload to keep UI in sync
            deleteModal.hide();
            setTimeout(() => {
                window.location.reload();
            }, 400);
        },
        complete: function () {
            // Restore button text
            btn.prop('disabled', false).text(originalText);
        }
    });
});

    // ================================
    // DETAILS MODAL
    // ================================
    function openDetailsModal(itemId) {
        currentItemId = itemId;
        loadItemDetails(itemId);
    }

    function loadItemDetails(itemId) {
        $('#detailsContent').html(`
            <div class="text-center py-4">
                <div class="spinner-border text-primary mb-3"></div>
                <div class="text-muted">جاري تحميل التفاصيل...</div>
            </div>
        `);
        detailsModal.show();

        const row = $(`tr:has([data-id="${itemId}"])`);
        if (row.length) {
            const itemName = row.find('.fw-semibold, .fw-bold').first().text().trim();
            const status = row.data('status') === 'active';
            const manufacturer = row.find('td:eq(1)').text().trim() || 'غير محدد';
            const originYarn = row.find('td:eq(2)').text().trim() || 'غير محدد';
            const comment = row.find('small').text().trim() || 'لا يوجد بيان';

            const detailsHtml = `
                <div class="p-4">
                    <div class="row mb-4">
                        <div class="col-12">
                            <div class="d-flex align-items-center p-3 bg-light rounded">
                                <div class="me-3">
                                    <i class="fas fa-box fa-2x text-primary"></i>
                                </div>
                                <div>
                                    <h4 class="mb-1 fw-bold text-dark">${itemName}</h4>
                                    <span class="badge bg-${status ? 'success' : 'secondary'} px-3 py-2">
                                        ${status ? 'نشط' : 'غير نشط'}
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="card"><div class="card-body">
                                <h6 class="card-title text-success"><i class="fas fa-industry me-2"></i>الشركة المصنعة</h6>
                                <p class="card-text">${manufacturer}</p>
                            </div></div>
                        </div>
                        <div class="col-md-6">
                            <div class="card"><div class="card-body">
                                <h6 class="card-title text-info"><i class="fas fa-link me-2"></i>الغزل المكون</h6>
                                <p class="card-text">${originYarn}</p>
                            </div></div>
                        </div>
                        <div class="col-12">
                            <div class="card"><div class="card-body">
                                <h6 class="card-title text-secondary"><i class="fas fa-comment-alt me-2"></i>البيان</h6>
                                <p class="card-text">${comment}</p>
                            </div></div>
                        </div>
                    </div>
                </div>
            `;

            $('#detailsContent').html(detailsHtml);
        }
    }

    $('#editFromDetails').click(function() {
        detailsModal.hide();
        if (currentItemId) {
            setTimeout(() => openEditModal(currentItemId), 300);
        }
    });

    $('#deleteFromDetails').click(function() {
        detailsModal.hide();
        if (currentItemId) {
            const row = $(`tr:has([data-id="${currentItemId}"])`);
            const itemName = row.find('.fw-semibold').first().text().trim();
            setTimeout(() => showDeleteConfirm(currentItemId, itemName), 300);
        }
    });

    // ================================
    // MODAL CLEANUP
    // ================================
    $('#yarnItemModal').on('hidden.bs.modal', function() {
        resetForm();
        currentItemId = null;
        isEditMode = false;
    });

    $('#yarnDetailsModal').on('hidden.bs.modal', function() {
        currentItemId = null;
    });

    // ================================
    // LOADING OVERLAY
    // ================================
    function showFormLoading() {
        $('#formLoadingOverlay').show();
    }
    function hideFormLoading() {
        $('#formLoadingOverlay').hide();
    }

    // ================================
    // NOTIFICATION FUNCTION
    // ================================
    function showNotification(message, type = 'success') {
        // You can implement your notification system here
        // For now using alert as fallback
        alert(message);
    }
});
</script>
    <style>
        /* Compact Styles */
        .card-header {
            padding: 0.75rem 1rem;
        }

        .search-row th {
            padding: 0.25rem;
        }

        .search-row input, .search-row select {
            border: 1px solid #dee2e6;
            font-size: 0.875rem;
        }

        .table-sm td {
            padding: 0.5rem 0.25rem;
            vertical-align: middle;
        }

        .table-hover tbody tr:hover {
            background-color: rgba(0, 123, 255, 0.05);
        }

        .mobile-item-card:hover {
            background-color: rgba(0, 123, 255, 0.02);
        }

        .btn-group-sm .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.775rem;
        }

        .badge {
            font-size: 0.7rem;
        }

        /* Modal Improvements - CENTERED */
        .modal-dialog {
            margin: 1.75rem auto; /* Centers modal horizontally and vertically */
        }

        /* Vertically center modal on screen */
        .modal.fade .modal-dialog {
            transform: translate(0, -50%);
            top: 50%;
        }

        .modal.show .modal-dialog {
            transform: translate(0, -50%);
            top: 50%;
        }

        /* Alternative: Use Bootstrap's built-in centering */
        .modal-dialog-centered {
            display: flex;
            align-items: center;
            min-height: calc(100% - 3.5rem);
        }

        .form-check-sm {
            margin-bottom: 0.25rem;
        }

            .form-check-sm .form-check-input {
                margin-top: 0.15rem;
            }

            .form-check-sm .form-check-label {
                font-size: 0.875rem;
            }

        /* Responsive adjustments */
        @@media (max-width: 768px) {
            .modal-lg

        {
            max-width: 95%;
            margin: 0.5rem auto; /* Keep centered on mobile */
        }

        .modal-dialog {
            margin: 1rem auto; /* Centered on mobile */
        }

        .mobile-item-card {
            margin: 0.5rem;
            border-radius: 0.375rem;
        }

        .btn-group .btn {
            padding: 0.375rem 0.5rem;
            font-size: 0.8rem;
        }

        }

        @@media (min-width: 576px) {
            .modal-dialog

        {
            max-width: 500px;
            margin: 1.75rem auto; /* Centered */
        }

        .modal-dialog-centered {
            min-height: calc(100% - 3.5rem);
        }

        }

        @@media (min-width: 992px) {
            .modal-lg

        {
            max-width: 800px;
            margin: 1.75rem auto; /* Centered for large modals */
        }

        }

       
        

        /* Animation for smooth filtering */
        .table-row {
            transition: opacity 0.2s ease;
        }

        .mobile-item-card {
            transition: opacity 0.2s ease;
        }

        /* Status indicator colors */
        .text-success {
            color: #198754 !important;
        }

        .text-danger {
            color: #dc3545 !important;
        }

        .text-warning {
            color: #fd7e14 !important;
        }

        .text-info {
            color: #0dcaf0 !important;
        }

        .text-muted {
            color: #6c757d !important;
        }

        /* Notification positioning */
        .alert.position-fixed {
            max-width: 400px;
            box-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.15);
        }

        /* Form validation */
        .is-invalid {
            border-color: #dc3545;
        }

        .invalid-feedback {
            display: block;
            color: #dc3545;
            font-size: 0.875rem;
        }
    </style>
    }