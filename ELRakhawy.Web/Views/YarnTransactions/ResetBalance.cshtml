@using ELRakhawy.EL.ViewModels
@model YarnResetBalanceViewModel
@{
    ViewData["Title"] = "تصفير رصيد الغزل";
    var currentTime = "2025-09-04 18:04:08";
    var currentUser = "Ammar-Yasser8";
}

<div class="container-fluid mt-4">
    <!-- Header Card -->
    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body bg-warning text-white rounded">
            <div class="row align-items-center">
                <div class="col">
                    <h4 class="mb-1">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        تصفير رصيد الغزل
                    </h4>
                    <p class="mb-0 opacity-75">
                        أداة تصفير الرصيد للتعديلات الإدارية والجرد
                    </p>
                </div>
                <div class="col-auto">
                    <div class="text-end">
                        <small class="d-block">@currentTime.Split(' ')[0]</small>
                        <small class="d-block">@currentUser</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts -->
    @if (TempData["Success"] != null || TempData["Error"] != null)
    {
        <div class="alert @(TempData["Success"] != null ? "alert-success" : "alert-danger") alert-dismissible fade show mb-4">
            <i class="fas @(TempData["Success"] != null ? "fa-check-circle" : "fa-exclamation-circle") me-2"></i>
            @(TempData["Success"] ?? TempData["Error"])
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (!Model.ShowConfirmation)
    {
        <!-- Selection Form -->
        <div class="card shadow-sm">
            <div class="card-header bg-warning text-white">
                <h5 class="mb-0">
                    <i class="fas fa-search me-2"></i>اختيار الصنف المراد تصفير رصيده
                </h5>
            </div>
            <div class="card-body">
                <form id="resetBalanceForm" method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="ShowConfirmation" value="false" />
                    
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="YarnItemId" class="form-label required">
                                <i class="fas fa-yarn text-primary me-1"></i>صنف الغزل
                            </label>
                            <select id="YarnItemId" name="YarnItemId" class="form-select" required>
                                <option value="">-- اختر صنف الغزل --</option>
                                @foreach (var item in Model.AvailableItems)
                                {
                                    <option value="@item.Value" @@(item.Value == Model.YarnItemId.ToString() ? "selected" : "")>
                                        @item.Text
                                    </option>
                                }
                            </select>
                            <span class="text-danger" asp-validation-for="YarnItemId"></span>
                        </div>
                        
                        <div class="col-md-4 mb-3">
                            <label class="form-label">
                                <i class="fas fa-info-circle text-info me-1"></i>الرصيد الحالي
                            </label>
                            <div id="currentBalanceDisplay" class="form-control bg-light">
                                <small class="text-muted">اختر الصنف أولاً</small>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-md-6 mb-3">
                            <label for="InternalId" class="form-label">
                                <i class="fas fa-file-alt text-info me-1"></i>رقم الإذن الداخلي
                            </label>
                            <input type="text" id="InternalId" name="InternalId" value="@Model.InternalId" 
                                   class="form-control" placeholder="اختياري - رقم مرجعي داخلي" />
                            <span class="text-danger" asp-validation-for="InternalId"></span>
                        </div>
                        
                        <div class="col-md-6 mb-3">
                            <label for="ResetDate" class="form-label required">
                                <i class="fas fa-calendar-alt text-warning me-1"></i>تاريخ التصفير
                            </label>
                            <input type="date" id="ResetDate" name="ResetDate"
                                   value="@Model.ResetDate.ToString("yyyy-MM-dd")" class="form-control" required />
                            <span class="text-danger" asp-validation-for="ResetDate"></span>
                        </div>
                    </div>

                    <div class="row">
                        <div class="col-12 mb-4">
                            <label for="ReasonForReset" class="form-label required">
                                <i class="fas fa-comment text-danger me-1"></i>سبب التصفير
                            </label>
                            <textarea id="ReasonForReset" name="ReasonForReset" class="form-control" rows="3" 
                                      placeholder="اذكر السبب التفصيلي لتصفير الرصيد (مطلوب)" required>@Model.ReasonForReset</textarea>
                            <span class="text-danger" asp-validation-for="ReasonForReset"></span>
                            <div class="form-text">
                                <small class="text-muted">
                                    <i class="fas fa-lightbulb me-1"></i>
                                    أمثلة: جرد سنوي، تلف المخزون، تصحيح خطأ إدخال، نقل للفرع الآخر
                                </small>
                            </div>
                        </div>
                    </div>

                    <div class="d-flex gap-2 justify-content-end">
                        <a href="@Url.Action("Overview", "YarnTransactions")" class="btn btn-secondary">
                            <i class="fas fa-times me-1"></i>إلغاء
                        </a>
                        <button type="submit" class="btn btn-warning text-white">
                            <i class="fas fa-search me-1"></i>معاينة التصفير
                        </button>
                    </div>
                </form>
            </div>
        </div>
    }
    else
    {
        <!-- Confirmation Form -->
        <div class="card shadow-sm border-danger">
            <div class="card-header bg-danger text-white">
                <h5 class="mb-0">
                    <i class="fas fa-exclamation-triangle me-2"></i>تأكيد تصفير الرصيد
                </h5>
            </div>
            <div class="card-body">
                <div class="alert alert-warning">
                    <div class="d-flex">
                        <div class="me-3">
                            <i class="fas fa-exclamation-triangle fa-2x text-warning"></i>
                        </div>
                        <div>
                            <h6 class="alert-heading">تحذير مهم!</h6>
                            <p class="mb-0">
                                أنت على وشك تصفير رصيد هذا الصنف بالكامل. هذا الإجراء سيقوم بإنشاء معاملة صادر 
                                لجعل الرصيد صفر. تأكد من صحة البيانات قبل المتابعة.
                            </p>
                        </div>
                    </div>
                </div>

                <!-- Current Balance Display -->
                <div class="row mb-4">
                    <div class="col-md-6">
                        <div class="card border-info">
                            <div class="card-header bg-info text-white">
                                <h6 class="mb-0">تفاصيل الصنف</h6>
                            </div>
                            <div class="card-body">
                                <p><strong>اسم الصنف:</strong> @Model.YarnItemName</p>
                                <p><strong>رقم الإذن:</strong> @(Model.InternalId ?? "غير محدد")</p>
                                <p><strong>تاريخ التصفير:</strong> @Model.ResetDate.ToString("dd/MM/yyyy")</p>
                                <p><strong>السبب:</strong> @Model.ReasonForReset</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-warning">
                            <div class="card-header bg-warning text-white">
                                <h6 class="mb-0">الرصيد الحالي</h6>
                            </div>
                            <div class="card-body text-center">
                                <div class="row">
                                    <div class="col-6">
                                        <h4 class="text-primary">@Model.CurrentQuantityBalance.ToString("N3")</h4>
                                        <small class="text-muted">كجم</small>
                                    </div>
                                    <div class="col-6">
                                        <h4 class="text-success">@Model.CurrentCountBalance</h4>
                                        <small class="text-muted">وحدة</small>
                                    </div>
                                </div>
                                <hr>
                                <p class="text-danger fw-bold mb-0">
                                    <i class="fas fa-arrow-down me-1"></i>
                                    سيصبح الرصيد: ٠.٠٠٠ كجم | ٠ وحدة
                                </p>
                            </div>
                        </div>
                    </div>
                </div>

                <form method="post">
                    @Html.AntiForgeryToken()
                    <input type="hidden" name="YarnItemId" value="@Model.YarnItemId" />
                    <input type="hidden" name="InternalId" value="@Model.InternalId" />
                    <input type="hidden" name="ResetDate" value="@Model.ResetDate.ToString("yyyy-MM-dd")" />
                    <input type="hidden" name="ReasonForReset" value="@Model.ReasonForReset" />
                    <input type="hidden" name="ConfirmReset" value="true" />
                    <input type="hidden" name="ShowConfirmation" value="true" />

                    <div class="d-flex gap-2 justify-content-end">
                        <a href="@Url.Action("ResetBalance", "YarnTransactions")" class="btn btn-secondary">
                            <i class="fas fa-arrow-left me-1"></i>العودة للتعديل
                        </a>
                        <button type="submit" class="btn btn-danger">
                            <i class="fas fa-check me-1"></i>تأكيد التصفير
                        </button>
                    </div>
                </form>
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Initialize select2
            $('#YarnItemId').select2({
                theme: 'bootstrap-5',
                width: '100%'
            });

            // Handle yarn item selection
            $('#YarnItemId').on('change', function() {
                var yarnItemId = $(this).val();
                if (yarnItemId) {
                    fetchYarnItemBalance(parseInt(yarnItemId));
                } else {
                    $('#currentBalanceDisplay').html('<small class="text-muted">اختر الصنف أولاً</small>');
                }
            });

            // Load initial balance if item is selected
            var initialYarnItemId = $('#YarnItemId').val();
            if (initialYarnItemId) {
                fetchYarnItemBalance(parseInt(initialYarnItemId));
            }
        });

        function fetchYarnItemBalance(yarnItemId) {
            $.ajax({
                url: '/YarnTransactions/GetYarnItemBalance',
                type: 'GET',
                data: { yarnItemId: yarnItemId },
                beforeSend: function() {
                    $('#currentBalanceDisplay').html('<i class="fas fa-spinner fa-spin"></i> جاري التحميل...');
                },
                success: function(response) {
                    if (response && response.success) {
                        var qtyBalance = (response.quantityBalance || 0).toFixed(3);
                        var countBalance = response.countBalance || 0;
                        
                        var html = `
                            <div class="d-flex justify-content-between">
                                <span class="text-primary fw-bold">${qtyBalance} كجم</span>
                                <span class="text-success fw-bold">${countBalance} وحدة</span>
                            </div>
                        `;
                        
                        if (qtyBalance == 0 && countBalance == 0) {
                            html = '<span class="text-muted">الرصيد بالفعل صفر</span>';
                        }
                        
                        $('#currentBalanceDisplay').html(html);
                    } else {
                        $('#currentBalanceDisplay').html('<small class="text-danger">خطأ في التحميل</small>');
                    }
                },
                error: function() {
                    $('#currentBalanceDisplay').html('<small class="text-danger">خطأ في الاتصال</small>');
                }
            });
        }
    </script>
}