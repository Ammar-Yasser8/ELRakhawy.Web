@using ELRakhawy.EL.ViewModels
@model YarnTransactionSearchViewModel

@{
    ViewData["Title"] = "البحث في معاملات الغزل";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h4 class="mb-0">
                        <i class="fas fa-search me-2"></i>
                        البحث في معاملات الغزل
                    </h4>
                </div>
                <div class="card-body">
                    @using (Html.BeginForm("Search", "YarnTransactions", FormMethod.Post, new { @class = "needs-validation", novalidate = "novalidate" }))
                    {
                        @Html.AntiForgeryToken()

                        <!-- Search Filters -->
                        <div class="row g-3 mb-4">
                            <!-- Date Range -->
                            <div class="col-md-6 col-lg-3">
                                <label for="FromDate" class="form-label">من تاريخ</label>
                                @Html.TextBoxFor(m => m.FromDate, new {
                                @class = "form-control",
                                                        @type = "date",
                                                        @id = "FromDate"
                                                        })
                        </div>

                        <div class="col-md-6 col-lg-3">
                            <label for="ToDate" class="form-label">إلى تاريخ</label>
                            @Html.TextBoxFor(m => m.ToDate, new {
                                                        @class = "form-control",
                                                        @type = "date",
                                                        @id = "ToDate"
                                                        })
                        </div>

                        <!-- Transaction ID -->
                        <div class="col-md-6 col-lg-3">
                            <label for="TransactionId" class="form-label">رقم المعاملة</label>
                            @Html.TextBoxFor(m => m.TransactionId, new {
                                                        @class = "form-control",
                                                        @placeholder = "أدخل رقم المعاملة",
                                                        @id = "TransactionId"
                                                        })
                        </div>

                        <!-- Transaction Type -->
                        <div class="col-md-6 col-lg-3">
                            <label for="TransactionType" class="form-label">نوع المعاملة</label>
                            @Html.DropDownListFor(m => m.TransactionType, new List<SelectListItem>
                                                        {
                                new SelectListItem { Text = "جميع الأنواع", Value = "" },
                                                        new SelectListItem { Text = "وارد", Value = "inbound" },
                                                        new SelectListItem { Text = "صادر", Value = "outbound" }
                                                        }, new { @class = "form-select", @id = "TransactionType" })
                        </div>

                        <!-- Yarn Item -->
                        <div class="col-md-6 col-lg-4">
                            <label for="YarnItemId" class="form-label">صنف الغزل</label>
                            @Html.DropDownListFor(m => m.YarnItemId,
                                                        new SelectList(Model.AvailableItems, "Value", "Text"),
                                                        "اختر صنف الغزل",
                                                        new { @class = "form-select", @id = "YarnItemId" })
                        </div>

                        <!-- Stakeholder Type -->
                        <div class="col-md-6 col-lg-4">
                            <label for="StakeholderTypeId" class="form-label">نوع التاجر</label>
                            @Html.DropDownListFor(m => m.StakeholderTypeId,
                                                        new SelectList(Model.StakeholderTypes, "Value", "Text"),
                                                        "اختر نوع التاجر",
                                                        new { @class = "form-select", @id = "StakeholderTypeId" })
                        </div>

                        <!-- Stakeholder -->
                        <div class="col-md-6 col-lg-4">
                            <label for="StakeholderId" class="form-label">التاجر</label>
                            @Html.DropDownListFor(m => m.StakeholderId,
                                                        new List<SelectListItem> { new SelectListItem { Text = "اختر التاجر", Value = "" } },
                                                        new { @class = "form-select", @id = "StakeholderId", @disabled = "disabled" })
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="row mb-4">
                        <div class="col-12">
                            <button type="submit" class="btn btn-primary me-2">
                                <i class="fas fa-search me-1"></i>
                                بحث
                            </button>
                            <button type="button" class="btn btn-secondary me-2" id="clearFilters">
                                <i class="fas fa-times me-1"></i>
                                مسح الفلاتر
                            </button>
                            <a href="@Url.Action("Index", "YarnItems")" class="btn btn-outline-secondary">
                                <i class="fas fa-arrow-right me-1"></i>
                                العودة للقائمة
                            </a>
                        </div>
                    </div>
                                        }

                    <!-- Search Results -->
                    @if (ViewBag.SearchPerformed == true)
                    {
                        <div class="row mb-3">
                            <div class="col-12">
                                <div class="card border-info">
                                    <div class="card-header bg-info text-white">
                                        <h5 class="mb-0">
                                            <i class="fas fa-chart-bar me-2"></i>
                                            إحصائيات البحث
                                        </h5>
                                    </div>
                                    <div class="card-body">
                                        <div class="row text-center">
                                            <div class="col-md-3 col-sm-6">
                                                <div class="border-end">
                                                    <h4 class="text-primary">@Model.TotalTransactions</h4>
                                                    <small class="text-muted">إجمالي المعاملات</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3 col-sm-6">
                                                <div class="border-end">
                                                    <h4 class="text-success">@Model.TotalInbound.ToString("N2")</h4>
                                                    <small class="text-muted">إجمالي الوارد</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3 col-sm-6">
                                                <div class="border-end">
                                                    <h4 class="text-danger">@Model.TotalOutbound.ToString("N2")</h4>
                                                    <small class="text-muted">إجمالي الصادر</small>
                                                </div>
                                            </div>
                                            <div class="col-md-3 col-sm-6">
                                                <h4 class="@(Model.NetBalance >= 0 ? "text-success" : "text-danger")">@Model.NetBalance.ToString("N2")</h4>
                                                <small class="text-muted">الرصيد الصافي</small>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        @if (Model.Results != null && Model.Results.Any())
                        {
                            <div class="table-responsive">
                                <table class="table table-striped table-hover">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>رقم المعاملة</th>
                                            <th>التاريخ</th>
                                            <th>صنف الغزل</th>
                                            <th>الغزل الأصلي</th>
                                            <th>نوع المعاملة</th>
                                            <th>الكمية</th>
                                            <th>العدد</th>
                                            <th>نوع التاجر</th>
                                            <th>التاجر</th>
                                            <th>رصيد الكمية</th>
                                            <th>رصيد العدد</th>
                                            <th>ملاحظات</th>
                                          
                                        </tr>
                                    </thead>
                                    <tbody>
                                        @foreach (var item in Model.Results)
                                        {
                                            <tr>
                                                <td>
                                                    <span class="fw-bold">@item.TransactionId</span>
                                                    @if (!string.IsNullOrEmpty(item.InternalId))
                                                    {
                                                        <br>
                                        
                                                        <small class="text-muted">داخلي: @item.InternalId</small>
                                                    }
                                                    @if (!string.IsNullOrEmpty(item.ExternalId))
                                                    {
                                                        <br>
                                        
                                                        <small class="text-muted">خارجي: @item.ExternalId</small>
                                                    }
                                                </td>
                                                <td>@item.Date.ToString("dd/MM/yyyy")</td>
                                                <td>@item.YarnItemName</td>
                                                <td>@(item.OriginYarnName ?? "غير محدد")</td>
                                                <td>
                                                    @if (item.IsInbound)
                                                    {
                                                        <span class="badge bg-success">وارد</span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-danger">صادر</span>
                                                    }
                                                </td>
                                                <td class="@(item.IsInbound ? "text-success" : "text-danger")">
                                                    @item.Quantity.ToString("N2")
                                                </td>
                                                <td>@item.Count</td>
                                                <td>@item.StakeholderTypeName</td>
                                                <td>@item.StakeholderName</td>
                                                <td>@item.QuantityBalance.ToString("N2")</td>
                                                <td>@item.CountBalance</td>
                                                <td>
                                                    @if (!string.IsNullOrEmpty(item.Comment))
                                                    {
                                                        <span title="@item.Comment">
                                                            @(item.Comment.Length > 30 ? item.Comment.Substring(0, 30) + "..." : item.Comment)
                                                        </span>
                                                    }
                                                </td>
                                              
                                            </tr>
                                        }
                                    </tbody>
                                </table>
                            </div>

                            <!-- Export Options -->
                            <div class="row mt-3">
                                <div class="col-12">
                                    <div class="d-flex justify-content-end gap-2">
                                        <button type="button" class="btn btn-success btn-sm" onclick="exportToExcel()">
                                            <i class="fas fa-file-excel me-1"></i>
                                            تصدير إلى Excel
                                        </button>
                                        <button type="button" class="btn btn-info btn-sm" onclick="printResults()">
                                            <i class="fas fa-print me-1"></i>
                                            طباعة
                                        </button>
                                    </div>
                                </div>
                            </div>
                        }
                        else
                        {
                            <div class="alert alert-warning" role="alert">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                لم يتم العثور على معاملات تطابق معايير البحث المحددة.
                            </div>
                        }
                    }
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Handle stakeholder type change
            $('#StakeholderTypeId').change(function() {
                var typeId = $(this).val();
                var stakeholderSelect = $('#StakeholderId');

                if (typeId) {
                    // Show loading state
                    stakeholderSelect.prop('disabled', true)
                                   .empty()
                                   .append('<option value="">جاري التحميل...</option>');

                    // Fetch stakeholders for selected type
                    $.ajax({
                        url: '@Url.Action("GetStakeholdersByType", "YarnTransactions")',
                        type: 'GET',
                        data: { typeId: typeId },
                        success: function(response) {
                            stakeholderSelect.empty().append('<option value="">اختر التاجر</option>');

                            if (response.success && response.data && response.data.length > 0) {
                                $.each(response.data, function(index, item) {
                                    stakeholderSelect.append('<option value="' + item.id + '">' + item.name + '</option>');
                                });
                                stakeholderSelect.prop('disabled', false);
                            } else {
                                stakeholderSelect.append('<option value="">لا توجد تجار لهذا النوع</option>');
                                console.warn('No stakeholders found:', response.error || 'Unknown error');
                            }
                        },
                        error: function(xhr, status, error) {
                            console.error('Error fetching stakeholders:', error);
                            stakeholderSelect.empty()
                                           .append('<option value="">خطأ في تحميل التجار</option>')
                                           .prop('disabled', false);
                        }
                    });
                } else {
                    // Reset stakeholder dropdown
                    stakeholderSelect.empty()
                                   .append('<option value="">اختر التاجر</option>')
                                   .prop('disabled', true);
                }
            });

            // Clear filters button
            $('#clearFilters').click(function() {
                $('form')[0].reset();
                $('#StakeholderId').empty()
                                  .append('<option value="">اختر التاجر</option>')
                                  .prop('disabled', true);

                // Set default dates
                var today = new Date();
                var thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(today.getDate() - 30);

                $('#FromDate').val(thirtyDaysAgo.toISOString().split('T')[0]);
                $('#ToDate').val(today.toISOString().split('T')[0]);
            });

            // Date validation
            $('#FromDate, #ToDate').change(function() {
                var fromDate = $('#FromDate').val();
                var toDate = $('#ToDate').val();

                if (fromDate && toDate && fromDate > toDate) {
                    alert('تاريخ البداية يجب أن يكون أقل من تاريخ النهاية');
                    $(this).focus();
                }
            });

            // Initialize tooltips
            $('[title]').tooltip();
        });

        // Export functions
        function exportToExcel() {
            // Create a form to submit search criteria for Excel export
            var form = $('<form>', {
                method: 'POST',
                action: '@Url.Action("ExportToExcel", "YarnTransactions")'
            });

            // Add anti-forgery token
            form.append($('@Html.AntiForgeryToken()'));

            // Add search parameters
            var formData = $('form').serializeArray();
            $.each(formData, function(i, field) {
                form.append($('<input>', {
                    type: 'hidden',
                    name: field.name,
                    value: field.value
                }));
            });

            form.appendTo('body').submit().remove();
        }

        function printResults() {
            window.print();
        }

        // Form validation
        (function() {
            'use strict';
            window.addEventListener('load', function() {
                var forms = document.getElementsByClassName('needs-validation');
                var validation = Array.prototype.filter.call(forms, function(form) {
                    form.addEventListener('submit', function(event) {
                        if (form.checkValidity() === false) {
                            event.preventDefault();
                            event.stopPropagation();
                        }
                        form.classList.add('was-validated');
                    }, false);
                });
            }, false);
        })();
    </script>

    <style>
        .border-end {
            border-right: 1px solid #dee2e6 !important;
        }

        @@media (max-width: 576px) {
            .border-end

        {
            border-right: none !important;
            border-bottom: 1px solid #dee2e6 !important;
            margin-bottom: 1rem;
            padding-bottom: 1rem;
        }

        }

        .table-responsive {
            border-radius: 0.375rem;
            box-shadow: 0 0.125rem 0.25rem rgba(0, 0, 0, 0.075);
        }

        .btn-group-sm > .btn {
            padding: 0.25rem 0.5rem;
            font-size: 0.875rem;
        }

        @@media print {
            .btn, .card-header, .no-print

        {
            display: none !important;
        }

        .card {
            border: none !important;
            box-shadow: none !important;
        }

        .table {
            font-size: 12px;
        }

        }</style>
}