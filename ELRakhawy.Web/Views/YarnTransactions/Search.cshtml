@using ELRakhawy.EL.ViewModels
@model YarnTransactionSearchViewModel

@{
    ViewData["Title"] = "البحث في معاملات الغزل";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<style>
    /* ✅ Simple Arabic date and number styling */
    .arabic-input {
        direction: rtl;
        font-family: 'Arial', 'Tahoma', sans-serif;
    }

    .arabic-display {
        direction: rtl;
        font-family: 'Arial', 'Tahoma', sans-serif;
        unicode-bidi: bidi-override;
    }

    .date-input-arabic {
        direction: ltr; /* Keep LTR for date picker functionality */
        font-family: 'Arial', 'Tahoma', sans-serif;
    }

    /* ✅ Arabic date display below input */
    .arabic-date-display {
        background: #f8f9fa;
        border: 1px solid #dee2e6;
        border-radius: 0.375rem;
        padding: 0.25rem 0.5rem;
        font-size: 0.875rem;
        color: #495057;
        direction: rtl;
        font-family: 'Arial', 'Tahoma', sans-serif;
        margin-top: 0.25rem;
        min-height: 1.5rem;
    }

        .arabic-date-display.has-date {
            background: #e3f2fd;
            border-color: #2196f3;
            color: #1976d2;
            font-weight: 500;
        }

    /* Table styling for Arabic numbers */
    .table .arabic-cell {
        direction: rtl;
        font-family: 'Arial', 'Tahoma', sans-serif;
    }

    /* ID display styling */
    .id-display {
        font-family: 'Courier New', monospace;
        background-color: rgba(13, 110, 253, 0.1);
        padding: 2px 6px;
        border-radius: 4px;
        border: 1px solid rgba(13, 110, 253, 0.3);
        color: #0d6efd;
    }
</style>

<div class="container-fluid">
    <!-- Search Form -->
    <div class="card">
        <div class="card-header bg-primary text-white">
            <h4><i class="fas fa-search me-2"></i>البحث في معاملات الغزل</h4>
            <small class="opacity-75">البحث بالتاريخ الميلادي مع عرض الأرقام العربية</small>
        </div>

        <div class="card-body">
            @using (Html.BeginForm("Search", "YarnTransactions", FormMethod.Post, new { @class = "needs-validation", @id = "searchForm" }))
            {
                @Html.AntiForgeryToken()

                <div class="row g-3">
                    <!-- ✅ Simple Date Range with Arabic Display -->
                    <div class="col-md-3">
                        <label for="FromDate" class="form-label">
                            <i class="fas fa-calendar-alt text-primary me-1"></i>من تاريخ
                        </label>
                        @Html.TextBoxFor(m => m.FromDate, "{0:yyyy-MM-dd}", new {
                        @class = "form-control date-input-arabic",
                                        @type = "date",
                                        @id = "FromDate"
                                        })
                    <div class="arabic-date-display" id="fromDateArabic">
                        <i class="fas fa-calendar-alt me-1"></i>اختر التاريخ
                    </div>
                </div>

                <div class="col-md-3">
                    <label for="ToDate" class="form-label">
                        <i class="fas fa-calendar-alt text-primary me-1"></i>إلى تاريخ
                    </label>
                    @Html.TextBoxFor(m => m.ToDate, "{0:yyyy-MM-dd}", new {
                                        @class = "form-control date-input-arabic",
                                        @type = "date",
                                        @id = "ToDate"
                                        })
                    <div class="arabic-date-display" id="toDateArabic">
                        <i class="fas fa-calendar-alt me-1"></i>اختر التاريخ
                    </div>
                </div>

                <!-- Internal ID Search -->
                <div class="col-md-3">
                    <label for="InternalId" class="form-label">
                        <i class="fas fa-file-alt text-info me-1"></i>رقم الإذن الداخلي
                    </label>
                    @Html.TextBoxFor(m => m.InternalId, new {
                                        @class = "form-control arabic-input",
                                        @placeholder = "أدخل رقم الإذن الداخلي",
                                        @id = "InternalId"
                                        })
                </div>

                <!-- External ID Search -->
                <div class="col-md-3">
                    <label for="ExternalId" class="form-label">
                        <i class="fas fa-external-link-alt text-warning me-1"></i>رقم الإذن الخارجي
                    </label>
                    @Html.TextBoxFor(m => m.ExternalId, new {
                                        @class = "form-control arabic-input",
                                        @placeholder = "أدخل رقم الإذن الخارجي",
                                        @id = "ExternalId"
                                        })
                </div>

                <!-- Transaction Type -->
                <div class="col-md-4">
                    <label for="TransactionType" class="form-label">
                        <i class="fas fa-exchange-alt text-primary me-1"></i>نوع المعاملة
                    </label>
                    @Html.DropDownListFor(m => m.TransactionType, new List<SelectListItem>
                                        {
                        new SelectListItem { Text = "جميع الأنواع", Value = "" },
                                        new SelectListItem { Text = "وارد", Value = "inbound" },
                                        new SelectListItem { Text = "صادر", Value = "outbound" }
                                        }, new { @class = "form-select", @id = "TransactionType" })
                </div>

                <!-- Yarn Item -->
                <div class="col-md-4">
                    <label for="YarnItemId" class="form-label">
                        <i class="fas fa-box text-primary me-1"></i>صنف الغزل
                    </label>
                    @Html.DropDownListFor(m => m.YarnItemId,
                                        new SelectList(Model.AvailableItems, "Value", "Text"),
                                        "اختر صنف الغزل",
                                        new { @class = "form-select", @id = "YarnItemId" })
                </div>

                <!-- Stakeholder -->
                <div class="col-md-4">
                    <label for="StakeholderId" class="form-label">
                        <i class="fas fa-user-tie text-primary me-1"></i>تاجر الغزل
                    </label>
                    @Html.DropDownListFor(m => m.StakeholderId,
                                        new SelectList(Model.YarnStakeholders, "Value", "Text"),
                                        "اختر تاجر الغزل",
                                        new { @class = "form-select", @id = "StakeholderId" })
                </div>
            </div>

            <!-- Advanced Filters -->
            <div class="mt-3">
                <button type="button" class="btn btn-outline-info btn-sm" data-bs-toggle="collapse" data-bs-target="#advancedFilters">
                    <i class="fas fa-cog me-1"></i>خيارات متقدمة
                </button>
            </div>

            <div class="collapse mt-3" id="advancedFilters">
                <div class="card card-body bg-light">
                    <div class="row g-3">
                        <!-- Packaging Style -->
                        <div class="col-md-4">
                            <label for="PackagingStyleId" class="form-label">
                                <i class="fas fa-cube text-success me-1"></i>نمط التعبئة
                            </label>
                            @Html.DropDownListFor(m => m.PackagingStyleId,
                                                        new SelectList(Model.PackagingStyles, "Value", "Text"),
                                                        "اختر نمط التعبئة",
                                                        new { @class = "form-select", @id = "PackagingStyleId" })
                        </div>

                        <!-- Quantity Range -->
                        <div class="col-md-4">
                            <label for="MinQuantity" class="form-label">
                                <i class="fas fa-weight text-success me-1"></i>أقل كمية (كجم)
                            </label>
                            @Html.TextBoxFor(m => m.MinQuantity, new {
                                                        @class = "form-control arabic-input",
                                                        @type = "number",
                                                        @step = "0.001",
                                                        @placeholder = "٠.٠",
                                                        @id = "MinQuantity"
                                                        })
                        </div>

                        <div class="col-md-4">
                            <label for="MaxQuantity" class="form-label">
                                <i class="fas fa-weight text-success me-1"></i>أعلى كمية (كجم)
                            </label>
                            @Html.TextBoxFor(m => m.MaxQuantity, new {
                                                        @class = "form-control arabic-input",
                                                        @type = "number",
                                                        @step = "0.001",
                                                        @placeholder = "٠.٠",
                                                        @id = "MaxQuantity"
                                                        })
                        </div>

                        <!-- Count Range -->
                        <div class="col-md-6">
                            <label for="MinCount" class="form-label">
                                <i class="fas fa-sort-numeric-up text-info me-1"></i>أقل عدد
                            </label>
                            @Html.TextBoxFor(m => m.MinCount, new {
                                                        @class = "form-control arabic-input",
                                                        @type = "number",
                                                        @placeholder = "٠",
                                                        @id = "MinCount"
                                                        })
                        </div>

                        <div class="col-md-6">
                            <label for="MaxCount" class="form-label">
                                <i class="fas fa-sort-numeric-up text-info me-1"></i>أعلى عدد
                            </label>
                            @Html.TextBoxFor(m => m.MaxCount, new {
                                                        @class = "form-control arabic-input",
                                                        @type = "number",
                                                        @placeholder = "٠",
                                                        @id = "MaxCount"
                                                        })
                        </div>

                        <!-- Comment Search -->
                        <div class="col-12">
                            <label for="CommentSearch" class="form-label">
                                <i class="fas fa-comment text-secondary me-1"></i>البحث في التعليقات
                            </label>
                            @Html.TextBoxFor(m => m.CommentSearch, new {
                                                        @class = "form-control",
                                                        @placeholder = "أدخل كلمة للبحث في التعليقات",
                                                        @id = "CommentSearch"
                                                        })
                        </div>
                    </div>
                </div>
            </div>

            <!-- Search Buttons -->
            <div class="mt-4">
                <div class="d-flex gap-2 flex-wrap">
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search me-1"></i>بحث
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="resetForm()">
                        <i class="fas fa-times me-1"></i>مسح
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="setToday()">
                        <i class="fas fa-calendar-day me-1"></i>اليوم
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="setThisWeek()">
                        <i class="fas fa-calendar-week me-1"></i>هذا الأسبوع
                    </button>
                    <button type="button" class="btn btn-outline-info" onclick="setThisMonth()">
                        <i class="fas fa-calendar-alt me-1"></i>هذا الشهر
                    </button>
                </div>
            </div>
                        }
        </div>
    </div>

    <!-- Results Section -->
    @if (ViewBag.SearchPerformed == true)
    {
        <div class="card mt-4">
            <div class="card-header bg-success text-white">
                <h5><i class="fas fa-list me-2"></i>نتائج البحث</h5>
            </div>

            <div class="card-body">
              

                @if (Model.Results != null && Model.Results.Any())
                {
                    <!-- Results Table -->
                    <div class="table-responsive">
                        <table class="table table-striped table-hover">
                            <thead class="table-primary">
                                <tr>
                                    <th>أرقام الإذن</th>
                                    <th>التاريخ</th>
                                    <th>صنف الغزل</th>
                                    <th>نوع المعاملة</th>
                                    <th>الكمية (كجم)</th>
                                    <th>العدد</th>
                                    <th>تاجر الغزل</th>
                                    <th>نمط التعبئة</th>
                                    <th>الرصيد</th>
                                    <th>ملاحظات</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.Results)
                                {
                                    <tr>
                                        <td>
                                            @if (!string.IsNullOrEmpty(item.InternalId))
                                            {
                                                <div class="id-display mb-1">
                                                    <i class="fas fa-file-alt me-1"></i>
                                                    <small>داخلي:</small> <span class="arabic-display">@item.InternalId</span>
                                                </div>
                                            }
                                            @if (!string.IsNullOrEmpty(item.ExternalId))
                                            {
                                                <div class="id-display">
                                                    <i class="fas fa-external-link-alt me-1"></i>
                                                    <small>خارجي:</small> <span class="arabic-display">@item.ExternalId</span>
                                                </div>
                                            }
                                            @if (string.IsNullOrEmpty(item.InternalId) && string.IsNullOrEmpty(item.ExternalId))
                                            {
                                                <span class="text-muted">غير محدد</span>
                                            }
                                        </td>
                                        <td class="arabic-display">@item.Date.ToString("dd/MM/yyyy HH:mm")</td>
                                        <td>
                                            <strong>@item.YarnItemName</strong>
                                            @if (!string.IsNullOrEmpty(item.OriginYarnName))
                                            {
                                                <br>
                                
                                                <small class="text-muted">@item.OriginYarnName</small>
                                            }
                                        </td>
                                        <td>
                                            @if (item.IsInbound)
                                            {
                                                <span class="badge bg-success"><i class="fas fa-arrow-down me-1"></i>وارد</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-danger"><i class="fas fa-arrow-up me-1"></i>صادر</span>
                                            }
                                        </td>
                                        <td class="@(item.IsInbound ? "text-success" : "text-danger") fw-bold arabic-cell">
                                            @item.Quantity.ToString("N2")
                                        </td>
                                        <td class="fw-bold arabic-cell">@item.Count</td>
                                        <td>
                                            <strong>@item.StakeholderName</strong>
                                            <br><small class="text-muted">@item.StakeholderTypeName</small>
                                        </td>
                                        <td>@item.PackagingStyleName</td>
                                        <td>
                                            <small class="text-muted">كمية:</small> <span class="arabic-cell">@item.QuantityBalance.ToString("N2")</span><br>
                                            <small class="text-muted">عدد:</small> <span class="arabic-cell">@item.CountBalance</span>
                                        </td>
                                        <td>
                                            @if (!string.IsNullOrEmpty(item.Comment))
                                            {
                                                <span title="@item.Comment">
                                                    @(item.Comment.Length > 30 ? item.Comment.Substring(0, 30) + "..." : item.Comment)
                                                </span>
                                            }
                                            else
                                            {
                                                <span class="text-muted">-</span>
                                            }
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle me-2"></i>
                        لم يتم العثور على معاملات تطابق معايير البحث المحددة.
                    </div>
                }
            </div>
        </div>
    }
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            console.log('🗓️ Simple Arabic Date System Loading...');
            console.log('👤 User: Ammar-Yasser8 | Time: 2025-10-11 12:38:59');

            // ✅ Arabic/Latin conversion functions
            function toArabicDigits(str) {
                if (typeof str !== 'string') str = str.toString();
                return str.replace(/[0-9]/g, d => '٠١٢٣٤٥٦٧٨٩'[d]);
            }

            function toLatinDigits(str) {
                if (typeof str !== 'string') str = str.toString();
                return str.replace(/[٠-٩]/g, d => '0123456789'['٠١٢٣٤٥٦٧٨٩'.indexOf(d)]);
            }

            // ✅ Format date to Arabic display
            function formatDateToArabic(dateStr) {
                if (!dateStr) return '';

                try {
                    const date = new Date(dateStr);
                    const day = String(date.getDate()).padStart(2, '0');
                    const month = String(date.getMonth() + 1).padStart(2, '0');
                    const year = date.getFullYear();

                    const formattedDate = `${day}/${month}/${year}`;
                    return toArabicDigits(formattedDate);
                } catch (error) {
                    console.error('Date formatting error:', error);
                    return toArabicDigits(dateStr);
                }
            }

            // ✅ Update Arabic date display
            function updateArabicDateDisplay(inputId, displayId) {
                const dateValue = $(`#${inputId}`).val();
                const $display = $(`#${displayId}`);

                if (dateValue) {
                    const arabicDate = formatDateToArabic(dateValue);
                    $display.html(`<i class="fas fa-calendar-check me-1 text-success"></i>${arabicDate}`)
                           .addClass('has-date');
                } else {
                    $display.html('<i class="fas fa-calendar-alt me-1"></i>اختر التاريخ')
                           .removeClass('has-date');
                }
            }

            // ✅ Date change handlers
            $('#FromDate').on('change', function() {
                updateArabicDateDisplay('FromDate', 'fromDateArabic');
                console.log('From date changed:', $(this).val());
            });

            $('#ToDate').on('change', function() {
                updateArabicDateDisplay('ToDate', 'toDateArabic');
                console.log('To date changed:', $(this).val());
            });

            // ✅ Real-time Arabic display for number inputs
            $('.arabic-input').on('input', function() {
                const cursorPos = this.selectionStart;
                const originalValue = $(this).val();
                const arabicValue = toArabicDigits(originalValue);

                if (originalValue !== arabicValue) {
                    $(this).val(arabicValue);
                    try {
                        this.setSelectionRange(cursorPos, cursorPos);
                    } catch (ex) {
                        // Ignore cursor positioning errors
                    }
                }
            });

            // ✅ Form submission with conversion
            $('#searchForm').on('submit', function(e) {
                console.log('🔄 Form submission - converting Arabic numbers to Latin');

                // Convert Arabic numbers to Latin before submission
                $('.arabic-input').each(function() {
                    const originalValue = $(this).val();
                    const latinValue = toLatinDigits(originalValue);

                    if (originalValue !== latinValue) {
                        console.log('Converting:', originalValue, '→', latinValue);
                        $(this).val(latinValue);
                    }
                });

                // Show loading state
                const submitBtn = $(this).find('button[type="submit"]');
                const originalText = submitBtn.html();
                submitBtn.prop('disabled', true)
                       .html('<span class="spinner-border spinner-border-sm me-2"></span>جاري البحث...');

                // Re-enable button after form processes
                setTimeout(() => {
                    submitBtn.prop('disabled', false).html(originalText);
                }, 3000);

                console.log('✅ Form ready for submission');
            });

            // ✅ Convert display elements to Arabic
            function convertDisplayToArabic() {
                $('.arabic-display').each(function() {
                    if (!$(this).is('input, textarea, select')) {
                        const originalText = $(this).text();
                        const arabicText = toArabicDigits(originalText);
                        $(this).text(arabicText);
                    }
                });

                $('.arabic-cell').each(function() {
                    const originalText = $(this).text();
                    const arabicText = toArabicDigits(originalText);
                    $(this).text(arabicText);
                });
            }

            // ✅ Quick date functions
            window.setToday = function() {
                const today = new Date().toISOString().split('T')[0];
                $('#FromDate, #ToDate').val(today).trigger('change');
                console.log('✅ Set to today:', today);
            };

            window.setThisWeek = function() {
                const today = new Date();
                const firstDay = new Date(today.setDate(today.getDate() - today.getDay()));
                const lastDay = new Date();

                $('#FromDate').val(firstDay.toISOString().split('T')[0]).trigger('change');
                $('#ToDate').val(lastDay.toISOString().split('T')[0]).trigger('change');
                console.log('✅ Set to this week');
            };

            window.setThisMonth = function() {
                const today = new Date();
                const firstDay = new Date(today.getFullYear(), today.getMonth(), 1);
                const lastDay = new Date();

                $('#FromDate').val(firstDay.toISOString().split('T')[0]).trigger('change');
                $('#ToDate').val(lastDay.toISOString().split('T')[0]).trigger('change');
                console.log('✅ Set to this month');
            };

            // ✅ Reset function
            window.resetForm = function() {
                $('#searchForm')[0].reset();

                // Reset date displays
                $('#fromDateArabic, #toDateArabic')
                    .html('<i class="fas fa-calendar-alt me-1"></i>اختر التاريخ')
                    .removeClass('has-date');

                // Set default dates (last 30 days)
                const today = new Date();
                const thirtyDaysAgo = new Date();
                thirtyDaysAgo.setDate(today.getDate() - 30);

                $('#FromDate').val(thirtyDaysAgo.toISOString().split('T')[0]).trigger('change');
                $('#ToDate').val(today.toISOString().split('T')[0]).trigger('change');

                console.log('✅ Form reset with default dates');
            };

            // ✅ Initialize page
            convertDisplayToArabic();

            // Set initial dates and update displays
            const today = new Date();
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(today.getDate() - 30);

            $('#FromDate').val(thirtyDaysAgo.toISOString().split('T')[0]);
            $('#ToDate').val(today.toISOString().split('T')[0]);

            // Update Arabic displays for initial dates
            updateArabicDateDisplay('FromDate', 'fromDateArabic');
            updateArabicDateDisplay('ToDate', 'toDateArabic');

            console.log('✅ Simple Arabic Date System Ready!');
            console.log('📅 Features: Normal calendar with Arabic number display');
        });
    </script>
}