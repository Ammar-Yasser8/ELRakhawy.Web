@using ELRakhawy.EL.ViewModels
@model YarnOverviewViewModel

@{
    ViewData["Title"] = "نظرة عامة على أرصدة الغزل";
    Layout = "~/Views/Shared/_Layout.cshtml";
    var currentTime = "2025-09-04 18:39:33"; // ✅ Updated to current time
    var currentUser = "Ammar-Yasser8";
}

<div class="container-fluid">
    <!-- Header Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center">
                <h2 class="text-primary mb-0">
                    <i class="fas fa-chart-line me-2"></i>
                    نظرة عامة على أرصدة الغزل
                </h2>
                <div class="d-flex gap-2">
                    <button type="button" class="btn btn-outline-primary" onclick="refreshData()">
                        <i class="fas fa-sync-alt me-1"></i>
                        تحديث
                    </button>
                    <div class="dropdown">
                        <button class="btn btn-success dropdown-toggle" type="button" data-bs-toggle="dropdown">
                            <i class="fas fa-download me-1"></i>
                            تصدير ومشاركة
                        </button>
                        <ul class="dropdown-menu">
                            <li>
                                <button class="dropdown-item" onclick="exportToExcel()">
                                    <i class="fas fa-file-excel me-2 text-success"></i>
                                    تصدير إلى Excel
                                </button>
                            </li>
                            <li>
                                <button class="dropdown-item" onclick="shareWhatsApp()">
                                    <i class="fab fa-whatsapp me-2 text-success"></i>
                                    مشاركة عبر واتساب
                                </button>
                            </li>
                            <li><hr class="dropdown-divider"></li>
                            <li>
                                <button class="dropdown-item" onclick="printOverview()">
                                    <i class="fas fa-print me-2"></i>
                                    طباعة
                                </button>
                            </li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

  
    <!-- Filters and Controls -->
    <div class="row mb-3">
        <div class="col-12">
            <div class="card">
                <div class="card-body py-2">
                    <div class="d-flex justify-content-between align-items-center flex-wrap gap-2">
                        <div class="d-flex align-items-center gap-3">
                            <div class="form-check form-switch">
                                <input class="form-check-input" type="checkbox" id="availableOnlyFilter"
                                       @(Model.AvailableOnly ? "checked" : "") onchange="toggleAvailableFilter()">
                                <label class="form-check-label" for="availableOnlyFilter">
                                    <i class="fas fa-filter me-1"></i>
                                    المتاح فقط
                                </label>
                            </div>

                            <div class="input-group" style="width: 250px;">
                                <input type="text" class="form-control" id="searchInput"
                                       placeholder="البحث في الأصناف..." onkeyup="filterItems()">
                                <span class="input-group-text">
                                    <i class="fas fa-search"></i>
                                </span>
                            </div>
                        </div>

                        <div class="d-flex align-items-center gap-2">
                            <small class="text-muted">
                                آخر تحديث: <span id="lastUpdatedDisplay">@Model.LastUpdated.ToString("dd/MM/yyyy HH:mm")</span>
                            </small>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Overview Table with Enhanced Display -->
    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-body p-0">
                    <div class="table-responsive">
                        <table class="table table-hover mb-0" id="overviewTable">
                            <thead class="table-dark sticky-top">
                                <tr>
                                    <th>صنف الغزل</th>
                                    <th>الغزل الأصلي</th>
                                    <th>الشركة المصنعة</th>
                                    <th>رصيد العدد والتعبئة</th>
                                    <th>الحالة</th>
                                    <th>إجمالي المعاملات</th>
                                    <th>آخر معاملة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody>
                                @foreach (var item in Model.OverviewItems)
                                {
                                    <tr class="yarn-item-row" data-yarn-id="@item.YarnItemId"
                                        data-available="@item.IsAvailable.ToString().ToLower()"
                                        data-search-text="@($"{item.YarnItemName} {item.OriginYarnName} {item.ManufacturerNames}".ToLower())">
                                        <td>
                                            <div class="d-flex align-items-center">
                                                <div class="me-2">
                                                    @if (item.IsAvailable)
                                                    {
                                                        <div class="bg-success rounded-circle" style="width: 10px; height: 10px;" title="متاح"></div>
                                                    }
                                                    else
                                                    {
                                                        <div class="bg-danger rounded-circle" style="width: 10px; height: 10px;" title="غير متاح"></div>
                                                    }
                                                </div>
                                                <div>
                                                    <strong>@item.YarnItemName</strong>
                                                    <small class="d-block text-muted">ID: @item.YarnItemId</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <div class="text-info fw-bold">@(item.OriginYarnName ?? "غير محدد")</div>
                                        </td>
                                        <td>
                                            <small class="text-muted">@(item.ManufacturerNames ?? "غير محدد")</small>
                                        </td>
                                        
                                        <td>
                                            <div class="count-balance-cell" data-yarn-id="@item.YarnItemId">
                                                <div class="d-flex align-items-center justify-content-center">
                                                    <div class="spinner-border spinner-border-sm text-primary me-2" role="status">
                                                        <span class="visually-hidden">جاري التحميل...</span>
                                                    </div>
                                                    <small class="text-muted">جاري التحميل...</small>
                                                </div>
                                            </div>
                                        </td>
                                        <td>
                                            <span class="badge @(item.IsAvailable ? "bg-success" : "bg-danger") fs-6">
                                                @if (item.IsAvailable)
                                                {
                                                    <i class="fas fa-check-circle me-1"></i>

                                                    @:متاح
                                                }
                                                else
                                                {
                                                    <i class="fas fa-times-circle me-1"></i>

                                                    @:غير متاح
                                                }
                                            </span>
                                        </td>
                                        <td>
                                            <div class="text-center">
                                                <span class="fw-bold d-block transaction-count">@item.TotalTransactions</span>
                                                @if (item.TotalTransactions > 0)
                                                {
                                                    <div class="d-flex justify-content-center gap-2 mt-1">
                                                        <small class="text-success">
                                                            <i class="fas fa-arrow-down me-1"></i>
                                                            <span class="inbound-count">@item.InboundTransactions</span>
                                                        </small>
                                                        <small class="text-danger">
                                                            <i class="fas fa-arrow-up me-1"></i>
                                                            <span class="outbound-count">@item.OutboundTransactions</span>
                                                        </small>
                                                    </div>
                                                }
                                            </div>
                                        </td>
                                        <td>
                                            @if (item.LastTransactionDate.HasValue)
                                            {
                                                <div class="text-center">
                                                    <span class="fw-bold last-transaction-date">@item.LastTransactionText</span>
                                                    @if (item.DaysSinceLastTransaction >= 0)
                                                    {
                                                        <small class="d-block text-muted">
                                                            منذ <span class="days-since">@item.DaysSinceLastTransaction</span> يوم
                                                        </small>
                                                    }
                                                </div>
                                            }
                                            else
                                            {
                                                <span class="text-muted">لا توجد معاملات</span>
                                            }
                                        </td>
                                        <td>
                                            <div class="btn-group btn-group-sm">
                                                <button type="button" class="btn btn-outline-info" title="عرض التفاصيل"
                                                        onclick="viewItemDetails(@item.YarnItemId, '@item.YarnItemName')">
                                                    <i class="fas fa-info-circle"></i>
                                                </button>
                                                <a href="@Url.Action("Search", "YarnTransactions", new { YarnItemId = item.YarnItemId })"
                                                   class="btn btn-outline-primary" title="البحث في المعاملات">
                                                    <i class="fas fa-search"></i>
                                                </a>
                                                @if (item.IsAvailable)
                                                {
                                                    <a href="@Url.Action("Outbound", "YarnTransactions", new { YarnItemId = item.YarnItemId })"
                                                       class="btn btn-outline-warning" title="إنشاء معاملة صادر">
                                                        <i class="fas fa-arrow-up"></i>
                                                    </a>
                                                }
                                                <a href="@Url.Action("Inbound", "YarnTransactions", new { YarnItemId = item.YarnItemId })"
                                                   class="btn btn-outline-success" title="إنشاء معاملة وارد">
                                                    <i class="fas fa-arrow-down"></i>
                                                </a>
                                            </div>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    @if (!Model.OverviewItems.Any())
    {
        <div class="row mt-4">
            <div class="col-12">
                <div class="alert alert-info text-center">
                    <i class="fas fa-info-circle fa-2x mb-3"></i>
                    <h5>لا توجد أصناف غزل</h5>
                    <p>لم يتم العثور على أي أصناف غزل نشطة في النظام.</p>
                    <a href="@Url.Action("Create", "YarnItems")" class="btn btn-primary">
                        <i class="fas fa-plus me-1"></i>
                        إضافة صنف جديد
                    </a>
                </div>
            </div>
        </div>
    }
</div>

<!-- Item Details Modal -->
<div class="modal fade" id="itemDetailsModal" tabindex="-1" aria-labelledby="itemDetailsModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-xl">
        <div class="modal-content">
            <div class="modal-header bg-primary text-white">
                <h5 class="modal-title" id="itemDetailsModalLabel">
                    <i class="fas fa-info-circle me-2"></i>
                    تفاصيل صنف الغزل
                </h5>
                <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body" id="modalBody">
                <div class="text-center py-4">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">جاري التحميل...</span>
                    </div>
                </div>
            </div>
            <!-- Updated Modal Footer with Export Button -->
            <div class="modal-footer">
                <div class="d-flex justify-content-between align-items-center w-100">
                    <!-- Left side - Export and additional actions -->
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-success btn-sm" onclick="exportTransactionsToExcel()" title="تصدير المعاملات إلى Excel">
                            <i class="fas fa-file-excel me-1"></i>
                            تصدير Excel
                        </button>
                        <button type="button" class="btn btn-info btn-sm" onclick="printTransactions()" title="طباعة المعاملات">
                            <i class="fas fa-print me-1"></i>
                            طباعة
                        </button>
                    </div>

                    <!-- Right side - Main actions -->
                    <div class="d-flex gap-2">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            <i class="fas fa-times me-1"></i>
                            إغلاق
                        </button>
                        <button type="button" class="btn btn-warning" onclick="location.href='@Url.Action("ResetPackagingBalance", "YarnTransactions")'">
                            <i class="fas fa-sync-alt me-1"></i>
                            إعادة ضبط الرصيد
                        </button>
                        <button type="button" class="btn btn-primary" id="seeMoreBtn" onclick="seeMoreTransactions()">
                            <i class="fas fa-eye me-1"></i>
                            عرض المزيد
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Loading Overlay -->
<div id="loadingOverlay" class="loading-overlay" style="display: none;">
    <div class="spinner-border text-primary" role="status">
        <span class="visually-hidden">جاري التحميل...</span>
    </div>
</div>
@section Scripts {
    <script>
      // ================================
// CONFIGURATION & CONSTANTS
// ================================
const CONFIG = {
    CURRENT_TIME: '2025-09-04 19:04:16',
    CURRENT_USER: 'Ammar-Yasser8',
    PAGE_SIZE: 10,
    AJAX_TIMEOUT: 15000,
    PACKAGING_AJAX_TIMEOUT: 10000,
    AUTO_REFRESH_INTERVAL: 300000,
    MAX_TRANSACTION_DISPLAY: 10,
    MAX_WHATSAPP_ITEMS: 10,
    MAX_WHATSAPP_LENGTH: 4000
};

const ARABIC_DIGITS = '٠١٢٣٤٥٦٧٨٩';
const LATIN_DIGITS = '0123456789';

// ================================
// STATE MANAGEMENT
// ================================
const AppState = {
    currentYarnItemId: 0,
    currentPage: 1,
    currentRequest: null,
    loadingPackaging: new Set(),
    
    setCurrentYarnItem(id) {
        this.currentYarnItemId = id;
        this.currentPage = 1;
    },
    
    reset() {
        this.currentYarnItemId = 0;
        this.currentPage = 1;
        this.abortCurrentRequest();
    },
    
    abortCurrentRequest() {
        if (this.currentRequest) {
            this.currentRequest.abort();
            this.currentRequest = null;
        }
    },
    
    isLoadingPackaging(yarnItemId) {
        return this.loadingPackaging.has(yarnItemId);
    },
    
    addLoadingPackaging(yarnItemId) {
        this.loadingPackaging.add(yarnItemId);
    },
    
    removeLoadingPackaging(yarnItemId) {
        this.loadingPackaging.delete(yarnItemId);
    }
};

// ================================
// UTILITY FUNCTIONS
// ================================
const Utils = {
    toArabicDigits(str) {
        if (typeof str !== 'string') str = str.toString();
        return str.replace(/[0-9]/g, d => ARABIC_DIGITS[d]);
    },

    toLatinDigits(str) {
        if (typeof str !== 'string') str = str.toString();
        return str.replace(/[٠-٩]/g, d => LATIN_DIGITS[ARABIC_DIGITS.indexOf(d)]);
    },

    escapeHtml(text) {
        return $('<div>').text(text).html();
    },

    formatDate(date, format = 'short') {
        const d = new Date(date);
        if (format === 'short') {
            return d.toLocaleDateString('ar-EG');
        }
        return d.toLocaleDateString('ar-EG', {
            year: 'numeric',
            month: 'long',
            day: 'numeric',
            hour: '2-digit',
            minute: '2-digit'
        });
    },

    isToday(date) {
        const today = new Date();
        const checkDate = new Date(date);
        return today.toDateString() === checkDate.toDateString();
    },

    debounce(func, wait) {
        let timeout;
        return function executedFunction(...args) {
            const later = () => {
                clearTimeout(timeout);
                func(...args);
            };
            clearTimeout(timeout);
            timeout = setTimeout(later, wait);
        };
    },

    log(message, data = null) {
        const timestamp = new Date().toLocaleString('ar-EG');
        if (data) {
            console.log(`[${timestamp}] ${message}`, data);
        } else {
            console.log(`[${timestamp}] ${message}`);
        }
    },

    logError(message, error) {
        const timestamp = new Date().toLocaleString('ar-EG');
        console.error(`[${timestamp}] ❌ ${message}`, error);
    }
};

// ================================
// NUMBER CONVERSION MODULE
// ================================
const NumberConverter = {
    convertPageNumbers() {
        const selectors = [
            '#totalItemsDisplay',
            '#availableItemsDisplay',
            '#totalQuantityDisplay',
            '#totalCountDisplay',
            '#percentageDisplay',
            '#lastUpdatedDisplay'
        ];

        selectors.forEach(selector => {
            const $element = $(selector);
            if ($element.length) {
                $element.text(Utils.toArabicDigits($element.text()));
            }
        });

        // Convert table numbers
        $('.quantity-balance, .transaction-count, .inbound-count, .outbound-count, .last-transaction-date, .days-since').each(function() {
            $(this).text(Utils.toArabicDigits($(this).text()));
        });

        // Handle Transaction IDs - keep them in Latin
        $('.transaction-id').each(function() {
            const text = $(this).text();
            if (!this.isTransactionId(text)) {
                $(this).text(Utils.toArabicDigits(text));
            } else {
                $(this).addClass('copyable-id');
            }
        });
    },

    isTransactionId(text) {
        // Transaction IDs typically have specific patterns
        return /^[A-Z]{2,}-\d+$|^TXN-\d+$|^\d{6,}$/.test(text);
    }
};

// ================================
// PACKAGING BREAKDOWN MODULE
// ================================
const PackagingModule = {
    loadAll() {
        Utils.log('📦 Starting to load all packaging breakdowns');
        
        $('.count-balance-cell').each(function() {
            const $cell = $(this);
            const yarnItemId = $cell.data('yarn-id');
            
            if (yarnItemId && !AppState.isLoadingPackaging(yarnItemId)) {
                // Add small delay between requests to prevent overwhelming server
                setTimeout(() => {
                    PackagingModule.loadSingle(yarnItemId, $cell);
                }, Math.random() * 500);
            }
        });
    },

    loadSingle(yarnItemId, $targetCell) {
        if (AppState.isLoadingPackaging(yarnItemId)) {
            Utils.log(`⏳ Already loading packaging for yarn item ${yarnItemId}`);
            return;
        }

        AppState.addLoadingPackaging(yarnItemId);

        $.ajax({
            url: '/YarnTransactions/GetYarnItemBalance',
            type: 'GET',
            data: { yarnItemId: yarnItemId },
            timeout: CONFIG.PACKAGING_AJAX_TIMEOUT,
            beforeSend: function() {
                $targetCell.html(`
                    <div class="text-center py-2">
                        <span class="spinner-border spinner-border-sm text-primary me-1"></span>
                        <small class="text-muted">جاري التحميل...</small>
                    </div>
                `);
            },
            success: function(response) {
                if (response && response.success) {
                    PackagingModule.render(response, $targetCell);
                    Utils.log(`✅ Packaging loaded for yarn item ${yarnItemId}`);
                } else {
                    PackagingModule.showError($targetCell, response?.error || 'لا توجد بيانات', yarnItemId);
                }
            },
            error: function(xhr, status, error) {
                let errorMessage = 'خطأ في التحميل';
                
                if (status === 'timeout') {
                    errorMessage = 'انتهت مهلة التحميل';
                } else if (xhr.status === 404) {
                    errorMessage = 'الصنف غير موجود';
                } else if (xhr.status === 500) {
                    errorMessage = 'خطأ في الخادم';
                }

                Utils.logError(`Error loading packaging for yarn item ${yarnItemId}`, {
                    status, error, statusCode: xhr.status
                });

                PackagingModule.showError($targetCell, errorMessage, yarnItemId);
            },
            complete: function() {
                AppState.removeLoadingPackaging(yarnItemId);
            }
        });
    },

    render(data, $targetCell) {
        let html = '';

        if (!data.packagingBreakdown || data.packagingBreakdown.length === 0) {
            html = PackagingModule.renderEmpty(data);
        } else {
            const positivePackaging = data.packagingBreakdown.filter(pkg => pkg.specificWeight > 0 || pkg.totalCount > 0);
            const negativePackaging = data.packagingBreakdown.filter(pkg => pkg.specificWeight < 0 || pkg.totalCount < 0);

            html = `
                <div class="packaging-display">
                    ${PackagingModule.renderSummary(data, negativePackaging.length > 0)}
                    ${PackagingModule.renderBreakdown(positivePackaging, negativePackaging)}
                    ${PackagingModule.renderInfo(data, positivePackaging.length, negativePackaging.length)}
                </div>
            `;
        }

        $targetCell.html(html);

        // Add click handler for detailed view
        if (data.packagingBreakdown && data.packagingBreakdown.length > 0) {
            $targetCell.addClass('clickable-cell').attr('title', 'انقر لعرض التفاصيل');
            $targetCell.off('click').on('click', function(e) {
                e.stopPropagation();
                PackagingModule.showDetailModal(data);
            });
        }
    },

    renderSummary(data, hasNegative) {
        const bgClass = hasNegative ? 'bg-danger bg-opacity-25 border-danger' : 'bg-light';
        
        return `
            <div class="balance-summary mb-2 p-2 ${bgClass} rounded">
                <div class="row text-center">
                    <div class="col-6">
                        <div class="fw-bold ${data.totalQuantityBalance < 0 ? 'text-danger' : 'text-primary'}">
                            ${Utils.toArabicDigits(data.totalQuantityBalance.toFixed(2))}
                        </div>
                        <small class="text-muted">كجم إجمالي</small>
                    </div>
                    <div class="col-6">
                        <div class="fw-bold ${data.totalCountBalance < 0 ? 'text-danger' : 'text-success'}">
                            ${Utils.toArabicDigits(data.totalCountBalance.toString())}
                        </div>
                        <small class="text-muted">وحدة إجمالي</small>
                    </div>
                </div>
                ${hasNegative ? `
                    <div class="alert alert-warning mb-0 mt-2 py-1 px-2 small">
                        <i class="fas fa-exclamation-triangle me-1"></i>
                        <strong>تحذير:</strong> يوجد أرصدة سالبة
                    </div>
                ` : ''}
            </div>
        `;
    },

    renderBreakdown(positivePackaging, negativePackaging) {
        let html = '<div class="packaging-breakdown">';
        html += '<div class="small text-info fw-semibold mb-1"><i class="fas fa-boxes me-1"></i>التفصيل:</div>';

        // Positive items
        if (positivePackaging.length > 0) {
            positivePackaging.forEach(pkg => {
                const bgClass = pkg.totalCount > 50 ? 'bg-success' :
                               pkg.totalCount > 20 ? 'bg-info' : 'bg-light text-dark border';
                
                html += `
                    <div class="packaging-item mb-1">
                        <span class="badge ${bgClass} me-1 d-inline-block" style="min-width: 120px;">
                            <i class="fas fa-cube me-1"></i>
                            ${Utils.toArabicDigits(pkg.totalCount.toString())} ${pkg.packagingType}
                        </span>
                        <div class="small text-success fw-bold mt-1">
                            ${Utils.toArabicDigits(pkg.specificWeight.toFixed(2))} كجم
                        </div>
                    </div>
                `;
            });
        }

        // Negative items
        if (negativePackaging.length > 0) {
            negativePackaging.forEach(pkg => {
                html += `
                    <div class="packaging-item mb-1 alert alert-danger py-2 px-2">
                        <span class="badge bg-danger me-1">
                            <i class="fas fa-exclamation-triangle me-1"></i>
                            ${Utils.toArabicDigits(pkg.totalCount.toString())} ${pkg.packagingType}
                        </span>
                        <div class="small text-danger fw-bold mt-1">
                            ${Utils.toArabicDigits(pkg.specificWeight.toFixed(2))} كجم
                            <span class="text-muted">(رصيد سالب!)</span>
                        </div>
                    </div>
                `;
            });
        }

        html += '</div>';
        return html;
    },

    renderInfo(data, positiveCount, negativeCount) {
        let html = '<div class="packaging-info mt-2">';

        if (data.packagingBreakdown.length > 1) {
            html += `
                <small class="text-info d-block">
                    <i class="fas fa-info-circle me-1"></i>
                    ${Utils.toArabicDigits(data.packagingBreakdown.length.toString())} نوع تعبئة
                </small>
            `;
        }

        if (!data.balanceMatches) {
            html += `
                <small class="text-warning d-block">
                    <i class="fas fa-exclamation-triangle me-1"></i>
                    تحذير: عدم تطابق في الحسابات
                </small>
            `;
        } else if (negativeCount === 0) {
            html += `
                <small class="text-success d-block">
                    <i class="fas fa-check-circle me-1"></i>
                    الحسابات متطابقة
                </small>
            `;
        }

        html += '</div>';
        return html;
    },

    renderEmpty(data) {
        if (data.totalCountBalance > 0 || data.totalQuantityBalance > 0) {
            return `
                <div class="text-center">
                    <div class="fw-bold text-success mb-1">
                        ${Utils.toArabicDigits(data.totalQuantityBalance.toFixed(2))} كجم
                    </div>
                    <div class="fw-bold text-primary mb-1">
                        ${Utils.toArabicDigits(data.totalCountBalance.toString())} وحدة
                    </div>
                    <small class="text-muted">غير محددة التعبئة</small>
                </div>
            `;
        }

        return `
            <div class="text-center text-muted p-2">
                <i class="fas fa-inbox fa-2x mb-2"></i>
                <div class="small">لا توجد وحدات</div>
                <div class="small">في المخزون</div>
            </div>
        `;
    },

    showError($targetCell, message, yarnItemId) {
        $targetCell.html(`
            <div class="text-center text-danger p-2">
                <i class="fas fa-exclamation-triangle fa-lg mb-1"></i>
                <div class="small fw-semibold">${message}</div>
                <button class="btn btn-outline-primary btn-sm mt-1" 
                        onclick="PackagingModule.loadSingle(${yarnItemId}, $(this).closest('td, div'))">
                    <i class="fas fa-redo-alt me-1"></i>إعادة المحاولة
                </button>
            </div>
        `);
    },

    showDetailModal(data) {
        const modalContent = `
            <div class="packaging-details-modal">
                <div class="row mb-3">
                    <div class="col-md-6">
                        <div class="card border-primary">
                            <div class="card-body text-center">
                                <h5 class="card-title text-primary">
                                    ${Utils.toArabicDigits(data.totalQuantityBalance.toFixed(3))}
                                </h5>
                                <p class="card-text">إجمالي الكمية (كجم)</p>
                            </div>
                        </div>
                    </div>
                    <div class="col-md-6">
                        <div class="card border-success">
                            <div class="card-body text-center">
                                <h5 class="card-title text-success">
                                    ${Utils.toArabicDigits(data.totalCountBalance.toString())}
                                </h5>
                                <p class="card-text">إجمالي العدد (وحدة)</p>
                            </div>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table class="table table-striped table-hover">
                        <thead class="table-primary">
                            <tr>
                                <th>نوع التعبئة</th>
                                <th>العدد</th>
                                <th>الوزن المحدد</th>
                                <th>متوسط الوزن</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${data.packagingBreakdown.map(pkg => `
                                <tr>
                                    <td><strong>${pkg.packagingType}</strong></td>
                                    <td class="text-center">
                                        <span class="badge bg-primary">
                                            ${Utils.toArabicDigits(pkg.totalCount.toString())} وحدة
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span class="fw-bold text-success">
                                            ${Utils.toArabicDigits(pkg.specificWeight.toFixed(2))} كجم
                                        </span>
                                    </td>
                                    <td class="text-center">
                                        <span class="text-info">
                                            ${Utils.toArabicDigits(pkg.averageWeightPerUnit.toFixed(3))} كجم/وحدة
                                        </span>
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                </div>
            </div>
        `;

        Swal.fire({
            title: 'تفاصيل المخزون',
            html: modalContent,
            showCloseButton: true,
            confirmButtonText: '<i class="fas fa-times me-1"></i>إغلاق',
            confirmButtonColor: '#6c757d',
            width: '800px'
        });
    }
};

// ================================
// MODAL MODULE
// ================================
const ModalModule = {
    open(yarnItemId, yarnItemName) {
        Utils.log(`🔍 Opening modal for yarn item ${yarnItemId}`);

        if (!yarnItemId || yarnItemId <= 0) {
            Utils.logError('Invalid yarn item ID', yarnItemId);
            alert('معرف الصنف غير صحيح');
            return;
        }

        AppState.setCurrentYarnItem(yarnItemId);

        const safeYarnItemName = Utils.escapeHtml(yarnItemName || 'صنف غير محدد');
        $('#itemDetailsModalLabel').html(`<i class="fas fa-info-circle me-2"></i>تفاصيل صنف الغزل: ${safeYarnItemName}`);

        const modalElement = document.getElementById('itemDetailsModal');
        if (!modalElement) {
            Utils.logError('Modal element not found');
            alert('خطأ: نافذة التفاصيل غير موجودة');
            return;
        }

        const modal = new bootstrap.Modal(modalElement, {
            backdrop: 'static',
            keyboard: true
        });
        modal.show();

        ModalModule.loadDetails();
    },

    loadDetails() {
        Utils.log(`🔄 Loading details for yarn item ${AppState.currentYarnItemId}`);

        AppState.abortCurrentRequest();

        $('#modalBody').html(`
            <div class="text-center py-5">
                <div class="spinner-border text-primary mb-3" style="width: 3rem; height: 3rem;">
                    <span class="visually-hidden">جاري التحميل...</span>
                </div>
                <h6 class="text-muted">جاري تحميل تفاصيل الصنف...</h6>
            </div>
        `);

        const startTime = performance.now();

        AppState.currentRequest = $.ajax({
            url: '/YarnTransactions/ItemDetails',
            type: 'GET',
            data: {
                id: AppState.currentYarnItemId,
                page: AppState.currentPage,
                pageSize: CONFIG.PAGE_SIZE
            },
            timeout: CONFIG.AJAX_TIMEOUT,
            success: function(response) {
                const duration = (performance.now() - startTime).toFixed(2);
                Utils.log(`✅ Details loaded in ${duration}ms`);

                if (response && response.success && response.yarnItem) {
                    ModalModule.renderDetails(response);
                } else {
                    ModalModule.showError(response?.message || 'بيانات الصنف غير متوفرة');
                }
            },
            error: function(xhr, status, error) {
                if (status === 'abort') return;

                let errorMessage = 'حدث خطأ أثناء تحميل البيانات';
                if (status === 'timeout') {
                    errorMessage = 'انتهت مهلة الاتصال. يرجى المحاولة مرة أخرى.';
                } else if (xhr.status === 500) {
                    errorMessage = 'خطأ في الخادم. يرجى المحاولة لاحقاً.';
                }

                Utils.logError('Failed to load details', { status, error, statusCode: xhr.status });
                ModalModule.showError(errorMessage);
            },
            complete: function() {
                AppState.currentRequest = null;
            }
        });
    },

    renderDetails(data) {
        const yarnItem = data.yarnItem;
        const transactions = data.transactions || [];
        const pagination = data.pagination;

        let html = ModalModule.renderSummary(yarnItem);

        if (transactions.length > 0) {
            html += ModalModule.renderTransactions(transactions, pagination);
        } else {
            html += ModalModule.renderNoTransactions();
        }

        $('#modalBody').html(html);
        $('[title]').tooltip();
    },

    renderSummary(yarnItem) {
        const yarnItemName = yarnItem.itemName || 'غير محدد';
        const originYarnName = yarnItem.originYarnName || 'غير محدد';
        const manufacturerName = yarnItem.manufacturerNames || 'غير محدد';

        return `
            <div class="row mb-4">
                <div class="col-12">
                    <div class="card border-primary shadow-sm">
                        <div class="card-header bg-primary text-white">
                            <h6 class="mb-0"><i class="fas fa-info me-2"></i>معلومات الصنف</h6>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-6">
                                    <div class="mb-3">
                                        <label class="fw-bold text-primary">اسم الصنف:</label>
                                        <span class="ms-2 fw-bold text-dark">${yarnItemName}</span>
                                    </div>
                                    <div class="mb-3">
                                        <label class="fw-bold text-primary">الغزل الأصلي:</label>
                                        <span class="ms-2 text-info fw-bold">${originYarnName}</span>
                                    </div>
                                    <div class="mb-3">
                                        <label class="fw-bold text-primary">الشركة المصنعة:</label>
                                        <span class="ms-2 text-success">${manufacturerName}</span>
                                    </div>
                                </div>
                                <div class="col-md-6">
                                    <div class="row text-center">
                                        <div class="col-6">
                                            <h4 class="mb-1 ${(yarnItem.quantityBalance || 0) >= 0 ? 'text-success' : 'text-danger'}">
                                                ${Utils.toArabicDigits(((yarnItem.quantityBalance || 0).toFixed(3)))}
                                            </h4>
                                            <small class="text-muted">رصيد الكمية (كجم)</small>
                                        </div>
                                        <div class="col-6">
                                            <h4 class="mb-1 ${(yarnItem.countBalance || 0) >= 0 ? 'text-success' : 'text-danger'}">
                                                ${Utils.toArabicDigits((yarnItem.countBalance || 0).toString())}
                                            </h4>
                                            <small class="text-muted">رصيد العدد</small>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `;
    },

    renderTransactions(transactions, pagination) {
        const safePageInfo = pagination || {
            CurrentPage: 1,
            TotalPages: 1,
            HasNextPage: false,
            HasPreviousPage: false
        };

        let html = `
            <div class="row">
                <div class="col-12">
                    <div class="card border-info shadow-sm">
                        <div class="card-header bg-info text-white">
                            <h6 class="mb-0"><i class="fas fa-history me-2"></i>المعاملات الأخيرة</h6>
                        </div>
                        <div class="card-body p-0">
                            <div class="table-responsive">
                                <table class="table table-hover table-sm mb-0">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>رقم المعاملة</th>
                                            <th>التاريخ</th>
                                            <th>النوع</th>
                                            <th>الكمية</th>
                                            <th>العدد</th>
                                            <th>التاجر</th>
                                            <th>رصيد الكمية</th>
                                            <th>ملاحظات</th>
                                        </tr>
                                    </thead>
                                    <tbody>
        `;

        transactions.forEach(transaction => {
            const transactionDate = new Date(transaction.date || transaction.Date);
            const isToday = Utils.isToday(transactionDate);

            html += `
                <tr>
                    <td>
                        <div class="fw-bold text-primary small">${transaction.transactionId || transaction.TransactionId}</div>
                    </td>
                    <td>
                        <div class="fw-bold small">${Utils.toArabicDigits(transactionDate.toLocaleDateString('ar-EG'))}</div>
                        ${isToday ? '<span class="badge bg-success ms-1">اليوم</span>' : ''}
                    </td>
                    <td>
                        <span class="badge rounded-pill ${(transaction.isInbound || transaction.IsInbound) ? 'bg-success' : 'bg-danger'} small">
                            ${(transaction.isInbound || transaction.IsInbound) ? 'وارد' : 'صادر'}
                        </span>
                    </td>
                    <td class="${(transaction.isInbound || transaction.IsInbound) ? 'text-success' : 'text-danger'} fw-bold small">
                        ${Utils.toArabicDigits(((transaction.quantity || transaction.Quantity || 0).toFixed(3)))}
                    </td>
                    <td class="fw-bold small">${Utils.toArabicDigits((transaction.count || transaction.Count || 0).toString())}</td>
                    <td><div class="fw-bold small">${transaction.stakeholderName || transaction.StakeholderName || 'غير محدد'}</div></td>
                    <td class="fw-bold text-primary small">${Utils.toArabicDigits(((transaction.quantityBalance || transaction.QuantityBalance || 0).toFixed(3)))}</td>
                    <td class="small">${transaction.comment || transaction.Comment || '-'}</td>
                </tr>
            `;
        });

        html += '</tbody></table></div></div></div></div></div>';

        // Pagination
        if (safePageInfo.TotalPages > 1) {
            html += '<div class="row mt-3"><div class="col-12"><nav><ul class="pagination pagination-sm justify-content-center mb-0">';
            
            if (safePageInfo.HasPreviousPage) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="ModalModule.loadPage(${safePageInfo.CurrentPage - 1}); return false;">السابق</a></li>`;
            }
            
            html += `<li class="page-item active"><span class="page-link">${Utils.toArabicDigits(safePageInfo.CurrentPage.toString())}</span></li>`;
            
            if (safePageInfo.HasNextPage) {
                html += `<li class="page-item"><a class="page-link" href="#" onclick="ModalModule.loadPage(${safePageInfo.CurrentPage + 1}); return false;">التالي</a></li>`;
            }
            
            html += '</ul></nav></div></div>';
        }

        return html;
    },

    renderNoTransactions() {
        return `
            <div class="row">
                <div class="col-12">
                    <div class="alert alert-info text-center py-4">
                        <i class="fas fa-info-circle fa-2x mb-3 text-info"></i>
                        <h6 class="mb-2">لا توجد معاملات</h6>
                        <p class="mb-0 text-muted small">لم يتم تسجيل أي معاملات لهذا الصنف حتى الآن.</p>
                    </div>
                </div>
            </div>
        `;
    },

    loadPage(page) {
        AppState.currentPage = page;
        ModalModule.loadDetails();
    },

    showError(message) {
        $('#modalBody').html(`
            <div class="alert alert-danger text-center py-4">
                <i class="fas fa-exclamation-triangle fa-3x mb-3 text-danger"></i>
                <h5 class="mb-2">حدث خطأ</h5>
                <p class="mb-3">${message}</p>
                <div class="d-flex gap-2 justify-content-center">
                    <button type="button" class="btn btn-primary btn-sm" onclick="ModalModule.loadDetails()">
                        <i class="fas fa-redo me-1"></i>إعادة المحاولة
                    </button>
                    <button type="button" class="btn btn-secondary btn-sm" data-bs-dismiss="modal">
                        <i class="fas fa-times me-1"></i>إغلاق
                    </button>
                </div>
            </div>
        `);
    }
};

// ================================
// EXPORT MODULE
// ================================
const ExportModule = {
    toExcel() {
        showLoadingOverlay();

        try {
            Utils.log('📊 Starting Excel export');
            const exportData = ExportModule.collectData();
            ExportModule.generateExcel(exportData);
        } catch (error) {
            Utils.logError('Excel export failed', error);
            alert('حدث خطأ أثناء تصدير البيانات: ' + error.message);
        } finally {
            setTimeout(hideLoadingOverlay, 1000);
        }
    },

    toExcelTransactions() {
        if (!AppState.currentYarnItemId) {
            alert('لا يوجد صنف محدد للتصدير');
            return;
        }

        showLoadingOverlay();

        try {
            Utils.log('📊 Starting transaction export');
            const exportData = ExportModule.collectModalData();
            ExportModule.generateTransactionExcel(exportData);
        } catch (error) {
            Utils.logError('Transaction export failed', error);
            alert('حدث خطأ أثناء تصدير بيانات المعاملات: ' + error.message);
        } finally {
            setTimeout(hideLoadingOverlay, 1000);
        }
    },

    collectData() {
        return {
            summary: {
                totalItems: Utils.toLatinDigits($('#totalItemsDisplay').text()),
                availableItems: Utils.toLatinDigits($('#availableItemsDisplay').text()),
                totalQuantity: Utils.toLatinDigits($('#totalQuantityDisplay').text().replace(/[^\d.,]/g, '')),
                totalCount: Utils.toLatinDigits($('#totalCountDisplay').text()),
                percentageAvailable: Utils.toLatinDigits($('#percentageDisplay').text().replace('%', '')),
                lastUpdated: Utils.toLatinDigits($('#lastUpdatedDisplay').text()),
                availableOnly: $('#availableOnlyFilter').is(':checked'),
                exportDate: new Date().toLocaleDateString('ar-EG'),
                exportTime: new Date().toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'}),
                exportedBy: CONFIG.CURRENT_USER
            },
            items: ExportModule.collectItems()
        };
    },

    collectItems() {
        const items = [];
        
        $('.yarn-item-row:visible').each(function() {
            const row = $(this);
            items.push({
                yarnItemId: row.data('yarn-id'),
                yarnItemName: row.find('td:first strong').text().trim(),
                originYarnName: row.find('td:nth-child(2) .text-info').text().trim() || 'غير محدد',
                manufacturerNames: row.find('td:nth-child(3) small').text().trim() || 'غير محدد',
                quantityBalance: Utils.toLatinDigits(row.find('.quantity-balance').text().trim()),
                countBalance: ExportModule.extractCountBalance(row.find('.count-balance-cell')),
                packagingBreakdown: ExportModule.extractPackagingBreakdown(row.find('.count-balance-cell')),
                isAvailable: row.data('available'),
                status: row.data('available') ? 'متاح' : 'غير متاح',
                totalTransactions: Utils.toLatinDigits(row.find('.transaction-count').text().trim()),
                inboundTransactions: Utils.toLatinDigits(row.find('.inbound-count').text().trim() || '0'),
                outboundTransactions: Utils.toLatinDigits(row.find('.outbound-count').text().trim() || '0'),
                lastTransactionDate: row.find('.last-transaction-date').text().trim() || 'لا توجد معاملات',
                daysSinceLastTransaction: Utils.toLatinDigits(row.find('.days-since').text().trim() || '0')
            });
        });
        
        return items;
    },

    extractCountBalance(cell) {
        const countText = cell.find('.fw-bold').text();
        return countText && countText.includes('وحدة') ? Utils.toLatinDigits(countText.replace(/[^\d]/g, '')) : '0';
    },

    extractPackagingBreakdown(cell) {
        const badges = cell.find('.badge');
        const breakdown = [];
        badges.each(function() {
            const text = $(this).text().trim();
            if (text) breakdown.push(Utils.toLatinDigits(text));
        });
        return breakdown.join(', ') || 'غير محددة';
    },

    collectModalData() {
        const modalTitle = $('#itemDetailsModalLabel').text();
        const yarnItemName = modalTitle.replace('تفاصيل صنف الغزل: ', '').replace(/.*: /, '');
        
        const data = {
            yarnItem: {
                id: AppState.currentYarnItemId,
                name: yarnItemName || 'غير محدد',
                quantityBalance: $('.card-body h4').first().text().trim(),
                countBalance: $('.card-body h4').last().text().trim()
            },
            transactions: [],
            summary: {
                exportDate: new Date().toLocaleDateString('ar-EG'),
                exportTime: new Date().toLocaleTimeString('ar-EG', {hour: '2-digit', minute: '2-digit'}),
                exportedBy: CONFIG.CURRENT_USER,
                currentPage: AppState.currentPage,
                pageSize: CONFIG.PAGE_SIZE
            }
        };

        $('#modalBody table tbody tr').each(function() {
            const cells = $(this).find('td');
            if (cells.length >= 8) {
                data.transactions.push({
                    transactionId: cells.eq(0).find('div').first().text().trim(),
                    internalId: cells.eq(0).find('small').text().replace('داخلي: ', '').trim() || '',
                    date: cells.eq(1).find('div').first().text().trim(),
                    time: cells.eq(1).find('small').text().trim(),
                    type: cells.eq(2).find('.badge').text().trim(),
                    quantity: Utils.toLatinDigits(cells.eq(3).text().trim()),
                    count: Utils.toLatinDigits(cells.eq(4).text().trim()),
                    stakeholder: cells.eq(5).find('div').text().trim(),
                    quantityBalance: Utils.toLatinDigits(cells.eq(6).text().trim()),
                    comment: cells.eq(7).text().trim() === '-' ? '' : cells.eq(7).text().trim()
                });
            }
        });

        return data;
    },

    generateExcel(data) {
        if (typeof XLSX === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
            script.onload = () => ExportModule.generateExcelWithLibrary(data);
            script.onerror = () => ExportModule.generateCSVFallback(data);
            document.head.appendChild(script);
        } else {
            ExportModule.generateExcelWithLibrary(data);
        }
    },

    generateExcelWithLibrary(data) {
        const workbook = XLSX.utils.book_new();

        // Summary sheet
        const summaryData = [
            ['نظرة عامة على أرصدة الغزل'],
            [''],
            ['تاريخ التصدير:', data.summary.exportDate],
            ['وقت التصدير:', data.summary.exportTime],
            ['تم التصدير بواسطة:', data.summary.exportedBy],
            [''],
            ['إجمالي الأصناف:', data.summary.totalItems],
            ['الأصناف المتاحة:', data.summary.availableItems],
            ['نسبة الأصناف المتاحة:', data.summary.percentageAvailable + '%']
        ];

        const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
        summarySheet['!cols'] = [{ width: 25 }, { width: 20 }];
        XLSX.utils.book_append_sheet(workbook, summarySheet, 'ملخص');

        // Items sheet
        const headers = ['معرف الصنف', 'اسم الصنف', 'الغزل الأصلي', 'الشركة المصنعة', 
                        'رصيد الكمية (كجم)', 'رصيد العدد', 'تفاصيل التعبئة', 'الحالة'];
        const itemsData = [headers];

        data.items.forEach(item => {
            itemsData.push([
                item.yarnItemId,
                item.yarnItemName,
                item.originYarnName,
                item.manufacturerNames,
                parseFloat(item.quantityBalance) || 0,
                parseInt(item.countBalance) || 0,
                item.packagingBreakdown,
                item.status
            ]);
        });

        const itemsSheet = XLSX.utils.aoa_to_sheet(itemsData);
        XLSX.utils.book_append_sheet(workbook, itemsSheet, 'تفاصيل الأصناف');

        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
        XLSX.writeFile(workbook, `ارصدة_الغزل_${timestamp}.xlsx`);

        setTimeout(() => alert('تم تصدير البيانات بنجاح!'), 500);
    },

    generateTransactionExcel(data) {
        if (typeof XLSX === 'undefined') {
            const script = document.createElement('script');
            script.src = 'https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js';
            script.onload = () => ExportModule.generateTransactionExcelWithLibrary(data);
            script.onerror = () => ExportModule.generateCSVFallback(data, true);
            document.head.appendChild(script);
        } else {
            ExportModule.generateTransactionExcelWithLibrary(data);
        }
    },

    generateTransactionExcelWithLibrary(data) {
        const workbook = XLSX.utils.book_new();

        // Summary sheet
        const summaryData = [
            ['تقرير معاملات صنف الغزل'],
            [''],
            ['معرف الصنف:', data.yarnItem.id],
            ['اسم الصنف:', data.yarnItem.name],
            [''],
            ['تاريخ التصدير:', data.summary.exportDate],
            ['عدد المعاملات:', data.transactions.length]
        ];

        const summarySheet = XLSX.utils.aoa_to_sheet(summaryData);
        XLSX.utils.book_append_sheet(workbook, summarySheet, 'ملخص');

        // Transactions sheet
        const headers = ['رقم المعاملة', 'التاريخ', 'النوع', 'الكمية (كجم)', 'العدد', 'الطرف المتعامل', 'رصيد الكمية', 'ملاحظات'];
        const transactionData = [headers];

        data.transactions.forEach(transaction => {
            transactionData.push([
                transaction.transactionId,
                transaction.date,
                transaction.type,
                parseFloat(transaction.quantity) || 0,
                parseInt(transaction.count) || 0,
                transaction.stakeholder,
                parseFloat(transaction.quantityBalance) || 0,
                transaction.comment
            ]);
        });

        const transactionSheet = XLSX.utils.aoa_to_sheet(transactionData);
        XLSX.utils.book_append_sheet(workbook, transactionSheet, 'المعاملات');

        const timestamp = new Date().toISOString().slice(0, 19).replace(/:/g, '-');
        const sanitizedName = data.yarnItem.name.replace(/[^\w\s-]/g, '').substring(0, 30);
        XLSX.writeFile(workbook, `معاملات_${sanitizedName}_${timestamp}.xlsx`);

        setTimeout(() => alert('تم تصدير معاملات الصنف بنجاح!'), 500);
    },

    generateCSVFallback(data, isTransaction = false) {
        Utils.log('Using CSV fallback for export');
        // CSV fallback implementation here if needed
        alert('التصدير بصيغة CSV - الرجاء استخدام متصفح حديث للحصول على ملفات Excel');
    }
};

// ================================
// FILTER MODULE
// ================================
const FilterModule = {
    init() {
        $('#searchInput').on('input', Utils.debounce(FilterModule.apply, 300));
        $('#availableOnlyFilter').on('change', FilterModule.toggleAvailable);
    },

    apply() {
        const searchTerm = $('#searchInput').val().toLowerCase();
        const availableOnly = $('#availableOnlyFilter').is(':checked');

        $('.yarn-item-row').each(function() {
            const row = $(this);
            const searchText = row.data('search-text');
            const isAvailable = row.data('available');

            let showRow = true;
            if (searchTerm && !searchText.includes(searchTerm)) showRow = false;
            if (availableOnly && !isAvailable) showRow = false;

            row.toggle(showRow);
        });

        FilterModule.updateVisibleCount();
    },

    toggleAvailable() {
        const availableOnly = $('#availableOnlyFilter').is(':checked');
        window.location.href = `/YarnTransactions/Overview?availableOnly=${availableOnly}`;
    },

    updateVisibleCount() {
        const visibleRows = $('.yarn-item-row:visible').length;
        const totalRows = $('.yarn-item-row').length;
        Utils.log(`Showing ${visibleRows} of ${totalRows} items`);
    }
};

// ================================
// UI HELPERS
// ================================
function showLoadingOverlay() {
    $('#loadingOverlay').show();
}

function hideLoadingOverlay() {
    $('#loadingOverlay').hide();
}

function refreshData() {
    showLoadingOverlay();
    const availableOnly = $('#availableOnlyFilter').is(':checked');
    window.location.href = `/YarnTransactions/Overview?availableOnly=${availableOnly}`;
}

function printOverview() {
    window.print();
}

// ================================
// GLOBAL FUNCTIONS (for onclick attributes)
// ================================
window.viewItemDetails = (yarnItemId, yarnItemName) => ModalModule.open(yarnItemId, yarnItemName);
window.exportToExcel = () => ExportModule.toExcel();
window.exportTransactionsToExcel = () => ExportModule.toExcelTransactions();
window.refreshData = refreshData;
window.printOverview = printOverview;
window.PackagingModule = PackagingModule;
window.ModalModule = ModalModule;

// ================================
// INITIALIZATION
// ================================
$(document).ready(function() {
    Utils.log('🚀 Yarn Overview initialized');

    // Convert numbers to Arabic
    NumberConverter.convertPageNumbers();

    // Initialize filters
    FilterModule.init();

    // Load packaging breakdowns with proper timing
    setTimeout(() => {
        PackagingModule.loadAll();
    }, 500); // Delay to ensure DOM is ready and prevent overwhelming server

    // Initialize tooltips
    $('[title]').tooltip();

    // Auto-refresh every 5 minutes
    setInterval(refreshData, CONFIG.AUTO_REFRESH_INTERVAL);

    // Modal cleanup on close
    $('#itemDetailsModal').on('hidden.bs.modal', function () {
        AppState.reset();
        Utils.log('🔒 Modal closed and cleaned up');
    });

    // Keyboard shortcuts
    $(document).keydown(function(e) {
        if (e.ctrlKey && e.keyCode === 82) {
            e.preventDefault();
            refreshData();
        }
        if (e.keyCode === 27 && $('#itemDetailsModal').hasClass('show')) {
            $('#itemDetailsModal').modal('hide');
        }
    });

    Utils.log('✅ Yarn Overview page fully loaded');
});
    </script>
}


<style>
    .loading-overlay {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        display: flex;
        justify-content: center;
        align-items: center;
        z-index: 9999;
    }

    .sticky-top {
        position: sticky;
        top: 0;
        z-index: 10;
    }

    .yarn-item-row {
        cursor: pointer;
        transition: background-color 0.2s;
    }

        .yarn-item-row:hover {
            background-color: rgba(0, 123, 255, 0.1);
        }

    .border-end {
        border-right: 1px solid #dee2e6 !important;
    }

    @@media (max-width: 768px) {
        .border-end {
            border-right: none !important;
            border-bottom: 1px solid #dee2e6 !important;
            margin-bottom: 0.5rem;
            padding-bottom: 0.5rem;
        }

        .btn-group-sm > .btn {
            padding: 0.2rem 0.4rem;
            font-size: 0.8rem;
        }
    }

    @@media print {
        .btn, .dropdown, .form-check, .input-group, .no-print {
            display: none !important;
        }

        .card {
            border: none !important;
            box-shadow: none !important;
        }

        .table {
            font-size: 11px;
        }

        .modal {
            display: none !important;
        }
    }

    .card:hover {
        box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
        transition: box-shadow 0.3s;
    }

    .pagination-sm .page-link {
        font-size: 0.875rem;
    }
</style>

<link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
