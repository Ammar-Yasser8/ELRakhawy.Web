@using ELRakhawy.EL.ViewModels
@model YarnTransactionViewModel
@{

    ViewData["Title"] = Model.IsInbound ? "اضافة وارد غزل" : "اضافة صادر غزل";
    var currentTime = "2025-08-12 02:19:03";
    var currentUser = "Ammar-Yasser8";
    var formName = Model.IsInbound ? "اضافة وارد غزل" : "اضافة صادر غزل";

    var isEdit = Model.Id>0;
}

<script>
    window.yarnFormConfig = {
        formName: '@Html.Raw(formName)',
        isInbound: @Json.Serialize(Model.IsInbound),
        currentTime: '@currentTime',
        currentUser: '@currentUser',
        formType: 'yarn'
    };
</script>

<div class="container-fluid mt-4 yarn-form-container">
    <!-- Header Card -->
    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body @(Model.IsInbound ? "bg-success" : "bg-warning") text-white rounded">
            <div class="row align-items-center">
                <div class="col">
                    <h4 class="mb-1">
                        <i class="fas @(Model.IsInbound ? "fa-arrow-down" : "fa-arrow-up") me-2"></i>
                        @ViewData["Title"]
                    </h4>
                    <p class="mb-0 opacity-75">
                        @(Model.IsInbound ? "تسجيل كمية غزل واردة للمخزن" : "تسجيل كمية غزل صادرة من المخزن")
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts -->
    @if (TempData["Success"] != null || TempData["Error"] != null)
    {
        <div class="alert @(TempData["Success"] != null ? "alert-success" : "alert-danger") alert-dismissible fade show mb-4">
            <i class="fas @(TempData["Success"] != null ? "fa-check-circle" : "fa-exclamation-circle") me-2"></i>
            @(TempData["Success"] ?? TempData["Error"])
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Main Form Card -->
    <div class="card shadow-sm">
        <div class="card-header @(Model.IsInbound ? "bg-success" : "bg-warning") text-white">
            <h5 class="mb-0">
                <i class="fas fa-form me-2"></i>تفاصيل المعاملة
            </h5>
        </div>
        <div class="card-body">
            <form id="yarnTransactionForm"
                  asp-controller="YarnTransactions"
                  asp-action="@(isEdit ? "Edit" : "SaveTransaction")"
                  method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" id="IsInbound" name="IsInbound" value="@Model.IsInbound.ToString().ToLower()" />
                <input type="hidden" id="YarnItemName" name="YarnItemName" />
                <input type="hidden" id="OriginYarnName" name="OriginYarnName" />
                <input type="hidden" id="StakeholderName" name="StakeholderName" />
                <input type="hidden" id="StakeholderTypeName" name="StakeholderTypeName" />
                <input type="hidden" id="PackagingStyleName" name="PackagingStyleName" />

                <div class="alert alert-danger" style="display:none;" id="validationSummary">
                    <ul id="validationList"></ul>
                </div>

                <!-- 1. Reference Numbers Section -->
                <div class="col-12 mb-4">
                    <h6 class="text-primary border-bottom pb-2">
                        <i class="fas fa-hashtag me-2"></i>١. أرقام المرجعية
                    </h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="InternalId" class="form-label">
                                <i class="fas fa-file-alt text-info me-1"></i>رقم الإذن الداخلي
                            </label>
                            <div class="input-group input-group-sm input-group-clearable">
                                <input type="text" id="InternalId" name="InternalId" value="@Model.InternalId"
                                       class="form-control" placeholder="أدخل رقم الإذن الداخلي" />
                                <button class="btn btn-outline-secondary btn-clear" type="button" data-target="InternalId">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <span class="text-danger" data-valmsg-for="InternalId"></span>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="ExternalId" class="form-label">
                                <i class="fas fa-external-link-alt text-warning me-1"></i>رقم الإذن الخارجي
                            </label>
                            <div class="input-group input-group-sm input-group-clearable">
                                <input type="text" id="ExternalId" name="ExternalId" value="@Model.ExternalId"
                                       class="form-control" placeholder="أدخل رقم الإذن الخارجي" />
                                <button class="btn btn-outline-secondary btn-clear" type="button" data-target="ExternalId">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <span class="text-danger" data-valmsg-for="ExternalId"></span>
                        </div>
                    </div>
                </div>

                <!-- 2. Yarn Item Selection Section -->
                <div class="col-12 mb-4">
                    <h6 class="text-primary border-bottom pb-2">
                        <i class="fas fa-box me-2"></i>٢. تفاصيل الصنف
                    </h6>
                    <div class="row">
                        <div class="col-md-8 mb-3">
                            <label for="YarnItemId" class="form-label required">
                                <i class="fas fa-yarn text-primary me-1"></i>صنف الغزل
                            </label>
                            <select id="YarnItemId" name="YarnItemId" class="form-select form-select-sm">
                                <option value="">-- اختر صنف الغزل --</option>
                                @foreach (var item in Model.AvailableItems)
                                {
                                    <option value="@item.Value">@item.Text</option>
                                }
                            </select>
                            <span class="text-danger" data-valmsg-for="YarnItemId"></span>
                        </div>
                        <div class="col-md-4 mb-3">
                            <label class="form-label">
                                <i class="fas fa-info-circle text-info me-1"></i>الرصيد الحالي
                            </label>
                            <div id="currentBalanceDisplay" class="form-control form-control-sm bg-light">
                                <small class="text-muted">اختر الصنف أولاً</small>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- 3. Stakeholder Section - UPDATED -->
                <div class="col-12 mb-4">
                    <h6 class="text-primary border-bottom pb-2">
                        <i class="fas fa-users me-2"></i>٣. بيانات الجهة
                    </h6>
                    <div class="row">
                        <!-- Stakeholder Type Selection -->
                        <div class="col-md-4 mb-3">
                            <label for="StakeholderTypeId" class="form-label required">
                                <i class="fas fa-layer-group text-info me-1"></i>نوع الجهة
                            </label>
                            <select id="StakeholderTypeId" name="StakeholderTypeId" class="form-select form-select-sm">
                                <option value="">-- اختر نوع الجهة --</option>
                            </select>
                            <span class="text-danger" data-valmsg-for="StakeholderTypeId"></span>
                        </div>

                        <!-- Stakeholder Selection (depends on type) -->
                        <div class="col-md-4 mb-3">
                            <label for="StakeholderId" class="form-label required">
                                <i class="fas fa-building text-success me-1"></i>الجهة
                            </label>
                            <select id="StakeholderId" name="StakeholderId" class="form-select form-select-sm" disabled>
                                <option value="">-- اختر نوع الجهة أولاً --</option>
                            </select>
                            <span class="text-danger" data-valmsg-for="StakeholderId"></span>
                        </div>
                    </div>
                </div>

                <!-- 4. Packaging and Date Section -->
                <div class="col-12 mb-4">
                    <h6 class="text-primary border-bottom pb-2">
                        <i class="fas fa-box-open me-2"></i>٤. التعبئة والتاريخ
                    </h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="PackagingStyleId" class="form-label required">
                                <i class="fas fa-cube text-info me-1"></i>نمط التعبئة
                            </label>
                            <select id="PackagingStyleId" name="PackagingStyleId" class="form-select form-select-sm">
                                <option value="">-- اختر نمط التعبئة --</option>
                                @foreach (var packaging in Model.PackagingStyles)
                                {
                                    <option value="@packaging.Value">@packaging.Text</option>
                                }
                            </select>
                            <span class="text-danger" data-valmsg-for="PackagingStyleId"></span>
                        </div>
                        <!--Date-->
                        <div class="col-md-4 mb-3">
                            <label for="Date" class="form-label required">
                                <i class="fas fa-calendar-alt text-warning me-1"></i>تاريخ المعاملة
                            </label>
                            <div class="input-group input-group-sm" dir="ltr">
                                <input type="text" id="Date" name="Date"
                                       value="@(Model.Date.ToString("yyyy-MM-dd"))"
                                       class="form-control text-end"
                                       placeholder="yyyy-MM-dd"
                                       readonly
                                       autocomplete="off" />
                                <button class="btn btn-outline-secondary" type="button" id="calendarBtn">
                                    <i class="fas fa-calendar"></i>
                                </button>
                            </div>
                            <span class="text-danger" data-valmsg-for="Date"></span>
                           
                        </div>
                    </div>
                </div>

                <!-- 5. Quantity Section -->
                <div class="col-12 mb-4">
                    <h6 class="text-primary border-bottom pb-2">
                        <i class="fas fa-calculator me-2"></i>٥. الكميات
                    </h6>
                    <div class="row">
                        <div class="col-md-4 mb-3">
                            <label for="Quantity" class="form-label required">
                                <i class="fas fa-weight text-success me-1"></i>الكمية
                            </label>
                            <div class="input-group input-group-sm input-group-clearable">
                                <input type="text" id="Quantity" name="Quantity" value="@Model.Quantity"
                                       class="form-control" placeholder="أدخل الكمية بالكيلوجرام" />
                                <span class="input-group-text">كجم</span>
                                <button class="btn btn-outline-secondary btn-clear" type="button" data-target="Quantity">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <span class="text-danger" data-valmsg-for="Quantity"></span>
                           
                        </div>
                        <div class="col-md-4 mb-3">
                            <label for="Count" class="form-label required">
                                <i class="fas fa-sort-numeric-up text-info me-1"></i>العدد
                            </label>
                            <div class="input-group input-group-sm input-group-clearable">
                                <input type="text" id="Count" name="Count" value="@Model.Count"
                                       class="form-control" placeholder="أدخل عدد الوحدات" />
                                <span class="input-group-text">وحدة</span>
                                <button class="btn btn-outline-secondary btn-clear" type="button" data-target="Count">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                            <span class="text-danger" data-valmsg-for="Count"></span>
                            
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-12">
                            <div class="alert alert-info d-none" id="unitWeightDisplay">
                                <i class="fas fa-calculator me-2"></i>
                                <strong>متوسط وزن الوحدة:</strong>
                                <span id="unitWeightValue">٠</span> كجم/وحدة
                            </div>
                        </div>
                    </div>
                </div>
                <!-- 6. Comment Section -->
                <div class="col-12 mb-4">
                    <h6 class="text-primary border-bottom pb-2">
                        <i class="fas fa-comment me-2"></i>٦. البيان والملاحظات
                    </h6>
                    <label for="Comment" class="form-label">
                        <i class="fas fa-sticky-note text-secondary me-1"></i>بيان المعاملة
                    </label>
                    <div class="position-relative">
                        <textarea id="Comment" name="Comment" class="form-control form-control-sm" rows="3"
                                  placeholder="أدخل أي ملاحظات أو تفاصيل إضافية عن المعاملة (اختياري)">@Model.Comment</textarea>
                        <button class="btn btn-sm btn-outline-secondary btn-clear-textarea" type="button" data-target="Comment">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <span class="text-danger" data-valmsg-for="Comment"></span>
                </div>
                <!-- Action Buttons -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex gap-2 justify-content-end flex-wrap">
                            <a href="@Url.Action("Index", "YarnItems")" class="btn btn-secondary btn-sm">
                                <i class="fas fa-times me-1"></i>إلغاء
                            </a>
                            <button type="button" class="btn btn-info btn-sm" id="previewBtn">
                                <i class="fas fa-eye me-1"></i>معاينة
                            </button>
                            <button type="button" class="btn btn-outline-primary btn-sm" id="resetBtn">
                                <i class="fas fa-undo me-1"></i>إعادة تعيين
                            </button>
                        </div>
                    </div>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <script src="/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ar.js"></script>

    <script>
        $(document).ready(function () {
            const CURRENT_TIME = '@currentTime';
            const CURRENT_USER = '@currentUser';
            const IS_INBOUND = window.yarnFormConfig?.isInbound || false;
            const FORM_NAME = window.yarnFormConfig?.formName || '';

            console.log('🚀 Enhanced yarn transaction form initializing:', {
                time: CURRENT_TIME,
                user: CURRENT_USER,
                isInbound: IS_INBOUND,
                formType: 'yarn'
            });

            // ✅ Utility functions
            function toArabicDigits(str) {
                if (!str) return str;
                return str.toString().replace(/[0-9]/g, d => '٠١٢٣٤٥٦٧٨٩'[d]);
            }

            function toLatinDigits(str) {
                if (!str) return str;
                return str.toString().replace(/[٠-٩]/g, d => '0123456789'['٠١٢٣٤٥٦٧٨٩'.indexOf(d)]);
            }

            function hasArabicChar(str) {
                if (!str) return false;
                return /[\u0600-\u06FF]/.test(str);
            }

            function hasEnglishChar(str) {
                if (!str) return false;
                return /[a-zA-Z]/.test(str);
            }

            function shouldUseArabicDigits(str) {
                if (!str) return true;
                if (hasArabicChar(str)) return true;
                if (hasEnglishChar(str)) return false;
                return true;
            }

            function applySmartNumberConversion($input) {
                let val = $input.val();
                let cursorPos = $input[0].selectionStart || 0;

                if (!val) return;

                let shouldUseArabic = shouldUseArabicDigits(val);
                let convertedVal = shouldUseArabic ? toArabicDigits(val) : toLatinDigits(val);

                if (val !== convertedVal) {
                    $input.val(convertedVal);
                    try {
                        $input[0].setSelectionRange(cursorPos, cursorPos);
                    } catch (ex) {
                        $input.focus();
                    }
                }
            }

            function handleNumberKeypress(e) {
                if (e.which >= 48 && e.which <= 57) {
                    e.preventDefault();
                    let digit = String.fromCharCode(e.which);
                    let input = e.target;
                    let cursorPos = input.selectionStart || 0;
                    let cursorEnd = input.selectionEnd || 0;
                    
                    // Get current value
                    let currentValue = input.value;
                    
                    // If text is selected, remove it first
                    if (cursorPos !== cursorEnd) {
                        currentValue = currentValue.slice(0, cursorPos) + currentValue.slice(cursorEnd);
                    }
                    
                    // Create temporary value to test conversion
                    let tempValue = currentValue.slice(0, cursorPos) + digit + currentValue.slice(cursorPos);

                    // Determine conversion based on content
                    let useArabic = shouldUseArabicDigits(tempValue);
                    let convertedDigit = useArabic ? toArabicDigits(digit) : digit;

                    // Insert the converted digit
                    let newValue = currentValue.slice(0, cursorPos) + convertedDigit + currentValue.slice(cursorPos);
                    input.value = newValue;
                    input.setSelectionRange(cursorPos + 1, cursorPos + 1);

                    // Trigger input event
                    $(input).trigger('input');
                }
            }

            const INPUT_SELECTORS = '#Quantity, #Count, #Comment, #InternalId, #ExternalId, input[type="text"]:not(#Date), textarea';

            $(document).on('input keyup paste', INPUT_SELECTORS, function(e) {
                applySmartNumberConversion($(this));
            });

            $(document).on('keypress', INPUT_SELECTORS, handleNumberKeypress);

            // ✅ Enhanced Select2 with full Arabic number support in search
            $('.form-select').select2({
                theme: 'bootstrap-5',
                width: '100%',
                dir: 'rtl',
                language: {
                    noResults: function () {
                        return "لا توجد نتائج";
                    },
                    searching: function () {
                        return "جاري البحث...";
                    },
                    inputTooShort: function() {
                        return "الرجاء إدخال حرف أو أكثر";
                    }
                },
                templateResult: function(data) {
                    if (!data.id) {
                        return data.text;
                    }
                    // Convert numbers in dropdown options to Arabic
                    var text = data.text;
                    if (text && /\d/.test(text)) {
                        text = toArabicDigits(text);
                    }
                    return $('<span>' + text + '</span>');
                },
                templateSelection: function(data) {
                    // Convert numbers in selected option to Arabic
                    var text = data.text;
                    if (text && /\d/.test(text)) {
                        text = toArabicDigits(text);
                    }
                    return text;
                },
                matcher: function (params, data) {
                    // If no search term, return all data
                    if ($.trim(params.term) === '') {
                        return data;
                    }

                    // Don't display if no text
                    if (typeof data.text === 'undefined') {
                        return null;
                    }

                    // Normalize Arabic characters (أإآ -> ا, ى -> ي)
                    const normalizeArabic = (str) => {
                        if (!str) return '';
                        return str.replace(/[أإآ]/g, 'ا').replace(/ى/g, 'ي');
                    };

                    // Get search term and option text
                    let searchTerm = params.term.toLowerCase().trim();
                    let optionText = data.text.toLowerCase().trim();

                    // Convert BOTH Arabic and Latin numbers to a common format (Latin) for comparison
                    // This allows searching with either ١٢٣ or 123
                    searchTerm = toLatinDigits(searchTerm);
                    optionText = toLatinDigits(optionText);

                    // Normalize Arabic characters
                    searchTerm = normalizeArabic(searchTerm);
                    optionText = normalizeArabic(optionText);

                    // Check if option text includes search term
                    if (optionText.includes(searchTerm)) {
                        return data;
                    }

                    // No match found
                    return null;
                }
            });

            // ✅ Handle Arabic number input in Select2 search box
            $(document).on('keyup', '.select2-search__field', function(e) {
                const $searchField = $(this);
                let searchValue = $searchField.val();
                
                // Use requestAnimationFrame for better performance and avoid lag
                if (searchValue && /[0-9]/.test(searchValue)) {
                    requestAnimationFrame(() => {
                        // Only convert if the field still has focus and value hasn't changed
                        if ($searchField.is(':focus') && $searchField.val() === searchValue) {
                            $searchField.val(toArabicDigits(searchValue));
                        }
                    });
                }
                
                // If already has Arabic numbers, leave as is
                // The matcher function will handle both Arabic and English numbers for searching
            });

            // ✅ Clear button functionality
            $(document).on('click', '.btn-clear', function() {
                const targetId = $(this).data('target');
                $('#' + targetId).val('').trigger('change').focus();
            });

            $(document).on('click', '.btn-clear-textarea', function() {
                const targetId = $(this).data('target');
                $('#' + targetId).val('').trigger('input').focus();
                $('#commentCharCount').text(toArabicDigits('0'));
            });

            // ✅ Show/hide clear buttons based on input
            $(document).on('input change', 'input[type="text"]:not(#Date), textarea', function() {
                const $clearBtn = $(this).siblings('.btn-clear, .btn-clear-textarea');
                if ($(this).val().trim()) {
                    $clearBtn.show();
                } else {
                    $clearBtn.hide();
                }
            });

            // Initial hide for empty fields
            $('input[type="text"]:not(#Date), textarea').each(function() {
                const $clearBtn = $(this).siblings('.btn-clear, .btn-clear-textarea');
                if (!$(this).val().trim()) {
                    $clearBtn.hide();
                }
            });

            // ✅ Arabic-friendly Flatpickr calendar
            if (window.flatpickr) {
                const dateInput = document.getElementById('Date');
                
                const fp = flatpickr(dateInput, {
                    dateFormat: 'Y-m-d',
                    locale: {
                        ...flatpickr.l10ns.ar,
                        firstDayOfWeek: 6 // Saturday
                    },
                    allowInput: false,
                    disableMobile: true,
                    defaultDate: dateInput.value || new Date(),
                    onChange: function(selectedDates, dateStr, instance) {
                        // Store Latin format internally for server
                        dateInput.setAttribute('data-latin-date', dateStr);
                        
                        // Display Arabic format to user
                        dateInput.value = toArabicDigits(dateStr);
                        
                        // Update calendar display with Arabic numbers
                        setTimeout(() => {
                            $('.flatpickr-day, .flatpickr-current-month .numInputWrapper input').each(function() {
                                const text = $(this).text() || $(this).val();
                                if (text && /\d/.test(text)) {
                                    if ($(this).is('input')) {
                                        // Don't convert year input to maintain functionality
                                    } else {
                                        $(this).text(toArabicDigits(text));
                                    }
                                }
                            });
                        }, 0);
                    },
                    onReady: function(selectedDates, dateStr, instance) {
                        // Store initial Latin date
                        if (dateStr) {
                            dateInput.setAttribute('data-latin-date', dateStr);
                            // Display in Arabic
                            dateInput.value = toArabicDigits(dateStr);
                        }
                        
                        // Convert calendar display to Arabic on load
                        setTimeout(() => {
                            $('.flatpickr-day, .flatpickr-monthDropdown-months option').each(function() {
                                const text = $(this).text();
                                if (text && /\d/.test(text)) {
                                    $(this).text(toArabicDigits(text));
                                }
                            });
                        }, 0);
                    },
                    onMonthChange: function(selectedDates, dateStr, instance) {
                        // Convert when month changes
                        setTimeout(() => {
                            $('.flatpickr-day').each(function() {
                                const text = $(this).text();
                                if (text && /\d/.test(text)) {
                                    $(this).text(toArabicDigits(text));
                                }
                            });
                        }, 0);
                    },
                    onYearChange: function(selectedDates, dateStr, instance) {
                        // Convert when year changes
                        setTimeout(() => {
                            $('.flatpickr-day').each(function() {
                                const text = $(this).text();
                                if (text && /\d/.test(text)) {
                                    $(this).text(toArabicDigits(text));
                                }
                            });
                        }, 0);
                    }
                });

                // Calendar button click handler
                $('#calendarBtn').on('click', function() {
                    fp.open();
                });

                // Convert existing date display to Arabic
                if (dateInput.value) {
                    const latinDate = dateInput.value;
                    dateInput.setAttribute('data-latin-date', latinDate);
                    dateInput.value = toArabicDigits(latinDate);
                }
            }

            // Convert existing content to Arabic
            function convertExistingContentToArabic() {
                $('span, div, p, td, th, label, small').each(function() {
                    let $element = $(this);
                    let text = $element.text();
                    if ($element.find('input, select, textarea').length > 0 ||
                        $element.hasClass('flatpickr-calendar') ||
                        $element.closest('.flatpickr-calendar').length > 0 ||
                        $element.attr('id') === 'Date' ||
                        $element.find('#Date').length > 0) {
                        return;
                    }
                    if (/[0-9]/.test(text)) {
                        $element.text(toArabicDigits(text));
                    }
                });

                $('input[placeholder]:not(#Date):not(.flatpickr-input), textarea[placeholder]').each(function() {
                    let $input = $(this);
                    let placeholder = $input.attr('placeholder');
                    if (placeholder && /[0-9]/.test(placeholder)) {
                        $input.attr('placeholder', toArabicDigits(placeholder));
                    }
                });

                $('.badge, .alert, .card-text, .form-text').each(function() {
                    let $element = $(this);
                    let html = $element.html();
                    if (html && /[0-9]/.test(html) &&
                        !$element.closest('.flatpickr-calendar').length &&
                        !$element.find('#Date').length) {
                        $element.html(html.replace(/\b\d+(\.\d+)?\b/g, match => toArabicDigits(match)));
                    }
                });

                console.log('✅ Converted existing content to Arabic digits');
            }

            convertExistingContentToArabic();

            // Comment character counter
            $('#Comment').on('input', function() {
                applySmartNumberConversion($(this));
                let length = this.value.length;
                $('#commentCharCount').text(toArabicDigits(length.toString()));
            });

            $('#commentCharCount').text(toArabicDigits($('#Comment').val().length.toString()));

            // Packaging change handler
            $('#PackagingStyleId').on('change', function () {
                var selectedText = $(this).find('option:selected').text();
                var selectedId = $(this).val();
                $('#PackagingStyleName').val(selectedText);

                $('#Quantity, #Count').removeClass('is-invalid');
                $('.invalid-feedback').remove();
                $('#validationSummary').hide().removeClass('alert-danger');

                if (selectedId && window.currentPackagingBreakdown) {
                    var availableCount = 0;
                    var availableWeight = 0;

                    window.currentPackagingBreakdown.forEach(function(pkg) {
                        if (pkg.packagingId == selectedId) {
                            availableCount = pkg.totalCount;
                            availableWeight = pkg.specificWeight;
                        }
                    });

                    var $countGroup = $('#Count').closest('.input-group');
                    var existingHelp = $countGroup.next('.packaging-help');
                    existingHelp.remove();

                    if (availableCount > 0) {
                        $countGroup.after(`
                            <div class="form-text packaging-help text-success">
                                <i class="fas fa-info-circle me-1"></i>
                                متاح من ${selectedText}: ${toArabicDigits(availableCount.toString())} وحدة
                                (${toArabicDigits(availableWeight.toFixed(2))} كجم)
                            </div>
                        `);
                    } else if (!IS_INBOUND) {
                        $countGroup.after(`
                            <div class="form-text packaging-help text-warning">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                لا يوجد رصيد متاح من ${selectedText}
                            </div>
                        `);
                    }
                }
            });

            // Quantity input handler
            $('#Quantity').on('input blur', function() {
                let val = this.value;
                val = val.replace(/،/g, '.');
                let parts = val.split('.');
                if (parts.length > 2) {
                    val = parts[0] + '.' + parts.slice(1).join('');
                }
                val = val.replace(/[^\d٠-٩.]/g, '');
                applySmartNumberConversion($(this));

                if (!IS_INBOUND && val && window.currentPackagingBreakdown) {
                    let selectedPackagingId = $('#PackagingStyleId').val();
                    if (selectedPackagingId) {
                        let quantityValue = parseFloat(toLatinDigits(val));
                        let selectedPackaging = window.currentPackagingBreakdown.find(pkg =>
                            pkg.packagingId.toString() === selectedPackagingId);

                        let $quantityField = $(this);

                        if (selectedPackaging && !isNaN(quantityValue)) {
                            if (quantityValue > selectedPackaging.specificWeight) {
                                $quantityField.addClass('is-invalid');
                                let existingError = $quantityField.closest('.input-group').next('.invalid-feedback');
                                if (existingError.length === 0) {
                                    $quantityField.closest('.input-group').after(`
                                        <div class="invalid-feedback d-block">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            الكمية ${toArabicDigits(quantityValue.toFixed(2))} كجم تتجاوز المتاح لـ${selectedPackaging.packagingType}
                                            (${toArabicDigits(selectedPackaging.specificWeight.toFixed(2))} كجم فقط)
                                        </div>
                                    `);
                                } else {
                                    existingError.html(`
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        الكمية ${toArabicDigits(quantityValue.toFixed(2))} كجم تتجاوز المتاح لـ${selectedPackaging.packagingType}
                                        (${toArabicDigits(selectedPackaging.specificWeight.toFixed(2))} كجم فقط)
                                    `);
                                }
                            } else {
                                $quantityField.removeClass('is-invalid');
                                $quantityField.closest('.input-group').next('.invalid-feedback').remove();
                            }
                        }
                    }
                } else {
                    $(this).removeClass('is-invalid');
                    $(this).closest('.input-group').next('.invalid-feedback').remove();
                }
            });

            // Count input handler
            $('#Count').on('input blur', function() {
                let val = this.value;
                val = val.replace(/\./g, '');
                val = val.replace(/[^\d٠-٩]/g, '');
                applySmartNumberConversion($(this));

                if (!IS_INBOUND && val && window.currentPackagingBreakdown) {
                    let selectedPackagingId = $('#PackagingStyleId').val();
                    if (selectedPackagingId) {
                        let countValue = parseInt(toLatinDigits(val));
                        let selectedPackaging = window.currentPackagingBreakdown.find(pkg =>
                            pkg.packagingId.toString() === selectedPackagingId);

                        let $countField = $(this);

                        if (selectedPackaging && !isNaN(countValue)) {
                            if (countValue > selectedPackaging.totalCount) {
                                $countField.addClass('is-invalid');
                                let existingError = $countField.closest('.input-group').next('.invalid-feedback');
                                if (existingError.length === 0) {
                                    $countField.closest('.input-group').after(`
                                        <div class="invalid-feedback d-block">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            العدد ${toArabicDigits(countValue.toString())} يتجاوز المتاح لـ${selectedPackaging.packagingType}
                                            (${toArabicDigits(selectedPackaging.totalCount.toString())} وحدة فقط)
                                        </div>
                                    `);
                                } else {
                                    existingError.html(`
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        العدد ${toArabicDigits(countValue.toString())} يتجاوز المتاح لـ${selectedPackaging.packagingType}
                                        (${toArabicDigits(selectedPackaging.totalCount.toString())} وحدة فقط)
                                    `);
                                }
                            } else {
                                $countField.removeClass('is-invalid');
                                $countField.closest('.input-group').next('.invalid-feedback').remove();
                            }
                        }
                    }
                } else {
                    $(this).removeClass('is-invalid');
                    $(this).closest('.input-group').next('.invalid-feedback').remove();
                }
            });

            // Clear placeholder zeros
            $('#Quantity, #Count').on('focus', function() {
                if (this.value === '0' || this.value === '٠') {
                    this.value = '';
                }
            });

            // Preview button
            $('#previewBtn').click(function () {
                let validation = validateForm();
                if (!validation.isValid) {
                    showValidationErrors(validation.errors);
                    return;
                }

                var data = {
                    yarnItem: $('#YarnItemId option:selected').text(),
                    quantity: $('#Quantity').val(),
                    count: $('#Count').val(),
                    stakeholder: $('#StakeholderId option:selected').text(),
                    packaging: $('#PackagingStyleId option:selected').text(),
                    date: $('#Date').val(),
                    comment: $('#Comment').val() || 'لا يوجد بيان',
                    type: IS_INBOUND ? 'وارد' : 'صادر'
                };

                var displayDate = toArabicDigits(data.date);

                var packagingWeight = '';
                if (window.currentPackagingBreakdown && $('#PackagingStyleId').val()) {
                    var selectedPackagingId = $('#PackagingStyleId').val();
                    var selectedPackaging = window.currentPackagingBreakdown.find(p =>
                        p.packagingId.toString() === selectedPackagingId);

                    if (selectedPackaging) {
                        packagingWeight = `<p><strong>الوزن المتاح للتعبئة:</strong> ${toArabicDigits(selectedPackaging.specificWeight.toFixed(2))} كجم</p>`;
                    }
                }

                var preview = `
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>النوع:</strong>
                                <span class="badge ${IS_INBOUND ? 'bg-success' : 'bg-warning'}">
                                    ${data.type}
                                </span>
                            </p>
                            <p><strong>الصنف:</strong> ${data.yarnItem}</p>
                            <p><strong>الكمية:</strong> ${data.quantity} كجم</p>
                            <p><strong>العدد:</strong> ${data.count} وحدة</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>الجهة:</strong> ${data.stakeholder}</p>
                            <p><strong>التعبئة:</strong> ${data.packaging}</p>
                            ${packagingWeight}
                            <p><strong>التاريخ:</strong> ${displayDate}</p>
                        </div>
                        <div class="col-12">
                            <p><strong>البيان:</strong> ${data.comment}</p>
                        </div>
                    </div>
                `;

                Swal.fire({
                    title: 'معاينة المعاملة',
                    html: preview,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: `<i class="fas fa-save me-1"></i> حفظ ${IS_INBOUND ? 'الوارد' : 'الصادر'}`,
                    cancelButtonText: '<i class="fas fa-times me-1"></i> تراجع',
                    confirmButtonColor: IS_INBOUND ? '#198754' : '#ffc107',
                    cancelButtonColor: '#6c757d',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        submitForm();
                    }
                });
            });

            // Form validation
            function validateForm() {
                var isValid = true;
                var errors = [];

                if (!$('#YarnItemId').val()) {
                    errors.push('يجب اختيار صنف الغزل');
                    $('#YarnItemId').addClass('is-invalid');
                    isValid = false;
                } else {
                    $('#YarnItemId').removeClass('is-invalid');
                }

                var quantityVal = $('#Quantity').val().trim();
                var quantity = parseFloat(toLatinDigits(quantityVal));
                if (!quantityVal || isNaN(quantity) || quantity <= 0) {
                    errors.push('يجب إدخال كمية صحيحة أكبر من الصفر');
                    $('#Quantity').addClass('is-invalid');
                    isValid = false;
                } else {
                    $('#Quantity').removeClass('is-invalid');
                }

                var countVal = $('#Count').val().trim();
                var count = parseInt(toLatinDigits(countVal));
                if (!countVal || isNaN(count) || count <= 0 || !Number.isInteger(parseFloat(toLatinDigits(countVal)))) {
                    errors.push('يجب إدخال عدد صحيح (بدون فاصلة عشرية) أكبر من الصفر');
                    $('#Count').addClass('is-invalid');
                    isValid = false;
                } else {
                    $('#Count').removeClass('is-invalid');
                }

                // NEW: Validate stakeholder type
                if (!$('#StakeholderTypeId').val()) {
                    errors.push('يجب اختيار نوع الجهة');
                    $('#StakeholderTypeId').next('.select2-container').addClass('is-invalid');
                    isValid = false;
                } else {
                    $('#StakeholderTypeId').next('.select2-container').removeClass('is-invalid');
                }

                // Validate stakeholder
                if (!$('#StakeholderId').val()) {
                    errors.push('يجب اختيار الجهة');
                    $('#StakeholderId').next('.select2-container').addClass('is-invalid');
                    isValid = false;
                } else {
                    $('#StakeholderId').next('.select2-container').removeClass('is-invalid');
                }

                if (!$('#PackagingStyleId').val()) {
                    errors.push('يجب اختيار نمط التعبئة');
                    $('#PackagingStyleId').next('.select2-container').addClass('is-invalid');
                    isValid = false;
                } else {
                    $('#PackagingStyleId').next('.select2-container').removeClass('is-invalid');
                }

                // Date validation and default
                var dateVal = $('#Date').val();
                var dateLatin = $('#Date').attr('data-latin-date') || toLatinDigits(dateVal || '');
                if (!dateLatin || !/^\d{4}-\d{2}-\d{2}$/.test(dateLatin)) {
                    // Set today's date in yyyy-MM-dd format
                    var today = new Date();
                    var yyyy = today.getFullYear();
                    var mm = String(today.getMonth() + 1).padStart(2, '0');
                    var dd = String(today.getDate()).padStart(2, '0');
                    var todayStr = yyyy + '-' + mm + '-' + dd;
                    $('#Date').val(toArabicDigits(todayStr));
                    $('#Date').attr('data-latin-date', todayStr);
                    dateLatin = todayStr;
                }
                $('#Date').removeClass('is-invalid');

                if (!IS_INBOUND && quantity > 0 && count > 0 && window.currentPackagingBreakdown) {
                    let selectedPackagingId = $('#PackagingStyleId').val();
                    if (selectedPackagingId) {
                        let selectedPackaging = window.currentPackagingBreakdown.find(pkg =>
                            pkg.packagingId.toString() === selectedPackagingId);

                        if (selectedPackaging) {
                            if (quantity > selectedPackaging.specificWeight) {
                                errors.push(`الكمية المطلوبة (${toArabicDigits(quantity.toFixed(2))} كجم) تتجاوز المتاح لـ${selectedPackaging.packagingType} (${toArabicDigits(selectedPackaging.specificWeight.toFixed(2))} كجم)`);
                                $('#Quantity').addClass('is-invalid');
                                isValid = false;
                            }

                            if (count > selectedPackaging.totalCount) {
                                errors.push(`العدد المطلوب (${toArabicDigits(count.toString())} وحدة) يتجاوز المتاح لـ${selectedPackaging.packagingType} (${toArabicDigits(selectedPackaging.totalCount.toString())} وحدة)`);
                                $('#Count').addClass('is-invalid');
                                isValid = false;
                            }
                        }
                    }
                }

                return { isValid: isValid, errors: errors };
            }

            function showValidationErrors(errors) {
                if (errors && errors.length > 0) {
                    var errorHtml = errors.map(error => `<li class="mb-1">${error}</li>`).join('');
                    $('#validationList').html(errorHtml);
                    $('#validationSummary').show().addClass('alert-danger');

                    $('html, body').animate({
                        scrollTop: $('#validationSummary').offset().top - 100
                    }, 500);

                    console.log('❌ Validation errors displayed:', errors);
                }
            }

            // Form submission
            $('#yarnTransactionForm').on('submit', function(e) {
                e.preventDefault();

                let validation = validateForm();

                if (!validation.isValid) {
                    showValidationErrors(validation.errors);

                    Swal.fire({
                        title: 'لا يمكن إتمام العملية',
                        html: `
                            <div class="text-danger">
                                <i class="fas fa-ban fa-2x mb-3"></i>
                                <h6>يوجد أخطاء تمنع حفظ المعاملة:</h6>
                            </div>
                            <ul class="text-start text-danger">
                                ${validation.errors.map(error => `<li>${error}</li>`).join('')}
                            </ul>
                        `,
                        icon: 'error',
                        confirmButtonText: 'فهمت، سأقوم بالتصحيح',
                        confirmButtonColor: '#dc3545'
                    });

                    return false;
                }

                submitForm();
            });

            function submitForm() {
                let quantityLatin = toLatinDigits($('#Quantity').val() || '0');
                let countLatin = toLatinDigits($('#Count').val() || '0');
                let dateLatin = $('#Date').attr('data-latin-date') || toLatinDigits($('#Date').val() || '');

                // Always ensure date is in correct format, fallback to today if not
                if (!dateLatin || !/^\d{4}-\d{2}-\d{2}$/.test(dateLatin)) {
                    var today = new Date();
                    var yyyy = today.getFullYear();
                    var mm = String(today.getMonth() + 1).padStart(2, '0');
                    var dd = String(today.getDate()).padStart(2, '0');
                    dateLatin = yyyy + '-' + mm + '-' + dd;
                    $('#Date').val(toArabicDigits(dateLatin));
                    $('#Date').attr('data-latin-date', dateLatin);
                }

                $('#Quantity').val(quantityLatin);
                $('#Count').val(countLatin);
                $('#Date').val(dateLatin);

                $('#saveBtn').prop('disabled', true)
                    .html('<span class="spinner-border spinner-border-sm me-2"></span>جاري الحفظ...');

                $('#yarnTransactionForm')[0].submit();
                return true;
            }

            // Yarn item selection
            $('#YarnItemId').on('change', function () {
                var selectedItemId = $(this).val();
                var selectedText = $(this).find('option:selected').text();
                $('#YarnItemName').val(selectedText);

                if (!selectedItemId) {
                    $('#currentBalanceDisplay').html('<small class="text-muted">اختر الصنف أولاً</small>');
                    return;
                }

                fetchYarnItemBalance(parseInt(selectedItemId));
            });

            // ✅ NEW: Stakeholder Type change handler
            $('#StakeholderTypeId').on('change', function () {
            var selectedTypeId = $(this).val();
            var selectedTypeName = $(this).find('option:selected').text();
            $('#StakeholderTypeName').val(selectedTypeName);

            // Clear and disable stakeholder dropdown
            var $stakeholderSelect = $('#StakeholderId');
            $stakeholderSelect.empty()
                .append('<option value="">-- اختر الجهة --</option>')
                .prop('disabled', true)
                .trigger('change');

            // Clear stakeholder name
            $('#StakeholderName').val('');

            if (selectedTypeId) {
                // Fetch stakeholders for this type
                fetchStakeholdersByType(parseInt(selectedTypeId));
            } else {
                $stakeholderSelect.prop('disabled', true)
                    .empty()
                    .append('<option value="">-- اختر نوع الجهة أولاً --</option>')
                    .trigger('change');
            }
        });
            // ✅ UPDATED: Stakeholder change handler
            $('#StakeholderId').on('change', function () {
            var selectedText = $(this).find('option:selected').text();
            $('#StakeholderName').val(selectedText);
        });


            // Reset button
            $('#resetBtn').on('click', function() {
                Swal.fire({
                    title: 'إعادة تعيين النموذج',
                    text: 'هل أنت متأكد من إعادة تعيين جميع الحقول؟',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'نعم، إعادة تعيين',
                    cancelButtonText: 'إلغاء',
                    confirmButtonColor: '#0d6efd',
                    cancelButtonColor: '#6c757d',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        $('#yarnTransactionForm')[0].reset();
                        $('.form-select').val('').trigger('change');
                        $('#validationSummary').hide();
                        $('.is-invalid').removeClass('is-invalid');
                        $('#currentBalanceDisplay').html('<small class="text-muted">اختر الصنف أولاً</small>');
                        $('#commentCharCount').text(toArabicDigits('0'));
                        $('.btn-clear, .btn-clear-textarea').hide();

                        Swal.fire({
                            title: 'تم إعادة التعيين',
                            text: 'تم مسح جميع الحقول بنجاح',
                            icon: 'success',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }
                });
            });

            // Load stakeholders and packaging
            fetchStakeholderTypesByForm(FORM_NAME);
            fetchPackagingStyles(FORM_NAME);

            var initialYarnItemId = $('#YarnItemId').val();
            if (initialYarnItemId) {
                fetchYarnItemBalance(parseInt(initialYarnItemId));
            }

           function fetchStakeholderTypesByForm(formName) {
            $.ajax({
                url: '/YarnTransactions/GetStackholderTypeByForm',
                type: 'GET',
                data: { fromName: formName },
                beforeSend: function () {
                    $('#StakeholderTypeId')
                        .prop('disabled', true)
                        .empty()
                        .append('<option value="">جاري التحميل...</option>');
                },
                success: function (response) {
                    var $select = $('#StakeholderTypeId');
                    $select.empty().append('<option value="">-- اختر نوع الجهة --</option>');

                    if (response?.success && response.data?.length > 0) {

                        response.data.forEach(function (item) {
                            var displayName = item.name;
                            if (displayName && /\d/.test(displayName)) {
                                displayName = toArabicDigits(displayName);
                            }

                            $select.append(new Option(displayName, item.id));
                        });

                        $select.prop('disabled', false);
                    } else {
                        $select.append('<option value="">لا توجد أنواع جهات متاحة</option>');
                        $select.prop('disabled', false);
                    }
                },
                error: function () {
                    $('#StakeholderTypeId')
                        .empty()
                        .append('<option value="">خطأ في تحميل أنواع الجهات</option>')
                        .prop('disabled', false);
                }
            });
        }

        // ✅ NEW: Function to fetch stakeholders by type ID
            function fetchStakeholdersByType(typeId) {
            if (!typeId || typeId <= 0) {
                return;
            }

            $.ajax({
                url: '/YarnTransactions/GetStackholderByGetType',
                type: 'GET',
                data: { typeId: typeId },
                beforeSend: function() {
                    var $select = $('#StakeholderId');
                    $select.prop('disabled', true)
                        .empty()
                        .append('<option value="">جاري التحميل...</option>');
                },
                success: function(response) {
                    var $select = $('#StakeholderId');
                    $select.empty().append('<option value="">-- اختر الجهة --</option>');

                    if (response && response.success && response.data && response.data.length > 0) {
                        response.data.forEach(function(stakeholder) {
                            var displayName = stakeholder.name;
                            if (displayName && /\d/.test(displayName)) {
                                displayName = toArabicDigits(displayName);
                            }
                            $select.append(new Option(displayName, stakeholder.id));
                        });
                        $select.prop('disabled', false);

                        console.log('✅ Loaded ' + response.data.length + ' stakeholders for type ' + typeId);
                    } else {
                        $select.append('<option value="">لا توجد جهات نشطة لهذا النوع</option>');
                        $select.prop('disabled', true);

                        if (response && response.error) {
                            console.warn('Stakeholders warning:', response.error);
                        }
                    }

                    $select.trigger('change');
                },
                error: function(xhr, status, error) {
                    console.error('Error loading stakeholders:', error);
                    var $select = $('#StakeholderId');
                    $select.empty()
                        .append('<option value="">خطأ في تحميل الجهات</option>')
                        .prop('disabled', false);
                }
            });
        }

            function fetchPackagingStyles(formName) {
                $.ajax({
                    url: '/YarnTransactions/GetPackagingStylesByForm',
                    type: 'GET',
                    data: { formType: formName },
                    success: function(response) {
                        var $select = $('#PackagingStyleId');
                        $select.empty().append('<option value="">-- اختر التعبئة --</option>');

                        var packagingStyles = response.data || response;
                        if (Array.isArray(packagingStyles) && packagingStyles.length > 0) {
                            packagingStyles.forEach(function(item) {
                                var optionText = item.name || item.styleName || item.text;
                                var optionValue = item.id || item.value;
                                // Convert numbers to Arabic
                                if (optionText && /\d/.test(optionText)) {
                                    optionText = toArabicDigits(optionText);
                                }
                                if (optionValue && optionText) {
                                    $select.append(new Option(optionText, optionValue));
                                }
                            });
                        }
                        $select.trigger('change');
                    },
                    error: function() {
                        console.error('Error loading packaging styles');
                    }
                });
            }

            function fetchYarnItemBalance(yarnItemId) {
                $.ajax({
                    url: '/YarnTransactions/GetYarnItemBalance',
                    type: 'GET',
                    data: { yarnItemId: yarnItemId },
                    beforeSend: function() {
                        $('#currentBalanceDisplay').html('<i class="fas fa-spinner fa-spin"></i> جاري التحميل...');
                    },
                    success: function(response) {
                        if (response && response.success) {
                            var totalBalance = response.totalQuantityBalance || 0;
                            var totalCount = response.totalCountBalance || 0;

                            var balanceAr = toArabicDigits(totalBalance.toFixed(3).toString());
                            var countAr = toArabicDigits(totalCount.toString());

                            $('#currentBalanceDisplay').html(`
                                <div class="d-flex justify-content-between align-items-center w-100">
                                    <div>
                                        <strong class="text-primary fs-6">${balanceAr}</strong>
                                        <small class="text-muted ms-1">كجم</small>
                                    </div>
                                    <div>
                                        <span class="badge bg-info">${countAr} وحدة</span>
                                    </div>
                                </div>
                            `);

                            window.currentPackagingBreakdown = response.packagingBreakdown || [];
                            $('#OriginYarnName').val(response.originYarn || '');

                            console.log('✅ Balance loaded:', {
                                yarnItem: response.yarnItem,
                                totalQuantityBalance: totalBalance,
                                totalCountBalance: totalCount
                            });
                        } else {
                            $('#currentBalanceDisplay').html('<small class="text-danger">٠</small>');
                        }
                    },
                    error: function() {
                        $('#currentBalanceDisplay').html('<small class="text-danger">خطأ في التحميل</small>');
                    }
                });
            }

            window.toArabicDigits = toArabicDigits;
            window.toLatinDigits = toLatinDigits;
        });
    </script>

    <style>
        /* Make the card larger */
        .card {
            border-radius: 0.75rem;
        }

        .card-body {
            padding: 1.5rem 1.75rem;
        }

        .card-header {
            padding: 1rem 1.25rem;
        }

        /* Increase font sizes across the form */
        body,
        .form-control,
        .form-select,
        .input-group-text,
        .form-label,
        small,
        .form-text,
        .alert,
        .btn,
        h6.border-bottom {
            font-size: 1rem !important;
        }

        /* Headings more prominent */
        .card-body.rounded h4 {
            font-size: 1.35rem !important;
        }

        h6.border-bottom {
            font-size: 1.1rem !important;
            font-weight: 700;
        }

        /* Buttons bigger */
        .btn-sm {
            padding: 0.45rem 0.9rem !important;
            font-size: 1rem !important;
            border-radius: 0.45rem;
        }

        /* Input bigger */
        .form-control-sm, .form-select-sm {
            font-size: 1rem !important;
            height: calc(2em + 0.75rem + 2px) !important;
            padding: 0.45rem 0.75rem !important;
        }

        /* Textarea bigger */
        textarea.form-control-sm {
            font-size: 1rem !important;
            padding: 0.6rem 0.75rem !important;
        }

        /* Display areas larger */
        #currentBalanceDisplay,
        #unitWeightDisplay {
            font-size: 1rem !important;
            padding: 0.5rem 0.75rem !important;
        }

        /* Select2 Larger */
        .select2-container--bootstrap-5 .select2-selection {
            min-height: calc(2em + 0.75rem) !important;
            font-size: 1rem !important;
        }

        .select2-container--bootstrap-5 .select2-selection__rendered {
            line-height: 2.2rem !important;
            padding: 0.45rem 0.75rem !important;
        }
        /* Optimized Compact Form Styling */
        .yarn-form-container {
            max-width: 900px;
            margin: 0 auto;
        }

        /* Compact form controls */
        .form-control-sm, .form-select-sm {
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
            height: calc(1.5em + 0.5rem + 2px);
        }

        .input-group-sm > .form-control,
        .input-group-sm > .input-group-text,
        .input-group-sm > .btn {
            font-size: 0.875rem;
            padding: 0.25rem 0.5rem;
            height: calc(1.5em + 0.5rem + 2px);
        }

        /* Compact spacing between form groups */
        .mb-3 {
            margin-bottom: 0.5rem !important;
        }

        .mb-4 {
            margin-bottom: 0.75rem !important;
        }

        /* Form labels - smaller and more compact */
        .form-label {
            font-weight: 600;
            font-size: 0.8rem;
            margin-bottom: 0.2rem;
            line-height: 1.2;
        }

            .form-label i {
                font-size: 0.75rem;
            }

        /* Section headers - more compact */
        h6.border-bottom {
            font-size: 0.9rem;
            padding-bottom: 0.4rem;
            margin-bottom: 0.6rem;
            font-weight: 700;
        }

            h6.border-bottom i {
                font-size: 0.85rem;
            }

        /* Required asterisk */
        .required::after {
            content: " *";
            color: #dc3545;
            font-size: 0.75rem;
        }

        /* Card styling - comfortable but not too large */
        .card {
            border-radius: 0.5rem;
        }

        .card-body {
            padding: 1rem 1.25rem;
        }

        .card-header {
            padding: 0.65rem 1rem;
        }

            .card-header h5 {
                font-size: 1rem;
                margin: 0;
                font-weight: 600;
            }

                .card-header h5 i {
                    font-size: 0.9rem;
                }

        /* Clear button styling */
        .btn-clear, .btn-clear-textarea {
            padding: 0.25rem 0.5rem;
            border: 1px solid #ced4da;
            border-left: none;
            background: #fff;
            color: #6c757d;
            transition: all 0.2s;
            height: calc(1.5em + 0.5rem + 2px);
        }

            .btn-clear:hover, .btn-clear-textarea:hover {
                background: #e9ecef;
                color: #dc3545;
            }

        .btn-clear-textarea {
            position: absolute;
            left: 5px;
            top: 5px;
            z-index: 10;
            border: 1px solid #ced4da;
            border-radius: 0.25rem;
            padding: 0.25rem 0.5rem;
            font-size: 0.7rem;
            height: auto;
        }

        .input-group-clearable {
            position: relative;
        }

        /* Select2 styling - compact */
        .select2-container--bootstrap-5 .select2-selection {
            min-height: calc(1.5em + 0.5rem + 2px);
            font-size: 0.875rem;
        }

        .select2-container--bootstrap-5 .select2-selection__rendered {
            line-height: calc(1.5em + 0.5rem);
            padding: 0.25rem 0.5rem;
        }

        .select2-container--bootstrap-5 .select2-selection__arrow {
            height: calc(1.5e + 0.5rem + 2px);
        }

        /* Date picker button */
        #calendarBtn {
            border-left: 1px solid #ced4da;
        }

        /* Balance display - more compact */
        #currentBalanceDisplay {
            display: flex;
            align-items: center;
            padding: 0.25rem 0.5rem;
            min-height: calc(1.5em + 0.5rem + 2px);
            font-size: 0.875rem;
        }

            #currentBalanceDisplay .fs-6 {
                font-size: 0.9rem !important;
            }

        /* Validation styling */
        .is-invalid {
            border-color: #dc3545;
        }

        .invalid-feedback {
            display: block;
            margin-top: 0.2rem;
            font-size: 0.75rem;
        }

        /* Button sizing */
        .btn-sm {
            padding: 0.25rem 0.65rem;
            font-size: 0.85rem;
        }

        /* Input group text */
        .input-group-text {
            font-size: 0.8rem;
            padding: 0.25rem 0.5rem;
        }

        /* Form text and small elements - more compact */
        .form-text {
            font-size: 0.7rem;
            margin-top: 0.15rem;
            line-height: 1.3;
        }

            .form-text i {
                font-size: 0.65rem;
            }

        small {
            font-size: 0.75rem;
            line-height: 1.3;
        }

        /* Alert compact */
        .alert {
            padding: 0.5rem 0.75rem;
            font-size: 0.85rem;
            margin-bottom: 0.75rem;
        }

            .alert i {
                font-size: 0.8rem;
            }

        /* Badge sizing */
        .badge {
            font-size: 0.7rem;
            padding: 0.25rem 0.45rem;
        }

        /* Packaging help text */
        .packaging-help {
            font-size: 0.7rem;
            margin-top: 0.15rem;
        }

        /* Flatpickr Arabic styling */
        .flatpickr-day.selected {
            background: #198754 !important;
            border-color: #198754 !important;
        }

        .flatpickr-calendar {
            direction: rtl;
        }

        /* Row gutters - reduce spacing */
        .row {
            --bs-gutter-x: 1rem;
        }

        /* Section dividers - less space */
        .col-12.mb-4 {
            margin-bottom: 0.75rem !important;
        }

        /* Textarea compact */
        textarea.form-control-sm {
            font-size: 0.875rem;
            padding: 0.35rem 0.5rem;
            line-height: 1.4;
        }

        /* Action buttons spacing */
        .row.mt-4 {
            margin-top: 1rem !important;
        }

        .d-flex.gap-2 {
            gap: 0.4rem !important;
        }

        /* Header card - more compact */
        .card.mb-4 {
            margin-bottom: 0.75rem !important;
        }

        .card-body.rounded h4 {
            font-size: 1.1rem;
            margin-bottom: 0.3rem;
        }

        .card-body.rounded p {
            font-size: 0.85rem;
        }

        /* Validation summary */
        #validationSummary {
            padding: 0.5rem 0.75rem;
            margin-bottom: 0.75rem;
        }

            #validationSummary ul {
                margin-bottom: 0;
                padding-left: 1.25rem;
            }

            #validationSummary li {
                font-size: 0.8rem;
                margin-bottom: 0.2rem;
            }

        /* Unit weight display */
        #unitWeightDisplay {
            padding: 0.4rem 0.75rem;
            font-size: 0.8rem;
        }

        /* Character count */
        #commentCharCount {
            font-size: 0.7rem;
        }

        /* Responsive */
        @@media (max-width: 768px) {
            .yarn-form-container {
                max-width: 100%;
            }

            .col-md-4, .col-md-6, .col-md-8 {
                max-width: 100%;
            }

            .form-label {
                font-size: 0.75rem;
            }

            h6.border-bottom {
                font-size: 0.85rem;
            }

            .card-body {
                padding: 0.75rem 1rem;
            }

            .row {
                --bs-gutter-x: 0.75rem;
            }
        }

        /* Fine-tune spacing between sections */
        .col-12 > .row {
            row-gap: 0.5rem;
        }

        /* Optimize icon sizes for better visual balance */
        .fas, .far {
            vertical-align: middle;
        }

        /* Input focus states - subtle */
        .form-control:focus,
        .form-select:focus {
            box-shadow: 0 0 0 0.15rem rgba(13, 110, 253, 0.15);
        }

        /* Better visual hierarchy */
        .text-primary {
            font-weight: 600;
        }

        /* Compact alert dismissible button */
        .alert .btn-close {
            padding: 0.35rem;
            font-size: 0.7rem;
        }
    </style>
   }