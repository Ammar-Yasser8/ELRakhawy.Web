@using ELRakhawy.EL.ViewModels
@model YarnTransactionViewModel
@{
    ViewData["Title"] = Model.IsInbound ? "اضافة وارد غزل" : "اضافة صادر غزل";
    var currentTime = "2025-08-12 02:19:03";
    var currentUser = "Ammar-Yasser8";
    var formName = Model.IsInbound ? "اضافة وارد غزل" : "اضافة صادر غزل";
}

<script>
    // Add this at the top of your script section
    window.yarnFormConfig = {
        formName: '@Html.Raw(formName)',
        isInbound: @Json.Serialize(Model.IsInbound),
        currentTime: '@currentTime',
        currentUser: '@currentUser',
        formType: 'yarn'
    };
</script>

 
<div class="container-fluid mt-4 yarn-form-container">
    <!-- Header Card -->
    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body @(Model.IsInbound ? "bg-success" : "bg-warning") text-white rounded">
            <div class="row align-items-center">
                <div class="col">
                    <h4 class="mb-1">
                        <i class="fas @(Model.IsInbound ? "fa-arrow-down" : "fa-arrow-up") me-2"></i>
                        @ViewData["Title"]
                    </h4>
                    <p class="mb-0 opacity-75">
                        @(Model.IsInbound ? "تسجيل كمية غزل واردة للمخزن" : "تسجيل كمية غزل صادرة من المخزن")
                    </p>
                </div>
                
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts -->
    @if (TempData["Success"] != null || TempData["Error"] != null)
    {
        <div class="alert @(TempData["Success"] != null ? "alert-success" : "alert-danger") alert-dismissible fade show mb-4">
            <i class="fas @(TempData["Success"] != null ? "fa-check-circle" : "fa-exclamation-circle") me-2"></i>
            @(TempData["Success"] ?? TempData["Error"])
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Main Form Card -->
    <div class="card shadow-sm">
        <div class="card-header @(Model.IsInbound ? "bg-success" : "bg-warning") text-white">
            <h5 class="mb-0">
                <i class="fas fa-form me-2"></i>تفاصيل المعاملة
            </h5>
        </div>
        <div class="card-body">
            <form id="yarnTransactionForm" action="~/YarnTransactions/SaveTransaction" method="post">
                @Html.AntiForgeryToken()
                <input type="hidden" id="IsInbound" name="IsInbound" value="@Model.IsInbound.ToString().ToLower()" />
                <input type="hidden" id="YarnItemName" name="YarnItemName" />
                <input type="hidden" id="OriginYarnName" name="OriginYarnName" />
                <input type="hidden" id="StakeholderName" name="StakeholderName" />
                <input type="hidden" id="StakeholderTypeName" name="StakeholderTypeName" />
                <input type="hidden" id="PackagingStyleName" name="PackagingStyleName" />

                <div class="alert alert-danger" style="display:none;" id="validationSummary">
                    <ul id="validationList"></ul>
                </div>

                <div class="row">
                    <!-- Reference Numbers Section -->
                    <div class="col-12 mb-4">
                        <h6 class="text-primary border-bottom pb-2">
                            <i class="fas fa-hashtag me-2"></i>أرقام المرجعية
                        </h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="InternalId" class="form-label">
                                    <i class="fas fa-file-alt text-info me-1"></i>رقم الإذن الداخلي
                                </label>
                                <input type="text" id="InternalId" name="InternalId" value="@Model.InternalId" 
                                       class="form-control" placeholder="أدخل رقم الإذن الداخلي" />
                                <span class="text-danger" data-valmsg-for="InternalId"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="ExternalId" class="form-label">
                                    <i class="fas fa-external-link-alt text-warning me-1"></i>رقم الإذن الخارجي
                                </label>
                                <input type="text" id="ExternalId" name="ExternalId" value="@Model.ExternalId" 
                                       class="form-control" placeholder="أدخل رقم الإذن الخارجي" />
                                <span class="text-danger" data-valmsg-for="ExternalId"></span>
                            </div>
                        </div>
                    </div>


                    <!-- Yarn Item Selection Section -->
                    <div class="col-12 mb-4">
                        <h6 class="text-primary border-bottom pb-2">
                            <i class="fas fa-box me-2"></i>تفاصيل الصنف
                        </h6>
                        <div class="row">
                            <div class="col-md-8 mb-3">
                                <label for="YarnItemId" class="form-label required">
                                    <i class="fas fa-yarn text-primary me-1"></i>صنف الغزل
                                </label>
                                <select id="YarnItemId" name="YarnItemId" class="form-select">
                                    <option value="">-- اختر صنف الغزل --</option>
                                    @foreach (var item in Model.AvailableItems)
                                    {
                                        <option value="@item.Value">@item.Text</option>
                                    }
                                </select>
                                <span class="text-danger" data-valmsg-for="YarnItemId"></span>
                            </div>
                            <div class="col-md-4 mb-3">
                                <label class="form-label">
                                    <i class="fas fa-info-circle text-info me-1"></i>الرصيد الحالي
                                </label>
                                <div id="currentBalanceDisplay" class="form-control bg-light">
                                    <small class="text-muted">اختر الصنف أولاً</small>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Quantity Section -->
                    <div class="col-12 mb-4">
                        <h6 class="text-primary border-bottom pb-2">
                            <i class="fas fa-calculator me-2"></i>الكميات
                        </h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="Quantity" class="form-label required">
                                    <i class="fas fa-weight text-success me-1"></i>الكمية
                                </label>
                                <div class="input-group">
                                    <input type="text" id="Quantity" name="Quantity" value="@Model.Quantity"
                                           class="form-control" placeholder="" />
                                    <span class="input-group-text">كجم</span>
                                </div>
                                <span class="text-danger" data-valmsg-for="Quantity"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="Count" class="form-label required">
                                    <i class="fas fa-sort-numeric-up text-info me-1"></i>العدد
                                </label>
                                <div class="input-group">
                                    <input type="text" id="Count" name="Count" value="@Model.Count"
                                           class="form-control" placeholder="" />
                                    <span class="input-group-text">وحدة</span>
                                </div>
                                <span class="text-danger" data-valmsg-for="Count"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Stakeholder Section -->
                  <div class="col-12 mb-4">
                        <h6 class="text-primary border-bottom pb-2">
                            <i class="fas fa-users me-2"></i>بيانات الجهة
                        </h6>
                        <div class="row">
                            <input type="hidden" id="StakeholderTypeId" name="StakeholderTypeId" value="@Model.StakeholderTypeId" />
                            <div class="col-md-6 mb-3">
                                <label for="StakeholderId" class="form-label required">
                                    <i class="fas fa-building text-success me-1"></i>الجهة
                                </label>
                                <select id="StakeholderId" name="StakeholderId" class="form-select">
                                    <option value="">-- اختر الجهة --</option>
                                    @foreach (var stakeholder in Model.Stakeholders)
                                    {
                                        <option value="">-- اختر الجهة --</option>
                                    }
                                </select>
                                <span class="text-danger" data-valmsg-for="StakeholderId"></span>
                            </div>
                        </div>
                    </div>

                    <!-- Packaging and Date Section -->
                 <div class="col-12 mb-4">
                        <h6 class="text-primary border-bottom pb-2">
                            <i class="fas fa-box-open me-2"></i>التعبئة والتاريخ
                        </h6>
                        <div class="row">
                            <div class="col-md-6 mb-3">
                                <label for="PackagingStyleId" class="form-label required">
                                    <i class="fas fa-cube text-info me-1"></i>نمط التعبئة
                                </label>
                                <select id="PackagingStyleId" name="PackagingStyleId" class="form-select">
                                    <option value="">-- اختر نمط التعبئة --</option>
                                    @foreach (var packaging in Model.PackagingStyles)
                                    {
                                        <select id="PackagingStyleId" name="PackagingStyleId" class="form-select">
                                            <option value="">-- اختر التعبئة --</option>
                                        </select>
                                    }
                                </select>
                                <span class="text-danger" data-valmsg-for="PackagingStyleId"></span>
                            </div>
                            <div class="col-md-6 mb-3">
                                <label for="Date" class="form-label required">
                                    <i class="fas fa-calendar-alt text-warning me-1"></i>تاريخ المعاملة
                                </label>
                                <div class="input-group" dir="ltr">
                                    <input type="text" id="Date" name="Date"
                                           value="@(Model.Date.ToString("yyyy-MM-dd"))"
                                           class="form-control text-end"
                                           placeholder="yyyy-MM-dd"
                                           pattern="\d{4}-\d{2}-\d{2}"
                                           maxlength="10"
                                           data-date-format="yyyy-MM-dd"
                                           data-input
                                           autocomplete="off" />
                                    <span class="input-group-text">
                                        <i class="fas fa-calendar"></i>
                                    </span>
                                </div>
                                <span class="text-danger" data-valmsg-for="Date"></span>
                                <small class="form-text text-muted">
                                    <i class="fas fa-info-circle"></i>
                                    صيغة التاريخ المطلوبة: yyyy-MM-dd (مثال: ٢٠٢٣-١٢-٣١)
                                </small>
                        </div>
                    </div>

                    <!-- Comment Section -->
                    <div class="col-12 mb-4">
                        <h6 class="text-primary border-bottom pb-2">
                            <i class="fas fa-comment me-2"></i>البيان والملاحظات
                        </h6>
                        <label for="Comment" class="form-label">
                            <i class="fas fa-sticky-note text-secondary me-1"></i>بيان المعاملة
                        </label>
                        <textarea id="Comment" name="Comment" class="form-control" rows="3" 
                                  placeholder="أدخل أي ملاحظات أو تفاصيل إضافية عن المعاملة (اختياري)">@Model.Comment</textarea>
                        <span class="text-danger" data-valmsg-for="Comment"></span>
                        <div class="form-text">
                            <small class="text-muted">
                                <i class="fas fa-lightbulb me-1"></i>يمكنك إضافة تفاصيل عن جودة الغزل، المصدر، أو أي ملاحظات مهمة
                            </small>
                        </div>
                    </div>
                </div>

                <!-- Action Buttons -->
                <div class="row mt-4">
                    <div class="col-12">
                        <div class="d-flex gap-2 justify-content-end">
                            <a href="@Url.Action("Index", "YarnItems")" class="btn btn-secondary">
                                <i class="fas fa-times me-1"></i>إلغاء
                            </a>
                            <button type="button" class="btn btn-info" id="previewBtn">
                                <i class="fas fa-eye me-1"></i>معاينة
                            </button>
                            <button type="submit" class="btn @(Model.IsInbound ? "btn-success" : "btn-warning") text-white" id="saveBtn">
                                <i class="fas fa-save me-1"></i>
                                حفظ @(Model.IsInbound ? "الوارد" : "الصادر")
                            </button>
                        </div>
                    </div>
                </div>

            </form>

        </div>
    </div>

    <!-- Balance Information Card -->
    <div class="card mt-4 border-info" id="balanceInfoCard" style="display: none;">
        <div class="card-header bg-info text-white">
            <h6 class="mb-0">
                <i class="fas fa-chart-line me-2"></i>معلومات الرصيد
            </h6>
        </div>
        <div class="card-body" id="balanceInfo">
            <!-- Will be populated dynamically -->
        </div>
    </div>

@section Scripts {
    <script src="/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ar.js"></script>

    <script>
        $(document).ready(function () {
            // Constants
            const CURRENT_TIME = '2025-08-12 02:19:03';
            const CURRENT_USER = 'Ammar-Yasser8';
            const IS_INBOUND = @Json.Serialize(Model.IsInbound);
            const FORM_NAME = '@Html.Raw(formName)';

            // Debug info
            console.log('Initializing yarn transaction form:', {
                time: CURRENT_TIME,
                user: CURRENT_USER,
                isInbound: IS_INBOUND,
                formType: 'yarn'
            });

            // Initialize select2 for all dropdowns
            $('.form-select').select2({
                theme: 'bootstrap-5',
                width: '100%',
                language: {
                    noResults: function () {
                        return "لا توجد نتائج";
                    },
                    searching: function () {
                        return "جاري البحث...";
                    }
                }
            });

            // Convert header date to Arabic digits
            (function() {
                var headerDateText = $('#headerDate').text();
                if (headerDateText) {
                    $('#headerDate').text(toArabicDigits(headerDateText));
                }
            })();

            // Normalize existing values in all text inputs and textareas to Arabic digits
            $('#yarnTransactionForm').find("input[type='text'], textarea").each(function() {
                var v = $(this).val();
                if (v) $(this).val(toArabicDigits(v.toString()));
            });

                     // Initialize Arabic date picker (Flatpickr)
        if (window.flatpickr) {
            // Configure Arabic locale
            flatpickr.localize(flatpickr.l10ns.ar);

            flatpickr('#Date', {
                dateFormat: 'Y-m-d',
                locale: 'ar',
                allowInput: true,
                disableMobile: true,
                defaultDate: $('#Date').val() || new Date(),

                // Format display on initialization
                onReady: function(selectedDates, dateStr, instance) {
                    if (dateStr) {
                        $('#Date').val(dateStr); // Don't convert to Arabic digits here
                    }
                },

                // Handle date selection
                onChange: function(selectedDates, dateStr, instance) {
                    if (dateStr) {
                        $('#Date').val(dateStr); // Keep in Latin format for processing
                    }
                }
            });

            // Remove the manual input handler that converts to Arabic digits
            // This was causing the format issues
        }
            // Handle yarn item selection change
            $('#YarnItemId').on('change', function () {
                var selectedItemId = $(this).val();
                var selectedText = $(this).find('option:selected').text();

                console.log('Yarn Item Change:', {
                    time: CURRENT_TIME,
                    itemId: selectedItemId,
                    selectedText: selectedText
                });

                // Update hidden field
                $('#YarnItemName').val(selectedText);

                if (!selectedItemId) {
                    $('#currentBalanceDisplay').html('<small class="text-muted">اختر الصنف أولاً</small>');
                    $('#balanceInfoCard').fadeOut();
                    return;
                }

                // Fetch yarn item balance
                fetchYarnItemBalance(parseInt(selectedItemId));
            });

            // Load stakeholders list directly by form (no explicit type selection)
            (function() {
                var $stakeholderSelect = $('#StakeholderId');
                resetStakeholderDropdown($stakeholderSelect);
                fetchStakeholdersByForm(FORM_NAME, $stakeholderSelect);
            })();

            // Handle stakeholder change: set hidden StakeholderTypeId and names
            $('#StakeholderId').on('change', function () {
                var $opt = $(this).find('option:selected');
                var selectedText = $opt.text();
                $('#StakeholderName').val(selectedText);
                var typeId = $opt.data('type-id');
                if (typeId) {
                    $('#StakeholderTypeId').val(typeId);
                }
            });

            // Handle packaging style change
            $('#PackagingStyleId').on('change', function () {
                var selectedText = $(this).find('option:selected').text();
                $('#PackagingStyleName').val(selectedText);
            });

            // Function to fetch yarn item balance
            function fetchYarnItemBalance(yarnItemId) {
                $.ajax({
                    url: '/YarnTransactions/GetYarnItemBalance',
                    type: 'GET',
                    data: { yarnItemId: yarnItemId },
                    dataType: 'json',
                    beforeSend: function() {
                        $('#currentBalanceDisplay').html('<i class="fas fa-spinner fa-spin"></i> جاري التحميل...');
                    },
                    success: function(response) {
                        if (response && response.success) {
                            var balance = response.quantityBalance || 0;
                            var countBalance = response.countBalance || 0;
                            
                            // format balances using Arabic digits
                            var balanceAr = toArabicDigits(balance.toFixed(3).toString());
                            var countBalanceAr = toArabicDigits(countBalance.toString());

                                    // In your fetchYarnItemBalance function, replace this part:
        $('#currentBalanceDisplay').html(`
            <div class="d-flex justify-content-between">
                <span><strong>${balanceAr}</strong> كجم</span>
                <span><strong>${response.packagingDisplay}</strong></span>
            </div>
        `);

                            // Show detailed balance info
                            showBalanceInfo(response);

                            // Update origin yarn hidden field
                            $('#OriginYarnName').val(response.originYarn || '');

                            console.log('Balance loaded:', {
                                yarnItem: response.yarnItem,
                                quantityBalance: balance,
                                countBalance: countBalance,
                                time: CURRENT_TIME
                            });
                        } else {
                            $('#currentBalanceDisplay').html('<small class="text-danger">0</small>');
                            toastr.error(response.error || 'فشل في تحميل رصيد الصنف');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error fetching yarn balance:', {
                            status: status,
                            error: error,
                            time: CURRENT_TIME
                        });
                        $('#currentBalanceDisplay').html('<small class="text-danger">خطأ في التحميل</small>');
                        toastr.error('حدث خطأ أثناء تحميل رصيد الصنف');
                    }
                });
            }

        // Function to show balance information with multiple packaging support
        function showBalanceInfo(data) {
            var qBalAr = toArabicDigits(data.quantityBalance.toFixed(3).toString());
            var tCountAr = toArabicDigits((data.transactionCount || 0).toString());
            var lastDateAr = toArabicDigits((data.lastTransactionDate || '').toString());

            // ✅ Use short display for main view, full display in details
            var packagingDisplayHtml = data.shortPackagingDisplay || 'لا توجد وحدات';
            var fullPackagingDisplay = data.packagingDisplay || 'لا توجد وحدات';

            var infoHtml = `
                <div class="row">
                    <div class="col-md-3">
                        <div class="text-center border-end">
                            <h5 class="text-primary mb-0">${qBalAr}</h5>
                            <small class="text-muted">رصيد الكمية (كجم)</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center border-end">
                            <div class="text-success mb-0" title="${fullPackagingDisplay}">
                                ${packagingDisplayHtml}
                            </div>
                            <small class="text-muted">رصيد العدد بالتعبئة</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center border-end">
                            <h5 class="text-info mb-0">${tCountAr}</h5>
                            <small class="text-muted">عدد المعاملات</small>
                        </div>
                    </div>
                    <div class="col-md-3">
                        <div class="text-center">
                            <h5 class="text-warning mb-0">${lastDateAr}</h5>
                            <small class="text-muted">آخر معاملة</small>
                        </div>
                    </div>
                </div>
                <hr>
                <div class="row">
                    <div class="col-md-6">
                        <p class="mb-1"><strong>الصنف:</strong> ${data.yarnItem}</p>
                        <p class="mb-0"><strong>الغزل المكون:</strong> ${data.originYarn}</p>
                    </div>
                    <div class="col-md-6">
                        <p class="mb-0"><strong>الشركة المصنعة:</strong> ${data.manufacturer}</p>
                    </div>
                </div>

                <!-- ✅ Enhanced packaging breakdown for multiple types -->
                ${data.packagingBreakdown && data.packagingBreakdown.length > 0 ? `
                <hr>
                <div class="row">
                    <div class="col-12">
                        <div class="d-flex justify-content-between align-items-center mb-2">
                            <h6 class="fw-bold text-dark mb-0">تفاصيل التعبئة:</h6>
                            ${data.hasMultiplePackaging ? '<small class="text-muted">أنواع متعددة</small>' : ''}
                        </div>
                        <div class="row g-2">
                            ${data.packagingBreakdown.map(p => `
                                <div class="col-auto">
                                    <span class="badge ${p.totalCount > 50 ? 'bg-success' : 'bg-light text-dark border'} fs-6 py-2 px-3">
                                        <i class="fas fa-box me-1"></i>
                                        ${toArabicDigits(p.totalCount.toString())} ${p.packagingType}
                                    </span>
                                </div>
                            `).join('')}
                        </div>
                        ${data.packagingBreakdown.length > 1 ? `
                        <div class="mt-2">
                            <small class="text-info">
                                <i class="fas fa-info-circle me-1"></i>
                                المجموع: ${toArabicDigits(data.countBalance.toString())} وحدة موزعة على ${toArabicDigits(data.packagingBreakdown.length.toString())} نوع تعبئة
                            </small>
                        </div>
                        ` : ''}
                    </div>
                </div>
                ` : ''}
            `;

            $('#balanceInfo').html(infoHtml);
            $('#balanceInfoCard').fadeIn();
        }

            // Function to reset stakeholder dropdown
            function resetStakeholderDropdown($select) {
                $select
                    .empty()
                    .append('<option value="">-- اختر الجهة --</option>')
                    .prop('disabled', false)
                    .select2('destroy')
                    .select2({
                        theme: 'bootstrap-5',
                        width: '100%',
                        language: {
                            noResults: function () {
                                return "لا توجد نتائج";
                            }
                        }
                    });
            }

            // Function to fetch stakeholders by form name
            function fetchStakeholdersByForm(formName, $select) {
                $.ajax({
                    url: '/YarnTransactions/GetStakeholdersByForm',
                    type: 'GET',
                    data: { formName: formName },
                    dataType: 'json',
                    beforeSend: function() {
                        $select
                            .empty()
                            .append('<option value="">-- اختر الجهة --</option>')
                            .append('<option value="" disabled>جاري التحميل...</option>')
                            .prop('disabled', true);
                    },
                    success: function(response) {
                        $select
                            .empty()
                            .append('<option value="">-- اختر الجهة --</option>')
                            .prop('disabled', false);

                        var stakeholders = (response && response.data) || [];
                        if (response && response.success && stakeholders.length > 0) {
                            stakeholders.forEach(function(item) {
                                var opt = new Option(item.name, item.id);
                                if (item.typeId) {
                                    $(opt).attr('data-type-id', item.typeId);
                                }
                                $select.append(opt);
                            });
                            toastr.success('تم تحميل الجهات بنجاح');
                        } else {
                            toastr.warning('لا توجد جهات متاحة للنموذج المحدد');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error fetching stakeholders:', {
                            status: status,
                            error: error,
                            time: CURRENT_TIME
                        });
                        toastr.error('حدث خطأ أثناء تحميل بيانات الجهات');
                    },
                    complete: function() {
                        $select.select2('destroy').select2({
                            theme: 'bootstrap-5',
                            width: '100%',
                            language: {
                                noResults: function () {
                                    return "لا توجد نتائج";
                                }
                            }
                        });
                    }
                });
            }

            // Function to fetch packaging styles
            function fetchPackagingStyles(formName, $select) {
                $.ajax({
                    url: '/YarnTransactions/GetPackagingStylesByForm',
                    type: 'GET',
                    data: { formType: formName },
                    dataType: 'json',
                    beforeSend: function() {
                        $select
                            .empty()
                            .append('<option value="">-- اختر التعبئة --</option>')
                            .append('<option value="" disabled>جاري التحميل...</option>')
                            .prop('disabled', true);
                    },
                    success: function(response) {
                        $select
                            .empty()
                            .append('<option value="">-- اختر التعبئة --</option>')
                            .prop('disabled', false);

                        var packagingStyles = response.data || response;
                        if (Array.isArray(packagingStyles) && packagingStyles.length > 0) {
                            packagingStyles.forEach(function(item) {
                                var optionText = item.name || item.styleName || item.text;
                                var optionValue = item.id || item.value;

                                if (optionValue && optionText) {
                                    $select.append(new Option(optionText, optionValue));
                                }
                            });
                            toastr.success('تم تحميل أنماط التعبئة بنجاح');
                        } else {
                            toastr.warning('لا توجد أنماط تعبئة متاحة');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('Error fetching packaging styles:', {
                            status: status,
                            error: error,
                            time: CURRENT_TIME
                        });
                        toastr.error('حدث خطأ أثناء تحميل أنماط التعبئة');
                    },
                    complete: function() {
                        $select.select2('destroy').select2({
                            theme: 'bootstrap-5',
                            width: '100%',
                            language: {
                                noResults: function () {
                                    return "لا توجد نتائج";
                                }
                            }
                        });
                    }
                });
            }

            // Normalize numeric fields to Latin before validation/submission
            $('#yarnTransactionForm').on('submit', function(e) {
                // normalize Quantity, Count, Date to Latin for parsing
                var qtyLatin = toLatinDigits($('#Quantity').val() || '');
                var cntLatin = toLatinDigits($('#Count').val() || '');
                    var dateValue = $('#Date').val();

        $('#Quantity').val(qtyLatin);
        $('#Count').val(cntLatin);
                $('#Quantity').val(qtyLatin);
                $('#Count').val(cntLatin);
                $('#Date').val(dateLatin);

                var isValid = validateForm();
                
                if (!isValid) {
                    e.preventDefault();
                    showValidationErrors();
                    return false;
                }

                // Check balance for outbound transactions
                if (!IS_INBOUND) {
                    var quantity = parseFloat(toLatinDigits($('#Quantity').val())) || 0;
                    var currentBalanceText = $('#currentBalanceDisplay').text();
                    // accept Arabic or Latin digits
                    var balanceMatch = toLatinDigits(currentBalanceText).match(/(\d+\.?\d*)\s*كجم/);
                    
                    if (balanceMatch) {
                        var currentBalance = parseFloat(balanceMatch[1]);
                        if (quantity > currentBalance) {
                            e.preventDefault();
                            Swal.fire({
                                title: 'تحذير',
                                text: `الكمية المطلوبة (${toArabicDigits(quantity.toFixed(3))} كجم) أكبر من الرصيد المتاح (${toArabicDigits(currentBalance.toFixed(3))} كجم)`,
                                icon: 'warning',
                                confirmButtonText: 'موافق'
                            });
                            return false;
                        }
                    }
                }

                // Show loading state
                $('#saveBtn').prop('disabled', true)
                    .html('<span class="spinner-border spinner-border-sm me-2"></span>جاري الحفظ...');
            });

                   // Preview functionality
        $('#previewBtn').click(function () {
            var data = {
                yarnItem: $('#YarnItemId option:selected').text(),
                quantity: $('#Quantity').val(),
                count: $('#Count').val(),
                stakeholderType: $('#StakeholderTypeId option:selected').text(),
                stakeholder: $('#StakeholderId option:selected').text(),
                packaging: $('#PackagingStyleId option:selected').text(),
                date: $('#Date').val(),
                comment: $('#Comment').val() || 'لا يوجد بيان',
                type: IS_INBOUND ? 'وارد' : 'صادر'
            };

            var preview = `
                <div class="row">
                    <div class="col-md-6">
                        <p><strong>النوع:</strong>
                            <span class="badge ${IS_INBOUND ? 'bg-success' : 'bg-warning'}">
                                ${data.type}
                            </span>
                        </p>
                        <p><strong>الصنف:</strong> ${data.yarnItem}</p>
                        <p><strong>الكمية:</strong> ${toArabicDigits((data.quantity || '').toString())} كجم</p>
                        <p><strong>العدد:</strong> ${toArabicDigits((data.count || '').toString())} وحدة</p>
                    </div>
                    <div class="col-md-6">
                        <p><strong>نوع الجهة:</strong> ${data.stakeholderType}</p>
                        <p><strong>الجهة:</strong> ${data.stakeholder}</p>
                        <p><strong>التعبئة:</strong> ${data.packaging}</p>
                        <p><strong>التاريخ:</strong> ${toArabicDigits((data.date || '').toString().replace(/-/g, '-'))}</p>
                    </div>
                    <div class="col-12">
                        <p><strong>البيان:</strong> ${data.comment}</p>
                    </div>
                </div>
            `;

            Swal.fire({
                title: 'معاينة المعاملة',
                html: preview + `
                    <div class="mt-3 text-center">
                        <button id="confirmSaveBtn" type="button"
                                class="btn ${IS_INBOUND ? 'btn-success' : 'btn-warning'} text-white">
                            <i class="fas fa-save me-1"></i>
                            حفظ ${IS_INBOUND ? 'الوارد' : 'الصادر'}
                        </button>
                        <button id="cancelBtn" type="button" class="btn btn-secondary ms-2">
                            <i class="fas fa-times me-1"></i>
                            تراجع
                        </button>
                    </div>
                `,
                showConfirmButton: false,
                showCancelButton: false,
                didOpen: () => {
                    // زر الحفظ
                    $('#confirmSaveBtn').on('click', function () {
                        var validation = validateForm();
                        if (validation.isValid) {
                            $('#yarnTransactionForm').submit();
                        } else {
                            showValidationErrors();
                        }
                    });

                    // زر التراجع
                    $('#cancelBtn').on('click', function () {
                        Swal.close();
                    });
                }
            });
        });

            // Initialize packaging styles
            var $packagingSelect = $('#PackagingStyleId');
            var formName = FORM_NAME;
            
            fetchPackagingStyles(formName, $packagingSelect);

            // Load initial yarn item balance if selected
            var initialYarnItemId = $('#YarnItemId').val();
            if (initialYarnItemId) {
                fetchYarnItemBalance(parseInt(initialYarnItemId));
            }

            // Auto-hide alerts
            $('.alert').delay(5000).fadeOut(350);

            console.log('Yarn transaction form initialized successfully');
        });

        // Form validation function
        function validateForm() {
            var isValid = true;
            var errors = [];

            // Validate yarn item
            if (!$('#YarnItemId').val()) {
                errors.push('يجب اختيار صنف الغزل');
                isValid = false;
            }

            // Validate quantity
            var quantity = parseFloat(toLatinDigits($('#Quantity').val()));
            if (!quantity || quantity <= 0) {
                errors.push('يجب إدخال كمية صحيحة أكبر من الصفر');
                isValid = false;
            }

            // Validate count
            var count = parseInt(toLatinDigits($('#Count').val()));
            if (!count || count <= 0) {
                errors.push('يجب إدخال عدد صحيح أكبر من الصفر');
                isValid = false;
            }

            // Validate stakeholder type
            if (!$('#StakeholderTypeId').val()) {
                errors.push('يجب اختيار نوع الجهة');
                isValid = false;
            }

            // Validate stakeholder
            if (!$('#StakeholderId').val()) {
                errors.push('يجب اختيار الجهة');
                isValid = false;
            }

            // Validate packaging
            if (!$('#PackagingStyleId').val()) {
                errors.push('يجب اختيار نمط التعبئة');
                isValid = false;
            }

            // Validate date
            if (!$('#Date').val()) {
                errors.push('يجب تحديد تاريخ المعاملة');
                isValid = false;
            }

            return { isValid: isValid, errors: errors };
        }

        // Show validation errors
        function showValidationErrors() {
            var validation = validateForm();
            if (!validation.isValid) {
                var errorHtml = validation.errors.map(error => `<li>${error}</li>`).join('');
                $('#validationList').html(errorHtml);
                $('#validationSummary').show();
                $('html, body').animate({ scrollTop: 0 }, 500);
            }
        }

        // دالة لتحويل الأرقام للغة العربية
        function toArabicDigits(str) {
            return str.replace(/[0-9]/g, d => '٠١٢٣٤٥٦٧٨٩'[d]);
        }

        // دالة لتحويل الأرقام للاتينية
        function toLatinDigits(str) {
            return str.replace(/[٠-٩]/g, d => '0123456789'['٠١٢٣٤٥٦٧٨٩'.indexOf(d)]);
        }

        // دالة لاكتشاف إذا كان الحرف عربي
        function isArabicChar(c) {
            return /[\u0600-\u06FF]/.test(c);
        }

        // دالة لاكتشاف إذا كان الحرف إنجليزي
        function isEnglishChar(c) {
            return /[a-zA-Z]/.test(c);
        }

        // دالة للعثور على آخر حرف (ليس رقم أو رمز)
        function getLastLetter(str) {
            for (let i = str.length - 1; i >= 0; i--) {
                let char = str[i];
                if (isArabicChar(char)) {
                    return 'arabic';
                } else if (isEnglishChar(char)) {
                    return 'english';
                }
            }
            return 'arabic'; // default is Arabic
        }

               // Validate date immediately
        function validateDateImmediate() {
            var $date = $('#Date');
            var $msg = $("span[data-valmsg-for='Date']");
            var value = ($date.val() || '').trim();

            // Basic format check (yyyy-mm-dd)
            var regex = /^\d{4}-\d{2}-\d{2}$/;
            if (!regex.test(value)) {
                $msg.text('صيغة التاريخ يجب أن تكون yyyy-MM-dd (مثال: 2023-12-31)');
                $date.addClass('is-invalid');
                return false;
            }

            // Check if it's a valid date
            var dateObj = new Date(value);
            if (isNaN(dateObj.getTime())) {
                $msg.text('تاريخ غير صحيح');
                $date.addClass('is-invalid');
                return false;
            }

            $msg.text('');
            $date.removeClass('is-invalid');
            return true;
        }

                // Remove or comment out this problematic handler:
        /*
        $(document).on("input", "#yarnTransactionForm input[type='text'], #yarnTransactionForm textarea", function() {
            let input = this;
            let val = input.value;
            if (val.length > 0) {
                let newVal = toArabicDigits(val);
                if (newVal !== val) {
                    let cursorPos = input.selectionStart;
                    input.value = newVal;
                    input.setSelectionRange(cursorPos, cursorPos);
                }
            }
        });
        */

        // Instead, add a specific handler that excludes the date field
        $(document).on("input", "#yarnTransactionForm input[type='text']:not(#Date), #yarnTransactionForm textarea", function() {
            let input = this;
            let val = input.value;
            if (val.length > 0) {
                let newVal = toArabicDigits(val);
                if (newVal !== val) {
                    let cursorPos = input.selectionStart;
                    input.value = newVal;
                    input.setSelectionRange(cursorPos, cursorPos);
                }
            }
        });

        // Validate date on input/blur/change
        $(document).on('input blur change', '#Date', function() {
            validateDateImmediate();
        });

        // تطبيق التحويل على حقول الأرقام أيضاً (Quantity, Count)
        $(document).on("input", "#yarnTransactionForm input[type='number']", function() {
            let input = this;
            let val = input.value;

            if (val.length > 0) {
                // تحويل الأرقام العربية إلى لاتينية للحقول الرقمية
                let newVal = toLatinDigits(val);
                
                // تحديث القيمة فقط إذا تغيرت
                if (newVal !== val) {
                    let cursorPos = input.selectionStart;
                    input.value = newVal;
                    // استعادة موضع المؤشر
                    input.setSelectionRange(cursorPos, cursorPos);
                }
            }
        });
    </script>

    <style>
        /* Layout width */
        .yarn-form-container { max-width: 1100px; }

        /* Label and input sizing */
        .form-label { font-weight: 600; font-size: 0.95rem; }
        .form-control, .form-select, .select2-selection--single { min-height: 42px; }
        .input-group-text { min-height: 42px; display: flex; align-items: center; }

        /* Select2 height alignment */
        .select2-container .select2-selection--single { height: 42px; }
        .select2-container--bootstrap-5 .select2-selection__rendered { line-height: 42px; }
        .select2-container--bootstrap-5 .select2-selection__arrow { height: 42px; }

        /* Flatpickr alignment */
        .flatpickr-input { min-height: 42px; }

        /* Spacing consistency */
        .mb-3 { margin-bottom: 1rem !important; }
        .card-header h5 { font-size: 1.05rem; }

        .required::after {
            content: " *";
            color: #dc3545;
        }

        .form-control:focus, .form-select:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .border-end {
            border-right: 1px solid #dee2e6 !important;
        }

        .select2-container--bootstrap-5 .select2-selection {
            min-height: calc(2.25rem + 2px);
        }

        @@media (max-width: 768px) {
            .border-end {
                border-right: none !important;
                border-bottom: 1px solid #dee2e6 !important;
                padding-bottom: 15px;
                margin-bottom: 15px;
            }
        }

        .card-header {
            position: relative;
            overflow: hidden;
        }

        .card-header::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
        }
    </style>
}