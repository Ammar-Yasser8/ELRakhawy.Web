@using ELRakhawy.EL.ViewModels
@model YarnTransactionViewModel
@{
    ViewData["Title"] = Model.IsInbound ? "اضافة وارد غزل" : "اضافة صادر غزل";
    var currentTime = "2025-08-12 02:19:03";
    var currentUser = "Ammar-Yasser8";
    var formName = Model.IsInbound ? "اضافة وارد غزل" : "اضافة صادر غزل";
}

<script>
    // Add this at the top of your script section
    window.yarnFormConfig = {
        formName: '@Html.Raw(formName)',
        isInbound: @Json.Serialize(Model.IsInbound),
        currentTime: '@currentTime',
        currentUser: '@currentUser',
        formType: 'yarn'
    };
</script>

 
<div class="container-fluid mt-4 yarn-form-container">
    <!-- Header Card -->
    <div class="card mb-4 border-0 shadow-sm">
        <div class="card-body @(Model.IsInbound ? "bg-success" : "bg-warning") text-white rounded">
            <div class="row align-items-center">
                <div class="col">
                    <h4 class="mb-1">
                        <i class="fas @(Model.IsInbound ? "fa-arrow-down" : "fa-arrow-up") me-2"></i>
                        @ViewData["Title"]
                    </h4>
                    <p class="mb-0 opacity-75">
                        @(Model.IsInbound ? "تسجيل كمية غزل واردة للمخزن" : "تسجيل كمية غزل صادرة من المخزن")
                    </p>
                </div>
                
                </div>
            </div>
        </div>
    </div>

    <!-- Alerts -->
    @if (TempData["Success"] != null || TempData["Error"] != null)
    {
        <div class="alert @(TempData["Success"] != null ? "alert-success" : "alert-danger") alert-dismissible fade show mb-4">
            <i class="fas @(TempData["Success"] != null ? "fa-check-circle" : "fa-exclamation-circle") me-2"></i>
            @(TempData["Success"] ?? TempData["Error"])
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <!-- Main Form Card -->
    <div class="card shadow-sm">
        <div class="card-header @(Model.IsInbound ? "bg-success" : "bg-warning") text-white">
            <h5 class="mb-0">
                <i class="fas fa-form me-2"></i>تفاصيل المعاملة
            </h5>
        </div>
        <div class="card-body">
        <form id="yarnTransactionForm" action="~/YarnTransactions/SaveTransaction" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" id="IsInbound" name="IsInbound" value="@Model.IsInbound.ToString().ToLower()" />
            <input type="hidden" id="YarnItemName" name="YarnItemName" />
            <input type="hidden" id="OriginYarnName" name="OriginYarnName" />
            <input type="hidden" id="StakeholderName" name="StakeholderName" />
            <input type="hidden" id="StakeholderTypeName" name="StakeholderTypeName" />
            <input type="hidden" id="PackagingStyleName" name="PackagingStyleName" />

            <div class="alert alert-danger" style="display:none;" id="validationSummary">
                <ul id="validationList"></ul>
            </div>

            <!-- 1. Reference Numbers Section -->
            <div class="col-12 mb-4">
                <h6 class="text-primary border-bottom pb-2">
                    <i class="fas fa-hashtag me-2"></i>١. أرقام المرجعية
                </h6>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="InternalId" class="form-label">
                            <i class="fas fa-file-alt text-info me-1"></i>رقم الإذن الداخلي
                        </label>
                        <input type="text" id="InternalId" name="InternalId" value="@Model.InternalId"
                               class="form-control" placeholder="أدخل رقم الإذن الداخلي" />
                        <span class="text-danger" data-valmsg-for="InternalId"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="ExternalId" class="form-label">
                            <i class="fas fa-external-link-alt text-warning me-1"></i>رقم الإذن الخارجي
                        </label>
                        <input type="text" id="ExternalId" name="ExternalId" value="@Model.ExternalId"
                               class="form-control" placeholder="أدخل رقم الإذن الخارجي" />
                        <span class="text-danger" data-valmsg-for="ExternalId"></span>
                    </div>
                </div>
            </div>

            <!-- 2. Yarn Item Selection Section -->
            <div class="col-12 mb-4">
                <h6 class="text-primary border-bottom pb-2">
                    <i class="fas fa-box me-2"></i>٢. تفاصيل الصنف
                </h6>
                <div class="row">
                    <div class="col-md-8 mb-3">
                        <label for="YarnItemId" class="form-label required">
                            <i class="fas fa-yarn text-primary me-1"></i>صنف الغزل
                        </label>
                        <select id="YarnItemId" name="YarnItemId" class="form-select">
                            <option value="">-- اختر صنف الغزل --</option>
                            @foreach (var item in Model.AvailableItems)
                            {
                                <option value="@item.Value">@item.Text</option>
                            }
                        </select>
                        <span class="text-danger" data-valmsg-for="YarnItemId"></span>
                    </div>
                    <div class="col-md-4 mb-3">
                        <label class="form-label">
                            <i class="fas fa-info-circle text-info me-1"></i>الرصيد الحالي
                        </label>
                        <div id="currentBalanceDisplay" class="form-control bg-light">
                            <small class="text-muted">اختر الصنف أولاً</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. Stakeholder Section -->
            <div class="col-12 mb-4">
                <h6 class="text-primary border-bottom pb-2">
                    <i class="fas fa-users me-2"></i>٣. بيانات الجهة
                </h6>
                <div class="row">
                    <input type="hidden" id="StakeholderTypeId" name="StakeholderTypeId" value="@Model.StakeholderTypeId" />
                    <div class="col-md-6 mb-3">
                        <label for="StakeholderId" class="form-label required">
                            <i class="fas fa-building text-success me-1"></i>الجهة
                        </label>
                        <select id="StakeholderId" name="StakeholderId" class="form-select">
                            <option value="">-- اختر الجهة --</option>
                            @foreach (var stakeholder in Model.Stakeholders)
                            {
                                <option value="@stakeholder.Value">@stakeholder.Text</option>
                            }
                        </select>
                        <span class="text-danger" data-valmsg-for="StakeholderId"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label class="form-label">
                            <i class="fas fa-tag text-info me-1"></i>نوع الجهة
                        </label>
                        <div id="stakeholderTypeDisplay" class="form-control bg-light">
                            <small class="text-muted">سيتم عرضه عند اختيار الجهة</small>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 4. Packaging and Date Section -->
            <div class="col-12 mb-4">
                <h6 class="text-primary border-bottom pb-2">
                    <i class="fas fa-box-open me-2"></i>٤. التعبئة والتاريخ
                </h6>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="PackagingStyleId" class="form-label required">
                            <i class="fas fa-cube text-info me-1"></i>نمط التعبئة
                        </label>
                        <select id="PackagingStyleId" name="PackagingStyleId" class="form-select">
                            <option value="">-- اختر نمط التعبئة --</option>
                            @foreach (var packaging in Model.PackagingStyles)
                            {
                                <option value="@packaging.Value">@packaging.Text</option>
                            }
                        </select>
                        <span class="text-danger" data-valmsg-for="PackagingStyleId"></span>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="Date" class="form-label required">
                            <i class="fas fa-calendar-alt text-warning me-1"></i>تاريخ المعاملة
                        </label>
                        <div class="input-group" dir="ltr">
                            <input type="text" id="Date" name="Date"
                                   value="@(Model.Date.ToString("yyyy-MM-dd"))"
                                   class="form-control text-end"
                                   placeholder="yyyy-MM-dd"
                                   pattern="\d{4}-\d{2}-\d{2}"
                                   maxlength="10"
                                   data-date-format="yyyy-MM-dd"
                                   data-input
                                   autocomplete="off" />
                            <span class="input-group-text">
                                <i class="fas fa-calendar"></i>
                            </span>
                        </div>
                        <span class="text-danger" data-valmsg-for="Date"></span>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i>
                            صيغة التاريخ المطلوبة: yyyy-MM-dd (مثال: ٢٠٢٥-١٠-١١)
                        </small>
                    </div>
                </div>
            </div>

            <!-- 5. Quantity Section -->
            <div class="col-12 mb-4">
                <h6 class="text-primary border-bottom pb-2">
                    <i class="fas fa-calculator me-2"></i>٥. الكميات
                </h6>
                <div class="row">
                    <div class="col-md-6 mb-3">
                        <label for="Quantity" class="form-label required">
                            <i class="fas fa-weight text-success me-1"></i>الكمية
                        </label>
                        <div class="input-group">
                            <input type="text" id="Quantity" name="Quantity" value="@Model.Quantity"
                                   class="form-control" placeholder="أدخل الكمية بالكيلوجرام" />
                            <span class="input-group-text">كجم</span>
                        </div>
                        <span class="text-danger" data-valmsg-for="Quantity"></span>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i>
                            الكمية الإجمالية للمعاملة
                        </small>
                    </div>
                    <div class="col-md-6 mb-3">
                        <label for="Count" class="form-label required">
                            <i class="fas fa-sort-numeric-up text-info me-1"></i>العدد
                        </label>
                        <div class="input-group">
                            <input type="text" id="Count" name="Count" value="@Model.Count"
                                   class="form-control" placeholder="أدخل عدد الوحدات" />
                            <span class="input-group-text">وحدة</span>
                        </div>
                        <span class="text-danger" data-valmsg-for="Count"></span>
                        <small class="form-text text-muted">
                            <i class="fas fa-info-circle"></i>
                            عدد وحدات التعبئة (شكارة، صندوق، إلخ)
                        </small>
                    </div>
                </div>
                <!-- Unit Weight Display -->
                <div class="row">
                    <div class="col-12">
                        <div class="alert alert-info d-none" id="unitWeightDisplay">
                            <i class="fas fa-calculator me-2"></i>
                            <strong>متوسط وزن الوحدة:</strong>
                            <span id="unitWeightValue">٠</span> كجم/وحدة
                        </div>
                    </div>
                </div>
            </div>

            <!-- 6. Comment Section -->
            <div class="col-12 mb-4">
                <h6 class="text-primary border-bottom pb-2">
                    <i class="fas fa-comment me-2"></i>٦. البيان والملاحظات
                </h6>
                <label for="Comment" class="form-label">
                    <i class="fas fa-sticky-note text-secondary me-1"></i>بيان المعاملة
                </label>
                <textarea id="Comment" name="Comment" class="form-control" rows="3"
                          placeholder="أدخل أي ملاحظات أو تفاصيل إضافية عن المعاملة (اختياري)">@Model.Comment</textarea>
                <span class="text-danger" data-valmsg-for="Comment"></span>
                <div class="form-text">
                    <small class="text-muted">
                        <i class="fas fa-lightbulb me-1"></i>يمكنك إضافة تفاصيل عن جودة الغزل، المصدر، أو أي ملاحظات مهمة
                    </small>
                </div>
                <!-- Character Counter -->
                <div class="form-text text-end">
                    <small class="text-muted">
                        <span id="commentCharCount">٠</span> حرف
                    </small>
                </div>
            </div>

            <!-- Action Buttons -->
            <div class="row mt-4">
                <div class="col-12">
                    <div class="d-flex gap-2 justify-content-end flex-wrap">
                        <a href="@Url.Action("Index", "YarnItems")" class="btn btn-secondary">
                            <i class="fas fa-times me-1"></i>إلغاء
                        </a>
                        <button type="button" class="btn btn-info" id="previewBtn">
                            <i class="fas fa-eye me-1"></i>معاينة
                        </button>
                        <button type="button" class="btn btn-outline-primary" id="resetBtn">
                            <i class="fas fa-undo me-1"></i>إعادة تعيين
                        </button>
                        <button type="submit" class="btn @(Model.IsInbound ? "btn-success" : "btn-warning") text-white" id="saveBtn">
                            <i class="fas fa-save me-1"></i>
                            حفظ @(Model.IsInbound ? "الوارد" : "الصادر")
                        </button>
                    </div>
                </div>
            </div>

        </form>
        </div>
    </div>

   
@section Scripts {
    <script src="/lib/jquery-validation/dist/jquery.validate.min.js"></script>
    <script src="/lib/jquery-validation-unobtrusive/jquery.validate.unobtrusive.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
    <link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
    <link href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/ar.js"></script>

    <script>
               $(document).ready(function () {
            // ✅ Updated Constants
            const CURRENT_TIME = '2025-10-14 20:37:20';
            const CURRENT_USER = 'Ammar-Yasser8';
            const IS_INBOUND = window.yarnFormConfig?.isInbound || false;
            const FORM_NAME = window.yarnFormConfig?.formName || '';

            console.log('🚀 Enhanced yarn transaction form initializing:', {
                time: CURRENT_TIME,
                user: CURRENT_USER,
                isInbound: IS_INBOUND,
                formType: 'yarn'
            });

            // ✅ Enhanced utility functions with improved logic
            function toArabicDigits(str) {
                if (!str) return str;
                return str.toString().replace(/[0-9]/g, d => '٠١٢٣٤٥٦٧٨٩'[d]);
            }

            function toLatinDigits(str) {
                if (!str) return str;
                return str.toString().replace(/[٠-٩]/g, d => '0123456789'['٠١٢٣٤٥٦٧٨٩'.indexOf(d)]);
            }

            function hasArabicChar(str) {
                if (!str) return false;
                return /[\u0600-\u06FF]/.test(str);
            }

            function hasEnglishChar(str) {
                if (!str) return false;
                return /[a-zA-Z]/.test(str);
            }

            // ✅ Enhanced logic: Arabic numbers if Arabic chars present, English numbers if English chars present
            function shouldUseArabicDigits(str) {
                if (!str) return true; // Default to Arabic for empty strings

                // If contains Arabic characters → use Arabic numbers
                if (hasArabicChar(str)) {
                    return true;
                }

                // If contains English characters → use English numbers
                if (hasEnglishChar(str)) {
                    return false;
                }

                // If only numbers or symbols → default to Arabic
                return true;
            }

            // ✅ Smart number conversion function for any input field
            function applySmartNumberConversion($input) {
                let val = $input.val();
                let cursorPos = $input[0].selectionStart || 0;

                if (!val) return;

                // Determine conversion direction based on content
                let shouldUseArabic = shouldUseArabicDigits(val);
                let convertedVal = shouldUseArabic ? toArabicDigits(val) : toLatinDigits(val);

                if (val !== convertedVal) {
                    $input.val(convertedVal);
                    try {
                        $input[0].setSelectionRange(cursorPos, cursorPos);
                    } catch (ex) {
                        $input.focus();
                    }
                }
            }

            // ✅ Enhanced keypress handler for immediate number conversion
            function handleNumberKeypress(e) {
                if (e.which >= 48 && e.which <= 57) { // 0-9
                    e.preventDefault();

                    let digit = String.fromCharCode(e.which);
                    let input = e.target;
                    let currentValue = input.value;
                    let cursorPos = input.selectionStart || 0;

                    // Create temporary value to test conversion
                    let tempValue = currentValue.slice(0, cursorPos) + digit + currentValue.slice(cursorPos);

                    // Determine conversion based on content
                    let useArabic = shouldUseArabicDigits(tempValue);
                    let convertedDigit = useArabic ? toArabicDigits(digit) : digit;

                    // Insert the converted digit
                    let newValue = currentValue.slice(0, cursorPos) + convertedDigit + currentValue.slice(cursorPos);
                    input.value = newValue;
                    input.setSelectionRange(cursorPos + 1, cursorPos + 1);

                    // Trigger input event for real-time processing
                    $(input).trigger('input');
                }
            }

            // ✅ Apply smart number conversion to ALL input fields
            const INPUT_SELECTORS = [
                '#Quantity', '#Count', '#Comment',
                '#searchByName', '#searchByForms', '#searchByComment',
                '#styleName', '#styleComment', '#manufacturerName', '#manufacturerDescription',
                'input[type="text"]', 'input[type="number"]', 'textarea'
            ].join(', ');

            // Apply to existing fields and dynamically added fields
            $(document).on('input keyup paste', INPUT_SELECTORS, function(e) {
                applySmartNumberConversion($(this));
            });

            $(document).on('keypress', INPUT_SELECTORS, handleNumberKeypress);

            // Initialize select2 for all dropdowns with enhanced search
            $('.form-select').select2({
                theme: 'bootstrap-5',
                width: '100%',
                language: {
                    noResults: function () {
                        return "لا توجد نتائج";
                    },
                    searching: function () {
                        return "جاري البحث...";
                    }
                }
            });

            // Convert header date to Arabic digits
            (function() {
                var headerDateText = $('#headerDate').text();
                if (headerDateText) {
                    $('#headerDate').text(toArabicDigits(headerDateText));
                }
            })();

            // ✅ Convert all existing numeric content to Arabic on page load
            function convertExistingContentToArabic() {
                // Convert all visible text elements containing numbers
                $('span, div, p, td, th, label, small').each(function() {
                    let $element = $(this);
                    let text = $element.text();

                    // Skip if element has input children or is part of a form control
                    if ($element.find('input, select, textarea').length > 0) return;

                    // Convert numbers in text content
                    if (/[0-9]/.test(text)) {
                        $element.text(toArabicDigits(text));
                    }
                });

                // Convert placeholder text
                $('input[placeholder], textarea[placeholder]').each(function() {
                    let $input = $(this);
                    let placeholder = $input.attr('placeholder');
                    if (placeholder && /[0-9]/.test(placeholder)) {
                        $input.attr('placeholder', toArabicDigits(placeholder));
                    }
                });

                // Convert badges, alerts, and other UI elements
                $('.badge, .alert, .card-text, .form-text').each(function() {
                    let $element = $(this);
                    let html = $element.html();
                    if (html && /[0-9]/.test(html)) {
                        // Preserve HTML tags while converting numbers
                        $element.html(html.replace(/\b\d+(\.\d+)?\b/g, match => toArabicDigits(match)));
                    }
                });
            }

             // ✅ Convert all existing numeric content to Arabic on page load (excluding date inputs)
        function convertExistingContentToArabic() {
            // Convert all visible text elements containing numbers
            $('span, div, p, td, th, label, small').each(function() {
                let $element = $(this);
                let text = $element.text();
                // Skip if element has input children, is part of a form control, or is related to date picker
                if ($element.find('input, select, textarea').length > 0 ||
                    $element.hasClass('flatpickr-calendar') ||
                    $element.closest('.flatpickr-calendar').length > 0 ||
                    $element.attr('id') === 'Date' ||
                    $element.find('#Date').length > 0) {
                    return;
                }
                // Convert numbers in text content
                if (/[0-9]/.test(text)) {
                    $element.text(toArabicDigits(text));
                }
            });

            // Convert placeholder text (excluding date inputs)
            $('input[placeholder]:not(#Date):not(.flatpickr-input), textarea[placeholder]').each(function() {
                let $input = $(this);
                let placeholder = $input.attr('placeholder');
                if (placeholder && /[0-9]/.test(placeholder)) {
                    $input.attr('placeholder', toArabicDigits(placeholder));
                }
            });

            // Convert badges, alerts, and other UI elements
            $('.badge, .alert, .card-text, .form-text').each(function() {
                let $element = $(this);
                let html = $element.html();
                if (html && /[0-9]/.test(html) &&
                    !$element.closest('.flatpickr-calendar').length &&
                    !$element.find('#Date').length) {
                    // Preserve HTML tags while converting numbers
                    $element.html(html.replace(/\b\d+(\.\d+)?\b/g, match => toArabicDigits(match)));
                }
            });

            console.log('✅ Converted existing content to Arabic digits');
        }

        // Convert header date to Arabic digits
        (function() {
            var headerDateText = $('#headerDate').text();
            if (headerDateText) {
                $('#headerDate').text(toArabicDigits(headerDateText));
            }
        })();

        // ✅ Call the conversion function BEFORE initializing date picker
        convertExistingContentToArabic();

        // ✅ Initialize date picker (Flatpickr) - English format, calendar only
        if (window.flatpickr) {
            flatpickr.localize(flatpickr.l10ns.ar);

            const datePicker = flatpickr('#Date', {
                dateFormat: 'Y-m-d',
                locale: 'ar',
                allowInput: false, // ✅ Prevent manual typing - calendar only
                disableMobile: true,
                defaultDate: $('#Date').val() || new Date(),
                onReady: function(selectedDates, dateStr, instance) {
                    // Keep date in English format (Latin digits)
                    if (dateStr) {
                        $('#Date').val(dateStr);
                    }
                },
                onChange: function(selectedDates, dateStr, instance) {
                    // Keep date in English format (Latin digits)
                    if (dateStr) {
                        $('#Date').val(dateStr);
                    }
                },
                onClose: function(selectedDates, dateStr, instance) {
                    // Keep date in English format (Latin digits)
                    if (dateStr) {
                        $('#Date').val(dateStr);
                    }
                }
            });

            // ✅ Make input readonly to prevent manual typing
            $('#Date').attr('readonly', true).css('background-color', '#fff');
        }


            // ✅ Enhanced packaging validation function
            function getAvailablePackagingDisplay() {
                if (!window.currentPackagingBreakdown || window.currentPackagingBreakdown.length === 0) {
                    return 'لا توجد أرصدة متاحة';
                }

                return window.currentPackagingBreakdown
                    .filter(p => p.totalCount > 0)
                    .map(p => `• ${toArabicDigits(p.totalCount.toString())} ${p.packagingType} (${toArabicDigits(p.specificWeight.toFixed(2))} كجم)`)
                    .join('<br>');
            }

            // ✅ Enhanced packaging change handler with Arabic numbers
            $('#PackagingStyleId').on('change', function () {
                var selectedText = $(this).find('option:selected').text();
                var selectedId = $(this).val();
                $('#PackagingStyleName').val(selectedText);

                $('#Quantity, #Count').removeClass('is-invalid');
                $('.invalid-feedback').remove();
                $('#validationSummary').hide().removeClass('alert-danger');

                if (selectedId && window.currentPackagingBreakdown) {
                    var availableCount = 0;
                    var availableWeight = 0;

                    window.currentPackagingBreakdown.forEach(function(pkg) {
                        if (pkg.packagingId == selectedId) {
                            availableCount = pkg.totalCount;
                            availableWeight = pkg.specificWeight;
                        }
                    });

                    var $countGroup = $('#Count').closest('.input-group');
                    var existingHelp = $countGroup.next('.packaging-help');
                    existingHelp.remove();

                    if (availableCount > 0) {
                        $countGroup.after(`
                            <div class="form-text packaging-help text-success">
                                <i class="fas fa-info-circle me-1"></i>
                                متاح من ${selectedText}: ${toArabicDigits(availableCount.toString())} وحدة
                                (${toArabicDigits(availableWeight.toFixed(2))} كجم)
                            </div>
                        `);
                    } else if (!IS_INBOUND) {
                        $countGroup.after(`
                            <div class="form-text packaging-help text-warning">
                                <i class="fas fa-exclamation-triangle me-1"></i>
                                لا يوجد رصيد متاح من ${selectedText}
                            </div>
                        `);
                    }
                }
            });

            // Clear placeholder zeros and handle decimal formatting
            $('#Quantity, #Count').on('focus', function() {
                if (this.value === '0' || this.value === '٠') {
                    this.value = '';
                }
            });

            // ✅ Enhanced Quantity input handler with Arabic numbers
            $('#Quantity').on('input blur', function() {
                let val = this.value;
                let cursorPos = this.selectionStart;

                // Convert Arabic decimal comma to dot for calculation
                val = val.replace(/،/g, '.');

                // Handle decimal point
                let parts = val.split('.');
                if (parts.length > 2) {
                    val = parts[0] + '.' + parts.slice(1).join('');
                }
                val = val.replace(/[^\d٠-٩.]/g, '');

                // Apply smart conversion
                applySmartNumberConversion($(this));

                // Real-time weight validation for outbound transactions
                if (!IS_INBOUND && val && window.currentPackagingBreakdown) {
                    let selectedPackagingId = $('#PackagingStyleId').val();
                    if (selectedPackagingId) {
                        let quantityValue = parseFloat(toLatinDigits(val));
                        let selectedPackaging = window.currentPackagingBreakdown.find(pkg =>
                            pkg.packagingId.toString() === selectedPackagingId);

                        let $quantityField = $(this);

                        if (selectedPackaging && !isNaN(quantityValue)) {
                            if (quantityValue > selectedPackaging.specificWeight) {
                                $quantityField.addClass('is-invalid');
                                let existingError = $quantityField.next('.invalid-feedback');
                                if (existingError.length === 0) {
                                    $quantityField.after(`
                                        <div class="invalid-feedback">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            الكمية ${toArabicDigits(quantityValue.toFixed(2))} كجم تتجاوز المتاح لـ${selectedPackaging.packagingType}
                                            (${toArabicDigits(selectedPackaging.specificWeight.toFixed(2))} كجم فقط)
                                        </div>
                                    `);
                                } else {
                                    existingError.html(`
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        الكمية ${toArabicDigits(quantityValue.toFixed(2))} كجم تتجاوز المتاح لـ${selectedPackaging.packagingType}
                                        (${toArabicDigits(selectedPackaging.specificWeight.toFixed(2))} كجم فقط)
                                    `);
                                }
                            } else {
                                $quantityField.removeClass('is-invalid');
                                $quantityField.next('.invalid-feedback').remove();
                            }
                        }
                    }
                } else {
                    $(this).removeClass('is-invalid');
                    $(this).next('.invalid-feedback').remove();
                }
            });

            // ✅ Enhanced Count input handler with Arabic numbers
            $('#Count').on('input blur', function() {
                let val = this.value;
                let cursorPos = this.selectionStart;

                // Only allow integers for count (remove decimal points)
                val = val.replace(/\./g, '');
                val = val.replace(/[^\d٠-٩]/g, '');

                // Apply smart conversion
                applySmartNumberConversion($(this));

                // Real-time packaging validation for Count field
                if (!IS_INBOUND && val && window.currentPackagingBreakdown) {
                    let selectedPackagingId = $('#PackagingStyleId').val();
                    if (selectedPackagingId) {
                        let countValue = parseInt(toLatinDigits(val));
                        let selectedPackaging = window.currentPackagingBreakdown.find(pkg =>
                            pkg.packagingId.toString() === selectedPackagingId);

                        let $countField = $(this);

                        if (selectedPackaging && !isNaN(countValue)) {
                            if (countValue > selectedPackaging.totalCount) {
                                $countField.addClass('is-invalid');
                                let existingError = $countField.next('.invalid-feedback');
                                if (existingError.length === 0) {
                                    $countField.after(`
                                        <div class="invalid-feedback">
                                            <i class="fas fa-exclamation-triangle me-1"></i>
                                            العدد ${toArabicDigits(countValue.toString())} يتجاوز المتاح لـ${selectedPackaging.packagingType}
                                            (${toArabicDigits(selectedPackaging.totalCount.toString())} وحدة فقط)
                                        </div>
                                    `);
                                } else {
                                    existingError.html(`
                                        <i class="fas fa-exclamation-triangle me-1"></i>
                                        العدد ${toArabicDigits(countValue.toString())} يتجاوز المتاح لـ${selectedPackaging.packagingType}
                                        (${toArabicDigits(selectedPackaging.totalCount.toString())} وحدة فقط)
                                    `);
                                }
                            } else {
                                $countField.removeClass('is-invalid');
                                $countField.next('.invalid-feedback').remove();
                            }
                        }
                    }
                } else {
                    $(this).removeClass('is-invalid');
                    $(this).next('.invalid-feedback').remove();
                }
            });

            // ✅ Enhanced Comment field handler with smart number conversion
            $('#Comment').on('input', function() {
                applySmartNumberConversion($(this));

                // Update character count with Arabic numbers
                let length = this.value.length;
                $('#commentCharCount').text(toArabicDigits(length.toString()));
            });

            // Initialize character count for comment with Arabic numbers
            $('#commentCharCount').text(toArabicDigits($('#Comment').val().length.toString()));

            // ✅ Enhanced preview with Arabic numbers
            $('#previewBtn').click(function () {
                let validation = validateForm();
                if (!validation.isValid) {
                    showValidationErrors(validation.errors);
                    return;
                }

                var data = {
                    yarnItem: $('#YarnItemId option:selected').text(),
                    quantity: $('#Quantity').val(),
                    count: $('#Count').val(),
                    stakeholder: $('#StakeholderId option:selected').text(),
                    packaging: $('#PackagingStyleId option:selected').text(),
                    date: $('#Date').val(),
                    comment: $('#Comment').val() || 'لا يوجد بيان',
                    type: IS_INBOUND ? 'وارد' : 'صادر'
                };

                // Convert date to Arabic for display
                var displayDate = toArabicDigits(data.date);

                var packagingWeight = '';
                if (window.currentPackagingBreakdown && $('#PackagingStyleId').val()) {
                    var selectedPackagingId = $('#PackagingStyleId').val();
                    var selectedPackaging = window.currentPackagingBreakdown.find(p =>
                        p.packagingId.toString() === selectedPackagingId);

                    if (selectedPackaging) {
                        packagingWeight = `<p><strong>الوزن المتاح للتعبئة:</strong> ${toArabicDigits(selectedPackaging.specificWeight.toFixed(2))} كجم</p>`;
                    }
                }

                var preview = `
                    <div class="row">
                        <div class="col-md-6">
                            <p><strong>النوع:</strong>
                                <span class="badge ${IS_INBOUND ? 'bg-success' : 'bg-warning'}">
                                    ${data.type}
                                </span>
                            </p>
                            <p><strong>الصنف:</strong> ${data.yarnItem}</p>
                            <p><strong>الكمية:</strong> ${data.quantity} كجم</p>
                            <p><strong>العدد:</strong> ${data.count} وحدة</p>
                        </div>
                        <div class="col-md-6">
                            <p><strong>الجهة:</strong> ${data.stakeholder}</p>
                            <p><strong>التعبئة:</strong> ${data.packaging}</p>
                            ${packagingWeight}
                            <p><strong>التاريخ:</strong> ${displayDate}</p>
                        </div>
                        <div class="col-12">
                            <p><strong>البيان:</strong> ${data.comment}</p>
                        </div>
                    </div>
                `;

                Swal.fire({
                    title: 'معاينة المعاملة',
                    html: preview,
                    icon: 'question',
                    showCancelButton: true,
                    confirmButtonText: `<i class="fas fa-save me-1"></i> حفظ ${IS_INBOUND ? 'الوارد' : 'الصادر'}`,
                    cancelButtonText: '<i class="fas fa-times me-1"></i> تراجع',
                    confirmButtonColor: IS_INBOUND ? '#198754' : '#ffc107',
                    cancelButtonColor: '#6c757d',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        submitForm();
                    }
                });
            });

            // ✅ Enhanced form validation function
            function validateForm() {
                var isValid = true;
                var errors = [];

                // Validate yarn item
                if (!$('#YarnItemId').val()) {
                    errors.push('يجب اختيار صنف الغزل');
                    $('#YarnItemId').addClass('is-invalid');
                    isValid = false;
                } else {
                    $('#YarnItemId').removeClass('is-invalid');
                }

                // Validate quantity
                var quantityVal = $('#Quantity').val().trim();
                var quantity = parseFloat(toLatinDigits(quantityVal));
                if (!quantityVal || isNaN(quantity) || quantity <= 0) {
                    errors.push('يجب إدخال كمية صحيحة أكبر من الصفر');
                    $('#Quantity').addClass('is-invalid');
                    isValid = false;
                } else {
                    $('#Quantity').removeClass('is-invalid');
                }

                // Validate count (must be integer)
                var countVal = $('#Count').val().trim();
                var count = parseInt(toLatinDigits(countVal));
                if (!countVal || isNaN(count) || count <= 0 || !Number.isInteger(parseFloat(toLatinDigits(countVal)))) {
                    errors.push('يجب إدخال عدد صحيح (بدون فاصلة عشرية) أكبر من الصفر');
                    $('#Count').addClass('is-invalid');
                    isValid = false;
                } else {
                    $('#Count').removeClass('is-invalid');
                }

                // Validate stakeholder
                if (!$('#StakeholderId').val()) {
                    errors.push('يجب اختيار الجهة');
                    $('#StakeholderId').next('.select2-container').addClass('is-invalid');
                    isValid = false;
                } else {
                    $('#StakeholderId').next('.select2-container').removeClass('is-invalid');
                }

                // Validate packaging
                if (!$('#PackagingStyleId').val()) {
                    errors.push('يجب اختيار نمط التعبئة');
                    $('#PackagingStyleId').next('.select2-container').addClass('is-invalid');
                    isValid = false;
                } else {
                    $('#PackagingStyleId').next('.select2-container').removeClass('is-invalid');
                }

                // Validate date
        if (!$('#Date').val()) {
            errors.push('يجب تحديد تاريخ المعاملة');
            $('#Date').addClass('is-invalid');
            isValid = false;
        } else {
            $('#Date').removeClass('is-invalid');
        }
                // Enhanced packaging validation with Arabic numbers in error messages
                if (!IS_INBOUND && quantity > 0 && count > 0 && window.currentPackagingBreakdown) {
                    let selectedPackagingId = $('#PackagingStyleId').val();
                    if (selectedPackagingId) {
                        let selectedPackaging = window.currentPackagingBreakdown.find(pkg =>
                            pkg.packagingId.toString() === selectedPackagingId);

                        if (selectedPackaging) {
                            if (quantity > selectedPackaging.specificWeight) {
                                errors.push(`الكمية المطلوبة (${toArabicDigits(quantity.toFixed(2))} كجم) تتجاوز المتاح لـ${selectedPackaging.packagingType} (${toArabicDigits(selectedPackaging.specificWeight.toFixed(2))} كجم)`);
                                $('#Quantity').addClass('is-invalid');
                                isValid = false;
                            }

                            if (count > selectedPackaging.totalCount) {
                                errors.push(`العدد المطلوب (${toArabicDigits(count.toString())} وحدة) يتجاوز المتاح لـ${selectedPackaging.packagingType} (${toArabicDigits(selectedPackaging.totalCount.toString())} وحدة)`);
                                $('#Count').addClass('is-invalid');
                                isValid = false;
                            }

                            let estimatedTotalWeight = count * selectedPackaging.averageWeightPerUnit;
                            if (Math.abs(quantity - estimatedTotalWeight) > (estimatedTotalWeight * 0.2)) {
                                errors.push(`تحذير: الكمية المدخلة (${toArabicDigits(quantity.toFixed(2))} كجم) لا تتطابق مع العدد المطلوب. الوزن المتوقع: ${toArabicDigits(estimatedTotalWeight.toFixed(2))} كجم`);
                                $('#Quantity').addClass('is-invalid');
                                isValid = false;
                            }
                        }
                    }
                }

                return { isValid: isValid, errors: errors };
            }

            // ✅ Enhanced error display function with Arabic numbers
            function showValidationErrors(errors) {
                if (errors && errors.length > 0) {
                    var errorHtml = errors.map(error => `<li class="mb-1">${error}</li>`).join('');
                    $('#validationList').html(errorHtml);
                    $('#validationSummary').show().addClass('alert-danger');

                    $('html, body').animate({
                        scrollTop: $('#validationSummary').offset().top - 100
                    }, 500);

                    $('.is-invalid').each(function() {
                        $(this).effect('shake', { times: 2 }, 300);
                    });

                    console.log('❌ Validation errors displayed:', errors);
                }
            }

            // ✅ Enhanced form submission handler
            $('#yarnTransactionForm').on('submit', function(e) {
                e.preventDefault();

                console.log('🔍 Form submission attempt started at:', new Date().toISOString());

                let validation = validateForm();

                if (!validation.isValid) {
                    console.log('❌ Form submission BLOCKED due to validation errors:', validation.errors);
                    showValidationErrors(validation.errors);

                    Swal.fire({
                        title: 'لا يمكن إتمام العملية',
                        html: `
                            <div class="text-danger">
                                <i class="fas fa-ban fa-2x mb-3"></i>
                                <h6>يوجد أخطاء تمنع حفظ المعاملة:</h6>
                            </div>
                            <ul class="text-start text-danger">
                                ${validation.errors.map(error => `<li>${error}</li>`).join('')}
                            </ul>
                            <div class="alert alert-info mt-3">
                                <i class="fas fa-lightbulb me-2"></i>
                                يرجى تصحيح الأخطاء أعلاه قبل المحاولة مرة أخرى
                            </div>
                        `,
                        icon: 'error',
                        confirmButtonText: 'فهمت، سأقوم بالتصحيح',
                        confirmButtonColor: '#dc3545',
                        allowOutsideClick: false,
                        allowEscapeKey: false
                    });

                    return false;
                }

                console.log('✅ Form validation passed, proceeding with submission');
                submitForm();
            });

            // ✅ Enhanced submitForm function
            function submitForm() {
                let finalValidation = validateForm();
                if (!finalValidation.isValid) {
                    console.log('❌ Final validation failed, blocking submission');
                    showValidationErrors(finalValidation.errors);
                    return false;
                }

                // Convert to Latin digits for server processing
                let quantityLatin = toLatinDigits($('#Quantity').val() || '0');
                let countLatin = toLatinDigits($('#Count').val() || '0');
        let dateLatin = toLatinDigits($('#Date').val() || ''); // Always convert date

                let selectedPackagingId = $('#PackagingStyleId').val();
                        // Validate date format after conversion
        if (!dateLatin || !/^\d{4}-\d{2}-\d{2}$/.test(dateLatin)) {
            Swal.fire({
                title: 'خطأ في التاريخ',
                text: 'تنسيق التاريخ غير صحيح. يجب أن يكون بصيغة yyyy-MM-dd',
                icon: 'error',
                confirmButtonText: 'موافق',
                confirmButtonColor: '#dc3545'
            });
            return false;
        }

                // Final validation for outbound transactions with Arabic error messages
                if (!IS_INBOUND) {
                    let quantity = parseFloat(quantityLatin);
                    let count = parseInt(countLatin);

                    if (window.currentPackagingBreakdown && selectedPackagingId) {
                        let selectedPackaging = window.currentPackagingBreakdown.find(pkg =>
                            pkg.packagingId.toString() === selectedPackagingId);

                        if (selectedPackaging) {
                            if (quantity > selectedPackaging.specificWeight) {
                                Swal.fire({
                                    title: '🚫 تم منع الحفظ',
                                    html: `
                                        <div class="text-danger">
                                            <h6>الكمية المطلوبة تتجاوز المتاح للتعبئة المحددة</h6>
                                            <p><strong>المطلوب:</strong> ${toArabicDigits(quantity.toFixed(2))} كجم</p>
                                            <p><strong>المتاح لـ${selectedPackaging.packagingType}:</strong> ${toArabicDigits(selectedPackaging.specificWeight.toFixed(2))} كجم</p>
                                        </div>
                                        <div class="alert alert-warning">
                                            <strong>الحد الأقصى المسموح:</strong> ${toArabicDigits(selectedPackaging.specificWeight.toFixed(2))} كجم
                                        </div>
                                    `,
                                    icon: 'error',
                                    confirmButtonText: 'موافق',
                                    confirmButtonColor: '#dc3545'
                                });
                                return false;
                            }

                            if (count > selectedPackaging.totalCount) {
                                Swal.fire({
                                    title: '🚫 تم منع الحفظ',
                                    html: `
                                        <div class="text-danger">
                                            <h6>العدد المطلوب يتجاوز المتاح للتعبئة المحددة</h6>
                                            <p><strong>المطلوب:</strong> ${toArabicDigits(count.toString())} وحدة</p>
                                            <p><strong>المتاح لـ${selectedPackaging.packagingType}:</strong> ${toArabicDigits(selectedPackaging.totalCount.toString())} وحدة</p>
                                        </div>
                                        <div class="alert alert-warning">
                                            <strong>الحد الأقصى المسموح:</strong> ${toArabicDigits(selectedPackaging.totalCount.toString())} وحدة
                                        </div>
                                    `,
                                    icon: 'error',
                                    confirmButtonText: 'موافق',
                                    confirmButtonColor: '#dc3545'
                                });
                                return false;
                            }
                        }
                    }
                }

                return proceedWithSubmission(quantityLatin, countLatin, dateLatin);
            }

            function proceedWithSubmission(quantityLatin, countLatin, dateLatin) {
                $('#Quantity').val(quantityLatin);
                $('#Count').val(countLatin);
                $('#Date').val(dateLatin);

                $('#saveBtn').prop('disabled', true)
                    .html('<span class="spinner-border spinner-border-sm me-2"></span>جاري الحفظ...');

                $('#yarnTransactionForm')[0].submit();
                return true;
            }

            // Handle yarn item selection change
            $('#YarnItemId').on('change', function () {
                var selectedItemId = $(this).val();
                var selectedText = $(this).find('option:selected').text();

                console.log('🔄 Yarn Item Change:', {
                    time: CURRENT_TIME,
                    itemId: selectedItemId,
                    selectedText: selectedText
                });

                $('#YarnItemName').val(selectedText);

                if (!selectedItemId) {
                    $('#currentBalanceDisplay').html('<small class="text-muted">اختر الصنف أولاً</small>');
                    $('#balanceInfoCard').fadeOut();
                    return;
                }

                fetchYarnItemBalance(parseInt(selectedItemId));
            });

            // Load stakeholders and packaging
            (function() {
                var $stakeholderSelect = $('#StakeholderId');
                resetStakeholderDropdown($stakeholderSelect);
                fetchStakeholdersByForm(FORM_NAME, $stakeholderSelect);
            })();

            $('#StakeholderId').on('change', function () {
                var $opt = $(this).find('option:selected');
                var selectedText = $opt.text();
                $('#StakeholderName').val(selectedText);
                var typeId = $opt.data('type-id');
                if (typeId) {
                    $('#StakeholderTypeId').val(typeId);
                }
            });

            var $packagingSelect = $('#PackagingStyleId');
            fetchPackagingStyles(FORM_NAME, $packagingSelect);

            var initialYarnItemId = $('#YarnItemId').val();
            if (initialYarnItemId) {
                fetchYarnItemBalance(parseInt(initialYarnItemId));
            }

            $('.alert').delay(5000).fadeOut(350);

            // ✅ Apply Arabic number conversion to existing content on page load
            convertExistingContentToArabic();

            console.log('✅ Enhanced yarn transaction form with comprehensive Arabic number support initialized successfully');

            // ✅ Helper Functions (continuing from previous code...)

            function resetStakeholderDropdown($select) {
                $select
                    .empty()
                    .append('<option value="">-- اختر الجهة --</option>')
                    .prop('disabled', false)
                    .select2('destroy')
                    .select2({
                        theme: 'bootstrap-5',
                        width: '100%',
                        language: {
                            noResults: function () {
                                return "لا توجد نتائج";
                            }
                        }
                    });
            }

            function fetchStakeholdersByForm(formName, $select) {
                $.ajax({
                    url: '/YarnTransactions/GetStakeholdersByForm',
                    type: 'GET',
                    data: { formName: formName },
                    dataType: 'json',
                    beforeSend: function() {
                        $select
                            .empty()
                            .append('<option value="">-- اختر الجهة --</option>')
                            .append('<option value="" disabled>جاري التحميل...</option>')
                            .prop('disabled', true);
                    },
                    success: function(response) {
                        $select
                            .empty()
                            .append('<option value="">-- اختر الجهة --</option>')
                            .prop('disabled', false);

                        var stakeholders = (response && response.data) || [];
                        if (response && response.success && stakeholders.length > 0) {
                            stakeholders.forEach(function(item) {
                                var opt = new Option(item.name, item.id);
                                if (item.typeId) {
                                    $(opt).attr('data-type-id', item.typeId);
                                }
                                $select.append(opt);
                            });
                            console.log('✅ Stakeholders loaded successfully');
                        } else {
                            console.warn('⚠️ No stakeholders available for form');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('❌ Error fetching stakeholders:', {
                            status: status,
                            error: error,
                            time: CURRENT_TIME
                        });
                        showError('حدث خطأ أثناء تحميل بيانات الجهات');
                    },
                    complete: function() {
                        $select.select2('destroy').select2({
                            theme: 'bootstrap-5',
                            width: '100%',
                            language: {
                                noResults: function () {
                                    return "لا توجد نتائج";
                                }
                            }
                        });
                    }
                });
            }

            function fetchPackagingStyles(formName, $select) {
                $.ajax({
                    url: '/YarnTransactions/GetPackagingStylesByForm',
                    type: 'GET',
                    data: { formType: formName },
                    dataType: 'json',
                    beforeSend: function() {
                        $select
                            .empty()
                            .append('<option value="">-- اختر التعبئة --</option>')
                            .append('<option value="" disabled>جاري التحميل...</option>')
                            .prop('disabled', true);
                    },
                    success: function(response) {
                        $select
                            .empty()
                            .append('<option value="">-- اختر التعبئة --</option>')
                            .prop('disabled', false);

                        var packagingStyles = response.data || response;
                        if (Array.isArray(packagingStyles) && packagingStyles.length > 0) {
                            packagingStyles.forEach(function(item) {
                                var optionText = item.name || item.styleName || item.text;
                                var optionValue = item.id || item.value;

                                if (optionValue && optionText) {
                                    $select.append(new Option(optionText, optionValue));
                                }
                            });
                            console.log('✅ Packaging styles loaded successfully');
                        } else {
                            console.warn('⚠️ No packaging styles available');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('❌ Error fetching packaging styles:', {
                            status: status,
                            error: error,
                            time: CURRENT_TIME
                        });
                        showError('حدث خطأ أثناء تحميل أنماط التعبئة');
                    },
                    complete: function() {
                        $select.select2('destroy').select2({
                            theme: 'bootstrap-5',
                            width: '100%',
                            language: {
                                noResults: function () {
                                    return "لا توجد نتائج";
                                }
                            }
                        });
                    }
                });
            }

            // ✅ Enhanced fetchYarnItemBalance with comprehensive Arabic number conversion
            function fetchYarnItemBalance(yarnItemId) {
                $.ajax({
                    url: '/YarnTransactions/GetYarnItemBalance',
                    type: 'GET',
                    data: { yarnItemId: yarnItemId },
                    dataType: 'json',
                    beforeSend: function() {
                        $('#currentBalanceDisplay').html('<i class="fas fa-spinner fa-spin"></i> جاري التحميل...');
                    },
                    success: function(response) {
                        if (response && response.success) {
                            var totalBalance = response.totalQuantityBalance || 0;
                            var totalCount = response.totalCountBalance || 0;

                            var balanceAr = toArabicDigits(totalBalance.toFixed(3).toString());

                            $('#currentBalanceDisplay').html(`
                                <div class="balance-summary">
                                    <div class="d-flex justify-content-between align-items-center mb-2">
                                        <div class="total-balance">
                                            <strong class="text-primary fs-5">${balanceAr}</strong>
                                            <small class="text-muted ms-1">كجم إجمالي</small>
                                        </div>
                                        <div class="packaging-count">
                                            <span class="badge bg-info">
                                                ${toArabicDigits((response.packagingTypesCount || 0).toString())} نوع تعبئة
                                            </span>
                                        </div>
                                    </div>
                                    ${createPackagingBreakdownDisplay(response.packagingBreakdown)}
                                </div>
                            `);

                            showEnhancedBalanceInfo(response);
                            $('#OriginYarnName').val(response.originYarn || '');

                            console.log('✅ Enhanced balance loaded:', {
                                yarnItem: response.yarnItem,
                                totalQuantityBalance: totalBalance,
                                totalCountBalance: totalCount,
                                packagingTypes: response.packagingTypesCount,
                                balanceMatches: response.balanceMatches,
                                time: CURRENT_TIME
                            });
                        } else {
                            $('#currentBalanceDisplay').html('<small class="text-danger">٠</small>');
                            showError(response.error || 'فشل في تحميل رصيد الصنف');
                        }
                    },
                    error: function(xhr, status, error) {
                        console.error('❌ Error fetching yarn balance:', {
                            status: status,
                            error: error,
                            time: CURRENT_TIME
                        });
                        $('#currentBalanceDisplay').html('<small class="text-danger">خطأ في التحميل</small>');
                        showError('حدث خطأ أثناء تحميل رصيد الصنف');
                    }
                });
            }

            // ✅ Enhanced packaging breakdown display with Arabic numbers
            function createPackagingBreakdownDisplay(packagingBreakdown) {
                if (!packagingBreakdown || packagingBreakdown.length === 0) {
                    return '<div class="text-muted small"><i class="fas fa-inbox me-1"></i>لا توجد وحدات</div>';
                }

                return `
                    <div class="packaging-breakdown">
                        ${packagingBreakdown.map((pkg, index) => `
                            <div class="packaging-item d-flex justify-content-between align-items-center py-1 ${index < packagingBreakdown.length - 1 ? 'border-bottom' : ''}">
                                <div class="packaging-info">
                                    <span class="packaging-name fw-semibold text-info">
                                        <i class="fas fa-cube me-1"></i>${pkg.packagingType}
                                    </span>
                                </div>
                                <div class="packaging-values text-end">
                                    <div class="specific-weight text-success fw-bold">
                                        ${toArabicDigits(pkg.specificWeight.toFixed(2))} كجم
                                    </div>
                                    <small class="text-muted">
                                        ${toArabicDigits(pkg.totalCount.toString())} وحدة
                                        (${toArabicDigits(pkg.averageWeightPerUnit.toFixed(3))} كجم/وحدة)
                                    </small>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            // ✅ Enhanced balance info display with comprehensive Arabic number conversion
            function showEnhancedBalanceInfo(data) {
                window.currentPackagingBreakdown = data.packagingBreakdown || [];
                window.currentYarnItemData = data;

                var totalBalanceAr = toArabicDigits(data.totalQuantityBalance.toFixed(3).toString());
                var totalCountAr = toArabicDigits(data.totalCountBalance.toString());
                var calculatedWeightAr = toArabicDigits(data.calculatedTotalWeight.toFixed(3).toString());
                var calculatedCountAr = toArabicDigits(data.calculatedTotalCount.toString());
                var transactionCountAr = toArabicDigits((data.transactionCount || 0).toString());
                var lastDateAr = toArabicDigits((data.lastTransactionDate || '').toString());

                var infoHtml = `
                    <div class="enhanced-balance-info">
                        <div class="row mb-3">
                            <div class="col-md-3">
                                <div class="text-center border-end">
                                    <h5 class="text-primary mb-0">${totalBalanceAr}</h5>
                                    <small class="text-muted">الرصيد الإجمالي (كجم)</small>
                                    ${data.balanceMatches ? '' : '<i class="fas fa-exclamation-triangle text-warning" title="عدم تطابق في الحسابات"></i>'}
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center border-end">
                                    <h5 class="text-success mb-0">${totalCountAr}</h5>
                                    <small class="text-muted">إجمالي الوحدات</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center border-end">
                                    <h5 class="text-info mb-0">${transactionCountAr}</h5>
                                    <small class="text-muted">عدد المعاملات</small>
                                </div>
                            </div>
                            <div class="col-md-3">
                                <div class="text-center">
                                    <h5 class="text-warning mb-0">${lastDateAr}</h5>
                                    <small class="text-muted">آخر معاملة</small>
                                </div>
                            </div>
                        </div>

                        <div class="row mb-3">
                            <div class="col-md-6">
                                <p class="mb-1"><strong>الصنف:</strong> ${data.yarnItem}</p>
                                <p class="mb-0"><strong>الغزل المكون:</strong> ${data.originYarn}</p>
                            </div>
                            <div class="col-md-6">
                                <p class="mb-0"><strong>الشركة المصنعة:</strong> ${data.manufacturer}</p>
                            </div>
                        </div>

                        ${data.packagingBreakdown && data.packagingBreakdown.length > 0 ? `
                        <div class="packaging-section">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="fw-bold text-dark mb-0">
                                    <i class="fas fa-boxes me-2"></i>تفاصيل التعبئة والأوزان
                                </h6>
                                <div class="packaging-stats">
                                    <span class="badge bg-primary">${toArabicDigits(data.packagingTypesCount.toString())} نوع</span>
                                    ${data.hasMultiplePackaging ? '<span class="badge bg-info ms-1">متعدد الأنواع</span>' : ''}
                                </div>
                            </div>

                            <div class="packaging-details">
                                ${data.packagingBreakdown.map((pkg, index) => `
                                    <div class="packaging-card mb-2 p-3 border rounded ${index % 2 === 0 ? 'bg-light' : 'bg-white'}">
                                        <div class="row align-items-center">
                                            <div class="col-md-4">
                                                <div class="packaging-name">
                                                    <i class="fas fa-cube text-info me-2"></i>
                                                    <strong>${pkg.packagingType}</strong>
                                                </div>
                                            </div>
                                            <div class="col-md-8">
                                                <div class="row text-center">
                                                    <div class="col-4">
                                                        <div class="fw-bold text-success fs-5">
                                                            ${toArabicDigits(pkg.specificWeight.toFixed(2))}
                                                        </div>
                                                        <small class="text-muted">كجم</small>
                                                    </div>
                                                    <div class="col-4">
                                                        <div class="fw-bold text-primary fs-5">
                                                            ${toArabicDigits(pkg.totalCount.toString())}
                                                        </div>
                                                        <small class="text-muted">وحدة</small>
                                                    </div>
                                                    <div class="col-4">
                                                        <div class="fw-bold text-info">
                                                            ${toArabicDigits(pkg.averageWeightPerUnit.toFixed(3))}
                                                        </div>
                                                        <small class="text-muted">كجم/وحدة</small>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>

                            <div class="packaging-summary mt-3 p-2 bg-info bg-opacity-10 rounded">
                                <div class="row text-center">
                                    <div class="col-md-6">
                                        <small class="text-info fw-semibold">
                                            <i class="fas fa-calculator me-1"></i>
                                            المجموع المحسوب: ${calculatedWeightAr} كجم | ${calculatedCountAr} وحدة
                                        </small>
                                    </div>
                                    <div class="col-md-6">
                                        <small class="${data.balanceMatches ? 'text-success' : 'text-warning'} fw-semibold">
                                            <i class="fas fa-${data.balanceMatches ? 'check-circle' : 'exclamation-triangle'} me-1"></i>
                                            ${data.balanceMatches ? 'الحسابات متطابقة' : 'يوجد اختلاف في الحسابات'}
                                        </small>
                                    </div>
                                </div>
                            </div>

                            ${!data.balanceMatches && data.balanceDiscrepancy ? `
                            <div class="alert alert-warning mt-2 py-2">
                                <i class="fas fa-exclamation-triangle me-2"></i>
                                <strong>تحذير:</strong> يوجد فرق في الأوزان:
                                ${toArabicDigits(Math.abs(data.balanceDiscrepancy.weightDifference).toFixed(3))} كجم
                                ${data.balanceDiscrepancy.countDifference !== 0 ?
                                    ` | فرق في العدد: ${toArabicDigits(Math.abs(data.balanceDiscrepancy.countDifference).toString())} وحدة` : ''}
                            </div>
                            ` : ''}

                            ${data.hasMultiplePackaging ? `
                            <div class="alert alert-info mt-2 py-2">
                                <i class="fas fa-lightbulb me-2"></i>
                                <strong>تنبيه:</strong> عند إدخال معاملة صادر، يجب اختيار نوع التعبئة المطابق للرصيد المتاح
                            </div>
                            ` : ''}
                        </div>
                        ` : `
                        <div class="alert alert-light text-center">
                            <i class="fas fa-inbox fa-2x text-muted mb-2"></i>
                            <div>لا توجد وحدات في المخزون</div>
                        </div>
                        `}
                    </div>
                `;

                $('#balanceInfo').html(infoHtml);
                $('#balanceInfoCard').fadeIn();

                console.log('✅ Enhanced balance info displayed with Arabic numbers:', {
                    yarnItemId: data.yarnItemId,
                    totalWeight: data.totalQuantityBalance,
                    packagingTypes: data.packagingTypesCount,
                    balanceMatches: data.balanceMatches,
                    calculatedWeight: data.calculatedTotalWeight,
                    user: CURRENT_USER,
                    time: CURRENT_TIME
                });
            }

            function showError(message) {
                Swal.fire({
                    title: 'خطأ',
                    text: message,
                    icon: 'error',
                    confirmButtonText: 'موافق',
                    confirmButtonColor: '#dc3545'
                });
            }

            // ✅ Enhanced reset button handler with Arabic numbers
            $('#resetBtn').on('click', function() {
                Swal.fire({
                    title: 'إعادة تعيين النموذج',
                    text: 'هل أنت متأكد من إعادة تعيين جميع الحقول؟',
                    icon: 'warning',
                    showCancelButton: true,
                    confirmButtonText: 'نعم، إعادة تعيين',
                    cancelButtonText: 'إلغاء',
                    confirmButtonColor: '#0d6efd',
                    cancelButtonColor: '#6c757d',
                    reverseButtons: true
                }).then((result) => {
                    if (result.isConfirmed) {
                        $('#yarnTransactionForm')[0].reset();
                        $('.form-select').val('').trigger('change');
                        $('#validationSummary').hide();
                        $('.is-invalid').removeClass('is-invalid');
                        $('#currentBalanceDisplay').html('<small class="text-muted">اختر الصنف أولاً</small>');
                        $('#balanceInfoCard').fadeOut();
                        $('#commentCharCount').text(toArabicDigits('0'));

                        Swal.fire({
                            title: 'تم إعادة التعيين',
                            text: 'تم مسح جميع الحقول بنجاح',
                            icon: 'success',
                            timer: 1500,
                            showConfirmButton: false
                        });
                    }
                });
            });

            // ✅ Expose utility functions globally for use in other scripts
            window.toArabicDigits = toArabicDigits;
            window.toLatinDigits = toLatinDigits;
            window.hasArabicChar = hasArabicChar;
            window.hasEnglishChar = hasEnglishChar;
            window.shouldUseArabicDigits = shouldUseArabicDigits;
            window.applySmartNumberConversion = applySmartNumberConversion;
        });

        // ✅ Utility functions (defined globally)
        function toArabicDigits(str) {
            if (!str) return str;
            return str.toString().replace(/[0-9]/g, d => '٠١٢٣٤٥٦٧٨٩'[d]);
        }

        function toLatinDigits(str) {
            if (!str) return str;
            return str.toString().replace(/[٠-٩]/g, d => '0123456789'['٠١٢٣٤٥٦٧٨٩'.indexOf(d)]);
        }
    </script>

    <style>
        /* Layout width */
        .yarn-form-container {
            max-width: 1100px;
        }

        /* Label and input sizing */
        .form-label {
            font-weight: 600;
            font-size: 0.95rem;
        }

        .form-control, .form-select, .select2-selection--single {
            min-height: 42px;
        }

        .input-group-text {
            min-height: 42px;
            display: flex;
            align-items: center;
        }

        /* Select2 height alignment */
        .select2-container .select2-selection--single {
            height: 42px;
        }

        .select2-container--bootstrap-5 .select2-selection__rendered {
            line-height: 42px;
        }

        .select2-container--bootstrap-5 .select2-selection__arrow {
            height: 42px;
        }

        /* Flatpickr alignment */
        .flatpickr-input {
            min-height: 42px;
        }

        /* Spacing consistency */
        .mb-3 {
            margin-bottom: 1rem !important;
        }

        .card-header h5 {
            font-size: 1.05rem;
        }

        .required::after {
            content: " *";
            color: #dc3545;
        }

        .form-control:focus, .form-select:focus {
            border-color: #86b7fe;
            box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25);
        }

        .border-end {
            border-right: 1px solid #dee2e6 !important;
        }

        .select2-container--bootstrap-5 .select2-selection {
            min-height: calc(2.25rem + 2px);
        }

        /* ✅ Enhanced packaging breakdown styles */
        .packaging-breakdown {
            background: #f8f9fa;
            border-radius: 0.5rem;
            padding: 0.75rem;
            margin-top: 0.5rem;
        }

        .packaging-item {
            padding: 0.5rem 0;
        }

        .packaging-card {
            transition: all 0.2s ease;
        }

            .packaging-card:hover {
                transform: translateY(-1px);
                box-shadow: 0 0.25rem 0.5rem rgba(0,0,0,0.1);
            }

        .balance-summary {
            border: 1px solid #dee2e6;
            border-radius: 0.5rem;
            padding: 1rem;
            background: linear-gradient(145deg, #f8f9fa 0%, #ffffff 100%);
        }

        .packaging-help {
            font-size: 0.875rem;
            margin-top: 0.25rem;
        }

        @@media (max-width: 768px) {
            .border-end

        {
            border-right: none !important;
            border-bottom: 1px solid #dee2e6 !important;
            padding-bottom: 15px;
            margin-bottom: 15px;
        }

        .packaging-card .row .col-4 {
            margin-bottom: 0.5rem;
        }

        }

        .card-header {
            position: relative;
            overflow: hidden;
        }

            .card-header::before {
                content: '';
                position: absolute;
                top: 0;
                left: 0;
                right: 0;
                bottom: 0;
                background: linear-gradient(45deg, rgba(255,255,255,0.1) 0%, rgba(255,255,255,0.05) 100%);
            }
    </style>
}